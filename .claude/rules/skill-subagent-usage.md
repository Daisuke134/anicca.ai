# Skill と Subagent を積極活用する

通常タスクで該当 Skill/Subagent を積極的に探して使う。

## 使い分け

- **Skill**: 専門知識が必要なタスク → 作業開始前に `SKILL.md` を読み、手順/制約をそのまま適用する。宣言だけで終わらせない。
- **Subagent**: 独立コンテキストが有効なタスク（リファクタリング・レビュー・広範囲探索など）、または並列実行したい場合に委任する。

※ 両者は併用可。Skill の知識を Subagent に渡して実行することもある。
※ 小さいタスクで該当する Skill/Subagent がない場合は、通常フローで進める。

## 利用時は明示

使用する Skill/Subagent と理由は1行で明記してから進める。

例:
```
Skill: /tdd - 新機能実装のため TDD ワークフローを適用
Subagent: code-quality-reviewer - 実装完了後のコードレビュー
```

## Available Skills (参考)

| スキル | 用途 |
|--------|------|
| `/decisive-agent` | **技術判断時に必須** - 検索→決定→理由の強制ワークフロー |
| `/plan` | 機能実装前に計画を立てる |
| `/tdd` | テスト駆動開発で実装する |
| `/code-review` | コミット前にレビューする |
| `/build-fix` | ビルドエラーを修正する |
| `/refactor-clean` | 不要コードを削除する |
| `/test-coverage` | テストカバレッジを確認・改善する |
| `/codex-review` | Codexレビューゲート（Spec更新後、major step後、コミット前に必須実行） |

## Available Subagents (参考)

| エージェント | 用途 |
|-------------|------|
| `Explore` | コードベース探索 |
| `planner` | 実装計画 |
| `architect` | 設計判断 |
| `tdd-guide` | テスト駆動開発 |
| `test-automation-engineer` | テスト作成 |
| `code-quality-reviewer` | コードレビュー |
| `security-auditor` | セキュリティ監査 |
| `tech-spec-researcher` | 技術調査 |
| `build-error-resolver` | ビルドエラー修正 |
| `refactor-cleaner` | 不要コード削除 |

## サブエージェント委任ルール

### いつ委任するか

| 条件 | 委任先 | 理由 |
|------|--------|------|
| 100行以上の出力が予想される探索 | `Explore` | メインコンテキスト汚染防止 |
| 3つ以上の独立タスクを並列実行 | 各タスク専用サブエージェント | 並列処理で高速化 |
| 専門知識が必要（セキュリティ、設計等） | 該当サブエージェント | 専門プロンプトの適用 |
| ベストプラクティス検索（技術判断前） | `Explore` or `tech-spec-researcher` | 自律的リサーチの実行 |
| テスト実装 | `tdd-guide` | TDDワークフロー強制 |
| コードレビュー | `code-quality-reviewer` | 実装後の品質確認 |

### いつ委任しないか

| 条件 | 理由 |
|------|------|
| 頻繁なやり取りが必要 | サブエージェントは新規コンテキスト開始のためレイテンシ大 |
| 5行以下の簡単なタスク | 20kトークンのオーバーヘッドに見合わない |
| 実装コーディング | メインエージェントの方がコンテキスト豊富で高品質 |
| 複数フェーズが相互依存 | コンテキスト共有が必要 |

### コンテキスト管理

| ルール | 詳細 |
|--------|------|
| メインコンテキスト使用率 | **40-60%を維持**（60%超えたら積極的に委任） |
| サブエージェント結果 | 要約のみメインに戻す（全出力をダンプしない） |
| `/compact` タイミング | 自然な区切り（計画完了後、実装完了後） |
| 並列実行 | 独立タスク3つ以上で有効。ファイル境界を明確に |

### 並列リサーチパターン（メインコンテキスト保全の核心）

**リサーチ・調査はサブエージェントに、実装はメインで。**

Web検索、コード探索、レビュー等の調査タスクはサブエージェントに委任し、メインコンテキストを実装作業に集中させる。

| パターン | 説明 | 例 |
|---------|------|----|
| **並列リサーチ** | 複数トピックを同時調査 | 技術選定で3つのライブラリを同時比較 |
| **並列レビュー** | 複数の観点から同時にレビュー | Postgres BPレビュー + コード品質レビュー + チェンジログ生成 |
| **バックグラウンド実行** | `run_in_background: true` で非ブロッキング | 長時間リサーチ中に別作業を続行 |

```
例: 技術判断が必要な場面
    ↓
サブエージェント1: Web検索（ベストプラクティス）  ← 並列
サブエージェント2: コードベース探索（既存パターン）← 並列
サブエージェント3: レビュー（品質チェック）        ← 並列
    ↓
メインに要約のみ返却 → メインが判断 → メインが実装
```

### ハンドオフ問題への対策

サブエージェントは**白紙状態**から始まる。以下を指示に必ず含める:

| 含めるべき情報 | 理由 |
|---------------|------|
| **タスクの目的** | 何を調査/レビューするか |
| **プロジェクト文脈** | 関連ファイルパス、使用技術 |
| **読むべきファイル一覧** | サブエージェントが自分で探す手間を省く |
| **期待する出力形式** | PASS/FAIL、テーブル形式、要約等 |
| **制約** | 「ファイルを変更しない」「リサーチのみ」等 |

### アンチパターン（絶対禁止）

| アンチパターン | 問題 | 代替策 |
|---------------|------|--------|
| 書き込みタスクの並列化 | ファイル競合 | 読み取りのみ並列、書き込みは直列 |
| 小さすぎるタスクの委任 | 20k+ トークンのオーバーヘッド | 5行以下は直接実行 |
| 全出力をメインにダンプ | コンテキスト汚染 | 要約のみ返す |
| コンテキスト依存タスクの委任 | 会話履歴がない | 必要な文脈を全て指示に含める |

### 並列実行の最適値（Anthropic公式 + コミュニティBP）

| ルール | 値 | 根拠 |
|--------|-----|------|
| **推奨並列数** | 3-5 agents | Anthropic Multi-Agent Research |
| **最大並列数** | 7 agents（ハードキャップ10） | Claude Code Task tool仕様 |
| **コンテキスト委任閾値** | 40-60%で積極委任 | 75%で強制compact（遅い＆割り込み） |
| **委任最小タスク** | 100行以上の出力 OR 3つ以上の独立タスク | オーバーヘッド vs 効果のバランス |

**重要な制限:** Claude は並列タスクをバッチで実行する。全タスク完了後に次のバッチを開始。
10個投げると最も遅いタスク完了まで全部待機 → 5個×2バッチの方が効率的な場合あり。

Sources:
- https://www.anthropic.com/engineering/multi-agent-research-system
- https://www.anthropic.com/engineering/claude-code-best-practices
- https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk

## Agent Teams（最終手段 — コスト高）

**通常はメインエージェント + Sub-agentで対応。Agent Teamsは「本当に分からない」時の最終手段。**

### エスカレーション順序

| レベル | 手段 | コスト | いつ使う |
|--------|------|--------|---------|
| 1 | メインエージェント自身で調査 | 最小 | まず自分で調べる |
| 2 | Sub-agent（Haiku/Sonnet） | 低 | 並列リサーチ、コードレビュー |
| 3 | **Agent Team（Opus複数）** | **高（5倍+）** | **上記で解決できない複雑な問題** |

### Agent Teamを使うべき場面

| 場面 | 理由 |
|------|------|
| 複雑なバグで原因不明 | 複数仮説を並列検証、互いに反証 |
| 大規模リファクタリング（独立モジュール） | ファイル境界が明確で並列実装可能 |
| 複数角度からのレビューが必要 | セキュリティ/パフォーマンス/テストを同時に |
| iOS + API + テストの同時開発 | クロスレイヤーで各自が担当 |

### Agent Teamを使わない場面

| 場面 | 理由 |
|------|------|
| 単純なバグ修正 | Sub-agentかメインで十分 |
| 1ファイルの変更 | オーバーヘッドが大きすぎる |
| 順次依存のタスク | 並列化の恩恵なし |
| 同じファイルを複数人で触る | 上書き競合する |

### 運用ルール

| ルール | 詳細 |
|--------|------|
| デフォルトモデル | リーダーと同じ（Opus） |
| コスト意識 | 5人チーム = 約5倍のトークン消費 |
| 安易に使わない | メイン + Sub-agentで解決を先に試す |
| ユーザー承認 | チーム立ち上げ前にユーザーに確認する |
