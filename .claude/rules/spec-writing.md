# Spec ファイルの書き方（必読）

## 目的

Spec ファイルは「設計の意図が明確で、AI が読んで実装できる」レベルの詳細を含む。

> **原則: Spec は What と Why を定義する。How（実装コード）は AI に任せる。**
> -- Spec-Driven Development (SDD) ベストプラクティス 2025

## Spec に書くもの / 書かないもの

| 書くもの | 書かないもの |
|---------|-------------|
| 何を解決するか（What） | 関数のボディ（実装コード） |
| なぜ必要か（Why） | テストコードの全文 |
| 受け入れ条件（テスト可能な形式） | Maestro YAML の全文 |
| データモデル / API コントラクト | 詳細なアルゴリズム |
| 主要な関数シグネチャ | コピペで動くパッチ |
| テストマトリックス（名前と対象） | - |
| 境界（やらないこと） | - |

**なぜフルパッチを書かないのか:**
- Spec が長くなりすぎてメンテ不可
- 実装とSpec両方を更新する二重作業
- レビューの意味が薄れる（既に書いてあるなら何をレビュー？）
- AI の最適化余地がゼロになる

## Specセクション（コア6 + オプション）

**コア6セクションは必須。オプションは該当する場合のみ。**

### コア（必須）

| # | セクション | 内容 |
|---|-----------|------|
| 1 | **概要（What & Why）** | 何を解決するか、なぜ必要か |
| 2 | **受け入れ条件** | テスト可能な形式の成功基準 |
| 3 | **As-Is / To-Be** | 現状→変更後の設計（シグネチャ、データモデル） |
| 4 | **テストマトリックス** | To-Be ごとのテスト名と対応（漏れ防止を兼ねる） |
| 5 | **境界** | やらないこと、触らないファイル |
| 6 | **実行手順** | ビルド、テストコマンド |

### オプション（該当時のみ — ただしE2E判定は必須記載）

| セクション | いつ必要か |
|-----------|-----------|
| **E2E判定（必須記載）** | **常に。** UI変更あり→シナリオ必須 / UI変更なし→「E2E不要: 理由」を明記 |
| ローカライズ | テキスト追加・変更がある場合 |
| ユーザーGUI作業 | 外部サービス連携・手動セットアップがある場合 |
| Skills / Sub-agents | 複雑なタスクで明示が必要な場合 |

**E2E判定の書き方:**
```markdown
## E2E判定

| 項目 | 値 |
|------|-----|
| UI変更 | あり / なし |
| 新画面 | あり → Maestro必須 / なし |
| 新ボタン/操作 | あり → Maestro必須 / なし |
| 結論 | Maestro E2Eシナリオ: 必要 / 不要（理由: ○○） |
```

**レビューチェックリストは不要。** codex-review（GATE 1）が自動でSpecの漏れを検出する。
**To-Beチェックリストは不要。** テストマトリックスが To-Be の漏れ防止を兼ねる。

## テストマトリックス例

| # | To-Be | テスト名 | カバー |
|---|-------|----------|--------|
| 1 | Thompson Sampling でバリアント選択 | `test_selectByThompsonSampling()` | OK |
| 2 | 時刻固定バリアント | `test_time_specific_variant()` | OK |
| 3 | 2日連続無視 → 30分シフト | `test_consecutive_ignored_triggers_shift()` | NG |

**全ての To-Be にテストが必要。** NG があれば Spec は不完全。

## ユーザー GUI タスクの明記（オプション：外部サービス連携時）

**Spec ファイルには、ユーザーが GUI で行う作業を必ず明記する。**

### ルール

1. **コード実装前にできるセットアップは、先にユーザーにやらせる**
   - Webhook URL 取得、API Key 取得、環境変数設定など
   - 「後でやる」は禁止。依存関係がある場合は先にやる

2. **具体的な手順を書く**（「〇〇を設定」だけはNG）
   - URL、ボタン名、画面名を明記
   - スクリーンショットがあればなお良い

3. **実装途中でユーザー確認が必要な場合は明記**
   - Maestro でテストできない項目
   - 実機でしか確認できない項目
   - 外部サービスとの連携確認

4. **Spec ファイルに専用セクションを設ける**

```markdown
## ユーザー作業（実装前）

| # | タスク | 手順 | 取得するもの |
|---|--------|------|-------------|
| 1 | Slack App 作成 | [手順へのリンク] | Webhook URL |

## ユーザー作業（実装中）

| # | タイミング | タスク | 理由 |
|---|-----------|--------|------|
| 1 | Slack 投稿テスト後 | Slack で確認 | 自動テスト不可 |

## ユーザー作業（実装後）

| # | タスク | 確認項目 |
|---|--------|---------|
| 1 | 翌日6:00確認 | 自動投稿が届くか |
```
