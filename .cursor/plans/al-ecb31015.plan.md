<!-- ecb31015-654c-42e8-900e-3a0a3044c5d2 4ee78554-0f6d-418f-8d42-d1f8670ef19b -->
# AlarmKit関連の修正パッチ

---

## 1. ロック画面で「habit_title_bedtime」とキー名が表示される問題

**原因**: `LocalizedStringResource("キー名")` がAlarmKitコンテキストで正しく解決されていない。AlarmKitはWidget Extension等の別プロセスでUIを表示するため、メインアプリのローカライズバンドルが参照されない。

**影響範囲**: wake, training, bedtime, custom の**全4種類**で同じ問題が発生する。

**修正ファイル**: [`AlarmKitHabitCoordinator.swift`](aniccaios/aniccaios/Notifications/AlarmKitHabitCoordinator.swift)

**パッチ（194-205行目を完全に置き換え）**:

```swift
// 変更前
private func localizedTitle(for habit: HabitType) -> LocalizedStringResource {
    switch habit {
    case .wake:
        return LocalizedStringResource("habit_title_wake")
    case .training:
        return LocalizedStringResource("habit_title_training")
    case .bedtime:
        return LocalizedStringResource("habit_title_bedtime")
    case .custom:
        return LocalizedStringResource("habit_title_custom_fallback")
    }
}

// 変更後 - 事前にローカライズ済み文字列を取得してから渡す
private func localizedTitle(for habit: HabitType) -> LocalizedStringResource {
    let title: String
    switch habit {
    case .wake:
        title = String(localized: "habit_title_wake")  // "起床" or "Wake Up"
    case .training:
        title = String(localized: "habit_title_training")  // "トレーニング" or "Training"
    case .bedtime:
        title = String(localized: "habit_title_bedtime")  // "就寝" or "Sleep"
    case .custom:
        // カスタム習慣はユーザーが設定した名前を使用
        title = CustomHabitStore.shared.displayName(
            fallback: String(localized: "habit_title_custom_fallback")
        )
    }
    return LocalizedStringResource(stringLiteral: title)
}
```

**表示結果**:

| 習慣タイプ | 修正前 | 修正後（日本語） | 修正後（英語） |

|-----------|--------|-----------------|---------------|

| wake | habit_title_wake | 起床 | Wake Up |

| training | habit_title_training | トレーニング | Training |

| bedtime | habit_title_bedtime | 就寝 | Sleep |

| custom | habit_title_custom_fallback | ユーザー設定名 or カスタム習慣 | ユーザー設定名 or Custom Habit |

---

## 2. Openボタンの色をオレンジ背景・白文字に統一

**修正ファイル**: [`AlarmKitHabitCoordinator.swift`](aniccaios/aniccaios/Notifications/AlarmKitHabitCoordinator.swift)

**パッチ1 - Openボタン (19-25行目)**:

```swift
// 変更前
static var openAppButton: AlarmButton {
    AlarmButton(
        text: LocalizedStringResource("Open"),
        textColor: .blue,
        systemImageName: "arrow.up.forward.app"
    )
}

// 変更後 - 白文字に変更
static var openAppButton: AlarmButton {
    AlarmButton(
        text: LocalizedStringResource("Open"),
        textColor: .white,
        systemImageName: "arrow.up.forward.app"
    )
}
```

**パッチ2 - tintColor統一 (207-218行目)**:

```swift
// 変更前
private func tintColor(for habit: HabitType) -> Color {
    switch habit {
    case .wake:
        return .orange
    case .training:
        return .green
    case .bedtime:
        return .indigo
    case .custom:
        return .blue
    }
}

// 変更後 - すべてオレンジに統一
private func tintColor(for habit: HabitType) -> Color {
    return .orange
}
```

---

## 3. 再通知回数のデフォルトをすべて2に変更

**修正ファイル**: [`AppState.swift`](aniccaios/aniccaios/AppState.swift)

**パッチ1 - defaultFollowupCount (180-185行目)**:

```swift
// 変更前
private func defaultFollowupCount(for habit: HabitType) -> Int {
    switch habit {
    case .wake, .bedtime: return 5
    default: return 2
    }
}

// 変更後 - すべて2に統一
private func defaultFollowupCount(for habit: HabitType) -> Int {
    return 2
}
```

**パッチ2 - loadFollowupCounts の else 句 (196行目付近)**:

```swift
// 変更前
habitFollowupCounts = [.wake: 5, .bedtime: 5, .training: 2, .custom: 2]

// 変更後
habitFollowupCounts = [.wake: 2, .bedtime: 2, .training: 2, .custom: 2]
```

---

## 4. Stickyモードのログ強化

**修正ファイル**: [`VoiceSessionController.swift`](aniccaios/aniccaios/VoiceSessionController.swift)

**パッチ - sendWakeResponseCreate (534-538行目)**:

```swift
// 変更前
private func sendWakeResponseCreate() {
    guard let channel = dataChannel, channel.readyState == .open else { return }
    guard let data = try? JSONSerialization.data(withJSONObject: ["type": "response.create"]) else { return }
    channel.sendData(RTCDataBuffer(data: data, isBinary: false))
}

// 変更後 - ログ追加
private func sendWakeResponseCreate() {
    guard let channel = dataChannel, channel.readyState == .open else {
        logger.warning("Sticky: cannot send response.create - channel not ready")
        return
    }
    guard let data = try? JSONSerialization.data(withJSONObject: ["type": "response.create"]) else {
        logger.error("Sticky: failed to serialize response.create")
        return
    }
    channel.sendData(RTCDataBuffer(data: data, isBinary: false))
    logger.info("Sticky \(self.stickyUserReplyCount)/\(self.stickyReleaseThreshold): sent response.create to keep talking")
}
```

**パッチ - handleRealtimeEvent の response.completed ケース (557-560行目)**:

```swift
// 変更前
case "response.completed":
    if stickyActive {
        sendWakeResponseCreate()
    }

// 変更後 - ログ追加
case "response.completed":
    if stickyActive {
        logger.info("Sticky \(self.stickyUserReplyCount)/\(self.stickyReleaseThreshold): response.completed received, triggering next response")
        sendWakeResponseCreate()
    }
```

---

## 5. Widget Extension（Dynamic Island対応）

**状態**: ユーザーがXcodeで `AniccaWidget` を追加済み（Include Live Activity チェック済み）

**動作**: アラーム型のAlarmKitは、Widget Extensionがあればシステムが自動的にDynamic Islandに表示する。

---

## 6. 習慣トグルOFF時にAlarmKitがキャンセルされない問題【新規バグ修正】

**症状**: 習慣のトグルをON→OFFにしても、設定した時刻にAlarmKitアラームが鳴る

**原因**: `removeHabitSchedule` で習慣を削除しても、AlarmKitアラームがキャンセルされていない

**修正ファイル**: [`AppState.swift`](aniccaios/aniccaios/AppState.swift)

**パッチ（246-251行目を修正）**:

```swift
// 変更前
func removeHabitSchedule(_ habit: HabitType) {
    habitSchedules.removeValue(forKey: habit)
    saveHabitSchedules()
    Task {
        await scheduler.applySchedules(habitSchedules)
    }
}

// 変更後 - 明示的にAlarmKitをキャンセル
func removeHabitSchedule(_ habit: HabitType) {
    habitSchedules.removeValue(forKey: habit)
    saveHabitSchedules()
    Task {
        // 削除された習慣のAlarmKit/通知を明示的にキャンセル
        scheduler.cancelHabit(habit)
        // 残りの習慣を再スケジュール
        await scheduler.applySchedules(habitSchedules)
    }
}
```

---

## 修正ファイル一覧

| ファイル | 修正内容 |

|---------|---------|

| `AlarmKitHabitCoordinator.swift` | ローカライズ修正、ボタン色統一 |

| `AppState.swift` | 再通知回数デフォルト変更、トグルOFFキャンセル修正 |

| `VoiceSessionController.swift` | Stickyモードログ強化 |

### To-dos

- [ ] AlarmKitのローカライズ問題を修正（全習慣タイプ対応）
- [ ] Openボタンをオレンジ背景・白文字に統一
- [ ] 再通知回数のデフォルトをすべて2に変更
- [ ] Stickyモードのログ出力を強化（Sticky X/10形式）
- [ ] AniccaWidgetLiveActivity.swiftの確認・修正