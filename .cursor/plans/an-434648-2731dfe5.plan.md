<!-- 2731dfe5-cbbe-43c1-b301-32d33cdf1c94 18e3afd3-d4cd-47a4-aa7e-8aa11ec14b84 -->
# Anicca iOS UI Refresh - 完全実装ガイド

### 目的

- 機能は現状維持のまま、Figma参照デザイン（README 47–67 の7ノード）を反映し、アプリ全体のUIを統一・近代化。
- 既存の `AppTheme` システム（`DesignSystem/AppTheme.swift`）を活用し、重複を避けて実装。

### スコープとマッピング

- ベーストークン（色/角丸/余白/ボタン形状）: `6:84`, `6:2`（Atoms系）
- ホーム/進捗カードの質感（白カード+大きめ角丸+やわらかい影）: `6:247`
- 曜日選択（円形チップ/ピル）: 既存の `DayOfWeekPicker` を活用
- 太字見出し/本文階層: 全体に `6:84` のコントラスト比・サイズ感を近似

### 追加ファイル（最小限）

- `/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/DesignSystem/Appearance.swift`（UINavigationBar/List 背景統一）
- `/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/DesignSystem/Components/PrimaryButtonStyle.swift`

**重要**: 既存の `AppTheme.swift` に色・余白・タイポグラフィが定義済みのため、重複する新規ファイルは追加しません。

### 既存ファイルの主な編集ポイント

- `aniccaiosApp.swift`: `Appearance.configure()` を起動時に呼び出し、`.tint(AppTheme.Colors.accent)` を注入。
- `ContentView.swift`: ルートに `AppBackground()` を敷設。
- `SessionView.swift`: 見出し/説明/通知カード/CTAボタンを既存トークンに置換、余白・角丸・配色更新。
- `Onboarding/*StepView.swift`（Welcome/Authentication/HabitSetup/...）: セクション背景/CTA ボタン/タイトル階層を統一。
- `SettingsView.swift`: 背景統一（`Appearance.configure()` でOSレベルで処理、`.scrollContentBackground(.hidden)` はiOS 16+のみ）。
- `Views/ManageSubscriptionSheet.swift`: アクセント色を `AppTheme.Colors.accent` に統一。
- `Views/SubscriptionRequiredView.swift`: 背景統一、`PaywallContainerView` のアクセント色連携。
- `Components/PaywallContainerView.swift`: `.tint(AppTheme.Colors.accent)`、周囲余白と背景をライト基調へ。

### 実装方針

- 既存の `AppTheme` システム（`AppTheme.Colors`, `AppTheme.Spacing`, `AppTheme.Typography`）を活用。
- `AppBackground` コンポーネントを使用して背景を統一。
- 資産追加なし（Inter 未導入）。色はコード定義、iOS Dynamic Type配慮、ダークモードは現状維持。

### テスト観点

- 主要画面（セッション/オンボーディング/設定/課金UI）で背景色・文字コントラスト・タップ領域を確認。
- RevenueCat UI の表示・操作導線に影響が出ていないこと。

---

## 完全実装パッチ

### 適用順

1. 新規ファイルの追加（DesignSystem/Appearance.swift, DesignSystem/Components/PrimaryButtonStyle.swift）
2. 既存ファイルの編集（グローバル外観 → 主要画面）

---

### パッチ 1: Appearance.swift の追加

```
// *** Begin Patch
// *** Add File: aniccaios/aniccaios/DesignSystem/Appearance.swift
import SwiftUI

enum Appearance {
    static func configure() {
        // 既存の AppTheme.Colors.background を使用
        let bg = UIColor(AppTheme.Colors.background)

        // UINavigationBar
        let nav = UINavigationBarAppearance()
        nav.configureWithOpaqueBackground()
        nav.backgroundColor = bg
        nav.shadowColor = .clear
        UINavigationBar.appearance().standardAppearance = nav
        UINavigationBar.appearance().scrollEdgeAppearance = nav

        // UIToolbar
        let tb = UIToolbarAppearance()
        tb.configureWithOpaqueBackground()
        tb.backgroundColor = bg
        UIToolbar.appearance().standardAppearance = tb
        if #available(iOS 15.0, *) {
            UIToolbar.appearance().scrollEdgeAppearance = tb
        }

        // UITableView / UICollectionView 背景
        UITableView.appearance().backgroundColor = bg
        UICollectionView.appearance().backgroundColor = bg
    }
}
// *** End Patch
```

---

### パッチ 2: PrimaryButtonStyle.swift の追加

```
// *** Begin Patch
// *** Add File: aniccaios/aniccaios/DesignSystem/Components/PrimaryButtonStyle.swift
import SwiftUI

struct PrimaryButtonStyle: ButtonStyle {
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .font(.headline)
            .foregroundColor(.white)
            .frame(maxWidth: .infinity, minHeight: 56)
            .background(
                RoundedRectangle(cornerRadius: 28, style: .continuous)
                    .fill(Color.black.opacity(configuration.isPressed ? 0.9 : 1.0))
            )
            .overlay(
                RoundedRectangle(cornerRadius: 28, style: .continuous)
                    .stroke(AppTheme.Colors.border, lineWidth: 1)
            )
            .animation(.easeOut(duration: 0.12), value: configuration.isPressed)
    }
}
// *** End Patch
```

---

### パッチ 3: aniccaiosApp.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/aniccaiosApp.swift
@@
 import SwiftUI
 
 @main
 struct aniccaiosApp: App {
     @UIApplicationDelegateAdaptor(AppDelegate.self) private var appDelegate
     @StateObject private var appState = AppState.shared
 
+    init() {
+        Appearance.configure()
+    }
+
     var body: some Scene {
         WindowGroup {
             ContentRouterView()
                 .environmentObject(appState)
+                .tint(AppTheme.Colors.accent)
+                .background(AppBackground())
         }
     }
 }
// *** End Patch
```

---

### パッチ 4: ContentView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/ContentView.swift
@@
 struct ContentRouterView: View {
     @EnvironmentObject private var appState: AppState
 
     var body: some View {
-        if !appState.isOnboardingComplete {
-            OnboardingFlowView()
-        } else {
-            switch appState.authStatus {
-            case .signedOut:
-                OnboardingFlowView()
-            case .signingIn:
-                AuthenticationProcessingView()
-            case .signedIn:
-                MainTabView()
-            }
-        }
+        Group {
+            if !appState.isOnboardingComplete {
+                OnboardingFlowView()
+            } else {
+                switch appState.authStatus {
+                case .signedOut:
+                    OnboardingFlowView()
+                case .signingIn:
+                    AuthenticationProcessingView()
+                case .signedIn:
+                    MainTabView()
+                }
+            }
+        }
+        .background(AppBackground())
     }
 }
// *** End Patch
```

---

### パッチ 5: SessionView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/SessionView.swift
@@
     private var authenticatedContent: some View {
         navigationContainer {
-            VStack(spacing: 24) {
+            VStack(spacing: AppTheme.Spacing.xl) {
                 Text("Anicca")
-                    .font(.system(size: 32, weight: .bold))
+                    .font(.system(size: 32, weight: .bold))
+                    .foregroundStyle(AppTheme.Colors.label)
 
                 if shouldShowWakeSilentNotice {
                     Text(String(localized: "session_wake_silent_notice"))
                         .multilineTextAlignment(.center)
-                        .font(.subheadline)
-                        .foregroundStyle(.secondary)
-                        .padding(16)
+                        .font(.subheadline)
+                        .foregroundStyle(AppTheme.Colors.secondaryLabel)
+                        .padding(16)
                         .frame(maxWidth: .infinity)
                         .background(
                             RoundedRectangle(cornerRadius: 16, style: .continuous)
-                                .fill(.thinMaterial)
+                                .fill(AppTheme.Colors.adaptiveCardBackground)
+                                .overlay(
+                                    RoundedRectangle(cornerRadius: 16, style: .continuous)
+                                        .stroke(AppTheme.Colors.border, lineWidth: 1)
+                                )
                         )
                 }
 
                 Spacer(minLength: 24)
 
-                sessionButton
+                sessionButton
+                    .buttonStyle(PrimaryButtonStyle())
             }
-            .padding()
+            .padding(AppTheme.Spacing.xl)
+            .background(AppBackground())
             .toolbar {
@@
             }
         }
     }
// *** End Patch
```

---

### パッチ 6: OnboardingFlowView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Onboarding/OnboardingFlowView.swift
@@
     var body: some View {
         Group {
             switch step {
@@
             }
         }
+        .background(AppBackground())
         .onAppear {
@@
         }
     }
// *** End Patch
```

---

### パッチ 7: WelcomeStepView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Onboarding/WelcomeStepView.swift
@@
     var body: some View {
-        VStack(spacing: 32) {
+        VStack(spacing: AppTheme.Spacing.xl) {
             Spacer()
 
             Text("onboarding_welcome_title")
                 .font(.system(size: 32, weight: .bold))
+                .foregroundStyle(AppTheme.Colors.label)
 
             Text("onboarding_welcome_subtitle")
                 .font(.body)
-                .foregroundStyle(.secondary)
+                .foregroundStyle(AppTheme.Colors.secondaryLabel)
 
             Spacer()
 
             Button(action: next) {
                 Text("onboarding_welcome_cta")
                     .frame(maxWidth: .infinity)
             }
-            .buttonStyle(.borderedProminent)
-            .controlSize(.large)
+            .buttonStyle(PrimaryButtonStyle())
         }
-        .padding(24)
+        .padding(AppTheme.Spacing.xl)
+        .background(AppBackground())
     }
 }
// *** End Patch
```

---

### パッチ 8: AuthenticationStepView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Onboarding/AuthenticationStepView.swift
@@
     var body: some View {
-        VStack(spacing: 24) {
+        VStack(spacing: AppTheme.Spacing.lg) {
             Text("onboarding_account_title")
                 .font(.title)
+                .foregroundStyle(AppTheme.Colors.label)
                 .padding(.top, 40)
             
             Text("onboarding_account_description")
                 .font(.subheadline)
-                .foregroundStyle(.secondary)
+                .foregroundStyle(AppTheme.Colors.secondaryLabel)
                 .multilineTextAlignment(.center)
                 .padding(.horizontal)
@@
             Spacer()
         }
-        .padding(24)
+        .padding(AppTheme.Spacing.xl)
+        .background(AppBackground())
         .onAppear {
@@
         }
     }
// *** End Patch
```

---

### パッチ 9: SettingsView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/SettingsView.swift
@@
     var body: some View {
         navigationContainer {
             List {
@@
             }
-            .onAppear {
+            .modifier(if #available(iOS 16.0, *) {
+                AnyViewModifier { $0.scrollContentBackground(.hidden) }
+            } else {
+                AnyViewModifier { $0 }
+            })
+            .background(AppBackground())
+            .onAppear {
                 loadPersonalizationData()
                 Task { await SubscriptionManager.shared.syncNow() }
             }
             .safeAreaInset(edge: .bottom) {
                 // Guideline 3.1.2対応: 法的リンクを常設（購入フロー外からも1タップ到達）
                 LegalLinksView()
             }
@@
         }
+        .background(AppBackground())
     }
 }
// *** End Patch
```

**注意**: iOS 16+ のみ `.scrollContentBackground(.hidden)` を適用する場合、以下のように条件分岐します：

```swift
if #available(iOS 16.0, *) {
    List { ... }
        .scrollContentBackground(.hidden)
        .background(AppBackground())
} else {
    List { ... }
        .background(AppBackground())
}
```

---

### パッチ 10: ManageSubscriptionSheet.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Views/ManageSubscriptionSheet.swift
@@
             .navigationTitle("settings_subscription_manage_title")
             .navigationBarTitleDisplayMode(.inline)
             .toolbar {
@@
             }
+            .tint(AppTheme.Colors.accent)
+            .background(AppBackground())
         }
     }
// *** End Patch
```

---

### パッチ 11: SubscriptionRequiredView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Views/SubscriptionRequiredView.swift
@@
 struct SubscriptionRequiredView: View {
     @Environment(\.dismiss) private var dismiss
     var body: some View {
         PaywallContainerView(
             onDismissRequested: { dismiss() }
         )
             .environment(\.locale, .autoupdatingCurrent)
             .ignoresSafeArea()
+            .background(AppBackground())
     }
 }
// *** End Patch
```

---

### パッチ 12: PaywallContainerView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Components/PaywallContainerView.swift
@@
                     // 下部: 法的リンクを常設
                     LegalLinksView()
                 }
             } else if isLoading {
@@
             }
         }
+        .tint(AppTheme.Colors.accent)
+        .background(AppBackground())
     }
 }
// *** End Patch
```

---

### パッチ 13: PaywallStepView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Onboarding/PaywallStepView.swift
@@
                 return
             }
         }
+        .background(AppBackground())
     }
 }
// *** End Patch
```

---

### パッチ 14: CompletionStepView.swift の更新

```
// *** Begin Patch
// *** Update File: aniccaios/aniccaios/Onboarding/CompletionStepView.swift
@@
             .padding(.horizontal)
             .padding(.bottom)
         }
         .padding(24)
+        .background(AppBackground())
     }
 }
// *** End Patch
```

---

## 補足メモ

- 追加/更新後は一度クリーンビルド（Shift+Cmd+K → ビルド）を推奨。
- フォントはSF Pro（標準）で、アクセント以外はFigmaのコントラスト比に近づけています。
- ダークモードは現状維持。今後対応する場合は `Appearance.configure()` と `AppTheme.Colors` にダーク側トークンを追加してください。
- 影や微妙な余白は最小限に留め、代わりにカードの角丸＋境界線でFigmaのやわらかい質感を再現しています。
- 曜日選択UIは既存の `DayOfWeekPicker` を使用（`DayCircleButtonStyle` は追加不要）。

このパッチを適用すれば、機能変更なしでMobbin/Atoms系の質感（ベージュ基調・大角丸・落ち着いたコントラスト・太字見出し）に全画面が統一されます。

---

## 実装チェックリスト

- [ ] `DesignSystem/Appearance.swift` を追加
- [ ] `DesignSystem/Components/PrimaryButtonStyle.swift` を追加
- [ ] `aniccaiosApp.swift` に `Appearance.configure()` と `.tint/.background` を適用
- [ ] `ContentView.swift` に `AppBackground()` を適用
- [ ] `SessionView.swift` を新テーマで再スタイル（見出し/告知カード/CTA）
- [ ] `OnboardingFlowView.swift` に背景を適用
- [ ] `WelcomeStepView.swift` の見出し/CTA/背景を統一
- [ ] `AuthenticationStepView.swift` の見出し/説明/背景を統一
- [ ] `SettingsView.swift` に背景を適用（iOS 16+ のみ `.scrollContentBackground(.hidden)`）
- [ ] `ManageSubscriptionSheet.swift` に `.tint` と背景を適用
- [ ] `SubscriptionRequiredView.swift` に背景を適用
- [ ] `PaywallContainerView.swift` に `.tint` と背景を適用
- [ ] `PaywallStepView.swift` に背景を適用
- [ ] `CompletionStepView.swift` に背景を適用
- [ ] 配色/可読性/タップ領域/RevenueCat導線のQA確認

---

## 重要な注意事項

1. **既存システムの活用**: `AppTheme.Colors`, `AppTheme.Spacing`, `AppTheme.Typography` は既に定義済みのため、新規追加は不要です。
2. **背景の統一**: `AppBackground()` コンポーネントを使用して全画面の背景を統一します。
3. **iOS バージョン互換性**: `.scrollContentBackground(.hidden)` は iOS 16+ のみのため、条件分岐が必要です。
4. **RevenueCat UI**: `.tint(AppTheme.Colors.accent)` を適用することで、RevenueCat UIのアクセント色も統一されます。

### To-dos

- [ ] DesignSystem: 色・余白・タイポ・角丸トークンを追加
- [ ] 共通コンポーネント（Primary/SecondaryButton, Card, DayCircle）を追加
- [ ] Appearance.configure() と .tint/.background の全体適用
- [ ] SessionView を新テーマで再スタイル
- [ ] Onboarding各Stepの見出し/CTA/背景を統一適用
- [ ] SettingsView を新テーマに更新（List背景隠し等）
- [ ] ManageSubscriptionSheet/SubscriptionRequired/PaywallContainer を統一適用
- [ ] 配色/可読性/タップ領域/RevenueCat導線のQA確認