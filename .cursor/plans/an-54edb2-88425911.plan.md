<!-- 88425911-370e-451a-88b3-51b2c54d82aa f405775f-3879-4b02-bcf6-041440baa1e3 -->
# Anicca iOS UI刷新 — 修正済みパッチ適用計画

## 要旨

- 本パッチはそのままでは一部が不整合（既存ファイルへの Add 指定、`SessionController`/`AuthStatus`の不一致等）。
- 既存構造（`VoiceSessionController.shared` と `AuthStatus.signedOut/signingIn/signedIn`）を維持し、UI刷新に限定して適用します（ご選択: A）。
- `DayOfWeekPicker` の円サイズは 48×48 に統一します（ご選択: A）。
- Xcodeは FileSystemSynchronizedRootGroup で自動取り込みのため pbxproj 追記は不要（iOS 16最小、`.foregroundStyle`利用OK）。

---

## 修正が必要な点（要約）

- 既存の `AppTheme.swift` と `AppBackground.swift` は「Add」ではなく「Update」にする（新トークンの追加入り）。
- `DayOfWeekPicker.swift` は既に存在するため「Add」→「Update」に変更し、サイズのみ48へ修正。
- `SessionView.swift` の原案はコントローラ名・認証状態が非互換のため不採用。UIのみ差し替える最小変更版に置換。
- 新規追加: `PrimaryButton.swift`/`CardView.swift`/`GradientIcon.swift`/`SectionRow.swift`/`CustomTabBar.swift` は「Add」でOK。

---

## 修正済みパッチ（MD差し替え用）

以下は .md パッチの置換用フラグメントです（短縮版）。そのまま該当 `fix*.md` に差し替えて適用ください。[[memory:11283936]]

### 1) fix1.md — DesignSystem 基本（Update＋Add）

- AppTheme.swift（Update: 既存にトークン追加）
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/DesignSystem/AppTheme.swift
@@
 enum AppTheme {
     enum Colors {
@@
-        static let background: Color = Color(hex: "#f8f5ed")
+        static let background: Color = Color(hex: "#f8f5ed")
+        // 追加: 透明度付き背景（軽い段差演出用）
+        static let backgroundWithOpacity: Color = Color(
+            red: 246/255, green: 245/255, blue: 236/255, opacity: 0.99
+        )
@@
     enum Radius {
         static let sm: CGFloat = 8
         static let md: CGFloat = 12
         static let lg: CGFloat = 20
         static let xl: CGFloat = 36
-        static let card: CGFloat = 37
-        static let cardLarge: CGFloat = 76
+        // 追加: 大型角丸
+        static let xxl: CGFloat = 32
+        static let card: CGFloat = 37
+        static let cardLarge: CGFloat = 76
+        static let cardXLarge: CGFloat = 87
     }
 }
*** End Patch
```

- AppBackground.swift（Update: 可変背景を選択可能に）
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/DesignSystem/AppBackground.swift
@@
-struct AppBackground: View {
-    var body: some View {
-        // Mobbinデザイン: 温かいベージュ背景を適用
-        if #available(iOS 15.0, *) {
-            AppTheme.Colors.adaptiveBackground.ignoresSafeArea()
-        } else {
-            AppTheme.Colors.background.ignoresSafeArea()
-        }
-    }
-}
+struct AppBackground: View {
+    var useOpacity: Bool = false
+    var body: some View {
+        if #available(iOS 15.0, *) {
+            (useOpacity ? AppTheme.Colors.backgroundWithOpacity : AppTheme.Colors.adaptiveBackground)
+                .ignoresSafeArea()
+        } else {
+            (useOpacity ? AppTheme.Colors.backgroundWithOpacity : AppTheme.Colors.background)
+                .ignoresSafeArea()
+        }
+    }
+}
*** End Patch
```

- PrimaryButton.swift（Add: 新規）
```diff
*** Begin Patch
*** Add File: aniccaios/aniccaios/DesignSystem/Components/PrimaryButton.swift
+import SwiftUI
+import UIKit
+
+struct PrimaryButton: View {
+    let title: String
+    var icon: String? = nil
+    var isEnabled: Bool = true
+    var isLoading: Bool = false
+    var style: ButtonStyle = .primary
+    let action: () -> Void
+
+    enum ButtonStyle { case primary, selected, unselected, large }
+
+    var body: some View {
+        Button {
+            guard isEnabled, !isLoading else { return }
+            UIImpactFeedbackGenerator(style: .medium).impactOccurred()
+            action()
+        } label: {
+            HStack(spacing: 8) {
+                if isLoading { ProgressView().progressViewStyle(.circular) }
+                else if let icon { Image(systemName: icon) }
+                Text(title).font(.headline).lineLimit(1)
+            }
+            .frame(maxWidth: .infinity)
+            .padding(.vertical, 16)
+        }
+        .foregroundStyle(foregroundColor)
+        .background(RoundedRectangle(cornerRadius: cornerRadius, style: .continuous).fill(backgroundColor))
+        .overlay(RoundedRectangle(cornerRadius: cornerRadius, style: .continuous).stroke(borderColor, lineWidth: borderWidth))
+        .opacity(isEnabled ? 1 : 0.6)
+        .disabled(!isEnabled || isLoading)
+    }
+
+    private var backgroundColor: Color { switch style {
+        case .primary, .large: return AppTheme.Colors.accent
+        case .selected: return AppTheme.Colors.buttonSelected
+        case .unselected: return AppTheme.Colors.buttonUnselected } }
+    private var foregroundColor: Color { switch style {
+        case .primary, .large: return .white
+        case .selected: return AppTheme.Colors.buttonTextSelected
+        case .unselected: return AppTheme.Colors.buttonTextUnselected } }
+    private var cornerRadius: CGFloat { switch style {
+        case .primary: return AppTheme.Radius.lg
+        case .selected, .unselected: return AppTheme.Radius.xl
+        case .large: return AppTheme.Radius.xxl } }
+    private var borderColor: Color { switch style {
+        case .primary, .large: return .clear
+        case .selected: return AppTheme.Colors.border
+        case .unselected: return AppTheme.Colors.borderLight } }
+    private var borderWidth: CGFloat { switch style {
+        case .primary, .large: return 0
+        case .selected, .unselected: return 4 } }
+}
*** End Patch
```

- CardView.swift（Add: 新規）
```diff
*** Begin Patch
*** Add File: aniccaios/aniccaios/DesignSystem/Components/CardView.swift
+import SwiftUI
+
+struct CardView<Content: View>: View {
+    let content: Content
+    var cornerRadius: CGFloat = AppTheme.Radius.card
+    var backgroundColor: Color? = nil
+    init(cornerRadius: CGFloat = AppTheme.Radius.card, backgroundColor: Color? = nil, @ViewBuilder content: () -> Content) {
+        self.cornerRadius = cornerRadius
+        self.backgroundColor = backgroundColor
+        self.content = content()
+    }
+    var body: some View {
+        content
+            .padding(AppTheme.Spacing.lg)
+            .background(RoundedRectangle(cornerRadius: cornerRadius, style: .continuous).fill(backgroundColor ?? AppTheme.Colors.cardBackground))
+            .shadow(color: .black.opacity(0.05), radius: 8, x: 0, y: 2)
+    }
+    static func large(@ViewBuilder content: () -> Content) -> CardView { CardView(cornerRadius: AppTheme.Radius.cardLarge, content: content) }
+    static func xLarge(@ViewBuilder content: () -> Content) -> CardView { CardView(cornerRadius: AppTheme.Radius.cardXLarge, content: content) }
+}
*** End Patch
```


---

### 2) fix2.md — DesignSystem 残り（DayOfWeekPickerはUpdate）

- DayOfWeekPicker.swift（Update: サイズ48へ、既存に合わせ最小差分）
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/DesignSystem/Components/DayOfWeekPicker.swift
@@
-// Mobbinデザイン: 曜日選択UIコンポーネント（円形145×145px、4pxボーダー）
+// Mobbinデザイン: 曜日選択UIコンポーネント（円形48×48px、4pxボーダー）
@@
-                .frame(width: 145, height: 145)  // Mobbin: 145×145px
+                .frame(width: 48, height: 48)    // Mobbin: 48×48px
*** End Patch
```

- GradientIcon.swift / SectionRow.swift / CustomTabBar.swift（Add: 新規、原案そのまま）
```diff
*** Begin Patch
*** Add File: aniccaios/aniccaios/DesignSystem/Components/GradientIcon.swift
+// ...（fix2.mdの原案どおり）
*** End Patch
```
```diff
*** Begin Patch
*** Add File: aniccaios/aniccaios/DesignSystem/Components/SectionRow.swift
+// ...（fix2.mdの原案どおり）
*** End Patch
```
```diff
*** Begin Patch
*** Add File: aniccaios/aniccaios/DesignSystem/Components/CustomTabBar.swift
+// ...（fix2.mdの原案どおり）
*** End Patch
```


---

### 3) fix3.md — ルート/全体UI（Updateのみ）

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/aniccaiosApp.swift
@@
-            ContentRouterView()
-                .environmentObject(appState)
+            ContentRouterView()
+                .environmentObject(appState)
+                .tint(AppTheme.Colors.accent)
*** End Patch
```
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/ContentView.swift
@@
 struct AuthenticationProcessingView: View {
@@
-        .frame(maxWidth: .infinity, maxHeight: .infinity)
+        .frame(maxWidth: .infinity, maxHeight: .infinity)
+        .background(AppBackground())
 }
*** End Patch
```
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Session/AuthRequiredPlaceholderView.swift
@@
-        .frame(maxWidth: .infinity, maxHeight: .infinity)
+        .frame(maxWidth: .infinity, maxHeight: .infinity)
+        .background(AppBackground())
*** End Patch
```
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/MainTabView.swift
@@
-        TabView(selection: $appState.selectedRootTab) {
+        TabView(selection: $appState.selectedRootTab) {
@@
-        }
+        }
+        .background(AppBackground())
*** End Patch
```

---

### 4) fix4.md — SessionView（最小変更でUI刷新）

- 既存のロジック/状態を保持しつつ、タイポグラフィ・背景・ボタンのみ刷新します。
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/SessionView.swift
@@
-            VStack(spacing: 24) {
-                Text("Anicca")
-                    .font(.system(size: 32, weight: .bold))
+            VStack(spacing: AppTheme.Spacing.xl) {
+                Text("Anicca")
+                    .font(AppTheme.Typography.appTitle)
+                    .fontWeight(.heavy)
+                    .foregroundStyle(AppTheme.Colors.label)
@@
-                if shouldShowWakeSilentNotice {
-                    Text(String(localized: "session_wake_silent_notice"))
-                        .multilineTextAlignment(.center)
-                        .font(.subheadline)
-                        .foregroundStyle(.secondary)
-                        .padding(16)
-                        .frame(maxWidth: .infinity)
-                        .background(
-                            RoundedRectangle(cornerRadius: 16, style: .continuous)
-                                .fill(.thinMaterial)
-                        )
-                }
+                if shouldShowWakeSilentNotice {
+                    Text(String(localized: "session_wake_silent_notice"))
+                        .multilineTextAlignment(.center)
+                        .font(AppTheme.Typography.subheadlineDynamic)
+                        .foregroundStyle(AppTheme.Colors.secondaryLabel)
+                        .padding(AppTheme.Spacing.lg)
+                        .frame(maxWidth: .infinity)
+                        .background(
+                            RoundedRectangle(cornerRadius: AppTheme.Radius.card, style: .continuous)
+                                .fill(AppTheme.Colors.cardBackground)
+                                .shadow(color: .black.opacity(0.05), radius: 8, x: 0, y: 2)
+                        )
+                }
@@
-            }
-            .padding()
+            }
+            .padding()
+            .background(AppBackground())
@@
-    private var sessionButton: some View {
-        let config = buttonConfig
-        return Button(config.title) {
-            config.action()
-        }
-        .buttonStyle(BorderedProminentButtonStyle())
-        .controlSize(.large)
-        .disabled(config.disabled)
-    }
+    private var sessionButton: some View {
+        let config = buttonConfig
+        let status = controller.connectionStatus
+        let icon: String? = (status == .connecting) ? "hourglass" : (status == .connected ? "stop.fill" : "mic.fill")
+        return PrimaryButton(
+            title: config.title,
+            icon: icon,
+            isEnabled: !config.disabled,
+            isLoading: status == .connecting,
+            style: .large,
+            action: config.action
+        )
+    }
*** End Patch
```


---

## 適用順序

1) fix1.md（Update＋Add）

2) fix2.md（DayOfWeekPickerはUpdate、他Add）

3) fix3.md（Updateのみ）

4) fix4.md（SessionView最小変更Update）

---

## リスク・検証

- iOS 16最小: `.foregroundStyle`/`.tint`/`NavigationStack`は対応済み（互換モードは現状維持）。
- Xcodeのファイル追加は自動取り込み（FileSystemSynchronizedRootGroup）。
- ビルド後、以下を目視確認:
  - 背景色（全画面で `AppBackground`）
  - タイトルと通知カードのタイポ・色
  - `PrimaryButton`の状態（接続/接続中/切断）
  - `DayOfWeekPicker`のサイズ 48×48

### To-dos

- [ ] fix1.md をUpdate＋Addに修正（AppTheme/AppBackground更新、PrimaryButton/CardView追加）
- [ ] fix2.md を修正（DayOfWeekPickerをUpdateに、その他はAdd）
- [ ] fix3.md を修正（tintとAppBackgroundの反映）
- [ ] fix4.md を修正（SessionViewを最小変更でUI刷新）