<!-- 7b63ac73-bcd9-4d91-b159-cad2524b09fa 160a22f2-6604-4f9f-b007-e3489588a16c -->
# AniccaScreenTimeReport をビルド可能にし、Screen Time 集計を安定表示する

## 背景（なぜ今のエラーが出るか）

- `AniccaScreenTimeReport/Info.plist` は **Device Activity Report Extension** の拡張ポイント `com.apple.deviceactivityui.report-extension` を指定している（DeviceActivityの公式説明にも同一identifierが出てくる）  
  - 参考: [DeviceActivityReport](https://developer.apple.com/documentation/deviceactivity/deviceactivityreport/) / [DeviceActivityReportExtension](https://developer.apple.com/documentation/deviceactivity/deviceactivityreportextension/) / [DeviceActivityReportScene](https://developer.apple.com/documentation/deviceactivity/deviceactivityreportscene/)
- 一方 `project.pbxproj` には `AniccaScreenTimeReport.appex` が **`wrapper.extensionkit-extension`** として定義されており、コンパイラは entrypoint を `AppExtension`（= ExtensionKit/ExtensionFoundation系）として解釈する。
  - このため `@main` 生成が `ExtensionKit` に依存し、未importだと `main()` が見つからない。
  - さらに `DeviceActivityReportExtension : AppExtension` のため、最新SDKでは `AppExtension` 要件（`extensionPoint` など）も満たす必要がある。

## 修正方針（コード側）

- `AniccaScreenTimeReport/ScreenTimeReportExtension.swift` に **`ExtensionKit` / `ExtensionFoundation` / `ManagedSettings`** の import を追加。
- `AppExtension` 要件の `extensionPoint: AppExtensionPoint` を **iOS 26.2+ の availability 付きで実装**し、identifierは Appleが明示している `com.apple.deviceactivityui.report-extension` を使用。
  - `AppExtensionPoint` は iOS 26+ API だが、availability を付ければ iOS 16.6 deployment でもビルド可能。
  - 参考: [AppExtension](https://developer.apple.com/documentation/extensionfoundation/appextension/) / [AppExtensionScene](https://developer.apple.com/documentation/extensionkit/appextensionscene/) / [AppExtensionPoint.init(identifier:)](https://developer.apple.com/documentation/extensionfoundation/appextensionpoint/init\\(identifier:))
- Swift 6 strict concurrency の「MainActor隔離の適合が nonisolated 文脈で使われる」系は、Appleが `@preconcurrency` を付けている領域（`AppExtensionScene` 等）と整合するよう、`DeviceActivity` import を `@preconcurrency import DeviceActivity` にする（= Swift 6言語モードでの硬いエラーを回避）。

## 提示パッチ（チャット用 diff）

```diff
diff --git a/aniccaios/AniccaScreenTimeReport/ScreenTimeReportExtension.swift b/aniccaios/AniccaScreenTimeReport/ScreenTimeReportExtension.swift
index 0000000..0000000 100644
--- a/aniccaios/AniccaScreenTimeReport/ScreenTimeReportExtension.swift
+++ b/aniccaios/AniccaScreenTimeReport/ScreenTimeReportExtension.swift
@@
-import DeviceActivity
+@preconcurrency import DeviceActivity
 import SwiftUI
 import os.log
+import ExtensionKit
+import ExtensionFoundation
+import ManagedSettings
@@
 @main
 struct AniccaScreenTimeReportExtension: DeviceActivityReportExtension {
+    // Xcode 26 / iOS 26 SDK では DeviceActivityReportExtension が AppExtension を継承するため
+    // AppExtension 要件（extensionPoint）を満たす必要がある。
+    // iOS 16–25 ではこのAPI自体が unavailable なので、runtime では参照されない。
+    @MainActor
+    @available(iOS 26.2, *)
+    var extensionPoint: AppExtensionPoint {
+        do {
+            // DeviceActivityReport のドキュメントに明記されている extension point identifier
+            return try AppExtensionPoint(identifier: "com.apple.deviceactivityui.report-extension")
+        } catch {
+            fatalError("Failed to create AppExtensionPoint: \(error)")
+        }
+    }
+
     var body: some DeviceActivityReportScene {
         TotalActivityReport { activityReport in
             TotalActivityView(report: activityReport)
         }
     }
 }
@@
-@MainActor
 struct TotalActivityReport: DeviceActivityReportScene {
     let context: DeviceActivityReport.Context = .totalActivity
     let content: (ActivityReport) -> TotalActivityView
@@
-                        let bundleId = app.application.bundleIdentifier ?? ""
+                        let bundleId = app.application.bundleIdentifier ?? ""
```

## 修正方針（配布/署名側：Family Controls (Distribution)）

- いま出ている警告
  - 「Bundle identifier is using development only version of Family Controls (Development)… Family Controls (Distribution) を request して」
  - これは **コードではなく Apple Developer 側の権限/entitlement 承認の問題**。
- Apple公式に「配布には distribution 用 entitlement の許可申請が必要」と明記されている。
  - 参考: [Configuring Family Controls](https://developer.apple.com/documentation/xcode/configuring-family-controls/)（“To distribute your app, you need an entitlement that enables distribution…” の段）
- Xcode 15+ の managed capabilities 運用としては、権限承認→Signing & Capabilities で有効化→プロビジョニングプロファイルに entitlements が自動取り込み、という流れ。
  - 参考: [Provisioning with capabilities (managed capabilities)](https://developer.apple.com/help/account/reference/provisioning-with-managed-capabilities)

## 実装後に確認する観点（機能面）

- `BehaviorView` は `DeviceActivityReport(.init(rawValue: "TotalActivity"), ...)` を極小表示して extension 実行をトリガーしている（iOS 16.6+で動く想定）。
- extension は App Groups `group.ai.anicca.app.ios` に `screenTime_totalMinutes_YYYY-MM-DD` 等を書き、`ScreenTimeManager.fetchDailySummary()` がそれを読む。

## 実装 Todo

- **patch-screentime-extension**: `AniccaScreenTimeReport/ScreenTimeReportExtension.swift` に上記 diff を適用し、ExtensionKit/AppExtension 要件と import 問題を解消する
- **docs-family-controls-distribution**: Family Controls (Distribution) の申請（App本体 + `AniccaScreenTimeReport`）と、managed capabilities のプロビジョニング更新手順をチーム手順として整理する

### To-dos

- [ ] `/Users/cbns03/Downloads/anicca-project/aniccaios/AniccaScreenTimeReport/ScreenTimeReportExtension.swift` に ExtensionKit/ExtensionFoundation/ManagedSettings import と `extensionPoint` 実装、`@preconcurrency import DeviceActivity` を加える（上記diff）。
- [ ] Family Controls (Development) 警告に対し、App本体と `AniccaScreenTimeReport` の両方で Family Controls (Distribution) を Apple に申請し、Xcode 15+ managed capabilities でプロビジョニング更新する手順を確定する。