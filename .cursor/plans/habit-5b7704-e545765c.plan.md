<!-- e545765c-d69e-4784-893e-f0f13737737e a80904da-f277-43d8-9bf5-414e75d5e5b5 -->
# ç¿’æ…£ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®æ—¥ä»˜ãƒªã‚»ãƒƒãƒˆä¿®æ­£

## å•é¡Œ

æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã‚‚ViewãŒå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œãªã„ãŸã‚ã€ç¿’æ…£ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ãŒå¤ã„ã¾ã¾è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

## ä¿®æ­£å†…å®¹

### 1. AppState.swift - ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒªã‚¬ãƒ¼è¿½åŠ 

- `@Published private(set) var dailyRefreshTrigger: UUID` ã‚’è¿½åŠ 
- `func triggerDailyRefresh()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 

### 2. AppState.swift - ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 

- `#if DEBUG` å†…ã« `simulateDayChange(habitId:daysAgo:)` ã‚’è¿½åŠ 
- æŒ‡å®šã—ãŸç¿’æ…£ã®lastCompletedDateã‚’éå»ã«è¨­å®šã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½ã«

### 3. HabitsSectionView.swift - scenePhaseç›£è¦–è¿½åŠ 

- `@Environment(\.scenePhase)` ã‚’è¿½åŠ 
- `.onChange(of: scenePhase)` ã§ `.active` æ™‚ã« `triggerDailyRefresh()` å‘¼ã³å‡ºã—
- `habitRow` ã¨ `customHabitRow` ã§ `dailyRefreshTrigger` ã‚’å‚ç…§

### 4. SettingsView.swift - ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³è¿½åŠ 

- `#if DEBUG` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã€Œæ—¥ä»˜å¤‰æ›´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

## å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- [aniccaios/aniccaios/AppState.swift](aniccaios/aniccaios/AppState.swift)
- [aniccaios/aniccaios/Habits/HabitsSectionView.swift](aniccaios/aniccaios/Habits/HabitsSectionView.swift)
- [aniccaios/aniccaios/SettingsView.swift](aniccaios/aniccaios/SettingsView.swift)

## å®Œå…¨ãªä¿®æ­£ãƒ‘ãƒƒãƒ

---

### 1. AppState.swift

**å ´æ‰€: 54è¡Œç›®ä»˜è¿‘ï¼ˆ`habitStreaks`ã®å®£è¨€ã®å¾Œï¼‰ã«è¿½åŠ **

```swift
// æ—¥ä»˜å¤‰æ›´æ™‚ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ç”¨ï¼ˆViewã®å¼·åˆ¶å†æç”»ãƒˆãƒªã‚¬ãƒ¼ï¼‰
@Published private(set) var dailyRefreshTrigger: UUID = UUID()

/// ã‚¢ãƒ—ãƒªãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ãŸæ™‚ã«å‘¼ã³å‡ºã—ã€ç¿’æ…£ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’å†è©•ä¾¡ã•ã›ã‚‹
func triggerDailyRefresh() {
    updateStreaksIfNeeded()  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®ãƒªã‚»ãƒƒãƒˆåˆ¤å®šã‚’å®Ÿè¡Œ
    dailyRefreshTrigger = UUID()  // Viewã®å†æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼
}
```

**å ´æ‰€: 446è¡Œç›®ä»˜è¿‘ï¼ˆæ—¢å­˜ã®`#if DEBUG`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€`setStreakForRecording`ã®å¾Œï¼‰ã«è¿½åŠ **

```swift
/// ãƒ‡ãƒãƒƒã‚°ç”¨: æŒ‡å®šã—ãŸç¿’æ…£ã®lastCompletedDateã‚’éå»ã«è¨­å®šã—ã¦æ—¥ä»˜å¤‰æ›´ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
func simulateDayChange(habitId: String, daysAgo: Int) {
    guard var data = habitStreaks[habitId] else {
        print("[DEBUG] habitStreaks[\(habitId)] not found")
        return
    }
    let pastDate = Calendar.current.date(byAdding: .day, value: -daysAgo, to: Date())!
    data.lastCompletedDate = Calendar.current.startOfDay(for: pastDate)
    habitStreaks[habitId] = data
    saveHabitStreaks()
    print("[DEBUG] Set \(habitId) lastCompletedDate to \(daysAgo) days ago")
    triggerDailyRefresh()
}

/// ãƒ‡ãƒãƒƒã‚°ç”¨: å…¨ç¿’æ…£ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯çŠ¶æ…‹ã‚’è¡¨ç¤º
func printStreakDebugInfo() {
    print("[DEBUG] === Habit Streaks ===")
    for (habitId, data) in habitStreaks {
        let dateStr = data.lastCompletedDate?.formatted() ?? "nil"
        let isToday = data.lastCompletedDate.map { Calendar.current.isDateInToday($0) } ?? false
        print("[DEBUG] \(habitId): streak=\(data.currentStreak), lastCompleted=\(dateStr), isToday=\(isToday)")
    }
    print("[DEBUG] =======================")
}
```

---

### 2. HabitsSectionView.swift

**å ´æ‰€: 32è¡Œç›®ä»˜è¿‘ï¼ˆ`@State`å¤‰æ•°ã®å®£è¨€ã®å¾Œï¼‰ã«è¿½åŠ **

```swift
@Environment(\.scenePhase) private var scenePhase
```

**å ´æ‰€: 280è¡Œç›®ä»˜è¿‘ï¼ˆ`.overlay { ... }`ã®å¾Œã€`body`ã®é–‰ã˜æ‹¬å¼§ã®ç›´å‰ï¼‰ã«è¿½åŠ **

```swift
.onChange(of: scenePhase) { newPhase in
    if newPhase == .active {
        // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ãŸæ™‚ã«å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
        appState.triggerDailyRefresh()
    }
}
```

**å ´æ‰€: 354è¡Œç›®ä»˜è¿‘ï¼ˆ`habitRow`é–¢æ•°å†…ã€`let isCompleted`ã®è¡Œã®å‰ï¼‰ã«è¿½åŠ **

```swift
// dailyRefreshTriggerã‚’å‚ç…§ã—ã¦æ—¥ä»˜å¤‰æ›´æ™‚ã®å†æç”»ã‚’ä¿è¨¼
let _ = appState.dailyRefreshTrigger
```

**å ´æ‰€: 461è¡Œç›®ä»˜è¿‘ï¼ˆ`customHabitRow`é–¢æ•°å†…ã€`let isCompleted`ã®è¡Œã®å‰ï¼‰ã«è¿½åŠ **

```swift
// dailyRefreshTriggerã‚’å‚ç…§ã—ã¦æ—¥ä»˜å¤‰æ›´æ™‚ã®å†æç”»ã‚’ä¿è¨¼
let _ = appState.dailyRefreshTrigger
```

---

### 3. SettingsView.swift

**å ´æ‰€: æ—¢å­˜ã®`#if DEBUG`ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã«è¿½åŠ ï¼ˆãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼‰**

```swift
#if DEBUG
Section("ãƒ‡ãƒãƒƒã‚°") {
    Button("1æ—¥å‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶­æŒï¼‰") {
        // å…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç¿’æ…£ã®lastCompletedDateã‚’1æ—¥å‰ã«è¨­å®š
        for habit in [HabitType.wake, .training, .bedtime] {
            appState.simulateDayChange(habitId: habit.rawValue, daysAgo: 1)
        }
        for customHabit in appState.customHabits {
            appState.simulateDayChange(habitId: customHabit.id.uuidString, daysAgo: 1)
        }
    }
    
    Button("2æ—¥å‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆã‚¹ãƒˆãƒªãƒ¼ã‚¯0ã«ãƒªã‚»ãƒƒãƒˆï¼‰") {
        // å…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç¿’æ…£ã®lastCompletedDateã‚’2æ—¥å‰ã«è¨­å®š
        for habit in [HabitType.wake, .training, .bedtime] {
            appState.simulateDayChange(habitId: habit.rawValue, daysAgo: 2)
        }
        for customHabit in appState.customHabits {
            appState.simulateDayChange(habitId: customHabit.id.uuidString, daysAgo: 2)
        }
    }
    
    Button("ã‚¹ãƒˆãƒªãƒ¼ã‚¯çŠ¶æ…‹ã‚’ãƒ­ã‚°å‡ºåŠ›") {
        appState.printStreakDebugInfo()
    }
}
#endif
```

---

## ä¿®æ­£å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“

### ä¿®æ­£å‰ã®å•é¡Œ

```
Day 1 (æœˆæ›œæ—¥ 23:00):
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œèµ·åºŠã€ã‚’ãƒã‚§ãƒƒã‚¯ âœ“
â”œâ”€ ã‚¹ãƒˆãƒªãƒ¼ã‚¯: 10 â†’ 11
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·11

Day 2 (ç«æ›œæ—¥ 08:00):
â”œâ”€ ã‚¢ãƒ—ãƒªã‚’é–‹ã
â”œâ”€ æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŒã€ViewãŒå†æç”»ã•ã‚Œãªã„
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·11  â† å•é¡Œï¼ãƒã‚§ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹

Day 2 (ç«æ›œæ—¥ 23:00):
â”œâ”€ ä»Šæ—¥ã¯ä½•ã‚‚ã—ãªã‹ã£ãŸ
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·11  â† ã¾ã ãƒã‚§ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ã‚‹

Day 3 (æ°´æ›œæ—¥ 08:00):
â”œâ”€ ã‚¢ãƒ—ãƒªã‚’é–‹ã
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·11  â† ã¾ã ï¼
```

### ä¿®æ­£å¾Œã®æ­£ã—ã„å‹•ä½œ

```
Day 1 (æœˆæ›œæ—¥ 23:00):
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œèµ·åºŠã€ã‚’ãƒã‚§ãƒƒã‚¯ âœ“
â”œâ”€ ã‚¹ãƒˆãƒªãƒ¼ã‚¯: 10 â†’ 11
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·11

Day 2 (ç«æ›œæ—¥ 08:00):
â”œâ”€ ã‚¢ãƒ—ãƒªã‚’é–‹ãï¼ˆãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°ï¼‰
â”œâ”€ triggerDailyRefresh() ãŒå‘¼ã°ã‚Œã‚‹
â”œâ”€ isDailyCompleted() ãŒå†è©•ä¾¡ã•ã‚Œã‚‹ â†’ false
â”œâ”€ ã‚¹ãƒˆãƒªãƒ¼ã‚¯: 11ï¼ˆã¾ã ä»Šæ—¥ãƒã‚§ãƒƒã‚¯ã™ã‚Œã°ç¶™ç¶šå¯èƒ½ï¼‰
â””â”€ è¡¨ç¤º: [â—‹] èµ·åºŠ  ğŸª·11  â† æ­£ã—ã„ï¼ãƒã‚§ãƒƒã‚¯ãŒãƒªã‚»ãƒƒãƒˆ

Day 2 (ç«æ›œæ—¥) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã—ãŸå ´åˆ:
â”œâ”€ ãƒã‚§ãƒƒã‚¯ã‚’ã‚¿ãƒƒãƒ—
â”œâ”€ ã‚¹ãƒˆãƒªãƒ¼ã‚¯: 11 â†’ 12
â””â”€ è¡¨ç¤º: [âœ“] èµ·åºŠ  ğŸª·12

Day 2 (ç«æ›œæ—¥) ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‚‚ã—ãªã‹ã£ãŸå ´åˆ:
â””â”€ è¡¨ç¤º: [â—‹] èµ·åºŠ  ğŸª·11ï¼ˆä»Šæ—¥ä¸­ã¯ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶­æŒï¼‰

Day 3 (æ°´æ›œæ—¥ 08:00) æ˜¨æ—¥ä½•ã‚‚ã—ãªã‹ã£ãŸå ´åˆ:
â”œâ”€ ã‚¢ãƒ—ãƒªã‚’é–‹ã
â”œâ”€ triggerDailyRefresh() â†’ updateStreaksIfNeeded()
â”œâ”€ lastCompletedDate = ä¸€æ˜¨æ—¥ â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒªã‚»ãƒƒãƒˆ
â””â”€ è¡¨ç¤º: [â—‹] èµ·åºŠ  ğŸª·0  â† æ­£ã—ããƒªã‚»ãƒƒãƒˆï¼
```

---

## ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®ä½¿ã„æ–¹

è¨­å®šç”»é¢ã®ã€Œãƒ‡ãƒãƒƒã‚°ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ï¼š

| ãƒœã‚¿ãƒ³ | å‹•ä½œ | çµæœ |
|--------|------|------|
| 1æ—¥å‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ | lastCompletedDateã‚’æ˜¨æ—¥ã«è¨­å®š | ãƒã‚§ãƒƒã‚¯ãŒãƒªã‚»ãƒƒãƒˆã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶­æŒ |
| 2æ—¥å‰ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ | lastCompletedDateã‚’ä¸€æ˜¨æ—¥ã«è¨­å®š | ãƒã‚§ãƒƒã‚¯ãŒãƒªã‚»ãƒƒãƒˆã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯0 |
| ã‚¹ãƒˆãƒªãƒ¼ã‚¯çŠ¶æ…‹ã‚’ãƒ­ã‚°å‡ºåŠ› | Xcodeã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ç¤º | ãƒ‡ãƒãƒƒã‚°ç¢ºèªç”¨ |

ã“ã‚Œã§0æ™‚ã¾ã§å¾…ãŸãšã«å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚

### To-dos

- [ ] AppStateã«dailyRefreshTriggerã¨triggerDailyRefresh()ã‚’è¿½åŠ 
- [ ] AppStateã«simulateDayChange()ãƒ‡ãƒãƒƒã‚°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
- [ ] HabitsSectionViewã«scenePhaseç›£è¦–ã¨å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è¿½åŠ 
- [ ] SettingsViewã«ãƒ‡ãƒãƒƒã‚°ç”¨æ—¥ä»˜å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 