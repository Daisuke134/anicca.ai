<!-- f1100577-0fa4-4d1d-a63e-fdb54ddb0314 d9c5ca9d-2326-46d1-9c7e-aaf1750830dd -->
# iOSリリース前の4つのバグ修正

## 問題1: Delete Accountでtokensテーブルが存在しないエラー

**問題**: `/apps/api/src/routes/mobile/account.js`の47行目で`DELETE FROM tokens`を実行しようとしているが、このテーブルが存在しない場合にエラーが発生する。

**修正方針**: `tokens`テーブルの削除をtry-catchで囲み、テーブルが存在しない場合はエラーを無視して処理を続行する

**修正ファイル**: `apps/api/src/routes/mobile/account.js`

### 疑似パッチ1

```diff
--- a/apps/api/src/routes/mobile/account.js
+++ b/apps/api/src/routes/mobile/account.js
@@ -44,7 +44,15 @@ router.delete('/', async (req, res, next) => {
       await client.query('DELETE FROM usage_sessions WHERE user_id = $1', [userId]);
       await client.query('DELETE FROM mobile_profiles WHERE user_id = $1', [userId]);
       await client.query('DELETE FROM mobile_voip_tokens WHERE user_id = $1', [userId]);
-      await client.query('DELETE FROM tokens WHERE user_id = $1', [userId]);
+      // tokensテーブルは存在しない場合があるため、エラーハンドリングを追加
+      try {
+        await client.query('DELETE FROM tokens WHERE user_id = $1', [userId]);
+      } catch (tokenError) {
+        // tokensテーブルが存在しない場合はエラーを無視して処理を続行
+        if (tokenError.code !== '42P01') { // 42P01は「relation does not exist」エラー
+          throw tokenError; // その他のエラーは再スロー
+        }
+        console.warn(`[Account Deletion] tokens table does not exist for user ${userId}, skipping deletion`);
+      }
       
       // profilesテーブルの削除: userIdがUUID形式かどうかを確認
```

## 問題2: オンボーディング画面で習慣が時系列順にソートされない

**問題**: `HabitSetupStepView.swift`の`sortedAllHabits`は既に時系列順にソートしているが、デフォルト習慣とカスタム習慣が分離されてソートされている可能性がある。

**修正方針**: デフォルト習慣とカスタム習慣を統合し、時刻でソート。時刻未設定の習慣は最後に配置

**修正ファイル**: `aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift`

### 疑似パッチ2

```diff
--- a/aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift
+++ b/aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift
@@ -18,24 +18,30 @@ struct HabitSetupStepView: View {
     // 時系列順にソートされた全習慣（デフォルト習慣とカスタム習慣を統合）
     private var sortedAllHabits: [(id: String, name: String, time: Date?, isCustom: Bool, customId: UUID?)] {
         var allHabits: [(id: String, name: String, time: Date?, isCustom: Bool, customId: UUID?)] = []
         
         // デフォルト習慣を追加
         for habit in [HabitType.wake, .training, .bedtime] {
             let time = habitTimes[habit] ?? Calendar.current.date(from: habit.defaultTime)
             allHabits.append((
                 id: habit.rawValue,
                 name: habit.title,
                 time: time,
                 isCustom: false,
                 customId: nil
             ))
         }
         
         // カスタム習慣を追加
         for customHabit in appState.customHabits {
-            let time = customHabitTimes[customHabit.id]
+            if let time = customHabitTimes[customHabit.id] {
+                allHabits.append((
+                    id: customHabit.id.uuidString,
+                    name: customHabit.name,
+                    time: time,
+                    isCustom: true,
+                    customId: customHabit.id
+                ))
+            }
+        }
+        
+        // 時系列順にソート（時刻が早い順）
+        // 時刻が設定されている習慣を時系列順にソートし、時刻未設定の習慣は最後に配置
+        let habitsWithTime = allHabits.filter { $0.time != nil }
+        let habitsWithoutTime = allHabits.filter { $0.time == nil }
+        
+        let sortedWithTime = habitsWithTime.sorted { item1, item2 in
+            guard let time1 = item1.time, let time2 = item2.time else {
+                return false
+            }
+            return time1 < time2
+        }
+        
+        return sortedWithTime + habitsWithoutTime
+    }
+    
+    // 時系列順にソート（時刻が早い順）
+    private var sortedAllHabits: [(id: String, name: String, time: Date?, isCustom: Bool, customId: UUID?)] {
+        var allHabits: [(id: String, name: String, time: Date?, isCustom: Bool, customId: UUID?)] = []
+        
+        // デフォルト習慣を追加
+        for habit in [HabitType.wake, .training, .bedtime] {
+            let time = habitTimes[habit] ?? Calendar.current.date(from: habit.defaultTime)
             allHabits.append((
-                id: customHabit.id.uuidString,
-                name: customHabit.name,
-                time: time,
-                isCustom: true,
-                customId: customHabit.id
-            ))
-        }
-        
-        // 時系列順にソート（時刻が早い順）
-        return allHabits.sorted { item1, item2 in
-            guard let time1 = item1.time, let time2 = item2.time else {
-                // 時刻未設定のものは最後に
-                return item1.time != nil
-            }
-            return time1 < time2
+                id: habit.rawValue,
+                name: habit.title,
+                time: time,
+                isCustom: false,
+                customId: nil
+            ))
+        }
+        
+        // カスタム習慣を追加（時刻設定済みのみ）
+        for customHabit in appState.customHabits {
+            if let time = customHabitTimes[customHabit.id] {
+                allHabits.append((
+                    id: customHabit.id.uuidString,
+                    name: customHabit.name,
+                    time: time,
+                    isCustom: true,
+                    customId: customHabit.id
+                ))
+            }
+        }
+        
+        // 時系列順にソート（時刻が早い順）
+        // 時刻が設定されている習慣を時系列順にソートし、時刻未設定の習慣は最後に配置
+        let habitsWithTime = allHabits.filter { $0.time != nil }
+        let habitsWithoutTime = allHabits.filter { $0.time == nil }
+        
+        let sortedWithTime = habitsWithTime.sorted { item1, item2 in
+            guard let time1 = item1.time, let time2 = item2.time else {
+                return false
+            }
+            return time1 < time2
+        }
+        
+        return sortedWithTime + habitsWithoutTime
         }
     }
```

## 問題3: Habits画面でトグルをタップすると習慣が消える

**問題**: `HabitsSectionView.swift`の223-236行目で、トグルをOFFにすると`activeHabits.remove(habit)`と`habitTimes.removeValue(forKey: habit)`が実行され、習慣がリストから消えてしまう。

**修正方針**: トグルをOFFにしても習慣は削除せず、非アクティブ状態として保持。`habitTimes`や`AppState`からは削除しない

**修正ファイル**: `aniccaios/aniccaios/Habits/HabitsSectionView.swift`

### 疑似パッチ3

```diff
--- a/aniccaios/aniccaios/Habits/HabitsSectionView.swift
+++ b/aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@ -223,16 +223,20 @@ struct HabitsSectionView: View {
             Toggle("", isOn: Binding(
                 get: { isActive },
                 set: { isOn in
                     if isOn {
                         activeHabits.insert(habit)
                         if let date = date {
                             habitTimes[habit] = date
                         }
                     } else {
-                        activeHabits.remove(habit)
-                        habitTimes.removeValue(forKey: habit)
+                        // トグルをOFFにしても習慣は削除しない（非アクティブ状態として保持）
+                        activeHabits.remove(habit)
+                        // habitTimesからは削除しない（時刻情報は保持）
+                        // AppStateからも削除しない（スワイプ削除のみで削除可能）
                     }
                 }
             ))
             .labelsHidden()
         }
@@ -279,7 +283,11 @@ struct HabitsSectionView: View {
                     } else {
-                        activeCustomHabits.remove(id)
-                        customHabitTimes.removeValue(forKey: id)
+                        // トグルをOFFにしても習慣は削除しない（非アクティブ状態として保持）
+                        activeCustomHabits.remove(id)
+                        // customHabitTimesからは削除しない（時刻情報は保持）
+                        // AppStateからも削除しない（スワイプ削除のみで削除可能）
                     }
                 }
             ))
             .labelsHidden()
         }
```

さらに、`sortedAllHabits`を修正して、`AppState`からも時刻を取得するようにします：

```diff
--- a/aniccaios/aniccaios/Habits/HabitsSectionView.swift
+++ b/aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@ -36,7 +36,7 @@ struct HabitsSectionView: View {
         // デフォルト習慣を追加（時刻設定済み）
         for habit in [HabitType.wake, .training, .bedtime] {
-            if let date = habitTimes[habit] {
+            // AppStateから時刻を取得（habitTimesにない場合も含む）
+            if let components = appState.habitSchedules[habit],
+               let date = Calendar.current.date(from: components) {
                 let components = Calendar.current.dateComponents([.hour, .minute], from: date)
                 allHabits.append((
                     id: habit.rawValue,
                     habit: habit,
                     customId: nil,
                     name: habit.title,
                     time: components,
                     isActive: activeHabits.contains(habit)
                 ))
+            } else if let date = habitTimes[habit] {
+                // habitTimesから取得（フォールバック）
+                let components = Calendar.current.dateComponents([.hour, .minute], from: date)
+                allHabits.append((
+                    id: habit.rawValue,
+                    habit: habit,
+                    customId: nil,
+                    name: habit.title,
+                    time: components,
+                    isActive: activeHabits.contains(habit)
+                ))
             }
         }
         
         // カスタム習慣を追加（時刻設定済み）
         for customHabit in appState.customHabits {
-            if let date = customHabitTimes[customHabit.id] {
+            // AppStateから時刻を取得（customHabitTimesにない場合も含む）
+            if let components = appState.customHabitSchedules[customHabit.id],
+               let date = Calendar.current.date(from: components) {
                 let components = Calendar.current.dateComponents([.hour, .minute], from: date)
                 allHabits.append((
                     id: customHabit.id.uuidString,
                     habit: nil,
                     customId: customHabit.id,
                     name: customHabit.name,
                     time: components,
                     isActive: activeCustomHabits.contains(customHabit.id)
                 ))
+            } else if let date = customHabitTimes[customHabit.id] {
+                // customHabitTimesから取得（フォールバック）
+                let components = Calendar.current.dateComponents([.hour, .minute], from: date)
+                allHabits.append((
+                    id: customHabit.id.uuidString,
+                    habit: nil,
+                    customId: customHabit.id,
+                    name: customHabit.name,
+                    time: components,
+                    isActive: activeCustomHabits.contains(customHabit.id)
+                ))
             }
         }
```

## 問題4: フォローアップ設定で時刻を変更しても反映されない

**問題**: `HabitEditSheet`の`save()`メソッドで時刻を保存しているが、`HabitsSectionView`の`loadHabitTimes()`が呼ばれていないため、画面に反映されない。

**修正方針**: `HabitEditSheet`に`onSave`コールバックを追加し、`HabitsSectionView`に`onChange`モディファイアを追加して`AppState`の変更を監視

**修正ファイル**: `aniccaios/aniccaios/Habits/HabitsSectionView.swift`

### 疑似パッチ4

```diff
--- a/aniccaios/aniccaios/Habits/HabitsSectionView.swift
+++ b/aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@ -162,7 +162,7 @@ struct HabitsSectionView: View {
             case .editor(let habit):
-                HabitEditSheet(habit: habit)
+                HabitEditSheet(habit: habit, onSave: {
+                    // 保存後に習慣時刻を再読み込み
+                    loadHabitTimes()
+                })
                     .environmentObject(appState)
             }
         }
         // 削除確認UIは廃止
         .onAppear {
             loadHabitTimes()
         }
+        .onChange(of: appState.habitSchedules) { _ in
+            // AppStateのhabitSchedulesが変更されたときに再読み込み
+            loadHabitTimes()
+        }
+        .onChange(of: appState.customHabitSchedules) { _ in
+            // AppStateのcustomHabitSchedulesが変更されたときに再読み込み
+            loadHabitTimes()
+        }
     }
     
     // 統合エディタ（時刻＋フォローアップ）
     struct HabitEditSheet: View {
         @EnvironmentObject private var appState: AppState
         let habit: HabitType
+        let onSave: (() -> Void)?
         @State private var time = Date()
         @State private var wakeLocation: String = ""
         @State private var sleepLocation: String = ""
         @State private var sleepRoutines: [RoutineItem] = []
         @Environment(\.dismiss) private var dismiss
+        
+        init(habit: HabitType, onSave: (() -> Void)? = nil) {
+            self.habit = habit
+            self.onSave = onSave
+        }
         
         var body: some View {
             // ... existing code ...
         }
         
         private func save() {
             // 時刻を保存
             Task {
                 await appState.updateHabit(habit, time: time)
+                // 保存後にコールバックを呼び出し
+                await MainActor.run {
+                    onSave?()
+                }
             }
             
             // Wake/Sleepの場所とルーティンを保存
             switch habit {
             case .wake:
                 appState.updateWakeLocation(wakeLocation)
                 appState.updateWakeRoutines(wakeRoutines.map { $0.text }.filter { !$0.isEmpty })
             case .bedtime:
                 appState.updateSleepLocation(sleepLocation)
                 appState.updateSleepRoutines(sleepRoutines.map { $0.text }.filter { !$0.isEmpty })
             case .training:
                 // トレーニングの目標と種類は既にAppStateで更新済み（リアルタイム更新）
                 break
             default:
                 break
             }
             
             dismiss()
         }
     }
```

## 実装ステップ

1. **Delete Accountエラーの修正**

   - `apps/api/src/routes/mobile/account.js`の47行目をtry-catchで囲む
   - エラーコード42P01（relation does not exist）の場合は警告ログを出力して処理を続行

2. **オンボーディング習慣ソートの修正**

   - `HabitSetupStepView.swift`の`sortedAllHabits`を修正
   - デフォルト習慣とカスタム習慣を統合し、時刻でソート
   - 時刻未設定の習慣は最後に配置

3. **Habits画面のトグル削除問題の修正**

   - `HabitsSectionView.swift`のトグル処理を修正
   - トグルをOFFにしても`habitTimes`や`AppState`から削除しない
   - `sortedAllHabits`で`AppState`からも時刻を取得するように修正

4. **フォローアップ時刻反映の修正**

   - `HabitEditSheet`に`onSave`コールバックを追加
   - `HabitsSectionView`に`onChange`モディファイアを追加して`AppState`の変更を監視
   - 保存後に`loadHabitTimes()`を呼び出して画面を更新