<!-- 16b26530-ac4d-4ea7-9004-3511ba2bf84a 8b5d545f-d250-409f-9bec-e506e095d10c -->
# iOS コンパイルエラー修正プラン

## エラー概要

| ファイル | 行 | エラー | 原因 |

|---------|-----|--------|------|

| `HabitsSectionView.swift` | 503 | `Cannot find 'AlarmStore' in scope` | AlarmKitでは`AlarmStore`ではなく`AlarmManager`が正しい |

| `NotificationScheduler.swift` | 716 | `'UNMutableNotificationContent' has no member 'mutableContent'` | ローカル通知ではこのプロパティは存在しない（リモート通知のペイロードのみで使用） |

| `MetricsUploader.swift` | 156, 159 | `Cannot convert value of type 'Any' to expected argument type 'NSObject'` | Swiftの`Logger`は`Any`型を直接string interpolationできない |

---

## 修正1: HabitsSectionView.swift (AlarmKit API修正)

Appleドキュメントによると、AlarmKitでは`AlarmStore`ではなく`AlarmManager`を使用します。また、`authorizationStatus`ではなく`authorizationState`プロパティを使用し、認可リクエストは`requestAuthorization()`メソッドで行います。

**修正箇所**: [aniccaios/aniccaios/Habits/HabitsSectionView.swift](aniccaios/aniccaios/Habits/HabitsSectionView.swift) 503行目付近

```swift
// 修正前
let store = AlarmStore.shared
let status = await store.authorizationStatus
switch status {
case .notDetermined:
    do {
        try await store.requestAuthorization()
        ...
    }
}

// 修正後
let manager = AlarmManager.shared
let status = manager.authorizationState
switch status {
case .notDetermined:
    do {
        _ = try await manager.requestAuthorization()
        ...
    }
}
```

---

## 修正2: NotificationScheduler.swift (mutableContent削除)

`UNMutableNotificationContent`には`mutableContent`プロパティは存在しません。これはリモート通知のAPNsペイロードで`mutable-content: 1`を設定するためのものであり、ローカル通知を作成するSwiftコードでは使用できません。

**修正箇所**: [aniccaios/aniccaios/Notifications/NotificationScheduler.swift](aniccaios/aniccaios/Notifications/NotificationScheduler.swift) 714-716行目

```swift
// 修正前
// mutable-content を有効化（Service Extension が処理するため）
// ★ 重要: Service Extensionが呼ばれるにはこのフラグが必須
content.mutableContent = true

// 修正後（行を削除）
// ★ 注意: ローカル通知では mutableContent は設定不要
// Service Extension はリモート通知（APNsの mutable-content: 1）でのみ呼ばれる
```

**補足**: Notification Service Extensionはリモート通知専用です。ローカル通知ではService Extensionは呼び出されません。

---

## 修正3: MetricsUploader.swift (Logger型安全性)

Swift の `Logger` は string interpolation で `Any` 型を直接受け入れません。`OSLogPrivacy`が適用できる型（String, Int, etc.）にキャストするか、`String(describing:)`で変換する必要があります。

**修正箇所**: [aniccaios/aniccaios/Services/MetricsUploader.swift](aniccaios/aniccaios/Services/MetricsUploader.swift) 155-159行目

```swift
// 修正前
if let sleepStart = payload["sleep_start_at"] {
    logger.info("MetricsUploader: sleep_start_at = \(sleepStart)")
}
if let wakeAt = payload["wake_at"] {
    logger.info("MetricsUploader: wake_at = \(wakeAt)")
}

// 修正後
if let sleepStart = payload["sleep_start_at"] as? String {
    logger.info("MetricsUploader: sleep_start_at = \(sleepStart)")
}
if let wakeAt = payload["wake_at"] as? String {
    logger.info("MetricsUploader: wake_at = \(wakeAt)")
}
```

---

## パッチ適用確認

修正後、以下のコマンドでビルドエラーが解消されたことを確認できます：

```bash
cd /Users/cbns03/Downloads/anicca-project/aniccaios
xcodebuild -scheme aniccaios -configuration Debug -destination 'platform=iOS Simulator,name=iPhone 16' build
```

### To-dos

- [ ] HabitsSectionView.swift: AlarmStore を AlarmManager に修正
- [ ] NotificationScheduler.swift: mutableContent 行を削除
- [ ] MetricsUploader.swift: Logger の Any 型を String にキャスト