<!-- 8583ef3a-ae37-4e09-a14e-96a18c510810 a31bf550-af11-4797-bddd-92f70f198502 -->
# iOS Habits UX 修正計画

## 目的

- Onboarding「Set Your Habits」および Habits タブの操作性/表示を改善し、時刻編集・並び順・削除・UI統一の不具合を解消する。
- Talk タブのギアアイコンの見た目/位置を Habits タブに統一する。
- バックエンドは変更不要。

## 変更ファイル（iOS）

- `aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift`
- `aniccaios/aniccaios/Habits/HabitsSectionView.swift`
- `aniccaios/aniccaios/AppState.swift`
- `aniccaios/aniccaios/SessionView.swift`

## 擬似パッチ

### 1) Onboarding: タップで時間シート、キャンセル時にトグル保持、説明文削除

対象: `aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift`

**habitCard関数の修正（159-201行目）:**

- `habit.detail`の表示を削除（167-169行目）
- カード全体に`.contentShape(Rectangle())`と`.onTapGesture`を追加して、選択状態に関わらずタップで時間設定シートを開く
```diff
@@
-            VStack(alignment: .leading, spacing: 8) {
-                Text(habit.title)
-                    .font(.headline)
-                Text(habit.detail)
-                    .font(.subheadline)
-                    .foregroundStyle(.secondary)
-            }
+            VStack(alignment: .leading, spacing: 8) {
+                Text(habit.title)
+                    .font(.headline)
+            }
@@
-        .padding()
-        .background(Color(.systemGray6))
-        .cornerRadius(12)
+        .padding()
+        .background(Color(.systemGray6))
+        .cornerRadius(12)
+        .contentShape(Rectangle())
+        .onTapGesture {
+            // 選択状態に関わらずタップで時間設定シートを開く
+            sheetTime = habitTimes[habit] ?? Calendar.current.date(from: habit.defaultTime) ?? Date()
+            showingTimePicker = habit
+        }
```


**customHabitCard関数の修正（203-239行目）:**

- カード全体に`.contentShape(Rectangle())`と`.onTapGesture`を追加
```diff
@@
-        .padding()
-        .background(Color(.systemGray6))
-        .cornerRadius(12)
+        .padding()
+        .background(Color(.systemGray6))
+        .cornerRadius(12)
+        .contentShape(Rectangle())
+        .onTapGesture {
+            sheetTime = customHabitTimes[customHabit.id] ?? Date()
+            showingCustomTimePicker = customHabit.id
+        }
```


**timePickerSheet関数のキャンセル処理修正（287-325行目）:**

- `selectedHabits.remove(habit)`を削除して、キャンセル時もトグル状態を保持
```diff
@@
-                ToolbarItem(placement: .navigationBarLeading) {
-                    Button(String(localized: "common_cancel")) {
-                        // Cancel時にselectedHabitsから削除
-                        selectedHabits.remove(habit)
-                        showingTimePicker = nil
-                    }
-                }
+                ToolbarItem(placement: .navigationBarLeading) {
+                    Button(String(localized: "common_cancel")) {
+                        // キャンセルしてもトグル状態は保持
+                        showingTimePicker = nil
+                    }
+                }
```


### 2) Habits タブ: 中央タップでも時間シート、キャンセル保持、デフォルト習慣もスワイプ削除、説明文削除、フォローアップ編集の Edit 削除

対象: `aniccaios/aniccaios/Habits/HabitsSectionView.swift`

**habitRow関数の修正（244-296行目）:**

- `habit.detail`の表示を削除（254-256行目）
- VStackに`.frame(maxWidth: .infinity, alignment: .leading)`を追加してタップ領域を拡大
- カード全体に`.swipeActions`を追加してデフォルト習慣のスワイプ削除を実装
```diff
@@
-            VStack(alignment: .leading, spacing: 8) {
-                Text(habit.title)
-                    .font(.headline)
-                Text(habit.detail)
-                    .font(.subheadline)
-                    .foregroundStyle(.secondary)
-            }
-            .contentShape(Rectangle())
+            VStack(alignment: .leading, spacing: 8) {
+                Text(habit.title)
+                    .font(.headline)
+            }
+            .frame(maxWidth: .infinity, alignment: .leading)
+            .contentShape(Rectangle())
@@
-            Toggle("", isOn: Binding(
+            Toggle("", isOn: Binding(
                 get: { isActive },
                 set: { isOn in
@@
-            ))
-            .labelsHidden()
+            ))
+            .labelsHidden()
         }
+        .swipeActions(edge: .trailing, allowsFullSwipe: true) {
+            Button(role: .destructive) {
+                // デフォルト習慣の削除＝スケジュールのクリア
+                appState.removeHabitSchedule(habit)
+                activeHabits.remove(habit)
+                habitTimes.removeValue(forKey: habit)
+            } label: {
+                Label(String(localized: "common_delete"), systemImage: "trash")
+            }
+        }
```


**customHabitRow関数の修正（298-343行目）:**

- VStackに`.frame(maxWidth: .infinity, alignment: .leading)`を追加してタップ領域を拡大
```diff
@@
-            VStack(alignment: .leading, spacing: 8) {
-                Text(name)
-                    .font(.headline)
-            }
+            VStack(alignment: .leading, spacing: 8) {
+                Text(name)
+                    .font(.headline)
+            }
+            .frame(maxWidth: .infinity, alignment: .leading)
+            .contentShape(Rectangle())
```


**timePickerSheet関数のキャンセル処理修正（346-386行目）:**

- `activeHabits.remove(habit)`を削除して、キャンセル時もトグル状態を保持
```diff
@@
-                    Button(String(localized: "common_cancel")) {
-                        // Cancel時はトグルを元に戻す
-                        activeHabits.remove(habit)
-                        activeSheet = nil
-                    }
+                    Button(String(localized: "common_cancel")) {
+                        // キャンセルしてもトグル状態は保持
+                        activeSheet = nil
+                    }
```


**customTimePickerSheet関数のキャンセル処理修正（388-425行目）:**

- `activeCustomHabits.remove(id)`を削除して、キャンセル時もトグル状態を保持
```diff
@@
-                    Button(String(localized: "common_cancel")) {
-                        activeCustomHabits.remove(id)
-                        activeSheet = nil
-                    }
+                    Button(String(localized: "common_cancel")) {
+                        // キャンセルしてもトグル状態は保持
+                        activeSheet = nil
+                    }
```


**HabitEditSheetのtoolbar修正（496-511行目）:**

- EditButtonを削除（506-510行目）
```diff
@@
-                // ルーティン編集モード用のEditButton（Wake/Sleepのみ）
-                if habit == .wake || habit == .bedtime {
-                    ToolbarItem(placement: .navigationBarTrailing) {
-                        EditButton()
-                    }
-                }
+                // Editボタンは不要のため削除（ドラッグハンドルで順序変更可能）
```


### 3) AppState: デフォルト習慣スケジュールのクリアAPIを追加

対象: `aniccaios/aniccaios/AppState.swift`

```diff
@@
     func updateHabits(_ schedules: [HabitType: Date]) async {
         guard case .signedIn = authStatus else { return }
@@
     }
+
+    /// デフォルト習慣のスケジュールを削除（通知も更新）
+    func removeHabitSchedule(_ habit: HabitType) {
+        habitSchedules.removeValue(forKey: habit)
+        saveHabitSchedules()
+        Task {
+            await scheduler.applySchedules(habitSchedules)
+        }
+    }
```

### 4) Talk タブ: ギアアイコンの見た目/位置/エフェクトを Habits に統一

対象: `aniccaios/aniccaios/SessionView.swift`

**body関数の修正（10-17行目）:**

- `navigationContainer`でラップしてNavigationStack/NavigationViewを追加
```diff
@@
-    private var authenticatedContent: some View {
-        VStack(spacing: 24) {
-            HStack {
-                Spacer()
-                Button(action: {
-                    isShowingSettings = true
-                }) {
-                    Image(systemName: "gearshape")
-                        .font(.title3)
-                }
-                .buttonStyle(.bordered)
-            }
-            .frame(maxWidth: .infinity, alignment: .trailing)
-            .padding(.top)
+    private var authenticatedContent: some View {
+        VStack(spacing: 24) {
@@
-        .padding()
-        .sheet(isPresented: $isShowingSettings) {
+        .padding()
+        .sheet(isPresented: $isShowingSettings) {
             SettingsView()
                 .environmentObject(appState)
         }
+        .toolbar {
+            ToolbarItem(placement: .navigationBarTrailing) {
+                Button(action: { isShowingSettings = true }) {
+                    Image(systemName: "gearshape")
+                }
+            }
+        }
```


**authenticatedContent関数の修正（19-114行目）:**

- HStackとギアボタン（21-32行目）を削除
- `.toolbar`を追加してナビゲーションバーの右上にギアアイコンを配置
```diff
@@
-    private var authenticatedContent: some View {
-        VStack(spacing: 24) {
-            HStack {
-                Spacer()
-                Button(action: {
-                    isShowingSettings = true
-                }) {
-                    Image(systemName: "gearshape")
-                        .font(.title3)
-                }
-                .buttonStyle(.bordered)
-            }
-            .frame(maxWidth: .infinity, alignment: .trailing)
-            .padding(.top)
+    private var authenticatedContent: some View {
+        VStack(spacing: 24) {
@@
-        .padding()
-        .sheet(isPresented: $isShowingSettings) {
+        .padding()
+        .toolbar {
+            ToolbarItem(placement: .navigationBarTrailing) {
+                Button(action: { isShowingSettings = true }) {
+                    Image(systemName: "gearshape")
+                }
+            }
+        }
+        .sheet(isPresented: $isShowingSettings) {
             SettingsView()
                 .environmentObject(appState)
         }
```


### 5) バックエンド（apps/api）

- 本件のUI/UX修正に伴うAPI変更は不要のため、変更なし。

## 注意点

- 既存のトグルON時に時間未設定の場合でも、タップで直接シートを開けます。
- キャンセル時は選択状態を保持するため、保存しない限りデータは更新されません。
- デフォルト習慣の「削除」はスケジュール（時刻）のクリアとして実装します（通知も更新）。
- `SessionView`は`TabView`内に配置されているため、`.toolbar`を使用するには`NavigationStack`でラップする必要があります。
- `AppState.removeHabitSchedule`メソッドは新規追加が必要です（`updateHabits`メソッドの後に追加）。

## 実装時の注意事項

### 1. SessionViewのNavigationStackラップ

- `SessionView`は`MainTabView`の`TabView`内に配置されているため、`.toolbar`を使用するには`NavigationStack`でラップする必要があります
- `NavigationStack`は`authenticatedContent`の最初に配置し、すべての修飾子（`.toolbar`、`.sheet`など）を内側に配置します

### 2. AppState.removeHabitScheduleの追加

- `AppState.swift`の`updateHabits`メソッドの後に追加してください
- このメソッドは`habitSchedules`から指定された習慣を削除し、通知も更新します

### 3. スワイプ削除の実装

- `HabitsSectionView.habitRow`に`.swipeActions`を追加します
- デフォルト習慣の削除時は`appState.removeHabitSchedule(habit)`を呼び出します
- カスタム習慣の削除は既存の`appState.removeCustomHabit(id:)`を使用します

### 4. キャンセル処理の統一

- すべての時間設定シート（`timePickerSheet`、`customTimePickerSheet`）で、キャンセル時にトグル状態を保持するように修正します
- `selectedHabits.remove(habit)`や`activeHabits.remove(habit)`を削除します

### To-dos

- [ ] Onboarding行タップで時間シート、説明文削除、キャンセル保持
- [ ] Habits行のタップ領域拡大・説明文削除（カスタム/デフォルト）
- [ ] 時間シートのCancelでトグル状態を保持（両画面）
- [ ] デフォルト習慣へスワイプ削除追加（AppStateにremoveHabitSchedule API追加）
- [ ] HabitEditSheetのEditボタン削除
- [ ] SessionViewをNavigationStackでラップしてギアをナビ右上に統一
- [ ] Onboarding/Habitsの時系列ソートの最終確認