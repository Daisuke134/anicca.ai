<!-- 946d1b87-d929-439e-82f5-a99210b86ba6 80eaff06-096c-475f-b67d-fee73a2a62c4 -->
# iOSアプリ修正対応

## 修正内容

### 1. オンボーディングから「Tell Us Your Name」を削除

**変更ファイル**: `aniccaios/aniccaios/Onboarding/OnboardingFlowView.swift`

- `.profile`ステップをスキップし、`.account`の次は直接`.habitSetup`へ遷移
- `ProfileInfoStepView.swift`は残すが、オンボーディングフローからは削除
```diff
*** aniccaios/aniccaios/Onboarding/OnboardingFlowView.swift
@@
     private func advance() {
         switch step {
         case .welcome:
             step = .microphone
         case .microphone:
             step = .notifications
         case .notifications:
             step = .account
         case .account:
-            step = .profile
-        case .profile:
             step = .habitSetup
             // プロフィール完了時にオファリングをプリフェッチ（Paywall表示の準備）
             Task {
                 await SubscriptionManager.shared.refreshOfferings()
             }
         case .habitSetup:
```


### 2. オンボーディングの「Set Your Habits」で時刻選択シートでSaveしたら自動でトグルがオンになる

**変更ファイル**: `aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift`

- `timePickerSheet`のSave処理で、`selectedHabits`に追加し、`habitTimes`に保存
- `customTimePickerSheet`のSave処理では、`customHabitTimes`に保存するだけでOK（`customHabitCard`のToggleは`hasTime`ベースなので、時刻設定で自動的にON表示される）
```diff
*** aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift
@@
                 ToolbarItem(placement: .navigationBarTrailing) {
                     Button(String(localized: "common_save")) {
                         habitTimes[habit] = sheetTime
-                        // 注意: selectedHabitsには既に含まれている（Toggle ON時に追加済み）
+                        selectedHabits.insert(habit)
                         showingTimePicker = nil
                     }
                 }
@@
                 ToolbarItem(placement: .navigationBarTrailing) {
                     Button(String(localized: "common_save")) {
                         customHabitTimes[id] = sheetTime
+                        // カスタム習慣も時刻設定で自動的に有効化（トグル表示用）
+                        // 注意: customHabitCardのToggleはhasTimeベースなので、時刻設定で自動的にON表示される
                         showingCustomTimePicker = nil
                     }
                 }
```


### 3. Settingsの「Ideal SELF」のローカライズ修正

**変更ファイル**: `aniccaios/aniccaios/SettingsView.swift`

**問題**: `LocalizedStringKey("ideal_trait_\(trait)")`は動的文字列補間で正しく動作しない可能性がある。`String(localized:)`は動的文字列補間をサポートしていないため、`NSLocalizedString`を使用する必要がある。

**確認済み**: `Localizable.strings`には`ideal_trait_kind`などのキーが定義されている。

```diff
*** aniccaios/aniccaios/SettingsView.swift
@@
         Button(action: {
             var traits = appState.userProfile.idealTraits
             if isSelected {
                 traits.removeAll { $0 == trait }
             } else {
                 traits.append(trait)
             }
             appState.updateIdealTraits(traits)
         }) {
-            Text(LocalizedStringKey("ideal_trait_\(trait)"))
+            Text(NSLocalizedString("ideal_trait_\(trait)", comment: ""))
                 .font(.subheadline)
                 .padding(.horizontal, 12)
                 .padding(.vertical, 8)
                 .background(isSelected ? Color.black : Color(.systemGray6))
                 .foregroundColor(isSelected ? .white : .secondary)
                 .cornerRadius(8)
         }
```

### 4. Habitsタブで習慣を新規追加したとき、その習慣の要素を押したら時刻選択シートが出る

**変更ファイル**: `aniccaios/aniccaios/Habits/HabitsSectionView.swift`

- `customHabitRow`の`onTapGesture`で、`isActive`でない場合（時刻未設定時）も時刻選択シートを表示
```diff
*** aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@
             .contentShape(Rectangle())
             .onTapGesture {
                 if isActive {
                     activeSheet = .customEditor(id)
+                } else {
+                    // 時刻未設定時も時刻選択シートを表示
+                    sheetTime = date ?? Date()
+                    activeSheet = .custom(id)
                 }
             }
```


### 5. Habitsタブでトグルをオンにしたとき、Cancelしたらトグルがオフのまま保存される

**変更ファイル**: `aniccaios/aniccaios/Habits/HabitsSectionView.swift`

- `timePickerSheet`と`customTimePickerSheet`のCancel処理で、トグルをオフに戻す
- トグルをオンにした時点では一時的にON表示し、Saveで確定、CancelでOFFに戻す
```diff
*** aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@
             Toggle("", isOn: Binding(
                 get: { isActive },
                 set: { isOn in
                     if isOn {
                         if let date = date {
                             activeHabits.insert(habit)
                             habitTimes[habit] = date
                         } else {
                             // 時刻未設定なら即シート表示（Saveで確定、CancelでOFFへ戻す）
                             sheetTime = Calendar.current.date(from: habit.defaultTime) ?? Date()
                             activeSheet = .habit(habit)
-                            activeHabits.insert(habit) // 一時的にON表示
+                            // 一時的にON表示しない（Cancel時にOFFに戻すため）
                         }
                     } else {
                         activeHabits.remove(habit)
                     }
                 }
             ))
@@
                 ToolbarItem(placement: .navigationBarLeading) {
                     Button(String(localized: "common_cancel")) {
-                        // キャンセルしてもトグル状態は保持
+                        // Cancel時はトグルをOFFに戻す
+                        if !habitTimes.keys.contains(habit) {
+                            activeHabits.remove(habit)
+                        }
                         activeSheet = nil
                     }
                 }
                 ToolbarItem(placement: .navigationBarTrailing) {
                     Button(String(localized: "common_save")) {
                         habitTimes[habit] = sheetTime
                         activeHabits.insert(habit)
                         _ = Calendar.current.dateComponents([.hour, .minute], from: sheetTime)
                         Task {
                             await appState.updateHabit(habit, time: sheetTime)
                         }
                         activeSheet = nil
                     }
                 }
@@
             Toggle("", isOn: Binding(
                 get: { isActive },
                 set: { isOn in
                     if isOn {
                         if let date = date {
                             activeCustomHabits.insert(id)
                             customHabitTimes[id] = date
                         } else {
                             sheetTime = Date()
                             activeSheet = .custom(id)
-                            activeCustomHabits.insert(id) // 一時的にON表示
+                            // 一時的にON表示しない（Cancel時にOFFに戻すため）
                         }
                     } else {
                         activeCustomHabits.remove(id)
                     }
                 }
             ))
@@
                 ToolbarItem(placement: .navigationBarLeading) {
                     Button(String(localized: "common_cancel")) {
-                        // キャンセルしてもトグル状態は保持
+                        // Cancel時はトグルをOFFに戻す
+                        if !customHabitTimes.keys.contains(id) {
+                            activeCustomHabits.remove(id)
+                        }
                         activeSheet = nil
                     }
                 }
```


### 6. 習慣の詳細画面の「Realert Every 10s」記述を削除

**変更ファイル**: `aniccaios/aniccaios/Resources/en.lproj/Localizable.strings`, `aniccaios/aniccaios/Resources/ja.lproj/Localizable.strings`

- `followup_repeats_help`の文字列から「Re-alert every 10s」/「10秒ごとに再通知」の記述を削除
```diff
*** aniccaios/aniccaios/Resources/en.lproj/Localizable.strings
@@
-"followup_repeats_help" = "Re-alert every 10s, 1–10 times.";
+"followup_repeats_help" = "1–10 times.";
```
```diff
*** aniccaios/aniccaios/Resources/ja.lproj/Localizable.strings
@@
-"followup_repeats_help" = "10秒ごとに再通知。1〜10回から選択。";
+"followup_repeats_help" = "1〜10回から選択。";
```


### 7. ランディングページのSupport/Privacyの言語対応

**確認**: 既に`/support/en`, `/support/ja`, `/privacy/en`, `/privacy/ja`が存在し、リダイレクトも実装済み

**変更ファイル**: 変更不要（既に実装済み）

- `apps/landing/app/support/page.tsx`: 言語自動判定でリダイレクト
- `apps/landing/app/privacy/page.tsx`: 言語自動判定でリダイレクト
- `apps/landing/app/support/en/page.tsx`: 英語版コンテンツ
- `apps/landing/app/support/ja/page.tsx`: 日本語版コンテンツ
- `apps/landing/app/privacy/en/page.tsx`: 英語版コンテンツ
- `apps/landing/app/privacy/ja/page.tsx`: 日本語版コンテンツ

**確認事項**:

- `LegalLinksView.swift`と`ManageSubscriptionSheet.swift`で既に言語別URLを使用しているため、変更不要



各修正のUI変化をドット図で示します。



## 修正1: オンボーディングから「Tell Us Your Name」を削除



### 修正前のフロー

```

Welcome

  ↓

Microphone Permission

  ↓

Notifications Permission

  ↓

Sign in with Apple

  ↓

Tell Us Your Name ← 【削除対象】

  ↓

Set Your Habits

  ↓

Paywall/Completion

```



### 修正後のフロー

```

Welcome

  ↓

Microphone Permission

  ↓

Notifications Permission

  ↓

Sign in with Apple

  ↓

Set Your Habits ← 【直接遷移】

  ↓

Paywall/Completion

```



名前入力は設定画面（Settings → Personalization → Name）で行います。



---



## 修正2: オンボーディングの「Set Your Habits」で時刻選択シートでSaveしたら自動でトグルがオンになる



### 修正前の動作

```

[Set Your Habits画面]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← ユーザーがトグルをONにする

└─────────────────────┘

         ↓

[時刻選択シート]

┌─────────────────────┐

│ Set Time            │

│ [07:00] ← 時刻選択  │

│ [Cancel] [Save]     │

└─────────────────────┘

         ↓ (Save押下)

[Set Your Habits画面]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← ❌ トグルがOFFのまま

│ 07:00               │ ← ✅ 時刻は表示される

└─────────────────────┘

```



### 修正後の動作

```

[Set Your Habits画面]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← ユーザーがカードをタップ

└─────────────────────┘

         ↓

[時刻選択シート]

┌─────────────────────┐

│ Set Time            │

│ [07:00] ← 時刻選択  │

│ [Cancel] [Save]     │

└─────────────────────┘

         ↓ (Save押下)

[Set Your Habits画面]

┌─────────────────────┐

│ Wake Up        [ON] │ ← ✅ トグルが自動でONになる

│ 07:00               │ ← ✅ 時刻も表示される

└─────────────────────┘

```



---



## 修正3: Settingsの「Ideal SELF」のローカライズ修正



### 修正前の表示

```

[Settings画面]

┌─────────────────────────────┐

│ Ideal self                  │

│ ┌─────┐ ┌─────┐ ┌─────┐    │

│ │ideal│ │ideal│ │ideal│    │ ← ❌ キー名がそのまま表示

│ │_trait│ │_trait│ │_trait│    │

│ │_kind│ │_confident│ │_calm│    │

│ └─────┘ └─────┘ └─────┘    │

└─────────────────────────────┘

```



### 修正後の表示

```

[Settings画面]

┌─────────────────────────────┐

│ Ideal self                  │

│ ┌─────┐ ┌─────┐ ┌─────┐    │

│ │やさしさ│ │自信│ │落ち着き│    │ ← ✅ 日本語で表示

│ └─────┘ └─────┘ └─────┘    │

│ ┌─────┐ ┌─────┐ ┌─────┐    │

│ │利他性│ │マインドフル│ │楽観性│    │

│ └─────┘ └─────┘ └─────┘    │

│ ┌─────┐ ┌─────┐            │

│ │レジリエンス│ │規律性│            │

│ └─────┘ └─────┘            │

│ ┌─────┐                    │

│ │誠実│                    │

│ └─────┘                    │

└─────────────────────────────┘



英語環境の場合：

│ ┌─────┐ ┌─────┐ ┌─────┐    │

│ │Kind│ │Confident│ │Calm│    │ ← ✅ 英語で表示

│ └─────┘ └─────┘ └─────┘    │

```



---



## 修正4: Habitsタブで習慣を新規追加したとき、その習慣の要素を押したら時刻選択シートが出る



### 修正前の動作

```

[Habitsタブ]

┌─────────────────────┐

│ + Add Habit         │ ← タップ

└─────────────────────┘

         ↓

[習慣名入力シート]

┌─────────────────────┐

│ Add Habit           │

│ [読書] ← 名前入力    │

│ [Cancel] [Add]      │

└─────────────────────┘

         ↓ (Add押下)

[Habitsタブ]

┌─────────────────────┐

│ 読書          [OFF] │ ← 新規追加された習慣

│ Weekly              │ ← 週間だけ表示

└─────────────────────┘

         ↓ (カードをタップ)

❌ 何も起こらない ← 【問題】

```



### 修正後の動作

```

[Habitsタブ]

┌─────────────────────┐

│ + Add Habit         │ ← タップ

└─────────────────────┘

         ↓

[習慣名入力シート]

┌─────────────────────┐

│ Add Habit           │

│ [読書] ← 名前入力    │

│ [Cancel] [Add]      │

└─────────────────────┘

         ↓ (Add押下)

[Habitsタブ]

┌─────────────────────┐

│ 読書          [OFF] │ ← 新規追加された習慣

│ Weekly              │ ← 週間だけ表示

└─────────────────────┘

         ↓ (カードをタップ)

[時刻選択シート]

┌─────────────────────┐

│ Set Time            │

│ [20:00] ← 時刻選択  │

│ [Cancel] [Save]     │

└─────────────────────┘

         ↓ (Save押下)

[Habitsタブ]

┌─────────────────────┐

│ 読書          [ON] │ ← ✅ トグルが自動でON

│ 20:00               │ ← ✅ 時刻も表示

└─────────────────────┘

```



---



## 修正5: Habitsタブでトグルをオンにしたとき、Cancelしたらトグルがオフのまま保存される



### 修正前の動作

```

[Habitsタブ]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← トグルをONにする

└─────────────────────┘

         ↓

[時刻選択シート]

┌─────────────────────┐

│ Set Time            │

│ [07:00]             │

│ [Cancel] [Save]      │

└─────────────────────┘

         ↓ (Cancel押下)

[Habitsタブ]

┌─────────────────────┐

│ Wake Up        [ON] │ ← ❌ トグルがONのまま

│ (時刻なし)          │ ← ❌ 時刻がないのにON

└─────────────────────┘

```



### 修正後の動作

```

[Habitsタブ]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← トグルをONにする

└─────────────────────┘

         ↓

[時刻選択シート]

┌─────────────────────┐

│ Set Time            │

│ [07:00]             │

│ [Cancel] [Save]      │

└─────────────────────┘

         ↓ (Cancel押下)

[Habitsタブ]

┌─────────────────────┐

│ Wake Up        [OFF]│ ← ✅ トグルがOFFに戻る

│                     │ ← ✅ 時刻も設定されない

└─────────────────────┘



         ↓ (Save押下の場合)

[Habitsタブ]

┌─────────────────────┐

│ Wake Up        [ON] │ ← ✅ トグルがONのまま

│ 07:00               │ ← ✅ 時刻も設定される

└─────────────────────┘

```



---



## 修正6: 習慣の詳細画面の「Realert Every 10s」記述を削除



### 修正前の表示

```

[Habit Edit Sheet]

┌─────────────────────────────┐

│ Wake Up                     │

│                             │

│ Time                        │

│ [07:00]                     │

│                             │

│ Reminder repeats            │

│ [5] times ← Stepper         │

│ Re-alert every 10s, 1–10    │ ← ❌ この行を削除

│ times.                      │

└─────────────────────────────┘

```



### 修正後の表示

```

[Habit Edit Sheet]

┌─────────────────────────────┐

│ Wake Up                     │

│                             │

│ Time                        │

│ [07:00]                     │

│                             │

│ Reminder repeats            │

│ [5] times ← Stepper         │

│ 1–10 times.                 │ ← ✅ 「Re-alert every 10s」を削除

└─────────────────────────────┘



日本語環境の場合：

│ 再通知回数                   │

│ [5] 回 ← Stepper            │

│ 1〜10回から選択。            │ ← ✅ 「10秒ごとに再通知」を削除

```



---



## 修正7: ランディングページのSupport/Privacyの言語対応



### 現在の動作（既に実装済み）

```

[iOSアプリ内]

Settings → Manage Plan → Contact support

         ↓

https://aniccaai.com/support

         ↓ (自動リダイレクト)

Accept-Language: ja → /support/ja

Accept-Language: en → /support/en



[iOSアプリ内]

Settings → Legal Links → Privacy Policy

         ↓

https://aniccaai.com/privacy

         ↓ (自動リダイレクト)

Accept-Language: ja → /privacy/ja

Accept-Language: en → /privacy/en

```



### 各ページの内容

```

/support/ja

┌─────────────────────────────┐

│ サポート                     │

│                             │

│ お問い合わせ                │

│ keiodaisuke@gmail.com       │

│                             │

│ よくある質問                │

│ - Aniccaはどのように...     │

│ - どのような権限が...       │

│ ...                         │

└─────────────────────────────┘



/support/en

┌─────────────────────────────┐

│ Support                     │

│                             │

│ Contact Us                  │

│ keiodaisuke@gmail.com       │

│                             │

│ Frequently Asked Questions  │

│ - How does Anicca work?     │

│ - What permissions...        │

│ ...                         │

└─────────────────────────────┘

```



---



## 全体のUIフローまとめ



### オンボーディングフロー（修正後）

```

Welcome

  ↓

Microphone Permission

  ↓

Notifications Permission

  ↓

Sign in with Apple

  ↓

Set Your Habits

  ├─ Wake Up カードをタップ → 時刻選択 → Save → トグルON

  ├─ Training カードをタップ → 時刻選択 → Save → トグルON

  ├─ Bedtime カードをタップ → 時刻選択 → Save → トグルON

  └─ + Add Habit → 名前入力 → Add → カードをタップ → 時刻選択 → Save → トグルON

  ↓

Paywall/Completion

```



### Habitsタブの動作（修正後）

```

[Habitsタブ]

  ├─ 既存習慣（時刻設定済み）

  │   ├─ カードをタップ → HabitEditSheet（時刻・フォローアップ編集）

  │   └─ トグルON/OFF → 即座に反映

  │

  ├─ 新規追加習慣（時刻未設定）

  │   ├─ カードをタップ → 時刻選択シート

  │   ├─ Save → トグルON + 時刻設定

  │   └─ Cancel → トグルOFFのまま

  │

  └─ トグル操作

      ├─ OFF → ON（時刻未設定） → 時刻選択シート

      │   ├─ Save → トグルON + 時刻設定

      │   └─ Cancel → トグルOFFに戻る

      └─ ON → OFF → 即座にOFF

```



この理解で合っていますか？修正が必要な点があれば教えてください。