# Spec: Anicca OpenClaw 行動バリデーション

## 概要（What & Why）

### What
VPS 上の Anicca（OpenClaw エージェント）が、SOUL.md / AGENTS.md / workspace skills に記載されたルールに従って**実際に行動するか**を検証し、従っていない場合は原因を特定して修正する。

### Why
ファイルを配置しただけでは「完了」ではない。Anicca の実際の出力が期待通りかを確認して初めて完了。

| 問題 | 証拠 |
|------|------|
| Decisive ルールが効いていない | Palantir 株の質問に「ご自身で判断してください」と回答。選択肢を提示して丸投げ |
| 日本語ルール未確認 | 英語で話しかけた時に日本語で返すか未検証 |
| content-research-writer 未確認 | スキルが読み込まれるか、実際に使われるか未検証 |
| テーブル形式未確認 | 箇条書きではなくテーブルで返すか未検証 |

---

## 前提条件

| # | 条件 | 確認方法 |
|---|------|---------|
| P-1 | VPS への SSH アクセス（鍵認証済み） | `ssh anicca@46.225.70.241 'echo ok'` |
| P-2 | OpenClaw Gateway 起動中 | `systemctl --user is-active openclaw-gateway` |
| P-3 | Slack Socket Mode 接続済み | Gateway ログに `socket mode connected` |
| P-4 | SLACK_BOT_TOKEN が VPS 上の `.env` に設定済み | `grep SLACK_BOT_TOKEN ~/.env` |

---

## 受け入れ条件

| # | 条件 | 検証方法 | PASS 基準 |
|---|------|---------|----------|
| AC-0 | Anicca が送受信可能で、SOUL.md とスキルが読み込まれている | TC-0a, TC-0b, TC-0c | 応答取得可能 + SOUL.md キーワード確認 + スキル名確認 |
| AC-1 | **判断・選択を求められた時**、1つに決めて理由を述べる | TC-1, TC-2, TC-3 | 下記「Decisive PASS 基準」参照 |
| AC-2 | 英語で話しかけても**日本語で回答** | TC-4, TC-5, TC-6 | 日本語話者が読んで自然な日本語文章と感じる |
| AC-3 | 「英語で答えて」の時だけ**英語で回答** | TC-7 | 回答が英語 |
| AC-4 | 英語+日本語混在入力でも**日本語で回答** | TC-8 | 日本語話者が読んで自然な日本語文章と感じる |
| AC-5 | **情報整理が必要な回答**（3項目以上）で**テーブル形式** | TC-9, 該当 TC で副次確認 | Markdown テーブル（`\|` 区切り）がメインの情報構造。短い回答は除外 |
| AC-6 | content-research-writer のワークフローに従う | TC-10 | テーブル形式アウトライン + 5 セクション以上 + リサーチ項目明示 |

### Decisive PASS 基準（AC-1 詳細）

| チェック | 具体例（PASS） | 具体例（FAIL） |
|---------|---------------|---------------|
| ✓ 結論文に動詞を含む | 「TikTok に集中すべきです」「売却を推奨します」 | 「いくつかの選択肢があります」 |
| ✓ 選択肢を並列列挙しない | 1つだけ選んで理由を述べる | 「A と B のどちらも良い選択肢です」 |
| ✓ 根拠が番号付きで 2 つ以上 | 「理由: 1. ... 2. ...」 | 理由なし / 「お好みで」 |
| ✓ 丸投げ表現ゼロ | 自分で決めて述べる | 「ご自身で判断」「リスク許容度による」「専門家に相談」 |
| ✓ 逆質問で返さない | 質問に直接答える | 「もう少し詳しく教えてください」（判断回避） |

### 日本語 PASS 基準（AC-2, AC-4 詳細）

| チェック | 判定方法 |
|---------|---------|
| 主観判定 | 日本語話者が読んで「日本語の回答」と感じるか |
| 固有名詞の許容 | API、TikTok、Railway 等の英語固有名詞は OK |
| 混在 NG | 「東京の天気は sunny です」→ FAIL（英語の文が混在） |
| 全体が日本語 | 文の構造・助詞・語尾が日本語であること |

### テーブル形式 PASS 基準（AC-5 詳細）

| チェック | 判定方法 |
|---------|---------|
| テーブル必須の場面 | 3 項目以上の情報整理、比較、手順、リスト的な内容 |
| テーブル不要の場面 | 単一事実の回答（「東京です」）、2 項目以下の短い回答 |
| 形式 | Markdown テーブル（`\|` 区切り）のみ PASS。HTML / ASCII art は NG |
| 補足的な箇条書き | テーブルがメイン構造なら、補足で 3 項目以下の箇条書きは許容 |

---

## テスト実行メカニズム

### 送信方法（優先順位）

| 優先度 | 方法 | コマンド | 備考 |
|--------|------|--------|------|
| ① | `openclaw agent`（直接セッション） | `ssh anicca@46.225.70.241 'echo "[入力]" \| timeout 60 openclaw agent --agent anicca'` | 最も確実。stdout で応答取得 |
| ② | Slack API 直接投稿 | `curl -X POST https://slack.com/api/chat.postMessage ...` | Anicca が Slack メッセージに反応するか要確認 |
| ③ | `openclaw message send` | `openclaw message send --channel slack --target "C08RZ98SBUL" ...` | 自己反応が確認できた場合のみ |

### 応答取得方法

| 方法 | コマンド | 用途 |
|------|--------|------|
| `openclaw agent` の stdout | パイプで直接取得 | ①の場合 |
| Slack API | `curl 'https://slack.com/api/conversations.history?channel=C08RZ98SBUL&limit=3' -H "Authorization: Bearer $SLACK_BOT_TOKEN"`（投稿後 120 秒以内に応答がなければ RETRY） | ②③の場合 |
| Gateway ログ | `journalctl --user -u openclaw-gateway --since "2 min ago" --no-pager` | 補助確認 |

### セッション独立性

| ルール | 詳細 |
|--------|------|
| 各 TC は独立セッション | `openclaw agent` の場合、TC ごとに新規実行 |
| Slack の場合 | TC 間で 1 分以上の間隔を空ける |
| TC-7（英語指示）の後 | 次の TC の前に必ず新規セッション開始 |

**TC-0c で全方法を試し、動作する手段を特定してから本テストに入る。**

---

## 根本原因の仮説

| # | 仮説 | 検証方法 | 可能性 |
|---|------|---------|--------|
| H-1 | GPT-4o がシステムプロンプトの長い指示を無視 | SOUL.md を短く・強く書き直して再テスト | 高 |
| H-2 | SOUL.md がセッション開始時に読み込まれていない | TC-0a で直接聞く + ログ確認 | 中 |
| H-3 | OpenClaw 内蔵プロンプトが上書きしている | ベースプロンプトを調査 | 中 |
| H-4 | AGENTS.md が冗長で Decisive ルールが埋もれている | AGENTS.md を簡潔化 | 中 |
| H-5 | Slack 経由の会話でワークスペースファイルが読み込まれない | Slack セッション時のシステムプロンプト構成を調査 | 低 |

---

## テストケース

### PASS/FAIL 判定ルール

| 判定 | 基準 |
|------|------|
| **PASS** | PASS 条件を**全て**満たす |
| **FAIL** | NG パターンに**1つでも**該当、または逆質問で判断回避 |
| **RETRY** | 応答なし / タイムアウト / 応答が 10 文字未満 → 最大 2 回再試行 |

### 診断テスト（TC-0: 前提確認）

| ID | 入力 | PASS 条件 | FAIL 条件 | 目的 |
|----|------|----------|----------|------|
| TC-0a | 「SOUL.md の Decision-Making セクションの内容を教えて」 | Decisive ルールの趣旨（自分で判断する / 選択肢を並べない / 1つに決める 等）が含まれる | 「わかりません」/ 無関係な内容 / SOUL.md の内容を知らない | SOUL.md 読み込み確認 |
| TC-0b | 「今読み込んでるスキルの一覧を教えて」 | 「content-research-writer」が含まれる | スキル名が出ない / 「スキルはありません」 | スキル読み込み確認 |
| TC-0c | 「テスト送受信: こんにちは」 | 応答を取得できる（方法は問わない） | 応答が取得できない | テスト実行メカニズムの確認 |

**TC-0 が FAIL の場合**: 行動テストに進まず、まず送受信メカニズムと読み込み問題を解決する。

### Decisive 行動テスト（TC-1 〜 TC-3）

**適用範囲**: 判断・選択を求める質問のみ。事実確認（「東京の人口は？」等）には適用しない。

| ID | 入力 | PASS 条件 | FAIL 条件（NG パターン） |
|----|------|----------|----------------------|
| TC-1 | "MacBook Air と MacBook Pro、どっちを買うべき？用途はコーディングと動画編集。予算は 30 万円。" | ① 結論文に動詞（すべき/推奨）② 根拠 2 つ以上 ③ 日本語 ④ 丸投げゼロ | 「お好みで」「どちらも良い選択肢」「予算や好みによる」「用途次第」 |
| TC-2 | "Anicca アプリの次のマーケティング、TikTok と Instagram どっちに集中すべき？" | ① 1つを選択 ② 根拠 2 つ以上 ③ 日本語 ④ 丸投げゼロ | 「どちらにもメリット」「お好みで」「両方やるべき」 |
| TC-3 | "サーバーを Railway から Fly.io に移すべき？" | ① 明確な結論（移す/移さない）② 根拠 2 つ以上 ③ 日本語 ④ 丸投げゼロ | 「要件による」「どちらも良い選択肢」「状況次第」 |

### 日本語ルールテスト（TC-4 〜 TC-8）

| ID | 入力 | PASS 条件 | FAIL 条件 |
|----|------|----------|----------|
| TC-4 | "Hey what's the weather like in Tokyo today?" | 日本語話者が自然な日本語と感じる回答 | 英語で回答 |
| TC-5 | "Tell me about the latest AI news" | 日本語話者が自然な日本語と感じる回答 | 英語で回答 |
| TC-6 | "What should we do for dinner tonight? I'm thinking maybe sushi or something" | 日本語で回答（カジュアルな英語でも日本語） | 英語で回答 |
| TC-7 | "英語で答えて。What's the capital of France?" | 英語で回答 | 日本語で回答（明示的英語指示を無視） |
| TC-8 | "So basically I was thinking about, あのさ、TikTokのマーケティングをどうしようかなと思って、what do you think?" | 日本語で回答（混在入力でも日本語が基本） | 英語で回答 / 英語の文が混在 |

### テーブル形式テスト（TC-9）

| ID | 入力 | PASS 条件 | FAIL 条件 |
|----|------|----------|----------|
| TC-9 | "TikTok マーケティングの基本戦略を 5 つ教えて" | Markdown テーブル（`\|` 区切り）がメインの情報構造 | 主要情報が `- ` や `• ` の箇条書きで列挙 |

### content-research-writer テスト（TC-10）

| ID | 入力 | PASS 条件 | FAIL 条件 |
|----|------|----------|----------|
| TC-10 | "マインドフルネスについてブログ記事を書きたい。アウトライン作って" | ① テーブル形式のアウトライン（SOUL.md のテーブル形式ルールがスキルのデフォルト出力形式より優先） ② 5 セクション以上 ③ リサーチ項目（「要調査」「確認すべき」等）への言及 | 箇条書きアウトライン / 3 セクション以下 / リサーチ言及なし |

---

## テスト実施フロー

```
Phase 0: メカニズム確認
  TC-0c → 送受信が動くか
  → 動かない → 優先順位①②③を順に試す → 動くまで
  → 動く → Phase 1 へ

Phase 1: 診断
  TC-0a → SOUL.md 読み込み確認
  TC-0b → スキル読み込み確認
  → 両方 PASS → Phase 2 へ
  → FAIL → 仮説 H-2, H-5 を調査 → 修正 → Phase 1 再実施

Phase 2: 行動テスト
  TC-1 〜 TC-10 を順番に実施
  → 全 PASS → Phase 3 へ
  → FAIL → 同一原因の TC をグループ化 → 原因ごとに修正
    → 修正後、該当グループの全 TC + 以前 PASS した TC を再実施
    → 同じ TC が 3 回 FAIL → 仮説を変更して別アプローチ

  ※ SOUL.md / AGENTS.md を修正した場合は、全 TC（TC-1〜10）を再実行。
    各 TC のリトライカウントはリセット。

Phase 3: 完了確認
  全 TC の結果をテーブルで報告
  ユーザーに最終確認を求める
  → 承認 → タスク完了
```

### グループ修正ルール

| 状況 | アクション |
|------|-----------|
| TC-1/2/3 が全て FAIL（Decisive 原因） | SOUL.md の Decisive セクションを修正 → TC-1/2/3 一括再テスト |
| TC-4/5/6/8 が全て FAIL（日本語原因） | SOUL.md の Communication Style を修正 → TC-4/5/6/8 一括再テスト |
| TC-9/10 が FAIL（テーブル/スキル原因） | SOUL.md + SKILL.md を修正 → TC-9/10 一括再テスト |
| バラバラに FAIL | 各 TC の原因を個別特定して修正 |

### イテレーション上限

| ルール | 値 |
|--------|-----|
| 同一 TC の最大リトライ | 3 回（SOUL.md 修正時はリセット） |
| 全体の最大ラウンド | 5 ラウンド（1 ラウンド = SOUL.md/AGENTS.md/設定の修正 1 回 + 該当 TC グループの再実行） |
| 5 ラウンド到達時 | ユーザーに報告: FAIL 一覧 + 試したアプローチ + 次の選択肢（要件緩和 / モデル変更 / 手動設定）+ 推奨アクション |

---

## テストマトリックス

| # | ID | テストケース | 対応 AC | 状態 |
|---|-----|------------|--------|------|
| 1 | TC-0a | SOUL.md 読み込み確認 | AC-0 | 未実施 |
| 2 | TC-0b | スキル読み込み確認 | AC-0 | 未実施 |
| 3 | TC-0c | 送受信メカニズム確認 | AC-0 | 未実施 |
| 4 | TC-1 | 購入判断 Decisive | AC-1, AC-2 | 未実施 |
| 5 | TC-2 | マーケティング判断 Decisive | AC-1, AC-2 | 未実施 |
| 6 | TC-3 | 技術判断 Decisive | AC-1, AC-2 | 未実施 |
| 7 | TC-4 | 英語入力 → 日本語出力 | AC-2 | 未実施 |
| 8 | TC-5 | 英語入力 → 日本語出力 (2) | AC-2 | 未実施 |
| 9 | TC-6 | カジュアル英語 → 日本語 | AC-2 | 未実施 |
| 10 | TC-7 | 明示的英語指示 → 英語 | AC-3 | 未実施 |
| 11 | TC-8 | 混在言語入力 → 日本語 | AC-4 | 未実施 |
| 12 | TC-9 | テーブル形式確認 | AC-5 | 未実施 |
| 13 | TC-10 | content-research-writer | AC-6, AC-5 | 未実施 |

---

## As-Is / To-Be

### As-Is（現状）

| 項目 | 状態 |
|------|------|
| SOUL.md | Decisive ルール + 日本語ルール + テーブル形式 記載済み（VPS: `~/.openclaw/workspace/SOUL.md`） |
| SOUL.md Language セクション（VPS 期待状態） | 「ユーザーが英語で話しかけても必ず日本語で回答。英語で回答するのは『英語で答えて』と明示的に指示された場合のみ」が記載されていること。※リポジトリの `.cursor/plans/ios/1.6.1/SOUL.md` は旧バージョンの可能性あり。**VPS 側が正** |
| AGENTS.md | Decision Making ルール 記載済み |
| content-research-writer | `~/.openclaw/workspace/skills/content-research-writer/SKILL.md` 配置済み |
| 実際の行動 | **未検証**。Palantir 株の質問で丸投げ回答が確認されている |

### To-Be（目標）

| 項目 | 状態 |
|------|------|
| Decisive | 判断を求められたら 1 つに決めて理由を述べる（TC-1/2/3 PASS） |
| 日本語 | 英語/混在入力でも日本語回答（TC-4/5/6/8 PASS）、明示指示時のみ英語（TC-7 PASS） |
| テーブル形式 | 3 項目以上の情報整理は常にテーブル（TC-9 PASS）。短い回答は除外 |
| content-research-writer | スキルのワークフローに沿った出力（TC-10 PASS） |

---

## E2E 判定

| 項目 | 値 |
|------|-----|
| UI変更 | なし |
| 新画面 | なし |
| 新ボタン/操作 | なし |
| 結論 | Maestro E2E シナリオ: **不要**（AI エージェントの行動テストであり、iOS UI 変更を含まないため） |

---

## 境界（やらないこと）

| やらないこと | 理由 |
|-------------|------|
| Proactive 行動テスト | 単発テストでは検証不可（自発的行動は長期観察が必要）。Docker 化後に Heartbeat で継続確認 |
| ツール参照の変換（decisive-agent, aso-growth スキル） | Docker 化の後で実施（別タスク #29, #30） |
| セキュリティ設定（allowlist / DM pairing 等） | Docker 化でコンテナ分離を行うことでセキュリティを担保（別タスク #28） |
| モデル階層導入（cron を mini に） | 別タスク #32 |
| IDENTITY.md / USER.md の設定 | 優先度低、別タスク |
| cron ジョブの修正 | 前セッションで完了済み |
| 事実確認質問の Decisive 検証 | 「東京の人口は？」等は判断不要。Decisive は判断・選択を求められた場合のみ |

---

## 実行手順

| # | アクション | 依存 |
|---|-----------|------|
| 1 | 前提条件（P-1 〜 P-4）を確認 | なし |
| 2 | TC-0c: 送受信メカニズムを確認。優先順位①②③で動く方法を特定 | #1 |
| 3 | TC-0a: SOUL.md 読み込みを確認 | #2 |
| 4 | TC-0b: スキル読み込みを確認 | #2 |
| 5 | 診断結果に基づき、必要なら SOUL.md / AGENTS.md / 設定を修正 | #3, #4 |
| 6 | TC-1 〜 TC-10: 行動テストを順番に実施 | #5 |
| 7 | FAIL した TC をグループ化 → 原因修正 → グループ再テスト（上限ルール適用） | #6 |
| 8 | 全 TC の結果テーブルをユーザーに報告 | #7 |
| 9 | ユーザー承認 → タスク完了 | #8 |

---

## 重要ルール

**「ファイルを配置した」≠「完了」。Anicca の実際の出力が期待通り = 完了。**

| ルール | 詳細 |
|--------|------|
| テスト実施者 | Claude Code（SSH 経由で Anicca と会話） |
| 判定者 | 上記 PASS/FAIL 基準 + ユーザー最終確認 |
| 完了条件 | 全 13 TC が PASS + ユーザー承認 |
| FAIL 時 | 原因仮説 → グループ修正 → 再テスト。同一 TC 3 回 FAIL で方針転換 |
| SOUL.md 修正時 | 全 TC 再実行、リトライカウントリセット |
| 全体上限 | 5 ラウンド。超えたら FAIL 一覧 + 試したアプローチ + 推奨アクションをユーザーに報告 |

---

## TDD レビュー対応履歴

| レビュー | 指摘数 | 対応 |
|---------|--------|------|
| 自己レビュー（TDD ワークフロー） | 7 件 | セキュリティ記述修正、PASS基準具体化、メカニズム追加、上限追加、混在言語テスト追加 |
| サブエージェントレビュー（Sonnet） | 21 件（C:3 H:6 M:6 L:6） | CRITICAL 3件 + HIGH 6件 全対応。前提条件追加、AC-0追加、Decisive基準詳細化、日本語判定簡略化、テーブル例外条件、グループ修正ルール、セッション独立性、逆質問NG、エスカレーション基準 |
| サブエージェントレビュー 3rd（Opus） | 12 件（C:1 H:2 M:4 L:3 I:2） | C1+H2+M4+I2 全対応。SOUL.md VPS期待状態明記、TC-1を金融→非金融に変更（GPT-4oガードレール回避）、TC-10スキルvsテーブルの優先順位明記、ラウンド定義追加、TC-0aキーワード緩和、TC-1/2/3のAC-5マッピング削除、Slackタイムアウト120秒追加、E2E判定セクション追加 |
