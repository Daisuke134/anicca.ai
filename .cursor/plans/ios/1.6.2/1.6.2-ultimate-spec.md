# Anicca 1.6.2 Ultimate Implementation Specification

> **ç›®çš„**: å®Ÿè£…è€…ãŒè³ªå•ãªã—ã§å®Œå…¨å®Ÿè£…ã§ãã‚‹ãƒ¬ãƒ™ãƒ«ã®è©³ç´°ä»•æ§˜
> **RFC 2119 æº–æ‹ **: MUST, SHOULD, MAY ã‚’ä½¿ç”¨
> **æœ€çµ‚æ›´æ–°**: 2026-02-07
> **ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³**: 4ã¤ã®å°‚é–€ãƒªã‚µãƒ¼ãƒ + 2026å¹´2æœˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»ï¼ˆThompson Sampling, ãƒ¡ãƒ¢ãƒªã‚·ã‚¹ãƒ†ãƒ , AI Agent Orchestration, Cron vs Event-drivenï¼‰

---

## MASTER TASK LISTï¼ˆå®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼‰

> **ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå…¨ã¦ã®çœŸå®Ÿã€‚è¿·ã£ãŸã‚‰ã“ã“ã‚’è¦‹ã‚‹ã€‚**

### Phase 1: Spec æ›´æ–°ï¼ˆè¨­è¨ˆå®Œäº†ï¼‰

| # | ã‚¿ã‚¹ã‚¯ | å†…å®¹ | çŠ¶æ…‹ |
|---|--------|------|------|
| 1.1 | **7.5 Verify + Learn Pattern** | å®Ÿè¡Œâ†’5ç§’å¾Œç¢ºèªâ†’24hå¾Œã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆå–å¾—â†’å­¦ç¿’è¨˜éŒ² | âœ… |
| 1.2 | **7.6 shared-learnings æ§‹é€ ** | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  + å„ã‚¹ã‚­ãƒ«ãŒè¨˜éŒ²ã™ã‚‹å†…å®¹ | âœ… |
| 1.3 | **7.7 Recursive Content Loop** | ç”Ÿæˆâ†’è©•ä¾¡â†’è¨ºæ–­â†’æ”¹å–„â†’4/5ä»¥ä¸Šã¾ã§ç¹°ã‚Šè¿”ã—ï¼ˆæœ€å¤§5å›ï¼‰ | âœ… |
| 1.4 | **7.8 å¤–éƒ¨ã‚¹ã‚­ãƒ«åˆ©ç”¨æ–¹é‡** | Remotion=YESï¼ˆå‹•ç”»ç”Ÿæˆï¼‰ã€Bird=NOï¼ˆCookie=BANãƒªã‚¹ã‚¯ï¼‰ | âœ… |
| 1.5 | **7.9 Buddhaæ±åŒ–å±¤ + Closed Loop** | ONE FLESH: å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¾ªç’°ã™ã‚‹çµ±åˆã‚·ã‚¹ãƒ†ãƒ  | âœ… |
| 1.6 | **X API é€£æºä»•æ§˜** | å…¬å¼OAuth 2.0ã€**ç›´æ¥è¿”ä¿¡ç¦æ­¢**ï¼ˆBotæ‰±ã„+BANãƒªã‚¹ã‚¯ï¼‰ | âœ… |
| 1.7 | **TikTok API é€£æºä»•æ§˜** | å…¬å¼Content Posting APIã€2æ®µéšæŠ•ç¨¿ï¼ˆreserveâ†’postï¼‰ | âœ… |

### Phase 2: proactive-agent ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

| # | ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ | çŠ¶æ…‹ |
|---|---------|------|------|
| 2.1 | **SOUL.md** | Anicca ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆè²¬ã‚ãªã„ã€å¯„ã‚Šæ·»ã†ã€Buddhaå“²å­¦ï¼‰ | â¬œ |
| 2.2 | **USER.md** | ãƒšãƒ«ã‚½ãƒŠæƒ…å ±ï¼ˆ6-7å¹´æŒ«æŠ˜ã€25-35æ­³ã€è‡ªå·±å«Œæ‚ªãƒ«ãƒ¼ãƒ—ï¼‰ | â¬œ |
| 2.3 | **HEARTBEAT.md** | å®šæœŸãƒã‚§ãƒƒã‚¯ï¼ˆãƒ­ã‚°ç¢ºèªã€proactive surpriseã€å­¦ç¿’æ›´æ–°ï¼‰ | â¬œ |

### Phase 3: VPS ã‚¹ã‚­ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤

| # | ã‚¹ã‚­ãƒ« | æ©Ÿèƒ½ | çŠ¶æ…‹ |
|---|--------|------|------|
| 3.1 | **x-poster** | Thompson Sampling + content-verifier + X API æŠ•ç¨¿ | â¬œ |
| 3.2 | **trend-hunter** | X API æ¤œç´¢ + è‹¦ã—ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ + è¨˜éŒ² | â¬œ |
| 3.3 | **suffering-detector** | æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ â†’ è‹¦ã—ã¿ã‚¹ã‚³ã‚¢åˆ¤å®š | â¬œ |
| 3.4 | **tiktok-poster** | Nudgeã‚«ãƒ¼ãƒ‰ç”»åƒ + TikTok API æŠ•ç¨¿ | â¬œ |
| 3.5 | **app-nudge-sender** | æ¤œå‡ºã—ãŸè‹¦ã—ã¿ â†’ ã‚¢ãƒ—ãƒªãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Nudge | â¬œ |

### Phase 4: å¾Œã§

| # | ã‚¿ã‚¹ã‚¯ | çŠ¶æ…‹ |
|---|--------|------|
| 4.1 | Moltbook å‚åŠ æ¤œè¨ | â¬œ å¾Œã§ |

---

### ä¾å­˜é–¢ä¿‚ï¼ˆå®Ÿè¡Œé †åºï¼‰

```
Phase 1 (Spec æ›´æ–°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”œâ”€â”€ 1.1-1.7: ä¸¦åˆ—ã§å…¨éƒ¨æ›¸ã‘ã‚‹                                â”‚
â”‚                                                            â”‚
â–¼                                                            â”‚
Phase 2 (proactive-agent) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”œâ”€â”€ Spec å®Œäº†å¾Œã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º                                â”‚
â”‚                                                            â”‚
â–¼                                                            â”‚
Phase 3 (VPS ãƒ‡ãƒ—ãƒ­ã‚¤) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”œâ”€â”€ skill-creator ã§ã‚¹ã‚­ãƒ«ä½œæˆ                               â”‚
â”œâ”€â”€ VPS (46.225.70.241) ã«é…ç½®                               â”‚
â””â”€â”€ cron è¨­å®š                                                â”‚
â”‚                                                            â”‚
â–¼                                                            â”‚
Phase 4 (Moltbook) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ç¢ºå®šäº‹é …ï¼ˆä¸ç¢ºå®Ÿæ€§ã‚¼ãƒ­ï¼‰

| è³ªå• | ç­”ãˆ | ç†ç”± |
|------|------|------|
| VPS å‹•ã„ã¦ã‚‹ï¼Ÿ | âœ… YES | `46.225.70.241` ã§24æ™‚é–“ç¨¼åƒä¸­ |
| OpenClaw å‹•ã„ã¦ã‚‹ï¼Ÿ | âœ… YES | Gateway + Slack æ¥ç¶šæ¸ˆã¿ |
| X API ä½¿ã†ï¼Ÿ | âœ… YES | å…¬å¼ OAuth 2.0ï¼ˆCookieç¦æ­¢ï¼‰ |
| Bird ã‚¹ã‚­ãƒ«ä½¿ã†ï¼Ÿ | âŒ NO | Cookie ãƒ™ãƒ¼ã‚¹ = BAN ãƒªã‚¹ã‚¯ |
| TikTok API ä½¿ã†ï¼Ÿ | âœ… YES | å…¬å¼ Content Posting API |
| **ç›´æ¥è¿”ä¿¡ã™ã‚‹ï¼Ÿ** | âŒ **NO** | Bot æ‰±ã„ + BAN ãƒªã‚¹ã‚¯ã€‚æŠ•ç¨¿ã®ã¿ |
| Buddhaå±¤ã¨Learningã¯åˆ¥ï¼Ÿ | âŒ NO | ONE FLESHï¼ˆå¾ªç’°ã‚·ã‚¹ãƒ†ãƒ ï¼‰ |
| Remotion ä½¿ã†ï¼Ÿ | âœ… YES | TikTokå‹•ç”»ç”Ÿæˆï¼ˆClawHubå®Ÿç¸¾ã‚ã‚Šï¼‰ |
| memU ã¯ Skillï¼Ÿ | âŒ NO | Serviceï¼ˆå…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ |

---

## 0.0 Specæ€§è³ªï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–ï¼‰

> **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è¨­è¨ˆä»•æ§˜æ›¸ï¼ˆProspective Design Specï¼‰ã§ã‚ã‚Šã€ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹ã®è¨˜è¿°ã§ã¯ãªã„ã€‚**

| é …ç›® | èª¬æ˜ |
|------|------|
| **æ€§è³ª** | To-Beè¨­è¨ˆã€‚å®Ÿè£…ã¯ã“ã®Specã«åŸºã¥ã„ã¦è¡Œã‚ã‚Œã‚‹ |
| **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«** | Specã«è¨˜è¼‰ã®ãƒ‘ã‚¹ã¯ã€Œä½œæˆã™ã¹ãå ´æ‰€ã€ã§ã‚ã‚Šã€å®Ÿè£…Phaseé–‹å§‹æ™‚ã«ä½œæˆã•ã‚Œã‚‹ |
| **fixtures/mocks** | TDDé–‹å§‹æ™‚ã«Specé€šã‚Šã®ãƒ‘ã‚¹ã«ä½œæˆã•ã‚Œã‚‹ |
| **schedule.yaml/SKILL.md** | Phase 4é–‹å§‹æ™‚ã«ãƒªãƒã‚¸ãƒˆãƒªã«è¿½åŠ ã•ã‚Œã‚‹ï¼ˆJ7/J26ãƒ†ã‚¹ãƒˆã®å‰ææ¡ä»¶ï¼‰ |
| **Maestro E2E** | UIå®Ÿè£…å®Œäº†å¾Œã«ä½œæˆã•ã‚Œã‚‹ |

**Codex TDDãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¦³ç‚¹:**
1. âœ… Specå†…ã®æ•´åˆæ€§ï¼ˆTo-BeåŒå£«ã®çŸ›ç›¾ãŒãªã„ã‹ï¼‰
2. âœ… ãƒ†ã‚¹ãƒˆãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ç¶²ç¾…æ€§ï¼ˆå…¨To-Beã«ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ã‹ï¼‰
3. âœ… TDDå®Ÿè¡Œå¯èƒ½æ€§ï¼ˆfixtures/mocks/ã‚³ãƒãƒ³ãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ï¼‰
4. âŒ ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®æ¯”è¼ƒï¼ˆã“ã‚Œã¯å®Ÿè£…å¾Œã®GATE 3ã§è¡Œã†ï¼‰

---

## 0. Executive Summary

| é …ç›® | å†…å®¹ |
|------|------|
| **ã‚´ãƒ¼ãƒ«** | 24/7ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä»æ•™ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ã€è‹¦ã—ã¿ã®ã‚ã‚‹å ´æ‰€ã«è‡ªã‚‰è¡Œãã€Nudgeã™ã‚‹ |
| **ã‚³ã‚¢ãƒ‘ã‚¿ãƒ¼ãƒ³** | Gatewayåˆ¶å¾¡ãƒ—ãƒ¬ãƒ¼ãƒ³ + 3å±¤ãƒ¡ãƒ¢ãƒª + Workflowå„ªå…ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ |
| **ãƒ‡ãƒ—ãƒ­ã‚¤** | **VPS (46.225.70.241) ã§24æ™‚é–“ç¨¼åƒä¸­** + Railway (API/DBç¶­æŒ) |
| **ã‚³ã‚¹ãƒˆç›®æ¨™** | LLMãƒˆãƒ¼ã‚¯ãƒ³90%å‰Šæ¸›ï¼ˆMem0 v2.0å®Ÿè¨¼æ¸ˆã¿: +26%ç²¾åº¦, -91%ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼‰ |
| **å“è³ªç›®æ¨™** | æŠ•ç¨¿ã‚¹ã‚³ã‚¢ >= 3/5 ã®ã¿å…¬é–‹ï¼ˆmax 3 retryï¼‰ |

---

## 0.2 æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆ2026-02-05æ™‚ç‚¹ï¼‰

> **é‡è¦**: OpenClawã¯VPS (46.225.70.241) ã§24æ™‚é–“ç¨¼åƒä¸­ã€‚systemd user service + lingeringã€‚

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | çŠ¶æ…‹ | è©³ç´° |
|---------------|------|------|
| **OpenClaw Gateway** | âœ… ç¨¼åƒä¸­ | VPS systemd user service (46.225.70.241:18789) |
| **Slacké€£æº** | âœ… å®Œäº† | #metrics (C091G3PKHL2), #ai (C08RZ98SBUL) |
| **Cronã‚¸ãƒ§ãƒ–åŸºç›¤** | âœ… å®Œäº† | `~/.openclaw/cron/jobs.json` |
| **SkillåŸºç›¤** | âœ… å®Œäº† | `~/.openclaw/workspace/skills/` (VPS) + `/usr/lib/node_modules/openclaw/skills/` (bundled) |
| **Railway API** | âœ… ç¨¼åƒä¸­ | Staging + Production |
| **PostgreSQL** | âœ… ç¨¼åƒä¸­ | Railway + Prisma |

### OpenClaw ç¾çŠ¶

| é …ç›® | å€¤ |
|------|-----|
| Config | `~/.openclaw/openclaw.json` (VPS: `/home/anicca/.openclaw/openclaw.json`) |
| Skills (workspace) | `~/.openclaw/workspace/skills/` |
| Skills (bundled) | `/usr/lib/node_modules/openclaw/skills/` |
| Logs | `~/.openclaw/logs/` (VPS) |
| Gateway å†èµ·å‹• | `ssh anicca@46.225.70.241 "export XDG_RUNTIME_DIR=/run/user/\$(id -u) && systemctl --user restart openclaw-gateway"` |
| ã‚¹ã‚­ãƒ«ä¸€è¦§ | `openclaw skills list` |
| Cronã‚¸ãƒ§ãƒ–ä¸€è¦§ | `openclaw cron list` |

### ã‚¹ã‚­ãƒ«ä½œæˆãƒ«ãƒ¼ãƒ«

| ãƒ«ãƒ¼ãƒ« | è©³ç´° |
|--------|------|
| **skill-creator ã‚’ä½¿ã†** | æ‰‹å‹•ã§ SKILL.md ã‚’æ›¸ããª |
| **å°‚ç”¨ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†** | exec ã§ä»£ç”¨ã™ã‚‹ãªï¼ˆslack, read, write ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†ï¼‰ |
| **æ—¢å­˜ã‚¹ã‚­ãƒ«ã‚’å‚è€ƒã«** | `/usr/lib/node_modules/openclaw/skills/slack/SKILL.md` (VPS bundled) |

### OpenClaw æœªæ´»ç”¨æ©Ÿèƒ½ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª¿æŸ» 2026-02-07ï¼‰

> **3ã¤ã®ä¸¦åˆ—ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ docs.openclaw.ai ã® 20+ ãƒšãƒ¼ã‚¸ã‚’èª¿æŸ»ã—ãŸçµæœ**

| # | æ©Ÿèƒ½ | å½±éŸ¿åº¦ | ç¾çŠ¶ | å¯¾å‡¦ |
|---|------|--------|------|------|
| 1 | **Memory** | æœ€é«˜ | MEMORY.md æœªä½œæˆã€æ—¥æ¬¡ãƒ­ã‚°ãªã— | workspace ã« MEMORY.md ä½œæˆ + memoryFlush æœ‰åŠ¹åŒ– |
| 2 | **Heartbeat** | æœ€é«˜ | every: "0m"ï¼ˆç„¡åŠ¹ï¼‰ã€HEARTBEAT.md æœªä½œæˆ | every: "30m" + HEARTBEAT.md + activeHours |
| 3 | **session-memory hook** | é«˜ | æœªæœ‰åŠ¹åŒ– | config ã§ enabled: true |
| 4 | **Vector memory search** | é«˜ | ç„¡åŠ¹ | memorySearch.provider: "openai" |
| 5 | **groupPolicy** | é«˜ | "open"ï¼ˆèª°ã§ã‚‚DMå¯èƒ½ï¼‰ | "allowlist" ã«å¤‰æ›´ |
| 6 | **Cron delivery** | ä¸­ | mode: "none" + execæ‰‹å‹• | mode: "announce" æ¨å¥¨ |
| 7 | **BOOT.md** | ä¸­ | æœªä½œæˆ | Gatewayå†èµ·å‹•æ™‚ã®è‡ªå‹•åˆæœŸåŒ– |
| 8 | **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»** | ä¸­ | æœªå®Ÿè¡Œ | `openclaw security audit --deep` |
| 9 | **mDNS** | ä½ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | minimal or off |
| 10 | **bestEffort** | ä½ | æœªè¨­å®š | delivery.bestEffort: true |

**è©³ç´°:** `.cursor/plans/reference/openclaw-learnings.md`

---

## 0.1 Architecture Before/After

### BEFORE (v1.6.1 - Railway Cron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   iOS App    â”‚â”€â”€â”€â”€â–¶â”‚  Railway API â”‚â”€â”€â”€â”€â–¶â”‚  PostgreSQL  â”‚
â”‚  (SwiftUI)   â”‚â—€â”€â”€â”€â”€â”‚   (Node.js)  â”‚â—€â”€â”€â”€â”€â”‚   (Prisma)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ Railway Cron â”‚
                     â”‚  (06:00 JST) â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼               â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ LLM Nudge  â”‚  â”‚ Rule-based â”‚  â”‚    STO     â”‚
     â”‚ Generator  â”‚  â”‚   Nudge    â”‚  â”‚ (æ™‚åˆ»æœ€é©åŒ–)â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å•é¡Œç‚¹:
â”œâ”€ âŒ å˜ä¸€LLMï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰
â”œâ”€ âŒ Hooké¸æŠãŒãƒ©ãƒ³ãƒ€ãƒ ï¼ˆæœ€é©åŒ–ãªã—ï¼‰
â”œâ”€ âŒ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å“è³ªæ¤œè¨¼ãªã—
â”œâ”€ âŒ ãƒ¡ãƒ¢ãƒªãªã—ï¼ˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºé™å®šçš„ï¼‰
â”œâ”€ âŒ X/TikTokæŠ•ç¨¿ã¯æ‰‹å‹•
â””â”€ âŒ ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ã‚°ã®ã¿ï¼ˆDLQãªã—ï¼‰
```

### AFTER (v1.6.2 - OpenClaw Skills)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         v1.6.2 ARCHITECTURE                                  â”‚
â”‚                    (OpenClaw + Workflow-First Design)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Hetzner VPS       â”‚
                              â”‚  (Tailscale Mesh)   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenClaw Gateway      â”‚  â”‚   Railway API   â”‚  â”‚     PostgreSQL      â”‚
â”‚  (localhost:18789)      â”‚  â”‚   (Node.js)     â”‚  â”‚  + memU Tables      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚                 â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ Sessionç®¡ç†          â”‚  â”‚  æ—¢å­˜APIç¶­æŒ    â”‚  â”‚  â€¢ memoryResource   â”‚
â”‚  â€¢ Skill Orchestration  â”‚  â”‚  + æ–°ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆâ”‚  â”‚  â€¢ memoryItem       â”‚
â”‚  â€¢ Cron Scheduler       â”‚  â”‚                 â”‚  â”‚  â€¢ memoryCategory   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                                      â”‚
          â–¼                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SCHEDULED SKILLS               â”‚    â”‚    HELPER SKILLS        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  x-poster   â”‚  â”‚tiktok-posterâ”‚           â”‚    â”‚  â”‚ Dynamic Prior   â”‚   â”‚
â”‚  â”‚ 09:00/21:00 â”‚  â”‚   20:00     â”‚           â”‚    â”‚  â”‚ Thompson        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚  â”‚ Sampling        â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚app-nudge-   â”‚  â”‚ suffering-detector  â”‚   â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  sender     â”‚  â”‚  (5min heartbeat)   â”‚   â”‚    â”‚  â”‚ Content         â”‚   â”‚
â”‚  â”‚  (hourly)   â”‚  â”‚                     â”‚   â”‚    â”‚  â”‚ Verifier        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚  â”‚ (score â‰¥ 3/5)   â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                                   â”‚  â”‚ memU Service    â”‚   â”‚
                                                   â”‚  â”‚ (3-Layer Memory)â”‚   â”‚
                                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                                   â”‚  â”‚ Nia (Wisdom)    â”‚   â”‚
                                                   â”‚  â”‚ Buddhist Texts  â”‚   â”‚
                                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”¹å–„ç‚¹:
â”œâ”€ âœ… Dynamic Prior Thompson Samplingï¼ˆ2026å¹´2æœˆè«–æ–‡: +0.19% CTR, -21% Regretï¼‰
â”œâ”€ âœ… Content Verifierï¼ˆscore â‰¥ 3/5, max 3 retryï¼‰
â”œâ”€ âœ… 3-Layer memUï¼ˆMem0 v2.0å®Ÿè¨¼: 90%ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›ï¼‰
â”œâ”€ âœ… DLQ + Circuit Breaker + Retryï¼ˆEnterpriseæ¨™æº–ï¼‰
â”œâ”€ âœ… LLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆOpenAI â†’ Anthropic â†’ Groqï¼‰
â”œâ”€ âœ… è‡ªå‹•SNSæŠ•ç¨¿ï¼ˆx-poster, tiktok-posterï¼‰
â””â”€ âœ… suffering-detectorï¼ˆ5min heartbeatï¼‰
```

### Key Architectural Decisions (2026å¹´2æœˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»ã«åŸºã¥ã)

| æ±ºå®šäº‹é … | é¸æŠ | æ ¹æ‹  |
|---------|------|------|
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** | Workflow-first + Agentä¾‹å¤– | Anthropic BP: äºˆæ¸¬å¯èƒ½æ€§ãƒ»ã‚³ã‚¹ãƒˆãƒ»ä¿¡é ¼æ€§ |
| **Hooké¸æŠ** | Dynamic Prior Thompson Sampling | 2026å¹´2æœˆarxivè«–æ–‡: ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­– |
| **ãƒ¡ãƒ¢ãƒª** | 3-Layer hierarchical + Consolidation | Mem0 v2.0: 90%ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›å®Ÿè¨¼ |
| **ã‚¨ãƒ©ãƒ¼å‡¦ç†** | Retry(æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•+Jitter) + Circuit Breaker + DLQ | Polly/Dapr Enterpriseæ¨™æº– |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | Railway API/DB + Hetzner VPS (OpenClaw) | ã‚³ã‚¹ãƒˆæœ€é© + é•·æ™‚é–“å®Ÿè¡Œå¯¾å¿œ |

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ±ºå®šè¨˜éŒ² (ADR)

### ADR-001: Workflows vs Agents

**æ±ºå®š**: Workflowå„ªå…ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨

| åŸºæº– | Workflow | Agent | Aniccaé¸æŠ |
|------|----------|-------|------------|
| **äºˆæ¸¬å¯èƒ½æ€§** | é«˜ï¼ˆäº‹å‰å®šç¾©ãƒ‘ã‚¹ï¼‰ | ä½ï¼ˆå‹•çš„åˆ¤æ–­ï¼‰ | âœ… Workflow |
| **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | ä½ | é«˜ | âœ… Workflow |
| **ã‚³ã‚¹ãƒˆ** | ä½ | é«˜ | âœ… Workflow |
| **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§** | é«˜ | ä½ | âœ… Workflow |
| **æŸ”è»Ÿæ€§** | ä½ | é«˜ | AgentãŒæœ‰åˆ©ã ãŒä¸è¦ |

**æ ¹æ‹ **: Anthropic "Building Effective Agents" ã‚ˆã‚Šã€Œå¯èƒ½ãªé™ã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªè§£æ±ºç­–ã‹ã‚‰å§‹ã‚ã‚‹ã€

**ä¾‹å¤–**: ä»¥ä¸‹ã®å ´åˆã®ã¿Agentä½¿ç”¨
- è‹¦ã—ã¿æŠ•ç¨¿ã¸ã®è¿”ä¿¡ç”Ÿæˆï¼ˆæ–‡è„ˆä¾å­˜æ€§ãŒé«˜ã„ï¼‰
- ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿”ä¿¡ç”Ÿæˆï¼ˆé¡§å®¢å¯¾å¿œã®ç¹Šç´°ã•ï¼‰

### ADR-002: Cron vs Heartbeat

**æ±ºå®š**: ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã«å¿œã˜ã¦ä½¿ã„åˆ†ã‘

| ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ | ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ | ç†ç”± |
|-----------|-------------|------|
| **x-poster** | Cron (isolated) | æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°å¿…é ˆã€æ–‡è„ˆä¸è¦ |
| **tiktok-poster** | Cron (isolated) | åŒä¸Š |
| **trend-hunter** | Cron (interval) | 4æ™‚é–“é–“éš”ã€ç‹¬ç«‹å®Ÿè¡Œ |
| **feedback-fetch** | Cron (interval) | 4æ™‚é–“é–“éš”ã€ç‹¬ç«‹å®Ÿè¡Œï¼ˆ**v1.6.3ã‚¹ã‚³ãƒ¼ãƒ—**ï¼‰ |
| **suffering-detector** | Heartbeat | æœ€æ–°ã®ä¼šè©±æ–‡è„ˆãŒå¿…è¦ |
| **moltbook-responder** | Heartbeat | ä¼šè©±ç¶™ç¶šæ€§ãŒå¿…è¦ï¼ˆ**v1.6.3ã‚¹ã‚³ãƒ¼ãƒ—**ï¼‰ |

**Moltbotç ”ç©¶ã‹ã‚‰ã®åˆ¤æ–­åŸºæº–**:
- æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒå¿…è¦ â†’ Cron (isolated)
- ä¼šè©±æ–‡è„ˆãŒå¿…è¦ â†’ Heartbeat (main session)
- ç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«/è¨­å®šãŒå¿…è¦ â†’ Cron (isolated)
- ãƒãƒ£ãƒ³ãƒãƒ«é…ä¿¡ãŒå¿…è¦ â†’ Cron with delivery

### ADR-003: ãƒ¡ãƒ¢ãƒªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**æ±ºå®š**: memU 3å±¤éšå±¤ã‚’æ¡ç”¨

```
memory/
â”œâ”€â”€ categories/              â† Category Layerï¼ˆè¦ç´„ãƒ»çµ±åˆï¼‰
â”‚   â”œâ”€â”€ preferences/
â”‚   â”‚   â”œâ”€â”€ morning_nudges.md
â”‚   â”‚   â””â”€â”€ tone_preferences.md
â”‚   â””â”€â”€ behaviors/
â”‚       â”œâ”€â”€ engagement_patterns.md
â”‚       â””â”€â”€ timing_responses.md
â”œâ”€â”€ items/                   â† Item Layerï¼ˆç´°ç²’åº¦ãƒ¡ãƒ¢ãƒªï¼‰
â”‚   â”œâ”€â”€ item_001.json       # "strict tone at 6am gets thumbs_up"
â”‚   â””â”€â”€ item_002.json       # "gentle tone works for anxiety"
â””â”€â”€ resources/              â† Resource Layerï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
    â”œâ”€â”€ nudge_feedback_123.json
    â””â”€â”€ behavior_event_456.json
```

**ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ**:
- ç¾åœ¨: æ¯å›å…¨å±¥æ­´ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹ â†’ 100%ã‚³ã‚¹ãƒˆ
- memUå¾Œ: Category â†’ Item â†’ Resource ã®éšå±¤çš„æ¤œç´¢ â†’ 10-20%ã‚³ã‚¹ãƒˆ

#### Prisma Schema (memU ãƒ†ãƒ¼ãƒ–ãƒ«)

> **å®Ÿè£…æ™‚ã®é©å¿œè¦ç´„**:
> - **FKå‚ç…§å…ˆ**: `userId` ã¯ `String @db.Uuid` ã¨ã—ã¦å®šç¾©ã€‚FKåˆ¶ç´„ã¯è¨­ã‘ãšã‚¢ãƒ—ãƒªå±¤ã§æ•´åˆæ€§ã‚’æ‹…ä¿ï¼ˆæ—¢å­˜ã® `UserSubscription.userId` ã¨åŒã˜å½¢å¼ï¼‰
> - **å‹**: `@db.Uuid @default(dbgenerated("gen_random_uuid()"))`, `@db.Timestamptz @default(now())`
> - **å‘½å**: `@map("snake_case")`, `@@map("table_names")`
> - **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: SQLæ‰‹å‹•é©ç”¨ + `prisma db pull`ï¼ˆv0.3æ–¹é‡ï¼‰

```prisma
// apps/api/prisma/schema.prisma ã«è¿½åŠ 
// å®Ÿè£…ä¾‹ï¼ˆæ—¢å­˜è¦ç´„é©ç”¨æ¸ˆã¿ï¼‰

model MemoryResource {
  id          String   @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  userId      String   @db.Uuid @map("user_id")  // FKåˆ¶ç´„ãªã—ã€ã‚¢ãƒ—ãƒªå±¤ã§æ•´åˆæ€§æ‹…ä¿
  type        String   @db.VarChar(50) @map("type")
  content     Json     @db.JsonB @map("content")
  metadata    Json?    @db.JsonB @map("metadata")
  createdAt   DateTime @db.Timestamptz @default(now()) @map("created_at")

  items       MemoryItem[]

  @@index([userId, type])
  @@index([createdAt])
  @@map("memory_resources")
}

model MemoryItem {
  id           String   @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  userId       String   @db.Uuid @map("user_id")
  resourceId   String   @db.Uuid @map("resource_id")
  content      String   @map("content")
  embedding    Bytes?   @map("embedding")  // text-embedding-3-small (1536 dims)
  categoryId   String?  @db.Uuid @map("category_id")
  relevance    Float    @default(1.0) @map("relevance")
  createdAt    DateTime @db.Timestamptz @default(now()) @map("created_at")
  updatedAt    DateTime @db.Timestamptz @updatedAt @map("updated_at")

  resource     MemoryResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  category     MemoryCategory? @relation(fields: [categoryId], references: [id])

  @@index([userId, categoryId])
  @@index([userId, createdAt])
  @@map("memory_items")
}

model MemoryCategory {
  id               String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  userId           String    @db.Uuid @map("user_id")
  name             String    @db.VarChar(255) @map("name")
  summary          String    @map("summary")
  itemCount        Int       @default(0) @map("item_count")
  lastSummarizedAt DateTime? @db.Timestamptz @map("last_summarized_at")
  createdAt        DateTime  @db.Timestamptz @default(now()) @map("created_at")
  updatedAt        DateTime  @db.Timestamptz @updatedAt @map("updated_at")

  items            MemoryItem[]

  @@unique([userId, name])
  @@index([userId])
  @@map("memory_categories")
}
```

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥**:

| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | ç”¨é€” |
|-------------|------|
| `userId, type` on Resource | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒªã‚½ãƒ¼ã‚¹æ¤œç´¢ |
| `userId, categoryId` on Item | ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¢ã‚¤ãƒ†ãƒ æ¤œç´¢ |
| `userId, createdAt` on Item | æ™‚ç³»åˆ—æ¤œç´¢ï¼ˆDiscounted TSç”¨ï¼‰ |

**åŸ‹ã‚è¾¼ã¿æ¤œç´¢**: 1.6.2ã§ã¯text-embedding-3-smallã§`MemoryItem.embedding`ã‚’ç”Ÿæˆã—ã€ã‚¢ãƒ—ãƒªå±¤ã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—ã‚’å®Ÿè¡Œã€‚pgvectorã¯æœ¬ç•ªã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã«æ¤œè¨ã€‚

#### Prisma Schema (Hook/Post ãƒ†ãƒ¼ãƒ–ãƒ«)

> **æ—¢å­˜è¦ç´„ã«æº–æ‹ ã—ãŸå®šç¾©**ï¼ˆ@map/@@map/@db.Uuid/@db.Timestamptzé©ç”¨æ¸ˆã¿ï¼‰

```prisma
// apps/api/prisma/schema.prisma ã«è¿½åŠ 

enum ProblemType {
  staying_up_late
  cant_wake_up
  self_loathing
  rumination
  procrastination
  anxiety
  lying
  bad_mouthing
  porn_addiction
  alcohol_dependency
  anger
  obsessive
  loneliness
}

enum HookPlatform {
  x
  tiktok
}

model Hook {
  id            String       @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  content       String       @db.VarChar(500) @map("content")
  problemType   ProblemType  @map("problem_type")
  source        String?      @db.VarChar(50) @map("source")
  metadata      Json?        @db.JsonB @map("metadata")

  // Thompson Sampling stats
  successCount  Int          @default(0) @map("success_count")
  failureCount  Int          @default(0) @map("failure_count")
  avgEngagement Float?       @map("avg_engagement")
  lastUsedAt    DateTime?    @db.Timestamptz @map("last_used_at")

  createdAt     DateTime     @db.Timestamptz @default(now()) @map("created_at")
  updatedAt     DateTime     @db.Timestamptz @updatedAt @map("updated_at")

  posts         HookPost[]

  @@index([problemType])
  @@index([createdAt])
  @@map("hooks")
}

model HookPost {
  id                String       @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  platform          HookPlatform @map("platform")
  hookId            String       @db.Uuid @map("hook_id")
  content           String       @db.Text @map("content")
  mediaUrl          String?      @db.VarChar(500) @map("media_url")
  externalPostId    String?      @db.VarChar(255) @map("external_post_id")
  verificationScore Int          @map("verification_score")
  relevance         Float        @default(1.0) @map("relevance")  // TTLã‚¯ãƒªãƒ¼ãƒŠãƒ¼ç”¨ï¼ˆ< 0.1 ã§30æ—¥å¾Œå‰Šé™¤å¯¾è±¡ï¼‰

  createdAt         DateTime     @db.Timestamptz @default(now()) @map("created_at")

  hook              Hook         @relation(fields: [hookId], references: [id], onDelete: Cascade)

  @@index([platform, createdAt])
  @@index([hookId])
  @@index([relevance, createdAt])  // TTLã‚¯ãƒªãƒ¼ãƒŠãƒ¼ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  @@map("hook_posts")
}

// TTLå‰Šé™¤å‰ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«
model HookPostArchive {
  id                String       @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  originalId        String       @db.Uuid @map("original_id")
  platform          HookPlatform @map("platform")
  hookId            String       @db.Uuid @map("hook_id")
  content           String       @db.Text @map("content")
  mediaUrl          String?      @db.VarChar(500) @map("media_url")
  externalPostId    String?      @db.VarChar(255) @map("external_post_id")
  verificationScore Int          @map("verification_score")
  relevance         Float        @map("relevance")
  originalCreatedAt DateTime     @db.Timestamptz @map("original_created_at")
  archivedAt        DateTime     @db.Timestamptz @default(now()) @map("archived_at")

  @@index([originalId])
  @@map("hook_post_archives")
}
```

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡**:
> **v0.3æ³¨æ„**: Prisma Migrateä¸»å°ã§ã¯ãªã„ã€‚SQLæ‰‹å‹•é©ç”¨ã¾ãŸã¯Drizzleç§»è¡Œå¾Œã«å¯¾å¿œã€‚

1. SQLæ‰‹å‹•ä½œæˆ: `CREATE TABLE hooks (...)`, `CREATE TABLE hook_posts (...)`
2. `prisma db pull` ã§ã‚¹ã‚­ãƒ¼ãƒåŒæœŸ
3. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—ï¼ˆæ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ï¼‰
4. TTL/ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–: `relevance < 0.1` ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯30æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤ï¼ˆCronã‚¸ãƒ§ãƒ–ï¼‰

---

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°è¨­è¨ˆ

### 2.1 Gatewayåˆ¶å¾¡ãƒ—ãƒ¬ãƒ¼ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ANICCA GATEWAY (VPS)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      OpenClaw Gateway                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ WebSocket Server (ws://127.0.0.1:18789)                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Typed protocol (TypeBox schemas)                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Session management                                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Tool orchestration                                             â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                  â”‚                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                       SESSION MANAGER                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Sessions:                                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ main           â†’ DMå¯¾è©±ï¼ˆHeartbeatã‚¿ã‚¹ã‚¯ï¼‰                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ cron:x-poster  â†’ æŠ•ç¨¿ã‚¸ãƒ§ãƒ–ï¼ˆisolatedï¼‰                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ cron:trend     â†’ ãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦–ï¼ˆisolatedï¼‰                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ hook:uuid      â†’ Webhookå‡¦ç†ï¼ˆä¸€æ™‚çš„ï¼‰                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Session Isolation Matrix:                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Session         â”‚ Tool Accessâ”‚ Memory      â”‚ Delivery   â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ main            â”‚ Full       â”‚ Shared      â”‚ Slack      â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ cron:*          â”‚ Scoped     â”‚ Isolated    â”‚ Optional   â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ hook:*          â”‚ Minimal    â”‚ None        â”‚ Callback   â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                  â”‚                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚                       CRON SCHEDULER                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Storage: ~/.openclaw/cron/jobs.json                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  History: ~/.openclaw/cron/runs/<jobId>.jsonl                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Job Types:                                                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ at: ä¸€å›é™ã‚Š (ISO 8601 timestamp)                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ every: å›ºå®šé–“éš” (ms)                                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ cron: 5ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¼ + ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³                         â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Execution Modes:                                              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ systemEvent: main session ã«ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ agentTurn: å°‚ç”¨ cron:<jobId> session ã§å®Ÿè¡Œ               â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚                                      â†“ ANICCA_AGENT_TOKEN                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


## 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 3.1 å¤šå±¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Moltbotç ”ç©¶ã‚ˆã‚Š)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SECURITY LAYERS                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Layer 1: Network Access                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Gateway bind: loopback only (127.0.0.1:18789)                       â”‚  â”‚
â”‚  â”‚ â€¢ Remote: Tailscale Serve (private) / Funnel (public)                â”‚  â”‚
â”‚  â”‚ â€¢ Auth: Token-based (ANICCA_AGENT_TOKEN)                             â”‚  â”‚
â”‚  â”‚ â€¢ TLS: Tailscale handles, or reverse proxy                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  Layer 2: Session Isolation                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Main session: Full access, trusted                                  â”‚  â”‚
â”‚  â”‚ â€¢ Cron sessions: Scoped tools, isolated memory                       â”‚  â”‚
â”‚  â”‚ â€¢ Hook sessions: Minimal tools, no persistent state                  â”‚  â”‚
â”‚  â”‚ â€¢ Sandboxing: Docker containers for untrusted execution              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  Layer 3: Tool Access Control                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Per-skill tool allow/deny lists                                     â”‚  â”‚
â”‚  â”‚ â€¢ Elevated mode for host execution (explicit opt-in)                 â”‚  â”‚
â”‚  â”‚ â€¢ Exec approvals for dangerous operations                            â”‚  â”‚
â”‚  â”‚ â€¢ Audit log for all tool invocations                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  Layer 4: Prompt Injection Defense                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Input sanitization (URL/code removal)                               â”‚  â”‚
â”‚  â”‚ â€¢ Tag encapsulation (<user_post>...</user_post>)                      â”‚  â”‚
â”‚  â”‚ â€¢ Known pattern detection (blocklist)                                 â”‚  â”‚
â”‚  â”‚ â€¢ Output validation (LLM second pass)                                 â”‚  â”‚
â”‚  â”‚ â€¢ Rate limiting (60 req/min)                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 VPS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šï¼ˆå°†æ¥è¨ˆç”» - æœ¬ç•ªã‚¹ã‚±ãƒ¼ãƒ«æ™‚ï¼‰

> **ã‚¹ã‚³ãƒ¼ãƒ—**: ã“ã®ç¯€ã¯VPSç§»è¡Œæ™‚ã®å‚è€ƒè³‡æ–™ã€‚1.6.2ã§ã¯macOS LaunchAgentã§é–‹ç™ºãƒ»é‹ç”¨ã€‚

```bash
#!/bin/bash
# /home/anicca/scripts/setup-security.sh
# NOTE: å°†æ¥ã®VPSç§»è¡Œæ™‚ã«ä½¿ç”¨ã€‚1.6.2ã§ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚

set -euo pipefail

echo "=== Anicca VPS Security Setup (Future) ==="

# 1. UFW Firewall
echo "[1/5] Configuring UFW..."
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp comment 'SSH'
# Port 18789 is NOT exposed - use Tailscale
sudo ufw --force enable

# 2. fail2ban
echo "[2/5] Installing fail2ban..."
sudo apt-get install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 3. SSH hardening
echo "[3/5] Hardening SSH..."
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart sshd

# 4. Tailscale
echo "[4/5] Installing Tailscale..."
curl -fsSL https://tailscale.com/install.sh | sh
sudo tailscale up

# 5. Auto-updates
echo "[5/5] Configuring auto-updates..."
sudo apt-get install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades

echo "=== Security setup complete ==="
echo "Next steps:"
echo "1. Verify Tailscale: tailscale status"
echo "2. Test SSH: ssh -o PasswordAuthentication=no user@host"
echo "3. Verify UFW: sudo ufw status"
```

---

## 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥

### 4.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å¯¾å¿œ (Anthropicç ”ç©¶ã‚ˆã‚Š)

| Status Code | åˆ†é¡ | ãƒªãƒˆãƒ©ã‚¤ | å¯¾å¿œ |
|-------------|------|---------|------|
| **400** | Bad Request | âŒ No | å³åº§ã«å¤±æ•—ã€ãƒ­ã‚°è¨˜éŒ²ã€DLQè¿½åŠ  |
| **401** | Unauthorized | âŒ No | ãƒˆãƒ¼ã‚¯ãƒ³å†å–å¾—ãŒå¿…è¦ã€ã‚¢ãƒ©ãƒ¼ãƒˆ |
| **403** | Forbidden | âŒ No | æ¨©é™å•é¡Œã€æ‰‹å‹•å¯¾å¿œå¿…è¦ |
| **404** | Not Found | âŒ No | ãƒªã‚½ãƒ¼ã‚¹ç¢ºèªã€æ‰‹å‹•å¯¾å¿œ |
| **429** | Rate Limit | âœ… Yes | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€Retry-Afterå°Šé‡ã€æœ€å¤§3å› |
| **500** | Server Error | âœ… Yes | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€æœ€å¤§3å› |
| **502** | Bad Gateway | âœ… Yes | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€æœ€å¤§3å› |
| **503** | Service Unavailable | âœ… Yes | é•·æœŸãƒãƒƒã‚¯ã‚ªãƒ•ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨ |
| **529** | Overloaded | âœ… Yes | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€è»½é‡ãƒ¢ãƒ‡ãƒ«ã¸åˆ‡æ›¿ |

### 4.2 Dead Letter Queue (DLQ)

```
/home/anicca/openclaw/dlq/
â”œâ”€â”€ x-poster.jsonl       # XæŠ•ç¨¿å¤±æ•—
â”œâ”€â”€ tiktok-poster.jsonl  # TikTokæŠ•ç¨¿å¤±æ•—
â”œâ”€â”€ trend-hunter.jsonl   # ãƒˆãƒ¬ãƒ³ãƒ‰æ¤œå‡ºå¤±æ•—
â””â”€â”€ suffering-detector.jsonl  # è‹¦ã—ã¿æ¤œå‡ºå¤±æ•—

å„ã‚¨ãƒ³ãƒˆãƒª:
{
  "timestamp": "2026-02-03T09:00:00+09:00",
  "skill": "x-poster",
  "error": "Text verification failed: score=2",
  "context": {
    "hook": "ç¿’æ…£ã‚¢ãƒ—ãƒª10å€‹...",
    "attempts": 3,
    "last_score": 2
  },
  "resolution": null  # æ‰‹å‹•è§£æ±ºå¾Œã«æ›´æ–°
}
```

### 4.3 Fallbackæˆ¦ç•¥

```python
# Fallback chain for LLM calls
FALLBACK_CHAIN = [
    {"provider": "openai", "model": "gpt-4o", "max_retries": 3},
    {"provider": "openai", "model": "gpt-4o-mini", "max_retries": 2},
    {"provider": "anthropic", "model": "claude-3-5-haiku", "max_retries": 2},
    {"provider": "groq", "model": "llama-3.3-70b-versatile", "max_retries": 2},  # æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
]

async def call_with_fallback(prompt, chain=FALLBACK_CHAIN):
    for config in chain:
        try:
            return await call_llm(prompt, **config)
        except Exception as e:
            logging.warning(f"Fallback: {config['model']} failed: {e}")
            continue
    
    raise Exception("All providers failed")
```

---

## 5. é€šçŸ¥æœ€é©åŒ– (é€šçŸ¥ãƒªã‚µãƒ¼ãƒã‚ˆã‚Š)

### 5.1 MLé€ä¿¡æ™‚é–“æœ€é©åŒ– (STO)

```javascript
/**
 * Send Time Optimization
 * 
 * Based on:
 * - Last 60 days of engagement data
 * - Hourly aggregation, localized to timezone
 * - Weekly model refresh
 */

// apps/api/src/services/sendTimeOptimization.js

/**
 * Calculate optimal send time for user
 * 
 * @param {string} userId - User ID
 * @param {string} problemType - Problem type
 * @returns {number} - Optimal hour (0-23) in user's timezone
 */
async function getOptimalSendTime(userId, problemType) {
  // 1. Get user's engagement history (last 60 days)
  const history = await prisma.nudgeFeedback.findMany({
    where: {
      userId,
      problemType,
      createdAt: {
        gte: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000),
      },
    },
    select: {
      scheduledHour: true,
      outcome: true, // 'tapped' | 'ignored' | 'thumbs_up' | 'thumbs_down'
      createdAt: true,
    },
  });
  
  if (history.length < 10) {
    // Insufficient data: use population average
    return getPopulationOptimalHour(problemType);
  }
  
  // 2. Aggregate by hour
  const hourlyStats = {};
  for (let h = 0; h < 24; h++) {
    hourlyStats[h] = { positive: 0, total: 0 };
  }
  
  for (const record of history) {
    const hour = record.scheduledHour;
    hourlyStats[hour].total++;
    if (['tapped', 'thumbs_up'].includes(record.outcome)) {
      hourlyStats[hour].positive++;
    }
  }
  
  // 3. Calculate engagement rate per hour
  let bestHour = 8; // Default
  let bestRate = 0;
  
  for (const [hour, stats] of Object.entries(hourlyStats)) {
    if (stats.total >= 3) { // Minimum samples
      const rate = stats.positive / stats.total;
      if (rate > bestRate) {
        bestRate = rate;
        bestHour = parseInt(hour);
      }
    }
  }
  
  // 4. Avoid inconvenient times (11pm - 6am)
  if (bestHour >= 23 || bestHour < 6) {
    // Shift to nearest acceptable time
    bestHour = bestHour >= 23 ? 22 : 7;
  }
  
  return bestHour;
}

/**
 * Get population-level optimal hour for problem type
 */
async function getPopulationOptimalHour(problemType) {
  const defaults = {
    staying_up_late: 22,    // Evening reminder
    cant_wake_up: 6,        // Morning motivation
    self_loathing: 20,      // Evening reflection
    rumination: 14,         // Afternoon break
    procrastination: 9,     // Morning kickstart
    anxiety: 7,             // Morning grounding
    loneliness: 19,         // Evening connection
    anger: 12,              // Midday pause
    // ... other types
  };
  
  return defaults[problemType] || 9; // Default to 9am
}

module.exports = { getOptimalSendTime, refreshWeeklyModel, getHourlyEngagement };

/**
 * Weekly Model Refresh (é€±æ¬¡æ›´æ–°)
 *
 * Cron: æ¯é€±æ—¥æ›œ 03:00 JST
 * ä¿å­˜å…ˆ: UserStoModel ãƒ†ãƒ¼ãƒ–ãƒ«
 *
 * @param {string} userId - User ID
 * @returns {Object} - Updated hourly engagement data
 */
async function refreshWeeklyModel(userId) {
  // éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

  const recentFeedback = await prisma.nudgeFeedback.findMany({
    where: {
      userId,
      createdAt: { gte: sevenDaysAgo }
    },
    select: {
      scheduledHour: true,
      outcome: true
    }
  });

  // hourlyEngagement è¨ˆç®—
  const hourlyEngagement = {};
  for (let h = 0; h < 24; h++) {
    hourlyEngagement[h] = { positive: 0, total: 0, rate: 0 };
  }

  for (const fb of recentFeedback) {
    const h = fb.scheduledHour;
    hourlyEngagement[h].total++;
    if (['tapped', 'thumbs_up'].includes(fb.outcome)) {
      hourlyEngagement[h].positive++;
    }
  }

  // engagement rate è¨ˆç®—
  for (let h = 0; h < 24; h++) {
    const stats = hourlyEngagement[h];
    stats.rate = stats.total >= 3 ? stats.positive / stats.total : 0;
  }

  // UserStoModel ã«ä¿å­˜ï¼ˆupsertï¼‰
  await prisma.userStoModel.upsert({
    where: { userId },
    create: {
      userId,
      hourlyEngagement: JSON.stringify(hourlyEngagement),
      lastRefreshedAt: new Date()
    },
    update: {
      hourlyEngagement: JSON.stringify(hourlyEngagement),
      lastRefreshedAt: new Date()
    }
  });

  return hourlyEngagement;
}

/**
 * Get cached hourly engagement data
 *
 * @param {string} userId - User ID
 * @returns {Object|null} - Cached hourly engagement or null
 */
async function getHourlyEngagement(userId) {
  const model = await prisma.userStoModel.findUnique({
    where: { userId },
    select: { hourlyEngagement: true, lastRefreshedAt: true }
  });

  if (!model) return null;

  // 7æ—¥ä»¥ä¸Šå¤ã„å ´åˆã¯å†è¨ˆç®—ã‚’æ¨å¥¨
  const daysSinceRefresh = (Date.now() - model.lastRefreshedAt.getTime()) / (1000 * 60 * 60 * 24);

  return {
    data: JSON.parse(model.hourlyEngagement),
    stale: daysSinceRefresh > 7
  };
}
```

**UserStoModel ã‚¹ã‚­ãƒ¼ãƒè¿½åŠ ï¼ˆprisma/schema.prismaï¼‰:**

```prisma
model UserStoModel {
  id               String   @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  userId           String   @unique @db.Uuid @map("user_id")
  hourlyEngagement String   @map("hourly_engagement") // JSON string: { "0": { positive, total, rate }, ... }
  lastRefreshedAt  DateTime @db.Timestamptz @map("last_refreshed_at")
  createdAt        DateTime @db.Timestamptz @default(now()) @map("created_at")
  updatedAt        DateTime @db.Timestamptz @updatedAt @map("updated_at")

  @@map("user_sto_models")
}
```

**STOé€±æ¬¡æ›´æ–°Cron**: Phase 4 ã® schedule.yaml jobs é…ä¸‹ã« `sto-weekly-refresh` ã¨ã—ã¦å®šç¾©æ¸ˆã¿ï¼ˆSection 6.4 å‚ç…§ï¼‰ã€‚

**sto-weekly-refresh SKILL.md**:

```yaml
---
name: sto-weekly-refresh
description: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®STOé€±æ¬¡ãƒ¢ãƒ‡ãƒ«æ›´æ–°ã‚¹ã‚­ãƒ«
metadata: { "openclaw": { "emoji": "ğŸ“Š", "requires": { "env": ["DATABASE_URL"] } } }
---

# sto-weekly-refresh

## Instructions

1. å…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆéå»30æ—¥ä»¥å†…ã«NudgeFeedbackã‚ã‚Šï¼‰ã‚’å–å¾—
2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ refreshWeeklyModel(userId) ã‚’å®Ÿè¡Œ
3. UserStoModel ãƒ†ãƒ¼ãƒ–ãƒ«ã« hourlyEngagement ã‚’ä¿å­˜
4. å®Œäº†å¾Œã€Slack #metrics ã«æ›´æ–°ä»¶æ•°ã‚’é€šçŸ¥

## Required Tools

- `read`: DBæ¥ç¶šè¨­å®š
- `exec`: refreshWeeklyModel ã®å®Ÿè¡Œ

## Execution Flow

\`\`\`
1. prisma.nudgeFeedback.groupBy({ userId, where: { createdAt > 30d ago } })
2. for each userId: await refreshWeeklyModel(userId)
3. Slacké€šçŸ¥: "STOé€±æ¬¡æ›´æ–°å®Œäº†: {count}ãƒ¦ãƒ¼ã‚¶ãƒ¼"
\`\`\`

## Error Handling

| ã‚¨ãƒ©ãƒ¼ | å¯¾å¿œ |
|--------|------|
| DBæ¥ç¶šå¤±æ•— | ãƒªãƒˆãƒ©ã‚¤3å›å¾Œã€Slack #ai ã«ã‚¢ãƒ©ãƒ¼ãƒˆ |
| å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†å¤±æ•— | ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã¸ã€æœ€çµ‚é›†è¨ˆã§å¤±æ•—æ•°ã‚’å ±å‘Š |
```

### 5.2 ç–²åŠ´é˜²æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³

```javascript
/**
 * User Fatigue Prevention
 * 
 * Strategies:
 * 1. Frequency caps (max notifications per day/week)
 * 2. Cool-off periods after negative feedback
 * 3. Variety in content (hook rotation)
 * 4. Progressive engagement
 */

const FATIGUE_CONFIG = {
  // Daily limits per problem type
  daily_limit_per_type: 5,

  // Total daily limit across all types
  daily_limit_total: 10,

  // Cool-off after thumbs_down
  cooloff_hours_after_negative: 24,

  // Cool-off since last send (ä»»æ„ã®é€ä¿¡ã‹ã‚‰ã®æœ€å°é–“éš”)
  min_minutes_since_last_send: 60,

  // Hook reuse prevention
  min_hours_between_same_hook: 48,

  // Progressive engagement (new users)
  new_user_ramp_up: {
    day_1: 3,
    day_2_7: 5,
    day_8_plus: 10,
  },
};

/**
 * Check if user should receive nudge
 */
async function shouldSendNudge(userId, problemType, hookId) {
  // 0. Check cool-off since last send (ç›´å‰é€ä¿¡ã‹ã‚‰ã®æœ€å°é–“éš”)
  const lastSend = await prisma.nudgeSent.findFirst({
    where: { userId },
    orderBy: { createdAt: 'desc' }
  });

  if (lastSend) {
    const minutesSince = (Date.now() - lastSend.createdAt.getTime()) / (1000 * 60);
    if (minutesSince < FATIGUE_CONFIG.min_minutes_since_last_send) {
      return { allowed: false, reason: 'cooloff_since_last_send' };
    }
  }

  // 1. Check daily limit
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const todayCount = await prisma.nudgeSent.count({
    where: {
      userId,
      createdAt: { gte: today },
    },
  });

  if (todayCount >= FATIGUE_CONFIG.daily_limit_total) {
    return { allowed: false, reason: 'daily_limit_reached' };
  }

  // 2. Check problem type limit
  const typeCount = await prisma.nudgeSent.count({
    where: {
      userId,
      problemType,
      createdAt: { gte: today },
    },
  });
  
  if (typeCount >= FATIGUE_CONFIG.daily_limit_per_type) {
    return { allowed: false, reason: 'type_limit_reached' };
  }
  
  // 3. Check cool-off after negative feedback
  const lastNegative = await prisma.nudgeFeedback.findFirst({
    where: {
      userId,
      outcome: 'thumbs_down',
    },
    orderBy: { createdAt: 'desc' },
  });
  
  if (lastNegative) {
    const hoursSince = (Date.now() - lastNegative.createdAt.getTime()) / (1000 * 60 * 60);
    if (hoursSince < FATIGUE_CONFIG.cooloff_hours_after_negative) {
      return { allowed: false, reason: 'cooloff_active' };
    }
  }
  
  // 4. Check hook reuse
  if (hookId) {
    const lastSameHook = await prisma.nudgeSent.findFirst({
      where: {
        userId,
        hookId,
      },
      orderBy: { createdAt: 'desc' },
    });
    
    if (lastSameHook) {
      const hoursSince = (Date.now() - lastSameHook.createdAt.getTime()) / (1000 * 60 * 60);
      if (hoursSince < FATIGUE_CONFIG.min_hours_between_same_hook) {
        return { allowed: false, reason: 'hook_recently_used' };
      }
    }
  }
  
  return { allowed: true };
}

module.exports = { shouldSendNudge, FATIGUE_CONFIG };
```

---

## 6. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ã‚¤ãƒ³ãƒ•ãƒ© (Day 1) â€” **å®Œäº†æ¸ˆã¿ãƒ»TDDã‚¹ã‚³ãƒ¼ãƒ—å¤–**

> **TDDã‚¹ã‚³ãƒ¼ãƒ—å¤–ã®ç†ç”±**: Phase 1ã¯ç’°å¢ƒæ§‹ç¯‰ã‚¿ã‚¹ã‚¯ã§ã‚ã‚Šã€æ‰‹å‹•æ¤œè¨¼ã§å®Œäº†ç¢ºèªæ¸ˆã¿ã€‚è‡ªå‹•ãƒ†ã‚¹ãƒˆå¯¾è±¡å¤–ã¨ã™ã‚‹ã€‚
> **æ¤œè¨¼æ–¹æ³•**: `launchctl list | grep openclaw` / `openclaw cron list` / Slack #metrics ã§æ‰‹å‹•ç¢ºèªã€‚

| # | ã‚¿ã‚¹ã‚¯ | AC | çŠ¶æ…‹ |
|---|--------|-----|------|
| 1.1 | ~~VPS ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š~~ | **ã‚¹ã‚­ãƒƒãƒ—**ï¼ˆmacOSã§é–‹ç™ºã€VPSã¯å°†æ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | âœ… N/A |
| 1.2 | ~~Tailscale è¨­å®š~~ | **ã‚¹ã‚­ãƒƒãƒ—**ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®ãŸã‚ä¸è¦ï¼‰ | âœ… N/A |
| 1.3 | OpenClaw Gateway èµ·å‹• | `launchctl kickstart` ã§ç¨¼åƒä¸­ | âœ… å®Œäº† |
| 1.4 | ç’°å¢ƒå¤‰æ•°è¨­å®š | `~/.openclaw/openclaw.json` + `.env` è¨­å®šæ¸ˆã¿ | âœ… å®Œäº† |
| 1.5 | Slacké€£æº | #metrics, #ai ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šæ¸ˆã¿ | âœ… å®Œäº† |
| 1.6 | Cronã‚¸ãƒ§ãƒ–åŸºç›¤ | `openclaw cron list` ã§ç¢ºèªå¯èƒ½ | âœ… å®Œäº† |

### Phase 2: Skillså®Ÿè£… (Day 1-2)

> **é‡è¦**: ã‚¹ã‚­ãƒ«ä½œæˆã¯ `skill-creator` ã‚¹ã‚­ãƒ«ã‚’ä½¿ã†ã€‚æ‰‹å‹•ã§ SKILL.md ã‚’æ›¸ããªã€‚

| # | ã‚¿ã‚¹ã‚¯ | AC | ä½œæˆæ–¹æ³• | çŠ¶æ…‹ |
|---|--------|-----|---------|------|
| 2.1 | x-poster Skill ä½œæˆ | æ‰‹å‹•å®Ÿè¡Œã§æŠ•ç¨¿æˆåŠŸ | `skill-creator` | â¬œ |
| 2.2 | hookSelector.js (Dynamic Prior TS) | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé | Node.jsç›´æ¥ | â¬œ |
| 2.3 | verifier.js | ãƒ†ã‚­ã‚¹ãƒˆ/ç”»åƒæ¤œè¨¼å‹•ä½œ | Node.jsç›´æ¥ | â¬œ |
| 2.4 | errorHandler.js | DLQ + Circuit Breakerç¢ºèª | Node.jsç›´æ¥ | â¬œ |
| 2.5 | tiktok-poster Skill | æ‰‹å‹•å®Ÿè¡Œã§æŠ•ç¨¿æˆåŠŸ | `skill-creator` | â¬œ |
| 2.6 | trend-hunter Skill | hook_candidatesè¿½åŠ ç¢ºèª | `skill-creator` | â¬œ |
| 2.7 | suffering-detector Skill | Moltbookè¿”ä¿¡ç¢ºèª | `skill-creator` | â¬œ |
| 2.8 | app-nudge-sender Skill | Pushé€šçŸ¥é€ä¿¡æˆåŠŸ | `skill-creator` | â¬œ |
| 2.9 | hookpost-ttl-cleaner Skill | `openclaw cron run <job-id>` ã§æ‰‹å‹•å®Ÿè¡ŒæˆåŠŸã€Slacké€šçŸ¥å±Šã | `skill-creator` | â¬œ |
| 2.10 | sto-weekly-refresh Skill | `openclaw cron run <job-id>` ã§æ‰‹å‹•å®Ÿè¡ŒæˆåŠŸã€UserStoModelæ›´æ–°ç¢ºèª | `skill-creator` | â¬œ |

#### Phase 2 å®Ÿè£…ä»•æ§˜ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚°ãƒãƒãƒ£ï¼‰

> **è¨€èªçµ±ä¸€**: OpenClaw Skillsã¯ JavaScript/TypeScriptã€APIã¯ Node.js ã§çµ±ä¸€ã€‚
> **ãƒ†ã‚¹ãƒˆåŸºç›¤**: Vitest + Supertestï¼ˆNode.jsï¼‰

##### 2.2-2.4 ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆNode.jså®Ÿè£…ï¼‰

**hook_selector.js**

> **TDDå¯¾å¿œ**: InvalidInputErrorå®šç¾©ã€RNG/clockæ³¨å…¥å¯¾å¿œï¼ˆãƒ†ã‚¹ãƒˆæ±ºå®šæ€§ç¢ºä¿ï¼‰

```javascript
// apps/api/src/services/hookSelector.js

/**
 * å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆA6-A8ãƒ†ã‚¹ãƒˆå¯¾å¿œï¼‰
 */
class InvalidInputError extends Error {
  constructor(message) {
    super(message);
    this.name = 'InvalidInputError';
  }
}

/**
 * Dynamic Prior Thompson Sampling ã§hookã‚’é¸æŠ
 *
 * @param {Array<Object>} hooks - Hookå€™è£œãƒªã‚¹ãƒˆ
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.epsilon - æ¢ç´¢ç‡ (default: 0.1)
 * @param {number} options.priorStrength - Priorå¼·åº¦ (default: 0.1)
 * @param {number} options.discountFactor - æ¸›è¡°ä¿‚æ•° (default: 0.95/é€±)
 * @param {Function} options.rng - ä¹±æ•°ç”Ÿæˆé–¢æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã€default: Math.randomï¼‰
 * @param {Function} options.clock - ç¾åœ¨æ™‚åˆ»é–¢æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨ã€default: Date.nowï¼‰
 * @returns {Object} é¸æŠã•ã‚ŒãŸhook
 * @throws {InvalidInputError} hooks ãŒç©ºã€éé…åˆ—ã€ã¾ãŸã¯ createdAt æ¬ è½ã®å ´åˆ
 */
async function selectHookThompson(hooks, options = {}) {
  const {
    epsilon = 0.1,
    priorStrength = 0.1,
    discountFactor = 0.95,
    rng = Math.random,  // ãƒ†ã‚¹ãƒˆç”¨æ³¨å…¥å¯èƒ½
    clock = Date.now    // ãƒ†ã‚¹ãƒˆç”¨æ³¨å…¥å¯èƒ½
  } = options;

  // A7: éé…åˆ—æ¤œè¨¼
  if (!Array.isArray(hooks)) {
    throw new InvalidInputError('hooks must be an array');
  }

  // A6: ç©ºé…åˆ—æ¤œè¨¼
  if (hooks.length === 0) {
    throw new InvalidInputError('hooks must be a non-empty array');
  }

  // A8: createdAtå¿…é ˆæ¤œè¨¼
  for (const hook of hooks) {
    if (!hook.createdAt) {
      throw new InvalidInputError(`hook "${hook.id || 'unknown'}" is missing required field: createdAt`);
    }
  }

  // å„hookã«å¯¾ã—ã¦Dynamic Prior Thompson Samplingã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
  const scored = hooks.map(hook => ({
    hook,
    score: calculateDynamicPriorTS(hook, { epsilon, priorStrength, discountFactor, rng, clock })
  }));

  // æœ€é«˜ã‚¹ã‚³ã‚¢ã®hookã‚’é¸æŠ
  return scored.reduce((best, current) =>
    current.score > best.score ? current : best
  ).hook;
}

/**
 * Dynamic Prior Thompson Samplingã‚¹ã‚³ã‚¢è¨ˆç®—
 *
 * @param {Object} hook - Hook ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {Object} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆrng/clockå«ã‚€ï¼‰
 * @returns {number} Thompson Samplingã‚¹ã‚³ã‚¢ (0-1)
 */
function calculateDynamicPriorTS(hook, { epsilon, priorStrength, discountFactor, rng, clock }) {
  const { successCount = 0, failureCount = 0, createdAt } = hook;

  // æ™‚é–“æ¸›è¡°ï¼ˆé€±å˜ä½ï¼‰- clockæ³¨å…¥å¯¾å¿œ
  const weeksSinceCreation = (clock() - new Date(createdAt).getTime()) / (7 * 24 * 60 * 60 * 1000);
  const decay = Math.pow(discountFactor, weeksSinceCreation);

  // æ¸›è¡°ã—ãŸã‚«ã‚¦ãƒ³ãƒˆ
  const alpha = 1 + (successCount * decay);
  const beta = 1 + (failureCount * decay);

  // Betaåˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° - rngæ³¨å…¥å¯¾å¿œ
  const sample = betaSample(alpha, beta, rng);

  // Dynamic Prior: Îµç¢ºç‡ã§æ¢ç´¢ã€(1-Îµ)ç¢ºç‡ã§æ´»ç”¨
  if (rng() < epsilon) {
    return rng(); // æ¢ç´¢: ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ã‚³ã‚¢
  }
  return sample; // æ´»ç”¨: Thompson Samplingã‚¹ã‚³ã‚¢
}

/**
 * Betaåˆ†å¸ƒã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆJÃ¶hnk's algorithmï¼‰
 * @param {number} alpha - Î± ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (> 0)
 * @param {number} beta - Î² ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (> 0)
 * @param {Function} rng - ä¹±æ•°ç”Ÿæˆé–¢æ•°ï¼ˆãƒ†ã‚¹ãƒˆç”¨æ³¨å…¥ï¼‰
 * @returns {number} 0-1 ã®ç¯„å›²ã®ã‚µãƒ³ãƒ—ãƒ«å€¤
 */
function betaSample(alpha, beta, rng = Math.random) {
  // JÃ¶hnk's algorithm for Beta distribution
  while (true) {
    const u1 = rng();
    const u2 = rng();
    const x = Math.pow(u1, 1 / alpha);
    const y = Math.pow(u2, 1 / beta);
    if (x + y <= 1) {
      return x / (x + y);
    }
  }
}

module.exports = { selectHookThompson, calculateDynamicPriorTS, betaSample, InvalidInputError };
```

**verifier.js**

```javascript
// apps/api/src/services/verifier.js

const { writeToDLQ } = require('./errorHandler');

/**
 * ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆï¼‹æ¤œè¨¼ãƒ«ãƒ¼ãƒ—ï¼ˆå†ç”Ÿæˆå¯¾å¿œï¼‰
 *
 * @param {Function} generateFn - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆé–¢æ•° (feedback) => Promise<string>
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.threshold - åˆæ ¼é–¾å€¤ (default: 3)
 * @param {number} options.maxRetries - æœ€å¤§å†ç”Ÿæˆå›æ•° (default: 3)
 * @param {string} options.skillName - ã‚¹ã‚­ãƒ«åï¼ˆDLQè¨˜éŒ²ç”¨ï¼‰
 * @param {Object} options.context - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆDLQè¨˜éŒ²ç”¨ï¼‰
 * @returns {Object} { passed: boolean, content: string, score: number, attempts: number }
 */
async function verifyWithRegeneration(generateFn, options = {}) {
  const { threshold = 3, maxRetries = 3, skillName = 'unknown', context = {} } = options;

  let bestAttempt = null;
  let attempts = [];

  for (let i = 0; i < maxRetries; i++) {
    // ç”Ÿæˆï¼ˆå‰å›ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æ¸¡ã™ï¼‰
    const feedback = attempts.length > 0 ? attempts[attempts.length - 1].feedback : null;
    const content = await generateFn(feedback);

    // æ¤œè¨¼
    const result = await verifyContent(content);
    attempts.push({ content, ...result, attempt: i + 1 });

    // åˆæ ¼åˆ¤å®š
    if (result.score >= threshold) {
      return { passed: true, content, score: result.score, attempts: i + 1 };
    }

    // best_attemptæ›´æ–°ï¼ˆæœ€é«˜ã‚¹ã‚³ã‚¢ã‚’è¨˜éŒ²ï¼‰
    if (!bestAttempt || result.score > bestAttempt.score) {
      bestAttempt = { content, score: result.score, attempt: i + 1 };
    }
  }

  // å…¨è©¦è¡Œå¤±æ•— â†’ DLQè¨˜éŒ² + best_attemptè¿”å´
  await writeToDLQ(skillName, new Error(`Verification failed after ${maxRetries} attempts`), {
    ...context,
    attempts,
    bestAttempt
  });

  return {
    passed: false,
    content: bestAttempt.content,
    score: bestAttempt.score,
    attempts: maxRetries,
    usedBestAttempt: true
  };
}

/**
 * å˜ä¸€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å“è³ªæ¤œè¨¼
 *
 * @param {string} content - æ¤œè¨¼å¯¾è±¡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 * @returns {Object} { score: number, feedback: string }
 */
async function verifyContent(content) {
  // å…¥åŠ›æ¤œè¨¼
  if (typeof content !== 'string' || content.trim().length === 0) {
    return { score: 0, feedback: 'Content is empty' };
  }

  // LLMæ¤œè¨¼å‘¼ã³å‡ºã—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
  return await callVerificationLLM(content);
}

/**
 * LLMæ¤œè¨¼å‘¼ã³å‡ºã—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
 *
 * @param {string} content - æ¤œè¨¼å¯¾è±¡
 * @returns {Object} { score: number, feedback: string }
 */
async function callVerificationLLM(content) {
  const FALLBACK_CHAIN = ['gpt-4o-mini', 'claude-3-5-haiku', 'llama-3.3-70b'];

  for (const model of FALLBACK_CHAIN) {
    try {
      return await verifyWithModel(content, model);
    } catch (error) {
      console.warn(`Verification failed with ${model}:`, error.message);
    }
  }

  throw new Error('All verification models failed');
}

/**
 * ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã§ã®æ¤œè¨¼å®Ÿè¡Œ
 *
 * @param {string} content - æ¤œè¨¼å¯¾è±¡
 * @param {string} model - ãƒ¢ãƒ‡ãƒ«å
 * @returns {Object} { score: number, feedback: string }
 */
async function verifyWithModel(content, model) {
  // LLM APIã‚³ãƒ¼ãƒ«ï¼ˆOpenAI/Anthropic/Groqï¼‰
  const response = await callLLMAPI(model, {
    prompt: `ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’0-5ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚3ä»¥ä¸Šã§åˆæ ¼ã§ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: ${content}

JSONå½¢å¼ã§è¿”ç­”: { "score": number, "feedback": "æ”¹å–„ç‚¹" }`
  });

  return JSON.parse(response);
}

/**
 * LLM API å‘¼ã³å‡ºã—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * @param {string} model - ãƒ¢ãƒ‡ãƒ«å ('gpt-4o-mini' | 'claude-3-5-haiku' | 'llama-3.3-70b')
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {string} options.prompt - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
 * @returns {string} LLMå¿œç­”ãƒ†ã‚­ã‚¹ãƒˆ
 */
async function callLLMAPI(model, { prompt }) {
  const { OpenAI } = require('openai');
  const Anthropic = require('@anthropic-ai/sdk');
  const Groq = require('groq-sdk');

  if (model.startsWith('gpt')) {
    const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
    const response = await openai.chat.completions.create({
      model,
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' }
    });
    return response.choices[0].message.content;
  }

  if (model.startsWith('claude')) {
    const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
    const response = await anthropic.messages.create({
      model,
      max_tokens: 1024,
      messages: [{ role: 'user', content: prompt }]
    });
    return response.content[0].text;
  }

  if (model.startsWith('llama')) {
    const groq = new Groq({ apiKey: process.env.GROQ_API_KEY });
    const response = await groq.chat.completions.create({
      model,
      messages: [{ role: 'user', content: prompt }]
    });
    return response.choices[0].message.content;
  }

  throw new Error(`Unsupported model: ${model}`);
}

module.exports = { verifyWithRegeneration, verifyContent, callVerificationLLM, callLLMAPI };
```

**errorHandler.js**

> **ESMçµ±ä¸€**: circuitBreakerMiddleware.jsã¨æ•´åˆã•ã›ã‚‹ãŸã‚ESMå½¢å¼ã§è¨˜è¿°

```javascript
// apps/api/src/services/errorHandler.js
// ESMå½¢å¼ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ESMã‚’ä½¿ç”¨ï¼‰

import fs from 'fs/promises';
import path from 'path';

const DLQ_DIR = process.env.DLQ_DIR || '/tmp/anicca/dlq';

/**
 * éåŒæœŸå¾…æ©Ÿãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * @param {number} ms - å¾…æ©ŸãƒŸãƒªç§’
 * @returns {Promise<void>}
 */
export function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

/**
 * Slacké€šçŸ¥é€ä¿¡ï¼ˆ401/403ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆç”¨ï¼‰
 * @param {string} channel - Slackãƒãƒ£ãƒ³ãƒãƒ«
 * @param {string} message - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
async function sendSlackAlert(channel, message) {
  // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰Webhook URLå–å¾—
  const webhookUrl = process.env.SLACK_WEBHOOK_URL;
  if (!webhookUrl) return;

  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ channel, text: message })
    });
  } catch (e) {
    console.error('Slack alert failed:', e);
  }
}

/**
 * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆEqual Jitter Backoff + DLQ + 401ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
 *
 * @param {Function} fn - å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.maxRetries - æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•° (default: 3)
 * @param {number} options.baseDelay - åŸºæœ¬é…å»¶ms (default: 1000)
 * @param {string} options.skillName - ã‚¹ã‚­ãƒ«åï¼ˆDLQè¨˜éŒ²ç”¨ï¼‰
 * @returns {any} é–¢æ•°ã®æˆ»ã‚Šå€¤
 * @throws {Error} å…¨ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚
 */
export async function withRetry(fn, options = {}) {
  const { maxRetries = 3, baseDelay = 1000, skillName = 'unknown' } = options;

  let lastError;
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;

      // 4xxç³»ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„ï¼ˆ401, 403, 404ï¼‰
      if (error.status >= 400 && error.status < 500 && error.status !== 429) {
        // E3: 401/403æ™‚ã«Slackã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
        if (error.status === 401 || error.status === 403) {
          await sendSlackAlert('#alerts', `[${skillName}] Auth error: ${error.status} - ${error.message}`);
          await writeToDLQ(skillName, error, { ...options.context, alerted: true });
        }
        throw error;
      }

      // Equal Jitter Backoff
      const delay = calculateEqualJitter(baseDelay, attempt);

      // 429ã®å ´åˆã¯Retry-Afterå°Šé‡
      if (error.status === 429 && error.retryAfter) {
        await sleep(error.retryAfter * 1000);
      } else {
        await sleep(delay);
      }
    }
  }

  // DLQã«è¨˜éŒ²
  await writeToDLQ(skillName, lastError, options.context);
  throw lastError;
}

/**
 * Equal Jitter Backoffè¨ˆç®—
 * delay = base * 2^attempt + random(0, base * 2^attempt)
 */
export function calculateEqualJitter(baseDelay, attempt) {
  const expDelay = baseDelay * Math.pow(2, attempt);
  const jitter = Math.random() * expDelay;
  return expDelay + jitter;
}

/**
 * DLQæ›¸ãè¾¼ã¿
 */
export async function writeToDLQ(skillName, error, context = {}) {
  const entry = {
    timestamp: new Date().toISOString(),
    skill: skillName,
    error: error.message,
    context,
    resolution: null
  };

  const filePath = path.join(DLQ_DIR, `${skillName}.jsonl`);
  await fs.mkdir(DLQ_DIR, { recursive: true });
  await fs.appendFile(filePath, JSON.stringify(entry) + '\n');
}
```

**Circuit Breakerï¼ˆerrorHandler.jsè¿½åŠ ï¼‰**

```javascript
// Circuit BreakerçŠ¶æ…‹ç®¡ç†
const CircuitState = {
  CLOSED: 'CLOSED',     // æ­£å¸¸å‹•ä½œ
  OPEN: 'OPEN',         // å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆå³åº§ã«å¤±æ•—
  HALF_OPEN: 'HALF_OPEN' // ãƒ†ã‚¹ãƒˆä¸­
};

// ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®CircuitçŠ¶æ…‹
const circuits = new Map();

/**
 * Circuit Breakerä»˜ããƒªãƒˆãƒ©ã‚¤
 *
 * @param {string} serviceName - ã‚µãƒ¼ãƒ“ã‚¹è­˜åˆ¥å­
 * @param {Function} fn - å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.failureThreshold - OPENç§»è¡Œã®å¤±æ•—å›æ•°é–¾å€¤ (default: 5)
 * @param {number} options.recoveryTimeout - OPENâ†’HALF_OPEN ã¾ã§ã®ms (default: 30000)
 * @param {number} options.successThreshold - HALF_OPENâ†’CLOSED ã¸ã®æˆåŠŸå›æ•° (default: 2)
 * @returns {any} é–¢æ•°ã®æˆ»ã‚Šå€¤
 * @throws {Error} Circuit OPENæ™‚ã¾ãŸã¯ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚
 */
async function withCircuitBreaker(serviceName, fn, options = {}) {
  const {
    failureThreshold = 5,
    recoveryTimeout = 30000,
    successThreshold = 2,
    ...retryOptions
  } = options;

  // åˆæœŸåŒ–
  if (!circuits.has(serviceName)) {
    circuits.set(serviceName, {
      state: CircuitState.CLOSED,
      failures: 0,
      successes: 0,
      lastFailure: null,
      nextAttempt: null
    });
  }

  const circuit = circuits.get(serviceName);

  // OPENçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  if (circuit.state === CircuitState.OPEN) {
    if (Date.now() < circuit.nextAttempt) {
      throw new Error(`Circuit OPEN for ${serviceName}. Retry after ${new Date(circuit.nextAttempt).toISOString()}`);
    }
    // å¾©å¸°ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆçµŒé â†’ HALF_OPEN
    circuit.state = CircuitState.HALF_OPEN;
    circuit.successes = 0;
  }

  try {
    const result = await withRetry(fn, retryOptions);

    // æˆåŠŸå‡¦ç†
    if (circuit.state === CircuitState.HALF_OPEN) {
      circuit.successes++;
      if (circuit.successes >= successThreshold) {
        circuit.state = CircuitState.CLOSED;
        circuit.failures = 0;
      }
    } else {
      circuit.failures = 0;
    }

    return result;
  } catch (error) {
    // å¤±æ•—å‡¦ç†
    circuit.failures++;
    circuit.lastFailure = Date.now();

    if (circuit.state === CircuitState.HALF_OPEN) {
      // HALF_OPENã§å¤±æ•— â†’ å³åº§ã«OPEN
      circuit.state = CircuitState.OPEN;
      circuit.nextAttempt = Date.now() + recoveryTimeout;
    } else if (circuit.failures >= failureThreshold) {
      // é–¾å€¤åˆ°é” â†’ OPEN
      circuit.state = CircuitState.OPEN;
      circuit.nextAttempt = Date.now() + recoveryTimeout;
    }

    throw error;
  }
}

/**
 * CircuitçŠ¶æ…‹å–å¾—ï¼ˆç›£è¦–ãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
 */
function getCircuitState(serviceName) {
  return circuits.get(serviceName) || null;
}

/**
 * CircuitçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
 */
function resetCircuit(serviceName) {
  circuits.delete(serviceName);
}

module.exports = {
  withRetry,
  calculateEqualJitter,
  writeToDLQ,
  sleep,
  withCircuitBreaker,
  getCircuitState,
  resetCircuit,
  CircuitState
};
```

**circuitBreakerMiddleware.jsï¼ˆCircuit Breaker OPENâ†’503ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰**:

```javascript
// apps/api/src/middleware/circuitBreakerMiddleware.js
// ESMå½¢å¼ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§ESMã‚’ä½¿ç”¨ï¼‰
import { getCircuitState, CircuitState } from '../services/errorHandler.js';

/**
 * Circuit BreakerçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
 * æŒ‡å®šã‚µãƒ¼ãƒ“ã‚¹ãŒOPENçŠ¶æ…‹ã®å ´åˆã€503 Service Unavailableã‚’è¿”å´
 *
 * @param {string} serviceName - ç›£è¦–å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹å
 * @returns {Function} Express middleware
 */
function requireCircuitClosed(serviceName) {
  return (req, res, next) => {
    const circuit = getCircuitState(serviceName);

    if (circuit && circuit.state === CircuitState.OPEN) {
      const retryAfterSeconds = Math.ceil(
        (circuit.nextAttempt - Date.now()) / 1000
      );
      res.set('Retry-After', String(Math.max(1, retryAfterSeconds)));
      return res.status(503).json({
        error: 'Service temporarily unavailable',
        service: serviceName,
        retryAfter: retryAfterSeconds
      });
    }

    next();
  };
}

/**
 * å…¨ã‚µãƒ¼ãƒ“ã‚¹ã® Circuit Breaker ãƒã‚§ãƒƒã‚¯
 * ã„ãšã‚Œã‹ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒOPENçŠ¶æ…‹ãªã‚‰503ã‚’è¿”å´
 *
 * @param {string[]} serviceNames - ç›£è¦–å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹åé…åˆ—
 * @returns {Function} Express middleware
 */
function requireAllCircuitsClosed(serviceNames) {
  return (req, res, next) => {
    for (const serviceName of serviceNames) {
      const circuit = getCircuitState(serviceName);
      if (circuit && circuit.state === CircuitState.OPEN) {
        const retryAfterSeconds = Math.ceil(
          (circuit.nextAttempt - Date.now()) / 1000
        );
        res.set('Retry-After', String(Math.max(1, retryAfterSeconds)));
        return res.status(503).json({
          error: 'Service temporarily unavailable',
          service: serviceName,
          retryAfter: retryAfterSeconds
        });
      }
    }
    next();
  };
}

export { requireCircuitClosed, requireAllCircuitsClosed };
```

**ä½¿ç”¨ä¾‹ï¼ˆagent/index.jsï¼‰**:

```javascript
// apps/api/src/routes/agent/index.js
import { requireAllCircuitsClosed } from '../../middleware/circuitBreakerMiddleware.js';

// å…¨agentãƒ«ãƒ¼ãƒˆã«Circuit Breakerãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨
router.use(requireAllCircuitsClosed(['openai', 'prisma', 'blotato']));
```

**memuService.js**

```javascript
// apps/api/src/services/memuService.js

const { prisma } = require('../lib/prisma');
const { callLLM } = require('./llmService');
const { OpenAI } = require('openai');

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

/**
 * Embeddingç”Ÿæˆï¼ˆtext-embedding-3-smallï¼‰
 * @param {string} text - åŸ‹ã‚è¾¼ã¿å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns {Float32Array} 1536æ¬¡å…ƒã®embedding
 */
async function generateEmbedding(text) {
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text.slice(0, 8000),  // æœ€å¤§8000æ–‡å­—
  });
  return new Float32Array(response.data[0].embedding);
}

/**
 * ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
 * @param {Float32Array} a - ãƒ™ã‚¯ãƒˆãƒ«A
 * @param {Float32Array} b - ãƒ™ã‚¯ãƒˆãƒ«B
 * @returns {number} é¡ä¼¼åº¦ (0-1)
 */
function cosineSimilarity(a, b) {
  if (a.length !== b.length) return 0;
  let dotProduct = 0, normA = 0, normB = 0;
  for (let i = 0; i < a.length; i++) {
    dotProduct += a[i] * b[i];
    normA += a[i] * a[i];
    normB += b[i] * b[i];
  }
  return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
}

/**
 * Buffer â†’ Float32Array å¤‰æ›
 * DBã‹ã‚‰å–å¾—ã—ãŸembeddingï¼ˆBufferå‹ï¼‰ã‚’Float32Arrayã«å¾©å…ƒ
 * @param {Buffer} buffer - Prisma ã‹ã‚‰å–å¾—ã—ãŸ embedding Buffer
 * @returns {Float32Array} å¾©å…ƒã•ã‚ŒãŸ 1536æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«
 */
function bufferToFloat32Array(buffer) {
  // Buffer ã‚’ ArrayBuffer ã«å¤‰æ›ã—ã€Float32Array ã¨ã—ã¦è§£é‡ˆ
  const arrayBuffer = buffer.buffer.slice(
    buffer.byteOffset,
    buffer.byteOffset + buffer.byteLength
  );
  return new Float32Array(arrayBuffer);
}

/**
 * Float32Array â†’ Buffer å¤‰æ›ï¼ˆmemorizeä¿å­˜ç”¨ï¼‰
 * generateEmbeddingã®çµæœã‚’Prisma Byteså‹ã¨ã—ã¦ä¿å­˜
 * @param {Float32Array} float32Array - 1536æ¬¡å…ƒã®embedding
 * @returns {Buffer} Prismaä¿å­˜ç”¨ã®Buffer
 */
function float32ArrayToBuffer(float32Array) {
  // Float32Array ã® underlying buffer ã‹ã‚‰ã‚³ãƒ”ãƒ¼
  return Buffer.from(float32Array.buffer);
}

/**
 * Round-tripæ¤œè¨¼ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
 * Float32Array â†’ Buffer â†’ Float32Array ãŒä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
 * @param {Float32Array} original - å…ƒã®embedding
 * @returns {boolean} ä¸€è‡´ã™ã‚Œã°true
 */
function verifyRoundTrip(original) {
  const buffer = float32ArrayToBuffer(original);
  const restored = bufferToFloat32Array(buffer);
  if (original.length !== restored.length) return false;
  for (let i = 0; i < original.length; i++) {
    if (original[i] !== restored[i]) return false;
  }
  return true;
}

/**
 * Resource ã‹ã‚‰ Item ã‚’æŠ½å‡ºï¼ˆLLMä½¿ç”¨ï¼‰
 * Mem0 v2.0 ã®2ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«åŸºã¥ã
 *
 * @param {Object} content - Resource ã® content ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.maxItems - æœ€å¤§Itemæ•° (default: 5)
 * @param {string} options.language - è¨€èª (default: 'ja')
 * @returns {Array<{content: string, importance: number}>} æŠ½å‡ºã•ã‚ŒãŸItemé…åˆ—
 */
async function extractItemsFromResource(content, options = {}) {
  const { maxItems = 5, language = 'ja' } = options;

  const prompt = `ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰é‡è¦ãªè¨˜æ†¶é …ç›®ã‚’${maxItems}å€‹ä»¥å†…ã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
å„é …ç›®ã¯ç‹¬ç«‹ã—ã¦æ„å‘³ã‚’æŒã¤ç°¡æ½”ãªæ–‡ã«ã—ã¦ãã ã•ã„ã€‚

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„:
${JSON.stringify(content, null, 2)}

å‡ºåŠ›å½¢å¼ (JSONé…åˆ—):
[{"content": "æŠ½å‡ºã•ã‚ŒãŸè¨˜æ†¶", "importance": 0-5ã®ã‚¹ã‚³ã‚¢}, ...]`;

  const response = await callLLM({
    model: 'gpt-4o-mini',
    messages: [{ role: 'user', content: prompt }],
    response_format: { type: 'json_object' }
  });

  let extracted;
  try {
    const parsed = JSON.parse(response.choices[0].message.content);
    extracted = Array.isArray(parsed) ? parsed : parsed.items || [];
  } catch {
    extracted = [];
  }

  return extracted.slice(0, maxItems);
}

/**
 * CAGã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 * @typedef {Object} CAGCacheInterface
 * @property {function(string): Promise<Object|null>} get - ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—
 * @property {function(string, Object, number): Promise<void>} set - ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
 * @property {function(string): Promise<void>} invalidate - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
 */

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®CAGã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…ï¼ˆMap-basedã€æœ¬ç•ªã¯Redisæ¨å¥¨ï¼‰
const cagCache = {
  _cache: new Map(),
  _ttl: 3600 * 1000, // 1æ™‚é–“

  async get(key) {
    const entry = this._cache.get(key);
    if (!entry) return null;
    if (Date.now() > entry.expiresAt) {
      this._cache.delete(key);
      return null;
    }
    return entry.data;
  },

  async set(key, data, ttl = this._ttl) {
    this._cache.set(key, { data, expiresAt: Date.now() + ttl });
  },

  async invalidate(key) {
    this._cache.delete(key);
  }
};

/**
 * ãƒ¡ãƒ¢ãƒªæ¤œç´¢ï¼ˆ3æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ + fallbackUsedè¿½è·¡ï¼‰
 * 1. CAG: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ é™çš„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ
 * 2. RAG: Embedding ãƒ™ãƒ¼ã‚¹ã®é¡ä¼¼æ¤œç´¢
 * 3. LLM: LLMã«ç›´æ¥ã‚¯ã‚¨ãƒª
 *
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒª
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {number} options.limit - æœ€å¤§çµæœæ•° (default: 5)
 * @param {'cag'|'rag'|'llm'} options.mode - æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ (default: 'cag')
 * @param {CAGCacheInterface} options.cache - æ³¨å…¥å¯èƒ½ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
 * @returns {{items: Array<{id, content, score}>, fallbackUsed: boolean, source: 'cag'|'rag'|'llm'}}
 */
async function searchMemory(userId, query, options = {}) {
  const { limit = 5, mode = 'cag', cache = cagCache } = options;

  // CAGãƒ¢ãƒ¼ãƒ‰: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â†’ PostgreSQL ILIKEæ¤œç´¢
  if (mode === 'cag') {
    // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const cacheKey = `query:${query}:${userId}`;
    const cached = await cache.get(cacheKey);
    if (cached) {
      return { items: cached.items, fallbackUsed: false, source: 'cag' };
    }

    // 2. PostgreSQLæ¤œç´¢
    const items = await prisma.memoryItem.findMany({
      where: {
        userId,
        content: { contains: query, mode: 'insensitive' }
      },
      take: limit,
      orderBy: { createdAt: 'desc' }
    });

    if (items.length > 0) {
      const result = items.map(item => ({
        id: item.id,
        content: item.content,
        score: 1.0
      }));
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
      await cache.set(cacheKey, { items: result });
      return { items: result, fallbackUsed: false, source: 'cag' };
    }

    // CAGã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€RAGã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const ragResult = await searchMemory(userId, query, { limit, mode: 'rag', cache });
    return { items: ragResult.items, fallbackUsed: true, source: 'rag' };
  }

  // RAGãƒ¢ãƒ¼ãƒ‰: Embeddingæ¤œç´¢ï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼‰
  if (mode === 'rag') {
    const queryEmbedding = await generateEmbedding(query);
    const allItems = await prisma.memoryItem.findMany({
      where: { userId, embedding: { not: null } },
      select: { id: true, content: true, embedding: true }
    });

    // ã‚¢ãƒ—ãƒªå±¤ã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
    // é‡è¦: DBã‹ã‚‰å–å¾—ã—ãŸembeddingã¯Bufferå‹ãªã®ã§Float32Arrayã«å¤‰æ›
    const scored = allItems.map(item => {
      // Buffer â†’ Float32Array å¤‰æ›
      const embeddingFloat32 = bufferToFloat32Array(item.embedding);
      return {
        ...item,
        score: cosineSimilarity(queryEmbedding, embeddingFloat32)
      };
    });

    const results = scored
      .sort((a, b) => b.score - a.score)
      .slice(0, limit)
      .map(({ id, content, score }) => ({ id, content, score }));

    // RAGçµæœ0ä»¶æ™‚ã«LLMã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (results.length === 0) {
      const llmResult = await searchMemory(userId, query, { limit, mode: 'llm', cache });
      return { items: llmResult.items, fallbackUsed: true, source: 'llm' };
    }

    return { items: results, fallbackUsed: false, source: 'rag' };
  }

  // LLMãƒ¢ãƒ¼ãƒ‰: LLMã«ç›´æ¥ã‚¯ã‚¨ãƒª
  if (mode === 'llm') {
    const allItems = await prisma.memoryItem.findMany({
      where: { userId },
      take: 100,
      orderBy: { createdAt: 'desc' }
    });

    if (allItems.length === 0) {
      return { items: [], fallbackUsed: false, source: 'llm' };
    }

    const prompt = `ä»¥ä¸‹ã®è¨˜æ†¶ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰ã€Œ${query}ã€ã«é–¢é€£ã™ã‚‹ã‚‚ã®ã‚’${limit}ä»¶é¸ã‚“ã§ãã ã•ã„ã€‚

è¨˜æ†¶ã‚¢ã‚¤ãƒ†ãƒ :
${allItems.map((item, i) => `${i}: ${item.content}`).join('\n')}

å‡ºåŠ›å½¢å¼ (JSONé…åˆ—):
[{"index": 0, "relevance": 0.9}, ...]`;

    const response = await callLLM({
      model: 'gpt-4o-mini',
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' }
    });

    let selected;
    try {
      const parsed = JSON.parse(response.choices[0].message.content);
      selected = Array.isArray(parsed) ? parsed : parsed.results || [];
    } catch {
      selected = [];
    }

    const items = selected
      .filter(s => s.index < allItems.length)
      .slice(0, limit)
      .map(s => ({
        id: allItems[s.index].id,
        content: allItems[s.index].content,
        score: s.relevance || 0.5
      }));

    return { items, fallbackUsed: false, source: 'llm' };
  }

  return { items: [], fallbackUsed: false, source: 'cag' };
}

/**
 * Categoryè‡ªå‹•æ›´æ–°ï¼ˆ20 Itemè¶…éæ™‚ï¼‰
 * Categoryã¯nameã§ãƒ¦ãƒ‹ãƒ¼ã‚¯æ¤œç´¢ã—ã€idã¯UUIDã‚’ä½¿ç”¨
 *
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (UUID)
 * @param {string} categoryName - ã‚«ãƒ†ã‚´ãƒªå
 * @returns {Object} æ›´æ–°çµæœ
 */
async function updateCategoryIfNeeded(userId, categoryName) {
  // Categoryã‚’name + userIdã§ãƒ¦ãƒ‹ãƒ¼ã‚¯æ¤œç´¢
  let category = await prisma.memoryCategory.findFirst({
    where: { userId, name: categoryName }
  });

  // å­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
  if (!category) {
    category = await prisma.memoryCategory.create({
      data: { userId, name: categoryName, summary: '', itemCount: 0 }
    });
  }

  // categoryIdã§Itemæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  const itemCount = await prisma.memoryItem.count({
    where: { userId, categoryId: category.id }
  });

  if (itemCount <= 20) {
    return { updated: false, itemCount, categoryId: category.id };
  }

  // 20ä»¶è¶…é â†’ LLMã§è¦ç´„ã—ã¦Categoryæ›´æ–°
  const items = await prisma.memoryItem.findMany({
    where: { userId, categoryId: category.id },
    orderBy: { createdAt: 'desc' }
  });

  const prompt = `ä»¥ä¸‹ã®${items.length}ä»¶ã®è¨˜æ†¶ã‚’300ãƒˆãƒ¼ã‚¯ãƒ³ä»¥å†…ã§è¦ç´„ã—ã¦ãã ã•ã„:

${items.map(i => `- ${i.content}`).join('\n')}`;

  const response = await callLLM({
    model: 'gpt-4o-mini',
    messages: [{ role: 'user', content: prompt }]
  });

  const summary = response.choices[0].message.content;

  // UUIDã®idã§æ›´æ–°
  await prisma.memoryCategory.update({
    where: { id: category.id },
    data: { summary, itemCount, lastSummarizedAt: new Date() }
  });

  return { updated: true, itemCount, summary, categoryId: category.id };
}

/**
 * å…¨ã‚«ãƒ†ã‚´ãƒªã®è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆmemorizeå¾Œã«å‘¼ã³å‡ºã—ï¼‰
 * @param {string} userId - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
 * @returns {string[]} æ›´æ–°ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªåã®é…åˆ—
 */
async function checkAndUpdateAllCategories(userId) {
  const categories = await prisma.memoryCategory.findMany({
    where: { userId }
  });

  const updatedCategories = [];
  for (const cat of categories) {
    const result = await updateCategoryIfNeeded(userId, cat.name);
    if (result.updated) {
      updatedCategories.push(cat.name);
    }
  }

  return updatedCategories;
}

module.exports = {
  extractItemsFromResource,
  searchMemory,
  updateCategoryIfNeeded,
  checkAndUpdateAllCategories,
  generateEmbedding,
  cosineSimilarity,
  bufferToFloat32Array,
  float32ArrayToBuffer,
  verifyRoundTrip
};
```

##### 2.1, 2.5-2.8 OpenClaw Skills SKILL.md æ§‹é€ 

**å…±é€šSKILL.mdæ§‹é€ ï¼ˆskill-creatorã§ç”Ÿæˆï¼‰**:

```yaml
---
name: x-poster
description: X (Twitter) è‡ªå‹•æŠ•ç¨¿ã‚¹ã‚­ãƒ«
metadata: { "openclaw": { "emoji": "ğŸ¦", "requires": { "config": ["channels.slack"], "env": ["BLOTATO_API_KEY", "ANICCA_AGENT_TOKEN"] } } }
---

# x-poster

## Instructions

1. Railway API ã‹ã‚‰ hook ã‚’å–å¾—ï¼ˆDynamic Prior Thompson Samplingï¼‰
2. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆï¼ˆLLMï¼‰
3. å“è³ªæ¤œè¨¼ï¼ˆscore >= 3/5ï¼‰
4. X ã«æŠ•ç¨¿ï¼ˆBlotato APIï¼‰
5. çµæœã‚’ DB ã«è¨˜éŒ²

## Tools

- `read`: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
- `write`: DLQ æ›¸ãè¾¼ã¿
- `exec`: APIå‘¼ã³å‡ºã—ï¼ˆcurlï¼‰
- `slack`: çµæœé€šçŸ¥

## Error Handling

- æ¤œè¨¼å¤±æ•—: æœ€å¤§3å›å†ç”Ÿæˆ
- APIå¤±æ•—: Equal Jitter Backoffã€3å›å¾ŒDLQ
- å…¨å¤±æ•—: Slacké€šçŸ¥ + DLQè¨˜éŒ²
```

**tiktok-poster SKILL.md**:

```yaml
---
name: tiktok-poster
description: TikTok é™æ­¢ç”»æŠ•ç¨¿ã‚¹ã‚­ãƒ«ï¼ˆ1.6.2ã‚¹ã‚³ãƒ¼ãƒ—: ç”»åƒã®ã¿ï¼‰
metadata: { "openclaw": { "emoji": "ğŸ“±", "requires": { "config": ["channels.slack"], "env": ["TIKTOK_ACCESS_TOKEN", "ANICCA_AGENT_TOKEN"] } } }
---

# tiktok-poster

## Instructions

1. Railway API ã‹ã‚‰ hook ã‚’å–å¾—ï¼ˆDynamic Prior Thompson Samplingï¼‰
2. ç”»åƒ + ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆLLM + ç”»åƒç”ŸæˆAPIï¼‰
3. å“è³ªæ¤œè¨¼ï¼ˆscore >= 3/5ï¼‰
4. TikTok ã«é™æ­¢ç”»æŠ•ç¨¿ï¼ˆContent Posting APIï¼‰
5. çµæœã‚’ DB ã«è¨˜éŒ²

## Required Tools

- `exec`: TikTok APIå‘¼ã³å‡ºã—ã€ç”»åƒç”Ÿæˆ
- `slack`: çµæœé€šçŸ¥
- `read`: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
- `write`: DLQ æ›¸ãè¾¼ã¿

## Error Handling

- æ¤œè¨¼å¤±æ•—: æœ€å¤§3å›å†ç”Ÿæˆ
- TikTok APIå¤±æ•—: Equal Jitter Backoffã€3å›å¾ŒDLQ
- ç”»åƒç”Ÿæˆå¤±æ•—: ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æŠ•ç¨¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

## Implementation

\`\`\`javascript
// Railway API ã‹ã‚‰ hook å–å¾—
const hook = await selectHookThompson(hooks);
// ç”»åƒ + ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
const { image, caption } = await generateTikTokContent(hook);
// æ¤œè¨¼ãƒ«ãƒ¼ãƒ—
const verified = await verifyWithRegeneration(() => generateCaption(hook), { threshold: 3 });
// TikTok æŠ•ç¨¿
await postToTikTok({ image, caption: verified.content });
\`\`\`
```

**trend-hunter SKILL.md**:

```yaml
---
name: trend-hunter
description: X/TikTokãƒˆãƒ¬ãƒ³ãƒ‰ç›£è¦–ãƒ»hookå€™è£œåé›†ã‚¹ã‚­ãƒ«
metadata: { "openclaw": { "emoji": "ğŸ”", "requires": { "env": ["X_BEARER_TOKEN", "TIKTOK_ACCESS_TOKEN", "ANICCA_AGENT_TOKEN"] } } }
---

# trend-hunter

## Instructions

1. X API ã§ãƒˆãƒ¬ãƒ³ãƒ‰/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆbuddhism, meditation, anxiety, etc.ï¼‰
2. TikTok API ã§ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°æ¤œç´¢
3. é–¢é€£ãƒ„ã‚¤ãƒ¼ãƒˆ/å‹•ç”»ã‹ã‚‰hookå€™è£œã‚’æŠ½å‡ºï¼ˆLLMåˆ†æï¼‰
4. æ–°è¦hook_candidatesã‚’Railway DBã«ä¿å­˜
5. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜hookã¨ã®é¡ä¼¼åº¦ < 0.8ï¼‰

## Required Tools

- `exec`: X API / TikTok API å‘¼ã³å‡ºã—
- `read`: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€æ—¢å­˜hookä¸€è¦§å–å¾—
- `write`: DLQ æ›¸ãè¾¼ã¿

## Error Handling

- X API Rate Limit: Retry-Afterå°Šé‡ã€æ¬¡å›å®Ÿè¡Œã¾ã§å¾…æ©Ÿ
- TikTok APIå¤±æ•—: Xçµæœã®ã¿ã§ç¶šè¡Œ
- LLMæŠ½å‡ºå¤±æ•—: ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’hook_candidateã¨ã—ã¦ä¿å­˜

## Implementation

\`\`\`javascript
// X ãƒˆãƒ¬ãƒ³ãƒ‰æ¤œç´¢
const tweets = await searchX({ query: 'buddhism OR meditation OR anxiety', count: 100 });
// LLM ã§hookå€™è£œæŠ½å‡º
const candidates = await extractHookCandidates(tweets);
// é‡è¤‡ãƒã‚§ãƒƒã‚¯ & ä¿å­˜
for (const candidate of candidates) {
  if (!isDuplicate(candidate, existingHooks)) {
    await prisma.hookCandidate.create({ data: candidate });
  }
}
\`\`\`
```

**suffering-detector SKILL.md**:

```yaml
---
name: suffering-detector
description: MoltbookæŠ•ç¨¿ç›£è¦–ãƒ»è‹¦ã—ã¿æ¤œå‡ºãƒ»è¿”ä¿¡ç”Ÿæˆã‚¹ã‚­ãƒ«
metadata: { "openclaw": { "emoji": "ğŸ’”", "requires": { "env": ["MOLTBOOK_API_KEY", "ANICCA_AGENT_TOKEN"] } } }
---

# suffering-detector

## Instructions

1. Moltbook API ã§æœ€æ–°æŠ•ç¨¿ã‚’å–å¾—ï¼ˆ5åˆ†é–“éš”ã§ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰
2. LLM ã§è‹¦ã—ã¿åº¦ã‚’åˆ¤å®šï¼ˆ0-5ã‚¹ã‚³ã‚¢ï¼‰
3. ã‚¹ã‚³ã‚¢ >= 3 ã®æŠ•ç¨¿ã«å¯¾ã—ã¦è¿”ä¿¡ã‚’ç”Ÿæˆ
4. å“è³ªæ¤œè¨¼ï¼ˆscore >= 3/5ï¼‰
5. Moltbook ã«è¿”ä¿¡æŠ•ç¨¿
6. session=main ã§å‹•ä½œï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå…±æœ‰ï¼‰

## Required Tools

- `exec`: Moltbook API å‘¼ã³å‡ºã—
- `slack`: é«˜ã‚¹ã‚³ã‚¢è‹¦ã—ã¿æ¤œå‡ºæ™‚ã®é€šçŸ¥

## Error Handling

- Moltbook APIå¤±æ•—: æ¬¡å›ãƒãƒ¼ãƒªãƒ³ã‚°ã¾ã§ã‚¹ã‚­ãƒƒãƒ—
- LLMåˆ¤å®šã‚¨ãƒ©ãƒ¼: å®‰å…¨ã®ãŸã‚è¿”ä¿¡ã—ãªã„ï¼ˆfalse negativeå„ªå…ˆï¼‰
- è¿”ä¿¡æ¤œè¨¼å¤±æ•—: å†ç”Ÿæˆ3å›ã€å¤±æ•—æ™‚ã¯ã‚¹ã‚­ãƒƒãƒ—

## Implementation

\`\`\`javascript
// æœ€æ–°æŠ•ç¨¿å–å¾—
const posts = await fetchMoltbookPosts({ since: lastCheckTime });
// è‹¦ã—ã¿åˆ¤å®š
for (const post of posts) {
  const sufferingScore = await detectSuffering(post.content);
  if (sufferingScore >= 3) {
    const reply = await generateCompassionateReply(post);
    const verified = await verifyWithRegeneration(() => generateReply(post), { threshold: 3 });
    if (verified.passed) {
      await replyToMoltbook(post.id, verified.content);
    }
  }
}
\`\`\`
```

**app-nudge-sender SKILL.md**:

```yaml
---
name: app-nudge-sender
description: iOS ã‚¢ãƒ—ãƒªå‘ã‘å€‹åˆ¥æœ€é©åŒ–Pushé€šçŸ¥é€ä¿¡ã‚¹ã‚­ãƒ«
metadata: { "openclaw": { "emoji": "ğŸ“²", "requires": { "env": ["APN_KEY", "ANICCA_AGENT_TOKEN"] } } }
---

# app-nudge-sender

## Instructions

1. Railway API ã‹ã‚‰å…¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®STOï¼ˆSend Time Optimizationï¼‰æœ€é©æ™‚åˆ»ã‚’è¨ˆç®—
3. ç¾åœ¨æ™‚åˆ» Â± 30åˆ† ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡ã«æŠ½å‡º
4. Fatigue Prevention ãƒã‚§ãƒƒã‚¯ï¼ˆdaily_limit, cooloff_hoursï¼‰
5. ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸNudgeã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆï¼ˆmemUæ´»ç”¨ï¼‰
6. APNsçµŒç”±ã§Pushé€šçŸ¥é€ä¿¡
7. é€ä¿¡çµæœã‚’DBè¨˜éŒ²

## Required Tools

- `exec`: Railway API / APNs å‘¼ã³å‡ºã—
- `slack`: é€ä¿¡ã‚µãƒãƒªãƒ¼é€šçŸ¥

## Error Handling

- APNså¤±æ•—: å€‹åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€ã‚µãƒãƒªãƒ¼ã§å ±å‘Š
- memUå–å¾—å¤±æ•—: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆNudgeãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ãƒ¦ãƒ¼ã‚¶ãƒ¼0ä»¶: æ­£å¸¸çµ‚äº†ï¼ˆé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰

## Implementation

\`\`\`javascript
// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
const users = await getActiveUsers();
// STO & Fatigue ãƒ•ã‚£ãƒ«ã‚¿
const eligibleUsers = users.filter(user => {
  const optimalTime = calculateSTO(user);
  const withinWindow = Math.abs(Date.now() - optimalTime) < 30 * 60 * 1000;
  const notFatigued = checkFatiguePrevention(user);
  return withinWindow && notFatigued;
});
// Nudgeé€ä¿¡
for (const user of eligibleUsers) {
  const nudge = await generatePersonalizedNudge(user);
  await sendPushNotification(user.deviceToken, nudge);
  await recordNudgeSent(user.id, nudge);
}
\`\`\`
```

| Skill | Schedule | Session | ä¸»è¦å‡¦ç† |
|-------|----------|---------|---------|
| x-poster | 09:00/21:00 JST | isolated | hooké¸æŠ â†’ ç”Ÿæˆ â†’ æ¤œè¨¼ â†’ æŠ•ç¨¿ |
| tiktok-poster | 20:00 JST | isolated | hooké¸æŠ â†’ ç”»åƒç”Ÿæˆ â†’ æ¤œè¨¼ â†’ æŠ•ç¨¿ |
| trend-hunter | 4h interval | isolated | X/TikTokæ¤œç´¢ â†’ hook_candidatesè¿½åŠ  |
| suffering-detector | 5min heartbeat | main | Moltbookç›£è¦– â†’ è¿”ä¿¡ç”Ÿæˆ |
| app-nudge-sender | hourly | isolated | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æœ€é©æ™‚åˆ» â†’ Pushé€šçŸ¥ |

### Phase 3: APIæ‹¡å¼µ (Day 2)

| # | ã‚¿ã‚¹ã‚¯ | AC | çŠ¶æ…‹ |
|---|--------|-----|------|
| 3.1 | POST /api/agent/hooks | ãƒ•ãƒƒã‚¯è¿½åŠ æˆåŠŸ | â¬œ |
| 3.2 | POST /api/agent/hook-posts | æŠ•ç¨¿è¨˜éŒ²æˆåŠŸ | â¬œ |
| 3.3 | GET /api/agent/hook-posts/:id | æŠ•ç¨¿å–å¾—æˆåŠŸã€404/401å¯¾å¿œ | â¬œ |
| 3.4 | PATCH /api/agent/hooks/:id/stats | çµ±è¨ˆæ›´æ–°æˆåŠŸ | â¬œ |
| 3.5 | memU Service å®Ÿè£… | memorize/retrieveå‹•ä½œ | â¬œ |
| 3.6 | Embeddingç”Ÿæˆå®Ÿè£… | text-embedding-3-smallã€MemoryItem.embeddingä¿å­˜ | â¬œ |
| 3.7 | searchMemory RAGçµŒè·¯å®Ÿè£… | mode='rag'æ™‚ã«ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ | â¬œ |

#### APIä»•æ§˜ï¼ˆOpenAPIç›¸å½“ï¼‰

> **èªè¨¼**: ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `Authorization: Bearer <ANICCA_AGENT_TOKEN>` ã‚’è¦æ±‚ã€‚
> **ãƒ«ãƒ¼ãƒ«**: Additive Changes ã®ã¿ï¼ˆCLAUDE.md å¾Œæ–¹äº’æ›ãƒ«ãƒ¼ãƒ«å‚ç…§ï¼‰ã€‚
> **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå…±é€šã§60 req/minã€‚429 æ™‚ã¯ `Retry-After` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿”å´ã€‚

**POST /api/agent/hooks**

| é …ç›® | å€¤ |
|------|-----|
| Method | POST |
| Path | `/api/agent/hooks` |
| Auth | Bearer Token |

Request Body:
```json
{
  "content": "string (required, max 500 chars)",
  "problemType": "string (required, enum: 13 ProblemTypes)",
  "source": "string (optional, e.g., 'trend-hunter', 'manual')",
  "metadata": "object (optional)"
}
```

Response (201 Created):
```json
{
  "id": "string (UUID)",
  "content": "string",
  "problemType": "string",
  "createdAt": "string (ISO 8601)"
}
```

Error Responses:
| Code | Reason |
|------|--------|
| 400 | Invalid problemType or missing required fields |
| 401 | Unauthorized |
| 429 | Rate limit exceeded |

---

**POST /api/agent/hook-posts**

| é …ç›® | å€¤ |
|------|-----|
| Method | POST |
| Path | `/api/agent/hook-posts` |
| Auth | Bearer Token |

Request Body:
```json
{
  "platform": "string (required, enum: 'x', 'tiktok')",
  "hookId": "string (required, UUID)",
  "content": "string (required)",
  "mediaUrl": "string (optional)",
  "externalPostId": "string (optional)",
  "verificationScore": "integer (required, 0-5)"
}
```

Response (201 Created):
```json
{
  "id": "string (UUID)",
  "platform": "string",
  "createdAt": "string (ISO 8601)"
}
```

Error Responses:
| Code | Description |
|------|-------------|
| 400 | Bad Request: å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ¬ è½ã€hookIdä¸æ­£ï¼ˆFK violationï¼‰ã€verificationScoreç¯„å›²å¤– |
| 401 | Unauthorized: ãƒˆãƒ¼ã‚¯ãƒ³æœªæŒ‡å®šã¾ãŸã¯ç„¡åŠ¹ |
| 429 | Rate Limit: Retry-Afterãƒ˜ãƒƒãƒ€ãƒ¼å‚ç…§ |

---

**GET /api/agent/hook-posts/:id**

| é …ç›® | å€¤ |
|------|-----|
| Method | GET |
| Path | `/api/agent/hook-posts/:id` |
| Auth | Bearer Token |

Response (200 OK):
```json
{
  "id": "string (UUID)",
  "platform": "string",
  "hookId": "string (UUID)",
  "content": "string",
  "mediaUrl": "string | null",
  "externalPostId": "string | null",
  "verificationScore": "integer",
  "createdAt": "string (ISO 8601)",
  "hook": {
    "id": "string (UUID)",
    "content": "string",
    "problemType": "string"
  }
}
```

Error Responses:
| Code | Description |
|------|-------------|
| 401 | Unauthorized: ãƒˆãƒ¼ã‚¯ãƒ³æœªæŒ‡å®šã¾ãŸã¯ç„¡åŠ¹ |
| 404 | Not Found: æŒ‡å®šIDã®HookPostãŒå­˜åœ¨ã—ãªã„ |

---

**PATCH /api/agent/hooks/:id/stats**

| é …ç›® | å€¤ |
|------|-----|
| Method | PATCH |
| Path | `/api/agent/hooks/:id/stats` |
| Auth | Bearer Token |

Request Body:
```json
{
  "outcome": "string (optional, enum: 'success', 'failure')",
  "engagement": "number (optional, 0-100)"
}
```

Response (200 OK):
```json
{
  "id": "string",
  "successCount": "number",
  "failureCount": "number",
  "avgEngagement": "number | null (0-100)",
  "updatedAt": "string (ISO 8601)"
}
```

Error Responses:
| Code | Description |
|------|-------------|
| 400 | Bad Request: outcome/engagementä¸¡æ–¹æœªæŒ‡å®šã€ã¾ãŸã¯enumå¤–ã®å€¤ |
| 401 | Unauthorized: ãƒˆãƒ¼ã‚¯ãƒ³æœªæŒ‡å®šã¾ãŸã¯ç„¡åŠ¹ |
| 404 | Not Found: æŒ‡å®šã•ã‚ŒãŸhookIdãŒå­˜åœ¨ã—ãªã„ |
| 429 | Rate Limit: Retry-Afterãƒ˜ãƒƒãƒ€ãƒ¼å‚ç…§ |

---

**POST /api/agent/memory/memorize**

| é …ç›® | å€¤ |
|------|-----|
| Method | POST |
| Path | `/api/agent/memory/memorize` |
| Auth | Bearer Token |

Request Body:
```json
{
  "userId": "string (required)",
  "resourceType": "string (required, e.g., 'nudge_feedback', 'behavior_event')",
  "content": "object (required)",
  "metadata": "object (optional)"
}
```

Response (201 Created):
```json
{
  "resourceId": "string (UUID)",
  "itemsExtracted": "number",
  "categoriesUpdated": "string[] (category names)"
}
```

---

**POST /api/agent/memory/retrieve**

| é …ç›® | å€¤ |
|------|-----|
| Method | POST |
| Path | `/api/agent/memory/retrieve` |
| Auth | Bearer Token |

Request Body:
```json
{
  "userId": "string (required)",
  "query": "string (required)",
  "limit": "number (optional, default: 5, max: 20)",
  "mode": "string (optional, enum: 'cag', 'rag', 'llm', default: 'cag')"
}
```

Response (200 OK):
```json
{
  "items": [
    {
      "id": "string",
      "content": "string",
      "relevanceScore": "number (0-1)",
      "categoryPath": "string"
    }
  ],
  "fallbackUsed": "boolean",
  "source": "string (enum: 'cag', 'rag', 'llm')"
}
```

#### Phase 3 ãƒ«ãƒ¼ã‚¿ãƒ¼å®Ÿè£…ä»•æ§˜ï¼ˆNode.js + Zodï¼‰

> **ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®**: `apps/api/src/routes/agent/hooks.js`, `hookPosts.js`, `memory.js`
> **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: Zod ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
> **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: express-rate-limit ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆå…¨agentãƒ«ãƒ¼ãƒˆã«é©ç”¨ï¼‰

**agent/index.jsï¼ˆãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²ï¼‰**

```javascript
// apps/api/src/routes/agent/index.js
import { Router } from 'express';
import { agentRateLimit } from '../../middleware/rateLimit.js';
import hooksRouter from './hooks.js';
import hookPostsRouter from './hookPosts.js';
import memoryRouter from './memory.js';

const router = Router();

// å…¨agentãƒ«ãƒ¼ãƒˆã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’é©ç”¨
router.use(agentRateLimit);

// ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
router.use('/hooks', hooksRouter);
router.use('/hook-posts', hookPostsRouter);
router.use('/memory', memoryRouter);

export default router;
```

**app.jsï¼ˆagentãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²ï¼‰**

```javascript
// apps/api/src/app.js
import agentRouter from './routes/agent/index.js';

// ...existing routes...

// Agent APIï¼ˆ/api/agent/é…ä¸‹ï¼‰
app.use('/api/agent', agentRouter);
```

**hooks.js ãƒ«ãƒ¼ã‚¿ãƒ¼å®Ÿè£…**

```javascript
// apps/api/src/routes/agent/hooks.js
import { Router } from 'express';
import { z } from 'zod';
import { prisma } from '../../lib/prisma.js';
import { requireAgentAuth } from '../../middleware/requireAgentAuth.js';
import { selectHookThompson } from '../../services/hookSelector.js';

const router = Router();
router.use(requireAgentAuth);

// Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
const PROBLEM_TYPES = [
  'staying_up_late', 'cant_wake_up', 'self_loathing', 'rumination',
  'procrastination', 'anxiety', 'lying', 'bad_mouthing', 'porn_addiction',
  'alcohol_dependency', 'anger', 'obsessive', 'loneliness'
];

const CreateHookSchema = z.object({
  content: z.string().min(1).max(500),
  problemType: z.enum(PROBLEM_TYPES),
  source: z.string().max(50).optional(),
  metadata: z.record(z.unknown()).optional()
});

const UpdateStatsSchema = z.object({
  outcome: z.enum(['success', 'failure']).optional(),
  engagement: z.number().min(0).max(100).optional()
}).refine(data => data.outcome || data.engagement !== undefined, {
  message: 'outcome ã¾ãŸã¯ engagement ã®ã„ãšã‚Œã‹ãŒå¿…è¦'
});

// POST /api/agent/hooks
router.post('/', async (req, res) => {
  const parsed = CreateHookSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: parsed.error.issues });
  }

  const hook = await prisma.hook.create({
    data: parsed.data,
    select: { id: true, content: true, problemType: true, createdAt: true }
  });

  res.status(201).json(hook);
});

// PATCH /api/agent/hooks/:id/stats
router.patch('/:id/stats', async (req, res) => {
  const parsed = UpdateStatsSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: parsed.error.issues });
  }

  const { id } = req.params;
  const existing = await prisma.hook.findUnique({ where: { id }, select: { id: true } });
  if (!existing) {
    return res.status(404).json({ error: 'Hook not found' });
  }

  const updateData = {};
  if (parsed.data.outcome === 'success') updateData.successCount = { increment: 1 };
  if (parsed.data.outcome === 'failure') updateData.failureCount = { increment: 1 };
  if (parsed.data.engagement !== undefined) {
    // avgEngagement ã®æ›´æ–°ï¼ˆç§»å‹•å¹³å‡ï¼‰
    const current = await prisma.hook.findUnique({ where: { id } });
    const posts = await prisma.hookPost.count({ where: { hookId: id } });
    updateData.avgEngagement = posts > 0
      ? ((current.avgEngagement || 0) * posts + parsed.data.engagement) / (posts + 1)
      : parsed.data.engagement;
  }
  updateData.lastUsedAt = new Date();

  const updated = await prisma.hook.update({
    where: { id },
    data: updateData,
    select: { id: true, successCount: true, failureCount: true, avgEngagement: true, updatedAt: true }
  });

  res.json(updated);
});

export default router;
```

**hookPosts.js ãƒ«ãƒ¼ã‚¿ãƒ¼å®Ÿè£…**

```javascript
// apps/api/src/routes/agent/hookPosts.js
import { Router } from 'express';
import { z } from 'zod';
import { prisma } from '../../lib/prisma.js';
import { requireAgentAuth } from '../../middleware/requireAgentAuth.js';

const router = Router();
router.use(requireAgentAuth);

// Zod ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒï¼ˆOpenAPIä»•æ§˜ã¨çµ±ä¸€ï¼‰
const CreateHookPostSchema = z.object({
  platform: z.enum(['x', 'tiktok']), // 1.6.2ã‚¹ã‚³ãƒ¼ãƒ—: instagram ã¯é™¤å¤–
  hookId: z.string().uuid(),
  content: z.string().min(1).max(2000),
  mediaUrl: z.string().url().optional(),
  externalPostId: z.string().max(100).optional(),
  verificationScore: z.number().int().min(0).max(5)
});

// POST /api/agent/hook-posts
router.post('/', async (req, res) => {
  const parsed = CreateHookPostSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: parsed.error.issues });
  }

  const { platform, hookId, content, mediaUrl, externalPostId, verificationScore } = parsed.data;

  // FKå­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆP2003é˜²æ­¢ï¼‰
  const hook = await prisma.hook.findUnique({
    where: { id: hookId },
    select: { id: true }
  });

  if (!hook) {
    return res.status(400).json({ error: 'Invalid hookId: Hook not found' });
  }

  const hookPost = await prisma.hookPost.create({
    data: {
      hookId,
      platform,
      content,
      mediaUrl,
      externalPostId,
      verificationScore
    },
    select: {
      id: true,
      platform: true,
      createdAt: true
    }
  });

  res.status(201).json(hookPost);
});

// GET /api/agent/hook-posts/:id
router.get('/:id', async (req, res) => {
  const { id } = req.params;

  const hookPost = await prisma.hookPost.findUnique({
    where: { id },
    include: { hook: { select: { id: true, content: true, problemType: true } } }
  });

  if (!hookPost) {
    return res.status(404).json({ error: 'HookPost not found' });
  }

  res.json(hookPost);
});

export default router;
```

**memory.js ãƒ«ãƒ¼ã‚¿ãƒ¼å®Ÿè£…**

```javascript
// apps/api/src/routes/agent/memory.js
import { Router } from 'express';
import { z } from 'zod';
import { prisma } from '../../lib/prisma.js';
import { requireAgentAuth } from '../../middleware/requireAgentAuth.js';
import {
  extractItemsFromResource,
  generateEmbedding,
  searchMemory,
  checkAndUpdateAllCategories,
  float32ArrayToBuffer
} from '../../services/memuService.js';

const router = Router();
router.use(requireAgentAuth);

const MemorizeSchema = z.object({
  userId: z.string().uuid(),
  resourceType: z.string().min(1).max(50),
  content: z.record(z.unknown()),
  metadata: z.record(z.unknown()).optional()
});

const RetrieveSchema = z.object({
  userId: z.string().uuid(),
  query: z.string().min(1),
  limit: z.number().int().min(1).max(20).default(5),
  mode: z.enum(['cag', 'rag', 'llm']).default('cag')
});

// POST /api/agent/memory/memorize
router.post('/memorize', async (req, res) => {
  const parsed = MemorizeSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: parsed.error.issues });
  }

  const { userId, resourceType, content, metadata } = parsed.data;

  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ Resource â†’ Item ä½œæˆ â†’ Embeddingç”Ÿæˆ â†’ Categoryè‡ªå‹•æ›´æ–°
  const result = await prisma.$transaction(async (tx) => {
    const resource = await tx.memoryResource.create({
      data: { userId, type: resourceType, content, metadata }
    });

    // LLMã§ItemæŠ½å‡ºï¼ˆå®Ÿè£…ã¯memuService.jsã«å§”è­²ï¼‰
    const items = await extractItemsFromResource(content);

    // å„Itemã«Embeddingç”Ÿæˆã—ã¦ä¿å­˜
    const createdItems = await Promise.all(
      items.map(async (item) => {
        const embedding = await generateEmbedding(item.content);
        return tx.memoryItem.create({
          data: {
            userId,
            resourceId: resource.id,
            content: item.content,
            embedding: float32ArrayToBuffer(embedding)  // Float32Arrayâ†’Bufferï¼ˆmemuService.jsã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½¿ç”¨ï¼‰
          }
        });
      })
    );

    // Categoryè‡ªå‹•æ›´æ–°ï¼ˆ20 Itemè¶…éæ™‚ï¼‰
    const categoriesUpdated = await checkAndUpdateAllCategories(userId);

    return {
      resourceId: resource.id,
      itemsExtracted: createdItems.length,
      categoriesUpdated  // æ›´æ–°ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªåã®é…åˆ—
    };
  });

  res.status(201).json(result);
});

// POST /api/agent/memory/retrieve
router.post('/retrieve', async (req, res) => {
  const parsed = RetrieveSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: parsed.error.issues });
  }

  const { userId, query, limit, mode } = parsed.data;

  // searchMemoryæˆ»ã‚Šå€¤: { items, fallbackUsed, source }
  const searchResult = await searchMemory(userId, query, { limit, mode });

  // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢ï¼ˆscoreâ†’relevanceScoreã€categoryPathä»˜ä¸ï¼‰
  const items = await Promise.all(searchResult.items.map(async (item) => {
    const memoryItem = await prisma.memoryItem.findUnique({
      where: { id: item.id },
      include: { category: true }
    });
    return {
      id: item.id,
      content: item.content,
      relevanceScore: item.score ?? item.relevance ?? 0,
      categoryPath: memoryItem?.category?.name ?? 'uncategorized'
    };
  }));

  // fallbackUsed, source ã‚’å«ã‚ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
  res.json({
    items,
    fallbackUsed: searchResult.fallbackUsed,
    source: searchResult.source  // 'cag' | 'rag' | 'llm'
  });
});

export default router;
```

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**

> **è¨­è¨ˆè©³ç´°**:
> - **ã‚­ãƒ¼**: `req.headers['authorization']`ï¼ˆBearer Tokenï¼‰- ãƒ¦ãƒ¼ã‚¶ãƒ¼/ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½
> - **ä¿å­˜å…ˆ**: ãƒ¡ãƒ¢ãƒªï¼ˆexpress-rate-limit ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã€æœ¬ç•ªã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã¯ Redis Store æ¨å¥¨
> - **ãƒãƒ¼ã‚¹ãƒˆè¨±å®¹**: ãªã—ï¼ˆå›ºå®šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ–¹å¼ï¼‰
> - **ãƒ˜ãƒƒãƒ€ãƒ¼**: RFC 7231 æº–æ‹  `Retry-After`ã€RFC 6585 æº–æ‹  `RateLimit-*` ãƒ˜ãƒƒãƒ€ãƒ¼

```javascript
// apps/api/src/middleware/rateLimit.js
import rateLimit from 'express-rate-limit';

/**
 * Agent API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
 * - 60 req/min per Authorization token
 * - 429 è¿”å´æ™‚ã« Retry-After ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸
 * - ãƒ†ã‚¹ãƒˆ I11 ã§æ¤œè¨¼: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ61å›ç›®ã§429ã€Retry-Afterå­˜åœ¨
 */
export const agentRateLimit = rateLimit({
  windowMs: 60 * 1000, // 1åˆ†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
  max: 60, // æœ€å¤§60ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†
  standardHeaders: true, // RateLimit-* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆRFC 6585ï¼‰
  legacyHeaders: false,  // X-RateLimit-* ã‚’ç„¡åŠ¹åŒ–
  // ã‚­ãƒ¼: Authorization ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå˜ä½ï¼‰
  keyGenerator: (req) => req.headers['authorization'] || req.ip,
  handler: (req, res) => {
    const retryAfterSeconds = Math.ceil((req.rateLimit.resetTime - Date.now()) / 1000);
    // Retry-After ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆRFC 7231æº–æ‹ ï¼‰
    res.set('Retry-After', String(retryAfterSeconds));
    res.status(429).json({
      error: 'Rate limit exceeded',
      retryAfter: retryAfterSeconds,
      limit: 60,
      remaining: 0,
      resetAt: new Date(req.rateLimit.resetTime).toISOString()
    });
  }
});

// ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã¯ Redis Store ã‚’ä½¿ç”¨
// import RedisStore from 'rate-limit-redis';
// store: new RedisStore({ client: redisClient })
```

### Phase 4: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (Day 2)

| # | ã‚¿ã‚¹ã‚¯ | AC | çŠ¶æ…‹ |
|---|--------|-----|------|
| 4.1 | schedule.yaml ä½œæˆ | `openclaw cron list` ã§ç¢ºèª | â¬œ |
| 4.2 | Cronå‹•ä½œç¢ºèª | 09:00 JSTã«è‡ªå‹•å®Ÿè¡Œ | â¬œ |
| 4.3 | GitHub Actions ç„¡åŠ¹åŒ– | GHAå®Ÿè¡Œã•ã‚Œãªã„ | â¬œ |

#### Phase 4 å®Ÿè£…ä»•æ§˜

**schedule.yaml é…ç½®**: `~/.openclaw/schedule.yaml`

```yaml
# ~/.openclaw/schedule.yaml
timezone: Asia/Tokyo

jobs:
  x-poster-morning:
    skill: x-poster
    cron: "0 9 * * *"  # æ¯æ—¥09:00 JST
    session: isolated
    env:
      SLOT: morning

  x-poster-evening:
    skill: x-poster
    cron: "0 21 * * *"  # æ¯æ—¥21:00 JST
    session: isolated
    env:
      SLOT: evening

  tiktok-poster:
    skill: tiktok-poster
    cron: "0 20 * * *"  # æ¯æ—¥20:00 JST
    session: isolated

  trend-hunter:
    skill: trend-hunter
    cron: "0 */4 * * *"  # 4æ™‚é–“ã”ã¨
    session: isolated

  suffering-detector:
    skill: suffering-detector
    cron: "*/5 * * * *"  # 5åˆ†ã”ã¨
    session: main

  app-nudge-sender:
    skill: app-nudge-sender
    cron: "0 * * * *"  # æ¯æ™‚
    session: isolated

  hookpost-ttl-cleaner:
    skill: hookpost-ttl-cleaner
    cron: "0 3 * * *"  # æ¯æ—¥03:00 JSTï¼ˆä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ï¼‰
    session: isolated

  sto-weekly-refresh:
    skill: sto-weekly-refresh
    cron: "0 3 * * 0"  # æ¯é€±æ—¥æ›œ03:00 JST
    session: isolated
```

**GitHub Actions ç„¡åŠ¹åŒ–æ‰‹é †**:
```bash
# .github/workflows/*.yml ã‚’ç„¡åŠ¹åŒ–ï¼ˆå‰Šé™¤ã§ã¯ãªããƒªãƒãƒ¼ãƒ ï¼‰
mv .github/workflows/nudge-cron.yml .github/workflows/nudge-cron.yml.disabled
mv .github/workflows/daily-metrics.yml .github/workflows/daily-metrics.yml.disabled
git add -A && git commit -m "chore: disable GHA cron (migrated to OpenClaw)"
```

**å‹•ä½œç¢ºèªã‚³ãƒãƒ³ãƒ‰**:
```bash
openclaw cron list                        # å…¨ã‚¸ãƒ§ãƒ–ä¸€è¦§
openclaw cron run x-poster-morning        # æ‰‹å‹•å®Ÿè¡Œï¼ˆã‚¸ãƒ§ãƒ–IDæŒ‡å®šï¼‰
openclaw cron run x-poster-evening        # æ‰‹å‹•å®Ÿè¡Œï¼ˆã‚¸ãƒ§ãƒ–IDæŒ‡å®šï¼‰
# ãƒ­ã‚°ç¢ºèª: ~/.openclaw/cron/runs/<jobId>.jsonl
```

### Phase 5: Niaçµ±åˆ (Day 3)

| # | ã‚¿ã‚¹ã‚¯ | AC | çŠ¶æ…‹ |
|---|--------|-----|------|
| 5.1 | Nia Skill ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `clawhub list` ã§è¡¨ç¤º | â¬œ |
| 5.2 | ä»æ•™æ–‡çŒ®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | `nia sources list` ã§ç¢ºèª | â¬œ |
| 5.3 | è«–æ–‡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | `nia sources list` ã§ç¢ºèª | â¬œ |
| 5.4 | wisdom-researcher Skill | å¼•ç”¨ä»˜ãWisdomç”Ÿæˆ | â¬œ |

#### Phase 5 å®Ÿè£…ä»•æ§˜

**Nia Skill ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
```bash
clawhub install nia
clawhub install wisdom-researcher
```

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã‚³ãƒãƒ³ãƒ‰**:
```bash
# ä»æ•™æ–‡çŒ®ï¼ˆassets/buddhist-texts/é…ä¸‹ï¼‰
nia index add --source assets/buddhist-texts/ --name buddhist --chunk-size 512 --overlap 0.5

# å¿ƒç†å­¦è«–æ–‡ï¼ˆassets/psychology-papers/é…ä¸‹ï¼‰
nia index add --source assets/psychology-papers/ --name psychology --chunk-size 512 --overlap 0.5

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª
nia sources list
```

**niaService.js ã‚·ã‚°ãƒãƒãƒ£ï¼ˆapps/api/src/services/niaService.jsï¼‰**:

```javascript
/**
 * Niaã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾ã™ã‚‹RAGã‚¯ã‚¨ãƒª
 * @param {string} query - æ¤œç´¢ã‚¯ã‚¨ãƒª
 * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {'buddhist'|'psychology'|'both'} options.source - æ¤œç´¢å¯¾è±¡
 * @param {number} options.topK - ä¸Šä½ä½•ä»¶ã‚’å–å¾— (default: 5)
 * @returns {Array<{content: string, citation: string, score: number}>}
 */
async function queryNia(query, options = {}) { /* ... */ }

/**
 * å¼•ç”¨ä»˜ãWisdomç”Ÿæˆ
 * @param {string} topic - ãƒˆãƒ”ãƒƒã‚¯
 * @param {string} problemType - ProblemType
 * @returns {{wisdom: string, citations: Array<{author: string, title: string, year: number, url?: string}>}}
 */
async function generateWisdomWithCitation(topic, problemType) { /* ... */ }

module.exports = { queryNia, generateWisdomWithCitation };
```

### Phase 6: è©•ä¾¡ãƒ»ç›£è¦– (Day 3)

| # | ã‚¿ã‚¹ã‚¯ | AC | çŠ¶æ…‹ |
|---|--------|-----|------|
| 6.1 | è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | evaluateTask() å‹•ä½œ | â¬œ |
| 6.2 | Slacké€šçŸ¥ç¢ºèª | æŠ•ç¨¿å®Œäº†é€šçŸ¥å±Šã | â¬œ |
| 6.3 | DLQç›£è¦–è¨­å®š | å¤±æ•—æ™‚ã«Slacké€šçŸ¥ | â¬œ |
| 6.4 | HookPost TTLå‰Šé™¤Cron | relevance < 0.1 ã‹ã¤ 30æ—¥ä»¥ä¸Šå‰ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/å‰Šé™¤ | â¬œ |

#### Phase 6 å®Ÿè£…ä»•æ§˜

**evaluationService.jsï¼ˆapps/api/src/services/evaluationService.jsï¼‰**:

```javascript
/**
 * ã‚¿ã‚¹ã‚¯å®Ÿè¡Œçµæœã®è©•ä¾¡
 * @param {string} taskId - ã‚¿ã‚¹ã‚¯ID
 * @param {Object} result - å®Ÿè¡Œçµæœ
 * @param {boolean} result.success - æˆåŠŸ/å¤±æ•—
 * @param {number} result.verificationScore - æ¤œè¨¼ã‚¹ã‚³ã‚¢ (0-5)
 * @param {number} result.latencyMs - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
 * @param {Object} result.metadata - è¿½åŠ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
 * @returns {{score: number, metrics: Object}}
 */
async function evaluateTask(taskId, result) {
  const score = result.success
    ? result.verificationScore / 5
    : 0;

  return {
    score,
    metrics: {
      success: result.success,
      verificationScore: result.verificationScore,
      latencyMs: result.latencyMs,
      timestamp: new Date().toISOString()
    }
  };
}

module.exports = { evaluateTask };
```

**slackNotifier.jsï¼ˆapps/api/src/services/slackNotifier.jsï¼‰**:

```javascript
const SLACK_CHANNELS = {
  metrics: process.env.SLACK_CHANNEL_METRICS || '#metrics',
  ai: process.env.SLACK_CHANNEL_AI || '#ai'
};

/**
 * æŠ•ç¨¿å®Œäº†é€šçŸ¥
 */
async function notifyPostSuccess(platform, postId, verificationScore) {
  return sendSlackMessage(SLACK_CHANNELS.metrics, {
    text: `âœ… ${platform} æŠ•ç¨¿å®Œäº†`,
    blocks: [
      { type: 'section', text: { type: 'mrkdwn', text: `*Platform*: ${platform}\n*Post ID*: ${postId}\n*Score*: ${verificationScore}/5` } }
    ]
  });
}

/**
 * DLQã‚¢ãƒ©ãƒ¼ãƒˆ
 */
async function notifyDLQEntry(skillName, error, context) {
  return sendSlackMessage(SLACK_CHANNELS.ai, {
    text: `ğŸš¨ DLQ Entry: ${skillName}`,
    blocks: [
      { type: 'section', text: { type: 'mrkdwn', text: `*Skill*: ${skillName}\n*Error*: ${error}\n*Context*: ${JSON.stringify(context, null, 2)}` } }
    ]
  });
}

module.exports = { notifyPostSuccess, notifyDLQEntry, SLACK_CHANNELS };
```

**dlqMonitor.jsï¼ˆapps/api/src/services/dlqMonitor.jsï¼‰**:

```javascript
const DLQ_DIR = process.env.DLQ_DIR || '/tmp/anicca/dlq';
const ARCHIVE_DAYS = 14;

/**
 * DLQã‚¨ãƒ³ãƒˆãƒªç›£è¦–ï¼ˆ14æ—¥ä»¥ä¸Šã¯è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
 * @returns {{active: number, archived: number}}
 */
async function monitorDLQ() {
  const files = await fs.readdir(DLQ_DIR);
  let active = 0, archived = 0;

  for (const file of files) {
    if (!file.endsWith('.jsonl')) continue;
    const entries = await readDLQFile(path.join(DLQ_DIR, file));

    for (const entry of entries) {
      const age = (Date.now() - new Date(entry.timestamp).getTime()) / (1000 * 60 * 60 * 24);
      if (age > ARCHIVE_DAYS) {
        await archiveEntry(entry);
        archived++;
      } else {
        active++;
      }
    }
  }

  return { active, archived };
}

module.exports = { monitorDLQ, ARCHIVE_DAYS };
```

**hookPostTtlCleaner.jsï¼ˆapps/api/src/services/hookPostTtlCleaner.jsï¼‰**:

> **åŸå­æ€§/ä¸€è²«æ€§è¨­è¨ˆ**:
> - **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**: å„HookPostã® ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–+å‰Šé™¤ ã¯ $transaction ã§ã‚¢ãƒˆãƒŸãƒƒã‚¯
> - **å†ªç­‰æ€§**: upsertä½¿ç”¨ - å†å®Ÿè¡Œæ™‚ã«é‡è¤‡ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é˜²æ­¢ï¼ˆoriginalIdãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
> - **éƒ¨åˆ†å¤±æ•—å¯¾å¿œ**: å„ãƒ¬ã‚³ãƒ¼ãƒ‰ç‹¬ç«‹å‡¦ç†ã€å¤±æ•—åˆ†ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° + æ¬¡å›å®Ÿè¡Œæ™‚ã«å†è©¦è¡Œ
> - **ãƒ†ã‚¹ãƒˆ J17ã§æ¤œè¨¼**: æ­£å¸¸ç³» + éƒ¨åˆ†å¤±æ•— + å†å®Ÿè¡Œæ™‚ã®é‡è¤‡é˜²æ­¢

```javascript
// apps/api/src/services/hookPostTtlCleaner.js
import { prisma } from '../lib/prisma.js';
import { logger } from '../lib/logger.js';

const RELEVANCE_THRESHOLD = 0.1;
const AGE_DAYS = 30;

/**
 * ä½relevance HookPostã®TTLå‰Šé™¤ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ + å†ªç­‰æ€§ä¿è¨¼ï¼‰
 * æ¡ä»¶: relevance < 0.1 ã‹ã¤ createdAt ãŒ30æ—¥ä»¥ä¸Šå‰
 * @returns {{deleted: number, archived: number, failed: number}}
 */
async function cleanOldLowRelevancePosts() {
  const cutoffDate = new Date(Date.now() - AGE_DAYS * 24 * 60 * 60 * 1000);

  // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡ã‚’å–å¾—
  const targets = await prisma.hookPost.findMany({
    where: {
      relevance: { lt: RELEVANCE_THRESHOLD },
      createdAt: { lt: cutoffDate }
    }
  });

  let deleted = 0;
  let archived = 0;
  let failed = 0;

  // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç‹¬ç«‹ã—ã¦ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ï¼ˆéƒ¨åˆ†å¤±æ•—ã‚’è¨±å®¹ï¼‰
  for (const post of targets) {
    try {
      await prisma.$transaction(async (tx) => {
        // 1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆå†ªç­‰æ€§: upsertä½¿ç”¨ - å†å®Ÿè¡Œæ™‚ã¯æ›´æ–°ï¼‰
        const { id, createdAt, updatedAt, ...restData } = post;
        await tx.hookPostArchive.upsert({
          where: { originalId: id },  // originalIdãŒãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
          create: {
            originalId: id,
            originalCreatedAt: createdAt,
            ...restData
          },
          update: {}  // å†å®Ÿè¡Œæ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆHookPostArchiveã«updatedAtãŒãªã„ãŸã‚ç©ºæ›´æ–°ï¼‰
        });

        // 2. å…ƒãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
        await tx.hookPost.delete({ where: { id: post.id } });
      });

      deleted++;
      archived++;
    } catch (error) {
      // P2025: Record not found (æ—¢ã«å‰Šé™¤æ¸ˆã¿ = å†ªç­‰æ€§OK)
      if (error.code === 'P2025') {
        logger.info(`HookPost ${post.id} already deleted (idempotent)`);
        continue;
      }
      // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°è¨˜éŒ²ã€æ¬¡å›å†è©¦è¡Œ
      logger.error(`Failed to archive HookPost ${post.id}:`, error);
      failed++;
    }
  }

  return { deleted, archived, failed };
}

export { cleanOldLowRelevancePosts, RELEVANCE_THRESHOLD, AGE_DAYS };
```

**schedule.yaml ã¸ã®è¿½åŠ **: Phase 4 ã® schedule.yaml jobs é…ä¸‹ã« `hookpost-ttl-cleaner` ã¨ã—ã¦å®šç¾©æ¸ˆã¿ã€‚

**hookpost-ttl-cleaner SKILL.md**:

```yaml
---
name: hookpost-ttl-cleaner
description: ä½relevance HookPostã®TTLå‰Šé™¤ã¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
metadata: { "openclaw": { "emoji": "ğŸ—‘ï¸", "requires": { "env": ["DATABASE_URL", "ANICCA_AGENT_TOKEN"] } } }
---

# hookpost-ttl-cleaner

## Instructions

1. Railway API ã‹ã‚‰30æ—¥ä»¥ä¸Šå‰ ã‹ã¤ relevance < 0.1 ã® HookPost ã‚’å–å¾—
2. HookPostArchive ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚³ãƒ”ãƒ¼
3. å…ƒã® HookPost ã‚’å‰Šé™¤
4. å‡¦ç†çµæœã‚’ Slack #metrics ã«é€šçŸ¥

## Required Tools

- `exec` (DBæ“ä½œç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ)
- `slack` (é€šçŸ¥)

## Error Handling

- DBæ¥ç¶šå¤±æ•—: ãƒªãƒˆãƒ©ã‚¤3å›å¾Œ DLQè¨˜éŒ²
- 0ä»¶ã®å ´åˆ: æ­£å¸¸çµ‚äº†ï¼ˆé€šçŸ¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰

## Implementation

\`\`\`javascript
// hookPostTtlCleaner.js ã‹ã‚‰ cleanOldLowRelevancePosts() ã‚’å‘¼ã³å‡ºã—
const { cleanOldLowRelevancePosts } = require('./services/hookPostTtlCleaner');
await cleanOldLowRelevancePosts();
\`\`\`
```

---

## 7. ä¸ç¢ºå®Ÿæ€§ã¨è§£æ±ºç­– (Uncertainties & Resolutions)

> **æ ¹æ‹ **: å„ä¸ç¢ºå®Ÿæ€§ã«ã¤ã„ã¦ã€ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ã‚ˆã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãƒªã‚µãƒ¼ãƒã‚’å®Ÿæ–½æ¸ˆã¿

### 7.1 Thompson Sampling é–¢é€£ï¼ˆ2026å¹´2æœˆæœ€æ–°ç ”ç©¶ã«åŸºã¥ãï¼‰

> **é‡è¦**: æ¨™æº–Thompson Sampling (Beta(1,1) Prior) ã¯æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’éå¤§è©•ä¾¡ã™ã‚‹è‡´å‘½çš„æ¬ é™¥ãŒã‚ã‚‹ã€‚
> **æ¨å¥¨**: Dynamic Prior Thompson Samplingï¼ˆ2026å¹´2æœˆarxiv 2602.00943ï¼‰

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U1 | ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå•é¡Œï¼ˆæ–°è¦hookã®ãƒ‡ãƒ¼ã‚¿ä¸è¶³ï¼‰ | **Dynamic Prior Thompson Sampling** - æ¢ç´¢ç‡Îµ=10%ã‚’æ˜ç¤ºçš„ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã€Prior Strength r=0.1 | arxiv 2602.00943 (2026å¹´2æœˆ): +0.19% CTR, -21% Regret |
| U2 | é•·æœŸçš„ãªhookã®æ€§èƒ½ä½ä¸‹æ¤œå‡º | **Discounted Thompson Sampling** - å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’æŒ‡æ•°çš„ã«æ¸›è¡°ï¼ˆÎ³=0.95/é€±ï¼‰ã€æœ€æ–°90æ—¥ã®ã¿é‡è¦– | Raj & Kalyani (2017) |
| U3 | æ¢ç´¢ã¨æ´»ç”¨ã®ãƒãƒ©ãƒ³ã‚¹ | **Dynamic Priorã§è‡ªå‹•èª¿æ•´** - Îµãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ˜ç¤ºçš„ã«æ¢ç´¢ç‡ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå¾“æ¥ã®Novelty Bonusã‚ˆã‚Šé€æ˜æ€§é«˜ã„ï¼‰ | arxiv 2602.00943 |

**Dynamic Prior Thompson Sampling å®Ÿè£…ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æ¨å¥¨å€¤ | èª¬æ˜ |
|-----------|--------|------|
| **æ¢ç´¢ç‡ï¼ˆÎµï¼‰** | 10% | ä¸­ç¨‹åº¦ã®æ¢ç´¢ï¼ˆmoderate explorationï¼‰ |
| **Prior Strength (r)** | 0.1 | Prior ã®å¼·åº¦ï¼ˆåŠ¹æœçš„ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºï¼‰ |
| **ä¿å®ˆçš„è¨­å®š** | Îµ = 1-3% | æ–°è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒä½å“è³ªã®å¯èƒ½æ€§ãŒé«˜ã„å ´åˆ |

**æ¨™æº–TSã¨ã®æ¯”è¼ƒ**:

| é …ç›® | æ¨™æº–TS (Beta(1,1)) | Dynamic Prior TS |
|------|-------------------|------------------|
| æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã®ä»®å®šæˆåŠŸç‡ | 50%ï¼ˆéå¤§è©•ä¾¡ï¼‰ | Îµï¼ˆæ˜ç¤ºçš„ã«è¨­å®šï¼‰ |
| å¼±ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã®éœ²å‡º | éå‰° | æœ€å°åŒ– |
| æ¢ç´¢æœŸé–“ | é•·ã„ | çŸ­ç¸® |
| Regret | é«˜ã„ | **-21%å‰Šæ¸›** |

### 7.2 ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼é–¢é€£

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U4 | ã‚¹ã‚³ã‚¢ã®ç²’åº¦ï¼ˆ1-10 vs 0-5 vs ãƒã‚¤ãƒŠãƒªï¼‰ | **0-5ã‚¹ã‚±ãƒ¼ãƒ«æ¡ç”¨** - é–¾å€¤3ä»¥ä¸Šã§åˆæ ¼ï¼ˆãƒã‚¤ãƒŠãƒªã‚ˆã‚Šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è±Šå¯Œã€10æ®µéšã‚ˆã‚ŠèªçŸ¥è² è·ä½ã„ï¼‰ | Karpathyæ¨å¥¨ "Keep it simple" |
| U5 | æœ€å¤§å†ç”Ÿæˆå›æ•°ã®æœ€é©å€¤ | **3å›ã§å›ºå®š** - çµ±è¨ˆçš„ã«3å›ã§åæŸã€4å›ä»¥ä¸Šã¯é™ç•ŒåŠ¹ç”¨é€“æ¸› | A/Bãƒ†ã‚¹ãƒˆæ¥­ç•Œæ¨™æº– |
| U6 | æ¤œè¨¼LLMã®ãƒ¢ãƒ‡ãƒ«é¸æŠ | **gpt-4o-mini** - ã‚³ã‚¹ãƒˆåŠ¹ç‡ã¨å“è³ªã®ãƒãƒ©ãƒ³ã‚¹æœ€è‰¯ï¼ˆ0.15$/1M tokensï¼‰ | OpenAI Pricing 2025 |

### 7.3 memU ãƒ¡ãƒ¢ãƒªé–¢é€£ï¼ˆMem0 v2.0å®Ÿè¨¼ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãï¼‰

> **å®Ÿè¨¼æ¸ˆã¿åŠ¹æœ** (Mem0 v2.0 Research):
> - ç²¾åº¦: **+26%** (52.9% â†’ 66.9%)
> - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·(p95): **-91%** (17.12ç§’ â†’ 1.44ç§’)
> - ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨: **-90%** (26K â†’ 1.8K tokens)

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U7 | Categoryè¦ç´„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚° | **é–¾å€¤ãƒ™ãƒ¼ã‚¹** - Itemæ•°ãŒ20ã‚’è¶…ãˆãŸã‚‰è‡ªå‹•è¦ç´„ã€ã¾ãŸã¯24æ™‚é–“ã”ã¨ã«ãƒãƒƒãƒå‡¦ç† | Mem0 v2.0: 2ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| U8 | Embeddingãƒ¢ãƒ‡ãƒ«é¸æŠ | **text-embedding-3-small** - 1536æ¬¡å…ƒã€$0.02/1M tokensã€ååˆ†ãªç²¾åº¦ | OpenAIæ¨å¥¨ |
| U9 | RAG vs LLMæ¤œç´¢ã®åˆ‡ã‚Šæ›¿ãˆåŸºæº– | **CAGãƒ‘ã‚¿ãƒ¼ãƒ³å„ªå…ˆ** - é™çš„ãƒ‡ãƒ¼ã‚¿ã¯Context-Augmented Generationã€å‹•çš„ãƒ‡ãƒ¼ã‚¿ã®ã¿RAG | UC Strategies 2026: "Standard RAG Is Dead" |

**Mem0 2ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**:

| ãƒ•ã‚§ãƒ¼ã‚º | å…¥åŠ› | å‡¦ç† | å‡ºåŠ› |
|---------|------|------|------|
| **PHASE 1: Extraction** | æœ€æ–°å¯¾è©± + rolling summary | LLMãŒå€™è£œãƒ¡ãƒ¢ãƒªæŠ½å‡º | å€™è£œäº‹å®Ÿ |
| **PHASE 2: Update** | å€™è£œäº‹å®Ÿ vs æ—¢å­˜ãƒ¡ãƒ¢ãƒª | ADD/UPDATE/DELETE/NOOPåˆ¤å®š | çµ±åˆãƒ¡ãƒ¢ãƒª |

**éšå±¤çš„è¦ç´„ï¼ˆ3å±¤æ§‹é€ ï¼‰**:

| ãƒ¬ãƒ™ãƒ« | ãƒˆãƒ¼ã‚¯ãƒ³ | ç”¨é€” | ä¿æŒæœŸé–“ |
|--------|---------|------|---------|
| Detailed | Full | å°†æ¥ã®è©³ç´°åˆ†æ | æ°¸ä¹…ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ |
| Executive Summary | 200-500 | æ—¥å¸¸çš„ãªæƒ³èµ· | 6-12ãƒ¶æœˆ |
| Reference | 50-100 | é–¢é€£æ€§åˆ¤å®š | ä½¿ç”¨é »åº¦ã«å¿œã˜ã¦æ¸›è¡° |

### 7.4 Nia çŸ¥è­˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é–¢é€£

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U10 | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°é »åº¦ | **é€±æ¬¡ãƒãƒƒãƒ** - æ–°ã—ã„è«–æ–‡/ãƒ†ã‚­ã‚¹ãƒˆã¯é€±1å›ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–° | Llama Indexæ¨å¥¨ |
| U11 | ãƒãƒ£ãƒ³ã‚¯æˆ¦ç•¥ | **512ãƒˆãƒ¼ã‚¯ãƒ³ + 50%ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—** - æ–‡è„ˆä¿æŒã¨æ¤œç´¢ç²¾åº¦ã®ãƒãƒ©ãƒ³ã‚¹ | RAGãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹2025 |
| U12 | å¼•ç”¨å½¢å¼ | **ç°¡æ˜“MLAå½¢å¼** - è‘—è€…, ã‚¿ã‚¤ãƒˆãƒ«, å¹´, URLï¼ˆå­¦è¡“è«–æ–‡ã®ã¿DOIï¼‰ | å¯èª­æ€§é‡è¦– |

### 7.5 Verify + Learn Pattern

> **@mattprd ã® OpenClaw For Business ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãè‡ªå¾‹çš„å“è³ªä¿è¨¼ãƒ«ãƒ¼ãƒ—**

**ãƒ•ãƒ­ãƒ¼**: `ANALYZE â†’ RECOMMEND â†’ APPROVE â†’ EXECUTE â†’ VERIFY(5ç§’å¾Œ) â†’ LEARN(24hå¾Œ)`

| è¦ç´  | å†…å®¹ |
|------|------|
| **VERIFYï¼ˆå³æ™‚ï¼‰** | execå¾Œ5ç§’ã§çµæœãƒã‚§ãƒƒã‚¯ï¼ˆAPIå¿œç­”, SlackæŠ•ç¨¿æˆåŠŸ, ã‚¨ãƒ©ãƒ¼æœ‰ç„¡ï¼‰ |
| **VERIFYï¼ˆé…å»¶ï¼‰** | 24hå¾Œã«ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆã„ã„ã­, RT, è¿”ä¿¡æ•°ï¼‰ |
| **LEARN** | æˆåŠŸ/å¤±æ•—ã‚’shared-learningsã«è¨˜éŒ²ã€‚æ¬¡å›é¸æŠã®Thompson Sampling priorã‚’æ›´æ–° |
| **Decision Interface** | å…¨å‡ºåŠ›æœ«å°¾ã« âœ… Approve / âŒ Reject ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆAutonomy Levelå¯¾å¿œï¼‰ |

**Autonomy Levels**:

| Level | èª¬æ˜ | ç”¨é€” |
|-------|------|------|
| L1 | å ±å‘Šã®ã¿ï¼ˆå®Ÿè¡Œã—ãªã„ï¼‰ | åˆæœŸãƒ†ã‚¹ãƒˆ |
| L2 | å®Ÿè¡Œå‰ã«ç¢ºèªã‚’æ±‚ã‚ã‚‹ | æ¨™æº–é‹ç”¨ |
| L3 | å®Ÿè¡Œï¼‹äº‹å¾Œå ±å‘Š | å®‰å®šé‹ç”¨å¾Œ |
| L4 | å®Œå…¨è‡ªå¾‹ï¼‹é€±æ¬¡ã‚µãƒãƒªãƒ¼ | æˆç†Ÿå¾Œ |

**åˆæœŸè¨­å®š**: L2ï¼ˆå®Ÿè¡Œå‰ç¢ºèªï¼‰ã€‚1ãƒ¶æœˆã®å®‰å®šé‹ç”¨å¾Œã«L3ã«æ˜‡æ ¼æ¤œè¨ã€‚

### 7.6 shared-learnings æ§‹é€ 

> **1ã¤ã®ã‚¹ã‚­ãƒ«ãŒå­¦ã‚“ã ã“ã¨ã‚’å…¨ã‚¹ã‚­ãƒ«ãŒä½¿ãˆã‚‹ã€‚Cross-skill knowledge sharingã€‚**

```
~/.openclaw/workspace/shared-learnings/
â”œâ”€â”€ hooks/                    # Hookãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ engagement.jsonl      # {hook_id, platform, likes, rt, clicks, timestamp}
â”‚   â””â”€â”€ quality-scores.jsonl  # {hook_id, score, evaluator, timestamp}
â”œâ”€â”€ content/                  # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨èˆ¬ã®å­¦ã³
â”‚   â”œâ”€â”€ what-works.md         # åŠ¹ã„ãŸãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚   â””â”€â”€ what-fails.md         # å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³
â”œâ”€â”€ audience/                 # ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ç†è§£
â”‚   â”œâ”€â”€ pain-points.jsonl     # æ¤œå‡ºã—ãŸè‹¦ã—ã¿ãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚   â””â”€â”€ resonance.jsonl       # ã©ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå…±æ„Ÿã‚’å¾—ãŸã‹
â””â”€â”€ platform/                 # ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®å­¦ã³
    â”œâ”€â”€ x-learnings.md
    â””â”€â”€ tiktok-learnings.md
```

**è¨˜éŒ²ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:

| ã‚¤ãƒ™ãƒ³ãƒˆ | è¨˜éŒ²å…ˆ | å†…å®¹ |
|---------|--------|------|
| ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æŠ•ç¨¿å¾Œ24h | `hooks/engagement.jsonl` | ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ•°å€¤ |
| content-verifier è©•ä¾¡å¾Œ | `hooks/quality-scores.jsonl` | ã‚¹ã‚³ã‚¢ + ç†ç”± |
| è‹¦ã—ã¿æ¤œå‡ºæ™‚ | `audience/pain-points.jsonl` | ãƒ†ã‚­ã‚¹ãƒˆ + ã‚¹ã‚³ã‚¢ + ã‚«ãƒ†ã‚´ãƒª |
| æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ | `content/what-works.md` | å‚¾å‘åˆ†æ |

### 7.7 Recursive Content Loop

> **ç”Ÿæˆâ†’è©•ä¾¡â†’è¨ºæ–­â†’æ”¹å–„â†’ç¹°ã‚Šè¿”ã—ã€‚4/5ä»¥ä¸Šã§åˆæ ¼ã€‚æœ€å¤§5å›ã€‚**

```
GENERATE â†’ EVALUATE(0-5) â†’ score < 4 ? DIAGNOSE â†’ IMPROVE â†’ REPEAT : PUBLISH
```

| ã‚¹ãƒ†ãƒƒãƒ— | æ‹…å½“ | è©³ç´° |
|---------|------|------|
| GENERATE | x-poster / tiktok-poster | Hook + æœ¬æ–‡ç”Ÿæˆï¼ˆThompson Samplingã§hooké¸æŠï¼‰ |
| EVALUATE | content-verifier (gpt-4o-mini) | 0-5ã‚¹ã‚±ãƒ¼ãƒ«ã€‚4ä»¥ä¸Šã§åˆæ ¼ |
| DIAGNOSE | content-verifier | ã€Œãªãœä½ã‚¹ã‚³ã‚¢ã‹ã€ã‚’å…·ä½“çš„ã«æŒ‡æ‘˜ï¼ˆä¾‹: "hookãŒæŠ½è±¡çš„ã™ãã‚‹"ï¼‰ |
| IMPROVE | ç”Ÿæˆã‚¹ã‚­ãƒ« | è¨ºæ–­çµæœã‚’åæ˜ ã—ã¦å†ç”Ÿæˆ |
| PUBLISH | æŠ•ç¨¿ã‚¹ã‚­ãƒ« | åˆæ ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŠ•ç¨¿ |

**ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: 5å›ã§4æœªæº€ã®å ´åˆã€æœ€é«˜ã‚¹ã‚³ã‚¢ç‰ˆã‚’ä½¿ç”¨ã€‚ãŸã ã—3æœªæº€ã¯æŠ•ç¨¿ã—ãªã„ã€‚

**ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š**: gpt-4o-mini ã§è©•ä¾¡ = ~$0.001/å›ã€‚5å›ãƒ«ãƒ¼ãƒ— = ~$0.005ã€‚æœˆé–“100æŠ•ç¨¿ = ~$0.50ã€‚

### 7.8 å¤–éƒ¨ã‚¹ã‚­ãƒ«åˆ©ç”¨æ–¹é‡

> **è»Šè¼ªã®å†ç™ºæ˜ã¯ã—ãªã„ã€‚ãŸã ã—ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯å¦¥å”ã—ãªã„ã€‚**

| ã‚¹ã‚­ãƒ«/ãƒ„ãƒ¼ãƒ« | æ¡ç”¨ | ç†ç”± |
|-------------|------|------|
| **Remotion** (ClawHub) | âœ… YES | TikTokå‹•ç”»ç”Ÿæˆã€‚Reactãƒ™ãƒ¼ã‚¹ã€ClawHubã§å®Ÿç¸¾ã‚ã‚Š |
| **Bird** (ClawHub) | âŒ **NO** | Cookieèªè¨¼ = BAN ãƒªã‚¹ã‚¯ã€‚Xå…¬å¼OAuth 2.0ã‚’ä½¿ã† |
| **tweet-writer** (ClawHub) | ğŸ“– å‚è€ƒã®ã¿ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆã‚’å‚è€ƒã«ã€‚èªè¨¼ã¯è‡ªå‰OAuth 2.0 |
| **coding-agent** (ClawHub) | âœ… YES | VPSã§ã®ã‚³ãƒ¼ãƒ‰è‡ªå‹•ä¿®æ­£ã€‚`npx clawhub@latest install coding-agent` |
| **skill-creator** (bundled) | âœ… YES | ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚­ãƒ«ä½œæˆã€‚æ‰‹å‹•SKILL.mdè¨˜è¿°ç¦æ­¢ |
| **gitclaw** (ClawHub) | âœ… YES | workspaceè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— |
| **system-monitor** (ClawHub) | âœ… YES | VPS CPU/RAM/ãƒ‡ã‚£ã‚¹ã‚¯ç›£è¦– |

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡**:

| ãƒ«ãƒ¼ãƒ« | è©³ç´° |
|--------|------|
| ClawHub 13.4%ã«è„†å¼±æ€§ | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‰ã«SKILL.mdã‚’ç›£æŸ» |
| Cookieèªè¨¼ã¯å…¨é¢ç¦æ­¢ | å…¬å¼OAuth/APIã®ã¿ä½¿ç”¨ |
| å®Ÿè¡Œå‰ãƒ†ã‚¹ãƒˆå¿…é ˆ | isolated session ã§ãƒ†ã‚¹ãƒˆ â†’ æœ¬ç•ª |

### 7.9 Buddhaæ±åŒ–å±¤ + Closed Loop (ONE FLESH)

> **å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¾ªç’°ã™ã‚‹çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã€‚åˆ‡ã‚Šé›¢ã›ãªã„ã€‚**

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ONE FLESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                          â”‚
    â”‚   Buddha Knowledge Layer                 â”‚
    â”‚   â”œâ”€â”€ å››è–è«¦ï¼ˆè‹¦é›†æ»…é“ï¼‰                 â”‚
    â”‚   â”œâ”€â”€ åäºŒå› ç¸                            â”‚
    â”‚   â””â”€â”€ å…«æ­£é“                              â”‚
    â”‚         â”‚                                â”‚
    â”‚         â–¼                                â”‚
    â”‚   Content Generation (x-poster etc.)     â”‚
    â”‚         â”‚                                â”‚
    â”‚         â–¼                                â”‚
    â”‚   content-verifier (4/5 threshold)       â”‚
    â”‚   + Recursive Loop (max 5 iterations)    â”‚
    â”‚         â”‚                                â”‚
    â”‚         â–¼                                â”‚
    â”‚   Thompson Sampling (Hook Selection)     â”‚
    â”‚   + Dynamic Prior (Îµ=10%)                â”‚
    â”‚         â”‚                                â”‚
    â”‚         â–¼                                â”‚
    â”‚   PUBLISH â†’ VERIFY (5s + 24h)            â”‚
    â”‚         â”‚                                â”‚
    â”‚         â–¼                                â”‚
    â”‚   LEARN â†’ shared-learnings/              â”‚â”€â”€â”
    â”‚                                          â”‚  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
              â–²                                    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    æ¬¡å›ç”Ÿæˆã«åæ˜ ï¼ˆå¾ªç’°ï¼‰
```

**ãªãœ ONE FLESH ã‹**:

| ç†ç”± | èª¬æ˜ |
|------|------|
| Buddhaå±¤ãŒç”Ÿæˆã‚’å°ã | å››è–è«¦ãŒã€Œè‹¦ã—ã¿ã®æœ¬è³ªã€ã‚’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åæ˜  |
| æ¤œè¨¼ãŒå“è³ªã‚’ä¿è¨¼ | content-verifierãŒä»æ•™çš„æ­£ç¢ºæ€§ã‚‚è©•ä¾¡ |
| é¸æŠãŒæœ€é©åŒ–ã™ã‚‹ | Thompson SamplingãŒåŠ¹ãhookã‚’å„ªå…ˆ |
| å­¦ç¿’ãŒå…¨ä½“ã‚’æ”¹å–„ | shared-learningsãŒæ¬¡ã®Buddhaå±¤é©ç”¨ã‚’ç²¾ç·»åŒ– |
| **å¾ªç’°ãŒçŸ¥æµã‚’æ·±ã‚ã‚‹** | æŠ•ç¨¿â†’åå¿œâ†’å­¦ç¿’â†’ã‚ˆã‚Šæ·±ã„æ´å¯Ÿâ†’ã‚ˆã‚Šè‰¯ã„æŠ•ç¨¿ |

### 7.10 X API é€£æºä»•æ§˜

> **å…¬å¼OAuth 2.0ã€‚ç›´æ¥è¿”ä¿¡ã¯ç¦æ­¢ï¼ˆBotæ‰±ã„ + BANãƒªã‚¹ã‚¯ï¼‰ã€‚**

| é …ç›® | å€¤ |
|------|-----|
| **èªè¨¼** | OAuth 2.0 PKCE (å…¬å¼ X Developer Portal) |
| **æŠ•ç¨¿** | `POST /2/tweets` |
| **æ¤œç´¢** | `GET /2/tweets/search/recent` (è‹¦ã—ã¿ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰) |
| **ç›´æ¥è¿”ä¿¡** | **ç¦æ­¢**ã€‚æŠ•ç¨¿ã®ã¿ |
| **Free Tieråˆ¶é™** | 1,500 tweets/æœˆ, 10,000 reads/æœˆ |
| **æŠ•ç¨¿é »åº¦** | æœ€å¤§3å›/æ—¥ï¼ˆæœæ˜¼æ™©ï¼‰ |

**ç’°å¢ƒå¤‰æ•°**:

| å¤‰æ•° | ç”¨é€” |
|------|------|
| `X_CLIENT_ID` | OAuth 2.0 Client ID |
| `X_CLIENT_SECRET` | OAuth 2.0 Client Secret |
| `X_ACCESS_TOKEN` | Bearer Token |
| `X_REFRESH_TOKEN` | Tokenæ›´æ–°ç”¨ |

**è‹¦ã—ã¿æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¾‹**:

| ã‚«ãƒ†ã‚´ãƒª | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ |
|---------|-----------|
| å¤œæ›´ã‹ã— | "çœ ã‚Œãªã„", "ã¾ãŸå¤œæ›´ã‹ã—", "ã‚¹ãƒãƒ›ã‚„ã‚ã‚‰ã‚Œãªã„" |
| è‡ªå·±å«Œæ‚ª | "è‡ªåˆ†ãŒå«Œã„", "ãƒ€ãƒ¡äººé–“", "å¤‰ã‚ã‚Œãªã„" |
| å…ˆå»¶ã°ã— | "ã‚„ã‚‹æ°—å‡ºãªã„", "æ˜æ—¥ã‚„ã‚ã†", "å…ˆå»¶ã°ã—" |
| ä¸å®‰ | "å°†æ¥ä¸å®‰", "æ¼ ç„¶ã¨ã—ãŸä¸å®‰", "ä½•ã‚‚ã§ããªã„" |

**ç›´æ¥è¿”ä¿¡ã—ãªã„ç†ç”±**:

| ãƒªã‚¹ã‚¯ | è©³ç´° |
|--------|------|
| Botåˆ¤å®š | X ã®ã‚¹ãƒ‘ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¼•ã£ã‹ã‹ã‚‹ |
| BAN | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡çµã®å¯èƒ½æ€§ |
| æŠ¼ã—ä»˜ã‘ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å«Œæ‚ªæ„Ÿã‚’ä¸ãˆã‚‹ |
| **æ­£ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ** | è‰¯ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŠ•ç¨¿ã—ã€è‹¦ã—ã‚“ã§ã„ã‚‹äººã®ç›®ã«è‡ªç„¶ã«å±Šãå¯èƒ½æ€§ã‚’ä½œã‚‹ |

### 7.11 TikTok API é€£æºä»•æ§˜

> **å…¬å¼ Content Posting APIã€‚Remotion ã§å‹•ç”»ç”Ÿæˆã€‚**

| é …ç›® | å€¤ |
|------|-----|
| **èªè¨¼** | OAuth 2.0 (TikTok Developer Portal) |
| **æŠ•ç¨¿ãƒ•ãƒ­ãƒ¼** | 2æ®µéš: `POST /v2/post/publish/video/init` â†’ upload â†’ `POST /v2/post/publish/status` |
| **é–²è¦§** | Research API (æ‰¿èªåˆ¶) |
| **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„** | Nudgeã‚«ãƒ¼ãƒ‰ç”»åƒ + ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (Remotionç”Ÿæˆ) |
| **æŠ•ç¨¿é »åº¦** | 1å›/æ—¥ |

**ç’°å¢ƒå¤‰æ•°**:

| å¤‰æ•° | ç”¨é€” |
|------|------|
| `TIKTOK_CLIENT_KEY` | OAuth Client Key |
| `TIKTOK_CLIENT_SECRET` | OAuth Client Secret |
| `TIKTOK_ACCESS_TOKEN` | Access Token |

**Remotion å‹•ç”»ç”Ÿæˆ**:

| é …ç›® | å€¤ |
|------|-----|
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Remotion (React) |
| è§£åƒåº¦ | 1080x1920 (9:16 TikTokæ¨™æº–) |
| é•·ã• | 15-60ç§’ |
| ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | Nudgeã‚«ãƒ¼ãƒ‰ + Buddhaå¼•ç”¨ + èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ |
| å‡ºåŠ› | MP4 |

### 7.20 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢é€£

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U13 | Backoffè¨ˆç®—å¼ | **Equal Jitter** - `delay = base * 2^attempt + random(0, base * 2^attempt)` | AWS Architecture Blog |
| U14 | DLQä¿æŒæœŸé–“ | **14æ—¥é–“** - æ‰‹å‹•ç¢ºèªã®ç¾å®Ÿçš„ãªæœŸé–“ã€ä»¥é™ã¯è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | SREæ¨™æº– |
| U15 | Multi-provider Fallbackã®é †åº | **OpenAI â†’ Anthropic â†’ Groq** - å“è³ªãƒ»ã‚³ã‚¹ãƒˆãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è€ƒæ…® | å®Ÿæ¸¬ãƒ™ãƒ¼ã‚¹ |

### 7.21 VPS/ã‚¤ãƒ³ãƒ•ãƒ©é–¢é€£

| ID | ä¸ç¢ºå®Ÿæ€§ | è§£æ±ºç­– | æ ¹æ‹  |
|----|---------|--------|------|
| U16 | Hetznerãƒªãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ | **Ashburn (ash)** - æ—¥æœ¬ã¸ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€è‰¯ï¼ˆ140msï¼‰ã€ã‚³ã‚¹ãƒˆæœ€å®‰ | Hetznerå…¬å¼ |
| U17 | Dockerã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•ãƒãƒªã‚·ãƒ¼ | **`restart: unless-stopped`** - OOMæ™‚ã‚‚è‡ªå‹•å¾©æ—§ã€æ‰‹å‹•åœæ­¢ã¯å°Šé‡ | Docker Best Practices |
| U18 | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–“éš” | **30ç§’** - éšœå®³æ¤œå‡ºé€Ÿåº¦ã¨è² è·ã®ãƒãƒ©ãƒ³ã‚¹ | Kubernetesæ¨å¥¨å€¤ |

---

## 8. ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª (Test Scenarios)

> **ãƒ†ã‚¹ãƒˆåŸºç›¤**: Vitest + Supertestï¼ˆNode.jsï¼‰ã€Swift Testingï¼ˆiOSï¼‰
> **åŸå‰‡**: å…¨ã‚·ãƒŠãƒªã‚ªã‚’ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ/çµ±åˆãƒ†ã‚¹ãƒˆã§ã‚«ãƒãƒ¼ã€‚
> **TDDã‚µã‚¤ã‚¯ãƒ«**: REDï¼ˆå¤±æ•—ãƒ†ã‚¹ãƒˆä½œæˆï¼‰â†’ GREENï¼ˆå®Ÿè£…ï¼‰â†’ REFACTORï¼ˆæ”¹å–„ï¼‰

### 8.0 E2E/Maestroåˆ¤å®š

| æ©Ÿèƒ½ | UIå¤‰æ›´ | æ–°ç”»é¢/ãƒœã‚¿ãƒ³ | Maestro E2E | ç†ç”± |
|------|--------|--------------|-------------|------|
| hook_selector | ãªã— | ãªã— | **ä¸è¦** | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ |
| verifier | ãªã— | ãªã— | **ä¸è¦** | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ |
| memU Service | ãªã— | ãªã— | **ä¸è¦** | API/DBã®ã¿ |
| x-poster / tiktok-poster | ãªã— | ãªã— | **ä¸è¦** | OpenClaw Skillã€UIå¤‰æ›´ãªã— |
| trend-hunter | ãªã— | ãªã— | **ä¸è¦** | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç† |
| suffering-detector | ãªã— | ãªã— | **ä¸è¦** | Moltbookç›£è¦–ã€iOSå´å¤‰æ›´ãªã— |
| **app-nudge-sender** | **ã‚ã‚Š** | é€šçŸ¥ã‚¿ãƒƒãƒ—â†’ã‚¢ãƒ—ãƒªé·ç§» | **å¿…è¦** | é€šçŸ¥è¡¨ç¤ºãƒ»ã‚¿ãƒƒãƒ—å¾Œã®ç”»é¢é·ç§»ç¢ºèª |

**Maestro E2Eã‚·ãƒŠãƒªã‚ªï¼ˆapp-nudge-senderç”¨ï¼‰**:

**é€šçŸ¥E2Eã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: å®Ÿéš›ã®Pushé€šçŸ¥ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã§å—ä¿¡ä¸å¯ã®ãŸã‚ã€**ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯çµŒç”±**ã§Nudge Cardè¡¨ç¤ºã‚’ãƒ†ã‚¹ãƒˆã€‚

```yaml
# maestro/nudge/01-nudge-deeplink-navigation.yaml
appId: com.anicca.ios
tags: [smokeTest, nudge]
---
- launchApp
# ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã§Nudge Cardç”»é¢ã«ç›´æ¥é·ç§»ï¼ˆé€šçŸ¥ã‚¿ãƒƒãƒ—ã¨åŒç­‰ã®åŠ¹æœï¼‰
- openLink: "anicca://nudge/show?problemType=procrastination&source=e2e_test"
- assertVisible:
    id: "nudge_card_view"
    timeout: 5000
- tapOn:
    id: "nudge_action_primary"
- assertVisible:
    id: "my_path_tab"
    timeout: 3000
```

**ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å®Ÿè£…ï¼ˆiOSå´ï¼‰**:

```swift
// aniccaios/App/AniccaApp.swift
.onOpenURL { url in
    if url.scheme == "anicca" && url.host == "nudge" {
        // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰Nudgeæƒ…å ±ã‚’å–å¾—
        let components = URLComponents(url: url, resolvingAgainstBaseURL: false)
        let problemType = components?.queryItems?.first(where: { $0.name == "problemType" })?.value
        let source = components?.queryItems?.first(where: { $0.name == "source" })?.value

        // E2Eãƒ†ã‚¹ãƒˆç”¨ or é€šçŸ¥ã‚¿ãƒƒãƒ—æ™‚ã®Nudge Cardè¡¨ç¤º
        appState.showNudgeCard(problemType: problemType, source: source)
    }
}
```

**iOSå´ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£IDä¸€è¦§ï¼ˆMaestro E2Eç”¨ï¼‰**:

| ID | ç”¨é€” | View |
|----|------|------|
| `nudge_card_view` | Nudge Cardæœ¬ä½“ | `NudgeCardView` |
| `nudge_action_primary` | ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ | `NudgeCardView` |
| `nudge_action_secondary` | ã‚µãƒ–ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ | `NudgeCardView` |
| `nudge_feedback_thumbsup` | ğŸ‘ãƒœã‚¿ãƒ³ | `NudgeCardView` |
| `nudge_feedback_thumbsdown` | ğŸ‘ãƒœã‚¿ãƒ³ | `NudgeCardView` |
| `my_path_tab` | My Pathã‚¿ãƒ– | `MainTabView` |

> **æ³¨æ„**: å®Ÿéš›ã®Pushé€šçŸ¥å—ä¿¡ãƒ†ã‚¹ãƒˆã¯å®Ÿæ©Ÿï¼ˆ`fastlane build_for_device`ï¼‰ã§ã®ã¿å¯èƒ½ã€‚E2Eã¯ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯çµŒç”±ã§åŒç­‰ã®ç”»é¢é·ç§»ã‚’ãƒ†ã‚¹ãƒˆã€‚

### 8.1 Thompson Sampling ãƒ†ã‚¹ãƒˆï¼ˆUnitï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| A1 | å…¨hookãŒæœªä½¿ç”¨ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰ | Dynamic Prioré©ç”¨ï¼ˆÎµ=10%ã§æ¢ç´¢ï¼‰ | `hookSelector.test.js::coldStart` |
| A2 | 1ã¤ã®hookãŒæˆåŠŸç‡90% | é«˜ç¢ºç‡ã§ãã®hookã‚’é¸æŠï¼ˆ>70%ï¼‰ | `hookSelector.test.js::highPerformer` |
| A3 | æ–°è¦hookè¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰ | Dynamic Priorï¼ˆÎµ=10%ï¼‰ã§åˆæœŸæ¢ç´¢ | `hookSelector.test.js::newHookExploration` |
| A4 | Îµ=1%ï¼ˆä¿å®ˆçš„è¨­å®šï¼‰ | æ¢ç´¢ç‡ãŒ1%ã«åˆ¶é™ | `hookSelector.test.js::conservativeEpsilon` |
| A5 | 90æ—¥ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ | Discounted TSé©ç”¨ã€å½±éŸ¿åº¦0.05ä»¥ä¸‹ | `hookSelector.test.js::discount` |
| A6 | **å…¥åŠ›æ¤œè¨¼: ç©ºé…åˆ—** | InvalidInputErrorã€å‰¯ä½œç”¨ãªã— | `hookSelector.test.js::emptyArrayThrows` |
| A7 | **å…¥åŠ›æ¤œè¨¼: éé…åˆ—ï¼ˆnull/undefinedï¼‰** | InvalidInputErrorã€å‰¯ä½œç”¨ãªã— | `hookSelector.test.js::nonArrayThrows` |
| A8 | **å…¥åŠ›æ¤œè¨¼: createdAtæ¬ è½** | InvalidInputErrorï¼ˆå¯¾è±¡hookã®ã¿ï¼‰ã€å‰¯ä½œç”¨ãªã— | `hookSelector.test.js::missingCreatedAtThrows` |

### 8.2 ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼ãƒ†ã‚¹ãƒˆï¼ˆUnitï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| B1 | ã‚¹ã‚³ã‚¢5/5ã®ãƒ†ã‚­ã‚¹ãƒˆ | å³åº§ã«PASSã€å†ç”Ÿæˆãªã— | `verifier.test.js::highScore` |
| B2 | ã‚¹ã‚³ã‚¢2/5ã®ãƒ†ã‚­ã‚¹ãƒˆ | å†ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä»˜ã | `verifier.test.js::lowScoreRegenerate` |
| B3 | 3å›å†ç”Ÿæˆå¾Œã‚‚é–¾å€¤æœªæº€ | best_attemptã‚’è¿”å´ã€DLQã«è¨˜éŒ² | `verifier.test.js::maxAttempts` |
| B4 | æ¤œè¨¼LLMã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒªãƒˆãƒ©ã‚¤å¾Œã€fallbackãƒ¢ãƒ‡ãƒ«ã¸ | `verifier.test.js::timeoutFallback` |
| B5 | ç©ºæ–‡å­—åˆ—å…¥åŠ› | å³åº§ã«ã‚¹ã‚³ã‚¢0ã€å†ç”Ÿæˆãƒˆãƒªã‚¬ãƒ¼ | `verifier.test.js::emptyContent` |

### 8.3 memU ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆï¼ˆUnit/Integrationï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| C1 | Resource â†’ ItemæŠ½å‡º | JSONé…åˆ—ã§3-5 Itemã‚’æŠ½å‡º | `memuService.test.js::extractItems` |
| C2 | Item â†’ Categoryè¦ç´„ | 300ãƒˆãƒ¼ã‚¯ãƒ³ä»¥ä¸‹ã®è¦ç´„ç”Ÿæˆ | `memuService.test.js::updateCategories` |
| C3 | RAGæ¤œç´¢ï¼ˆã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ï¼‰ | Embeddingæ¤œç´¢ã§top-ké–¢é€£Itemè¿”å´ | `memuService.test.js::ragSearch` |
| C4 | LLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ | RAGçµæœ0ä»¶æ™‚ã€LLMæ¤œç´¢å®Ÿè¡Œ | `memuService.test.js::llmFallback` |
| C4a | **CAGãƒ’ãƒƒãƒˆæ¤œç´¢** | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã‚¯ã‚¨ãƒª â†’ å³æ™‚è¿”å´ã€fallbackUsed=false | `memuService.test.js::cagHit` |
| C4b | **CAGâ†’RAGãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯** | CAGãƒŸã‚¹ â†’ RAGæ¤œç´¢å®Ÿè¡Œã€fallbackUsed=true | `memuService.test.js::cagToRagFallback` |
| C4c | **CAGâ†’RAGâ†’LLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯** | CAGãƒŸã‚¹ + RAGçµæœ0ä»¶ â†’ LLMæ¤œç´¢ã€fallbackUsed=true | `memuService.test.js::fullFallbackChain` |
| C5 | 20 Itemè¶…éæ™‚ã®è‡ªå‹•è¦ç´„ | Category.summaryæ›´æ–°ã€lastSummarizedAtè¨˜éŒ²ï¼ˆItemã¯ä¿æŒï¼‰ | `memuService.test.js::autoSummarize` |
| C6 | **Buffer â†” Float32Arrayå¤‰æ›** | float32ArrayToBuffer â†’ bufferToFloat32Array ã§ãƒ©ã‚¦ãƒ³ãƒ‰ãƒˆãƒªãƒƒãƒ—æˆåŠŸã€verifyRoundTrip=true | `memuService.test.js::embeddingRoundTrip` |

### 8.4 Nia çŸ¥è­˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆIntegrationï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| D1 | ä»æ•™ãƒ†ã‚­ã‚¹ãƒˆã‚¯ã‚¨ãƒª | å¼•ç”¨ä»˜ãã§å›ç­”ã€å‡ºå…¸æ˜è¨˜ | `niaService.test.js::buddhistQuery` |
| D2 | å¿ƒç†å­¦è«–æ–‡ã‚¯ã‚¨ãƒª | DOIä»˜ãå¼•ç”¨ã§å›ç­” | `niaService.test.js::psychologyQuery` |
| D3 | ãƒãƒ£ãƒ³ã‚¯å¢ƒç•Œãƒ†ã‚¹ãƒˆ | ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ã§æ–‡è„ˆä¿æŒ | `niaService.test.js::chunkOverlap` |
| D4 | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–° | æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ ã€æ¤œç´¢å¯èƒ½ | `niaService.test.js::indexUpdate` |

### 8.5 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆUnitï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| E1 | 429 Rate Limit | Equal Jitter backoffã€3å›ãƒªãƒˆãƒ©ã‚¤ | `errorHandler.test.js::rateLimit` |
| E2 | 500 Server Error | æŒ‡æ•°backoffã€3å›å¾ŒDLQ | `errorHandler.test.js::serverError` |
| E3 | 401 Unauthorized | å³åº§ã«å¤±æ•—ã€ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡ | `errorHandler.test.js::authError` |
| E4 | DLQæ›¸ãè¾¼ã¿ | JSON Lineså½¢å¼ã€å…¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜ | `errorHandler.test.js::dlqWrite` |
| E5 | Fallback Chain (AnthropicæˆåŠŸ) | OpenAIå¤±æ•— â†’ AnthropicæˆåŠŸ | `verifier.test.js::llmFallbackToAnthropic` |
| E5a | Fallback Chain (GroqæˆåŠŸ) | OpenAIå¤±æ•— â†’ Anthropicå¤±æ•— â†’ GroqæˆåŠŸ | `verifier.test.js::llmFallbackToGroq` |
| E5b | Fallback Chain (å…¨å¤±æ•—) | OpenAI/Anthropic/Groqå…¨å¤±æ•— â†’ DLQè¨˜éŒ²ã€ã‚¨ãƒ©ãƒ¼è¿”å´ | `verifier.test.js::llmFallbackAllFail` |
| E6 | Circuit Breaker CLOSEDâ†’OPEN | 5å›é€£ç¶šå¤±æ•—ã§OPENçŠ¶æ…‹ã«é·ç§» | `errorHandler.test.js::circuitOpen` |
| E7 | Circuit Breaker OPENâ†’HALF_OPEN | 30ç§’å¾Œã«HALF_OPENçŠ¶æ…‹ã«é·ç§» | `errorHandler.test.js::circuitHalfOpen` |
| E8 | Circuit Breaker HALF_OPENâ†’CLOSED | 2å›é€£ç¶šæˆåŠŸã§CLOSEDçŠ¶æ…‹ã«å¾©å¸° | `errorHandler.test.js::circuitRecovery` |
| E9 | Circuit Breaker HALF_OPENâ†’OPEN | HALF_OPENã§å¤±æ•—æ™‚ã€å³åº§ã«OPENã«æˆ»ã‚‹ | `errorHandler.test.js::circuitHalfOpenFail` |
| E10 | 403 Forbidden | å³åº§ã«å¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ãªã— | `errorHandler.test.js::forbiddenNoRetry` |
| E11 | 404 Not Found | å³åº§ã«å¤±æ•—ã€ãƒªãƒˆãƒ©ã‚¤ãªã— | `errorHandler.test.js::notFoundNoRetry` |
| E12 | 502 Bad Gateway | æŒ‡æ•°backoffã€3å›ãƒªãƒˆãƒ©ã‚¤ | `errorHandler.test.js::badGatewayRetry` |
| E13 | 503 Service Unavailable | æŒ‡æ•°backoffã€3å›ãƒªãƒˆãƒ©ã‚¤ | `errorHandler.test.js::serviceUnavailableRetry` |
| E14 | 529 Overloaded | æŒ‡æ•°backoffã€3å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆAnthropicå›ºæœ‰ï¼‰ | `errorHandler.test.js::overloadedRetry` |
| E15 | 429 with Retry-After | Retry-Afterãƒ˜ãƒƒãƒ€ãƒ¼å€¤ã‚’å„ªå…ˆã€æŒ‡æ•°backoffã‚ˆã‚Šé•·ã‘ã‚Œã°å¾…æ©Ÿ | `errorHandler.test.js::retryAfterRespected` |

### 8.6 x-poster Skill ãƒ†ã‚¹ãƒˆï¼ˆIntegrationï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| F1 | æ­£å¸¸æŠ•ç¨¿ãƒ•ãƒ­ãƒ¼ | hooké¸æŠ â†’ ç”Ÿæˆ â†’ æ¤œè¨¼ â†’ æŠ•ç¨¿ â†’ DBä¿å­˜ | `xPoster.test.js::happyPath` |
| F2 | ç”»åƒç”Ÿæˆã‚¹ã‚­ãƒƒãƒ—ï¼ˆFAL_API_KEYæœªè¨­å®šï¼‰ | ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æŠ•ç¨¿ã€æˆåŠŸ | `xPoster.test.js::textOnly` |
| F3 | Blotato APIå¤±æ•— | ãƒªãƒˆãƒ©ã‚¤å¾Œã€DLQè¨˜éŒ² | `xPoster.test.js::blotatoFailure` |
| F4 | 09:00 JST ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ | Cron ãƒˆãƒªã‚¬ãƒ¼ã€slot=morning | `xPoster.test.js::morningSchedule` |
| F5 | 21:00 JST ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ | Cron ãƒˆãƒªã‚¬ãƒ¼ã€slot=evening | `xPoster.test.js::eveningSchedule` |

### 8.7 tiktok-poster Skill ãƒ†ã‚¹ãƒˆï¼ˆIntegrationï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| G1 | é™æ­¢ç”»æŠ•ç¨¿ï¼ˆ1.6.2ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰ | ç”»åƒ + ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã§æŠ•ç¨¿æˆåŠŸ | `tiktokPoster.test.js::imagePost` |
| G2 | ç”»åƒæ¤œè¨¼å¤±æ•— | å†ç”Ÿæˆã€3å›å¾Œbestè¿”å´ | `tiktokPoster.test.js::imageVerification` |
| G3 | TikTok API å¤±æ•— | ãƒªãƒˆãƒ©ã‚¤å¾Œã€DLQè¨˜éŒ² | `tiktokPoster.test.js::apiFailure` |

### 8.8 çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆIntegrationï¼‰

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| H1 | Gateway â†’ Skill â†’ API â†’ DB | ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æˆåŠŸ | `integration.test.js::fullFlow` |
| H2 | è¤‡æ•°SkillåŒæ™‚å®Ÿè¡Œ | ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†é›¢ã€å¹²æ¸‰ãªã— | `integration.test.js::concurrentSkills` |
| H3 | LaunchAgentçŠ¶æ…‹æ¤œè¨¼ï¼ˆç–‘ä¼¼å¾©æ—§ï¼‰| `launchctl list` ã§OpenClawå­˜åœ¨ç¢ºèªã€Cronã‚¸ãƒ§ãƒ–å†ç™»éŒ²æˆåŠŸ | `integration.test.js::launchAgentStatus` |
| H4 | memU â†’ Nudgeç”Ÿæˆé€£æº | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | `integration.test.js::memuNudge` |
| H5 | Nia â†’ wisdom-researcheré€£æº | å¼•ç”¨ä»˜ãWisdomç”Ÿæˆ | `integration.test.js::niaWisdom` |

### 8.9 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆï¼ˆIntegrationï¼‰

| ID | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------------|---------|---------|---------------|
| I1 | POST /api/agent/hooks | æ­£å¸¸ç³»: hookè¿½åŠ  | 201 Created, UUIDè¿”å´ | `hooks.test.js::createHook` |
| I2 | POST /api/agent/hooks | 400: contentæ¬ è½ | 400 Bad Request | `hooks.test.js::createHookMissingContent` |
| I3 | POST /api/agent/hooks | 401: ãƒˆãƒ¼ã‚¯ãƒ³ãªã— | 401 Unauthorized | `hooks.test.js::createHookNoAuth` |
| I4 | POST /api/agent/hook-posts | æ­£å¸¸ç³»: æŠ•ç¨¿è¨˜éŒ² | 201 Created | `hookPosts.test.js::createPost` |
| I5 | POST /api/agent/hook-posts | 400: hookIdä¸æ­£ | 400 Bad Request | `hookPosts.test.js::createPostInvalidHook` |
| I5a | GET /api/agent/hook-posts/:id | æ­£å¸¸ç³»: æŠ•ç¨¿å–å¾— | 200 OK, hookæƒ…å ±å«ã‚€ | `hookPosts.test.js::getPost` |
| I5b | GET /api/agent/hook-posts/:id | 404: å­˜åœ¨ã—ãªã„hookPost | 404 Not Found | `hookPosts.test.js::getPostNotFound` |
| I5c | GET /api/agent/hook-posts/:id | 401: ãƒˆãƒ¼ã‚¯ãƒ³ãªã— | 401 Unauthorized | `hookPosts.test.js::getPostNoAuth` |
| I5d | POST /api/agent/hook-posts | 401: ãƒˆãƒ¼ã‚¯ãƒ³ãªã— | 401 Unauthorized | `hookPosts.test.js::createPostNoAuth` |
| I5e | POST /api/agent/hook-posts | 400: platformä¸æ­£ï¼ˆinstagramç­‰ï¼‰ | 400 Bad Request | `hookPosts.test.js::createPostInvalidPlatform` |
| I5f | POST /api/agent/hook-posts | 400: verificationScoreç¯„å›²å¤–ï¼ˆ6ä»¥ä¸Šï¼‰ | 400 Bad Request | `hookPosts.test.js::createPostInvalidScore` |
| I5g | POST /api/agent/hook-posts | 400: contentæ¬ è½ | 400 Bad Request | `hookPosts.test.js::createPostMissingContent` |
| I6 | PATCH /api/agent/hooks/:id/stats | æ­£å¸¸ç³»: successæ›´æ–° | 200 OK, successCount+1 | `hooks.test.js::updateStatsSuccess` |
| I7 | PATCH /api/agent/hooks/:id/stats | æ­£å¸¸ç³»: engagementæ›´æ–° | 200 OK, avgEngagementæ›´æ–° | `hooks.test.js::updateEngagement` |
| I8 | PATCH /api/agent/hooks/:id/stats | 404: å­˜åœ¨ã—ãªã„hook | 404 Not Found | `hooks.test.js::updateStatsNotFound` |
| I9 | POST /api/agent/memory/memorize | æ­£å¸¸ç³»: ãƒ¡ãƒ¢ãƒªä¿å­˜ | 201 Created, resourceId/itemsExtracted/categoriesUpdatedè¿”å´ | `memory.test.js::memorize` |
| I10 | POST /api/agent/memory/retrieve | æ­£å¸¸ç³»: ãƒ¡ãƒ¢ãƒªæ¤œç´¢ | 200 OK, itemsé…åˆ—ï¼ˆå„itemã«relevanceScore, categoryPathå«ã‚€ï¼‰, sourceå­˜åœ¨ | `memory.test.js::retrieveMemory` |
| I10a | POST /api/agent/memory/retrieve | **CAGãƒ’ãƒƒãƒˆæ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹** | 200 OK, fallbackUsed=false, source='cag', items[].relevanceScore >= 0 | `memory.test.js::retrieveCagHit` |
| I10b | POST /api/agent/memory/retrieve | **RAGãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹** | 200 OK, fallbackUsed=true, source='rag', items[].categoryPathå­˜åœ¨ | `memory.test.js::retrieveRagFallback` |
| I10c | POST /api/agent/memory/retrieve | **LLMãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹** | 200 OK, fallbackUsed=true, source='llm' | `memory.test.js::retrieveLlmFallback` |
| I11 | å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | 429: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | 429 + Retry-After | `rateLimit.test.js::rateLimitAll` |
| I12 | POST /api/agent/memory/memorize | 500: LLM APIå¤±æ•— | 500 Internal Server Error, DLQè¨˜éŒ² | `memory.test.js::memorizeLLMFailure` |
| I13 | POST /api/agent/memory/retrieve | 500: DBæ¥ç¶šå¤±æ•— | 500 Internal Server Error | `memory.test.js::retrieveDBFailure` |
| I14 | POST /api/agent/hooks | 500: DBæ¥ç¶šå¤±æ•— | 500 Internal Server Error | `hooks.test.js::createHookDBFailure` |
| I15 | PATCH /api/agent/hooks/:id/stats | 400: ä¸æ­£ãªJSONãƒœãƒ‡ã‚£ | 400 Bad Request | `hooks.test.js::updateStatsInvalidJSON` |
| I16 | POST /api/agent/hooks | 401: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ | 401 Unauthorized | `hooks.test.js::createHookInvalidToken` |
| I17 | POST /api/agent/memory/memorize | 400: userIdä¸æ­£å½¢å¼ | 400 Bad Request (Zod validation) | `memory.test.js::memorizeInvalidUserId` |
| I18 | å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | Circuit Breaker OPEN | 503 Service Unavailable | `circuitBreaker.test.js::openCircuit` |
| I19 | POST /api/agent/hook-posts | 401: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ | 401 Unauthorized | `hookPosts.test.js::createPostInvalidToken` |
| I20 | POST /api/agent/memory/memorize | 401: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ | 401 Unauthorized | `memory.test.js::memorizeInvalidToken` |
| I21 | POST /api/agent/memory/retrieve | 401: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ | 401 Unauthorized | `memory.test.js::retrieveInvalidToken` |
| I22 | PATCH /api/agent/hooks/:id/stats | 401: ãƒˆãƒ¼ã‚¯ãƒ³ãªã— | 401 Unauthorized | `hooks.test.js::updateStatsNoAuth` |
| I23 | PATCH /api/agent/hooks/:id/stats | 401: ä¸æ­£ãªãƒˆãƒ¼ã‚¯ãƒ³ | 401 Unauthorized | `hooks.test.js::updateStatsInvalidToken` |
| I24 | PATCH /api/agent/hooks/:id/stats | 400: outcome/engagementä¸¡æ–¹æ¬ è½ | 400 Bad Request | `hooks.test.js::updateStatsMissingFields` |

### 8.10 Phase 4-6 è¿½åŠ ãƒ†ã‚¹ãƒˆ

| ID | Phase | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|-------|---------|---------|---------------|
| J1 | 4 | trend-hunter æ­£å¸¸å®Ÿè¡Œ | X/TikTokã‹ã‚‰hookå€™è£œå–å¾—ã€DBä¿å­˜ | `trendHunter.test.js::happyPath` |
| J2 | 4 | trend-hunter APIå¤±æ•— | ãƒªãƒˆãƒ©ã‚¤å¾ŒDLQã€Slacké€šçŸ¥ | `trendHunter.test.js::apiFailure` |
| J3 | 4 | suffering-detector è‹¦ã—ã¿æ¤œå‡º | MoltbookæŠ•ç¨¿æ¤œå‡ºã€è¿”ä¿¡ç”Ÿæˆ | `sufferingDetector.test.js::detectSuffering` |
| J4 | 4 | suffering-detector èª¤æ¤œå‡ºå›é¿ | éè‹¦ã—ã¿æŠ•ç¨¿ã«ã‚¹ã‚­ãƒƒãƒ— | `sufferingDetector.test.js::skipNonSuffering` |
| J5 | 4 | app-nudge-sender é€ä¿¡æˆåŠŸ | ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥æœ€é©æ™‚åˆ»ã§Pushé€ä¿¡ | `appNudgeSender.test.js::sendNudge` |
| J6 | 4 | app-nudge-sender ç–²åŠ´é˜²æ­¢ | daily_limitè¶…éã§é€ä¿¡ã‚¹ã‚­ãƒƒãƒ— | `appNudgeSender.test.js::fatiguePrevention` |
| J7 | 4 | schedule.yaml æ­£å¸¸èª­ã¿è¾¼ã¿ | `openclaw cron list` ã§å…¨ã‚¸ãƒ§ãƒ–è¡¨ç¤º | `schedule.test.js::loadSchedule` |
| J8 | 4 | Cron x-poster 09:00 JST | x-poster(morning) ãŒ09:00 JSTã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::xPosterMorning` |
| J8a | 4 | Cron x-poster 21:00 JST | x-poster(evening) ãŒ21:00 JSTã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::xPosterEvening` |
| J8b | 4 | Cron tiktok-poster | tiktok-poster ãŒ20:00 JSTã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::tiktokPoster` |
| J8c | 4 | Cron trend-hunter | trend-hunter ãŒ4æ™‚é–“é–“éš”ã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::trendHunter` |
| J8d | 4 | Cron suffering-detector | suffering-detector ãŒ5åˆ†é–“éš”ï¼ˆ*/5 * * * *ï¼‰ã§ãƒˆãƒªã‚¬ãƒ¼ã€session=main | `schedule.test.js::sufferingDetector` |
| J8e | 4 | Cron app-nudge-sender | app-nudge-sender ãŒ1æ™‚é–“é–“éš”ã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::appNudgeSender` |
| J8f | 4 | Cron hookpost-ttl-cleaner | hookpost-ttl-cleaner ãŒ03:00 JSTã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::hookpostTtlCleaner` |
| J8g | 5 | Cron sto-weekly-refresh | sto-weekly-refresh ãŒæ—¥æ›œ03:00 JSTã§ãƒˆãƒªã‚¬ãƒ¼ã€session=isolated | `schedule.test.js::stoWeeklyRefresh` |
| J8h | 4 | Job type: atï¼ˆä¸€å›é™ã‚Šï¼‰ | ISO 8601 timestamp ã§ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆå®Ÿè¡Œ | `schedule.test.js::jobTypeAt` |
| J8i | 4 | Job type: everyï¼ˆå›ºå®šé–“éš”ï¼‰ | mså˜ä½ã®å›ºå®šé–“éš”ã§ç¹°ã‚Šè¿”ã—å®Ÿè¡Œ | `schedule.test.js::jobTypeEvery` |
| J8j | 4 | Execution mode: systemEvent | main session ã«ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼ã€ãƒ¡ãƒ¢ãƒªå…±æœ‰ | `schedule.test.js::execModeSystemEvent` |
| J8k | 4 | Execution mode: agentTurn | å°‚ç”¨ cron:jobId session ã§å®Ÿè¡Œã€ãƒ¡ãƒ¢ãƒªéå…±æœ‰ | `schedule.test.js::execModeAgentTurn` |
| J8l | 4 | runså±¥æ­´ï¼ˆjsonlï¼‰ | å®Ÿè¡Œå¾Œã« `~/.openclaw/cron/runs/<jobId>.jsonl` ã«è¨˜éŒ² | `schedule.test.js::runsHistory` |
| J9 | 5 | Nia ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ | ä»æ•™æ–‡çŒ®100ä»¶ã€è«–æ–‡50ä»¶ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | `nia.test.js::buildIndex` |
| J10 | 5 | wisdom-researcher å¼•ç”¨ç”Ÿæˆ | å¼•ç”¨ä»˜ãWisdomã€MLAå½¢å¼ | `wisdomResearcher.test.js::generateWithCitation` |
| J11 | 6 | è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | evaluateTask() ã§ã‚¹ã‚³ã‚¢ç®—å‡º | `evaluation.test.js::evaluateTask` |
| J12 | 6 | Slacké€šçŸ¥ï¼ˆæŠ•ç¨¿æˆåŠŸï¼‰ | #metrics ã«æŠ•ç¨¿å®Œäº†é€šçŸ¥ | `slackNotifier.test.js::postSuccess` |
| J13 | 6 | Slacké€šçŸ¥ï¼ˆDLQã‚¢ãƒ©ãƒ¼ãƒˆï¼‰ | #ai ã«DLQã‚¨ãƒ³ãƒˆãƒªé€šçŸ¥ | `slackNotifier.test.js::dlqAlert` |
| J14 | 6 | DLQç›£è¦–ï¼ˆ14æ—¥ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ | 14æ—¥ä»¥ä¸Šã®ã‚¨ãƒ³ãƒˆãƒªè‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– | `dlqMonitor.test.js::archiveOldEntries` |
| J15 | 1 | GitHub Actions ç„¡åŠ¹åŒ– | `.github/workflows/*.yml` â†’ `*.yml.disabled` ãƒªãƒãƒ¼ãƒ æ¸ˆã¿ | `ghaDisable.test.js::workflowsDisabled` |
| J16 | 5 | Nia Skill ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª | `openclaw skills list` ã« nia ãŒå­˜åœ¨ | `nia.test.js::skillInstalled` |
| J17 | 6 | HookPost TTLå‰Šé™¤ | relevance < 0.1 ã‹ã¤ 30æ—¥ä»¥ä¸Šå‰ â†’ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–/å‰Šé™¤ | `hookPostTtl.test.js::archiveOldLowRelevance` |
| J18 | 3 | Embeddingç”Ÿæˆï¼ˆmemorizeï¼‰ | memorizeæ™‚ã«text-embedding-3-smallã§embeddingç”Ÿæˆ | `memuService.test.js::generateEmbedding` |
| J19 | 3 | searchMemory RAGçµŒè·¯ | mode='rag'ã§ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ã€top-kè¿”å´ | `memuService.test.js::searchMemoryRag` |
| J20 | 5 | **STO å±¥æ­´10ä»¶æœªæº€** | å±¥æ­´<10ä»¶ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡æ™‚é–“ï¼ˆtimezoneè€ƒæ…®ï¼‰ | `sendTimeOptimization.test.js::defaultTime` |
| J21 | 5 | **STO 23-6æ™‚å›é¿** | æœ€é©æ™‚é–“ãŒ23:00-06:00 â†’ æœ€ã‚‚è¿‘ã„è¨±å¯æ™‚é–“å¸¯ã«ã‚·ãƒ•ãƒˆ | `sendTimeOptimization.test.js::nightHourAvoid` |
| J22 | 5 | **STO é€±æ¬¡ãƒ¢ãƒ‡ãƒ«æ›´æ–°** | 7æ—¥é–“ãƒ‡ãƒ¼ã‚¿ã§ãƒ¢ãƒ‡ãƒ«å†è¨ˆç®—ã€hourlyEngagementæ›´æ–° | `sendTimeOptimization.test.js::weeklyRefresh` |
| J23 | 4 | **ç–²åŠ´é˜²æ­¢ cool-offæœŸé–“** | ç›´å‰é€ä¿¡ã‹ã‚‰60åˆ†æœªæº€ â†’ shouldSendNudge=false | `appNudgeSender.test.js::coolOffPeriod` |
| J24 | 4 | **ç–²åŠ´é˜²æ­¢ daily_limitè¶…é** | å½“æ—¥é€ä¿¡æ•° >= daily_limit â†’ shouldSendNudge=false | `appNudgeSender.test.js::dailyLimitExceeded` |
| J25 | 4 | **ç–²åŠ´é˜²æ­¢ ä¸¡æ¡ä»¶ã‚¯ãƒªã‚¢** | cool-offçµŒé + limitæœªé” â†’ shouldSendNudge=true | `appNudgeSender.test.js::canSend` |
| J26 | 4 | **schedule.yaml SKILL.mdå­˜åœ¨æ¤œè¨¼** | å…¨ã‚¸ãƒ§ãƒ–ã®skillåã«å¯¾å¿œã™ã‚‹SKILL.mdå®Ÿä½“ãŒå­˜åœ¨ | `schedule.test.js::skillsHaveSkillMd` |
| J27 | 6 | **hookpost-ttl-cleaner Skill E2E** | Skillæ‰‹å‹•å®Ÿè¡Œ â†’ HookPostArchiveã«ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ  â†’ Slacké€šçŸ¥åˆ°ç€ | `skillE2E.test.js::hookpostTtlCleanerFullFlow` |
| J28 | 5 | **sto-weekly-refresh Skill E2E** | Skillæ‰‹å‹•å®Ÿè¡Œ â†’ UserStoModelæ›´æ–° â†’ Slacké€šçŸ¥åˆ°ç€ | `skillE2E.test.js::stoWeeklyRefreshFullFlow` |

### 8.11 ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆFixturesï¼‰

> **é…ç½®**: `apps/api/src/__tests__/fixtures/`

```javascript
// fixtures/hooks.js
export const testHooks = [
  {
    id: '550e8400-e29b-41d4-a716-446655440001',
    content: '6å¹´é–“ã€ä½•ã‚‚å¤‰ã‚ã‚Œãªã‹ã£ãŸè‡ªåˆ†ãŒã„ã‚‹',
    problemType: 'procrastination',
    successCount: 10,
    failureCount: 2,
    createdAt: new Date('2026-01-01')
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440002',
    content: 'ç¿’æ…£ã‚¢ãƒ—ãƒª10å€‹å…¨éƒ¨æŒ«æŠ˜ã—ãŸ',
    problemType: 'self_loathing',
    successCount: 0,
    failureCount: 0,  // æ–°è¦hook
    createdAt: new Date()
  }
];

// fixtures/memory.js
export const testMemoryResources = [
  {
    id: '660e8400-e29b-41d4-a716-446655440001',
    userId: '770e8400-e29b-41d4-a716-446655440001', // UUIDå½¢å¼å¿…é ˆ
    type: 'nudge_feedback',
    content: { outcome: 'thumbs_up', nudgeId: 'nudge-1' }
  }
];

// fixtures/users.js
export const testUsers = [
  {
    id: '770e8400-e29b-41d4-a716-446655440001', // UUIDå½¢å¼å¿…é ˆ
    timezone: 'Asia/Tokyo',
    problemTypes: ['procrastination', 'anxiety']
  }
];

// fixtures/memoryItems.js (J18/J19ç”¨)
export const testMemoryItems = [
  {
    id: '880e8400-e29b-41d4-a716-446655440001',
    userId: '770e8400-e29b-41d4-a716-446655440001',
    resourceId: '660e8400-e29b-41d4-a716-446655440001',
    content: 'æ¯æœ5åˆ†ã®ç‘æƒ³ã‚’å§‹ã‚ãŸ',
    embedding: new Float32Array(1536).fill(0.1), // 1536æ¬¡å…ƒembedding
    categoryId: null,
    relevance: 0.8,
    createdAt: new Date('2026-01-15')
  },
  {
    id: '880e8400-e29b-41d4-a716-446655440002',
    userId: '770e8400-e29b-41d4-a716-446655440001',
    resourceId: '660e8400-e29b-41d4-a716-446655440001',
    content: 'ä¸å®‰ãªæ°—æŒã¡ã¨å‘ãåˆã†ç·´ç¿’ã‚’ã—ã¦ã„ã‚‹',
    embedding: new Float32Array(1536).fill(0.2), // ç•°ãªã‚‹embedding
    categoryId: null,
    relevance: 0.9,
    createdAt: new Date('2026-01-20')
  }
];

// fixtures/cagCache.js (C4a/C4b/C4c/I10a/I10bç”¨)
export const testCagCache = {
  // CAGãƒ’ãƒƒãƒˆç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒª
  'query:ç‘æƒ³:770e8400-e29b-41d4-a716-446655440001': {
    items: [
      {
        id: '880e8400-e29b-41d4-a716-446655440001',
        content: 'æ¯æœ5åˆ†ã®ç‘æƒ³ã‚’å§‹ã‚ãŸ',
        relevanceScore: 0.95,
        categoryPath: 'mindfulness/meditation'
      }
    ],
    cachedAt: new Date('2026-02-05T10:00:00Z'),
    ttl: 3600 // 1æ™‚é–“
  }
};

// CAGãƒŸã‚¹ç”¨ã‚¯ã‚¨ãƒªï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å­˜åœ¨ã—ãªã„ï¼‰
export const cagMissQuery = 'å­˜åœ¨ã—ãªã„ã‚¯ã‚¨ãƒª_xyz123';

// fixtures/schedule/ (J7/J26ç”¨ - ç’°å¢ƒä¾å­˜ã‚’æ’é™¤)
// ãƒ†ã‚¹ãƒˆç”¨ãƒ‘ã‚¹: apps/api/src/__tests__/fixtures/schedule/
// ç’°å¢ƒå¤‰æ•° OPENCLAW_CONFIG_PATH ã§ãƒ‘ã‚¹ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½

// fixtures/schedule/schedule.yaml
export const testScheduleYaml = `
jobs:
  x-poster-morning:
    skill: x-poster
    cron: "0 9 * * *"
    session: isolated
    env:
      SLOT: morning
  x-poster-evening:
    skill: x-poster
    cron: "0 21 * * *"
    session: isolated
  tiktok-poster:
    skill: tiktok-poster
    cron: "0 20 * * *"
    session: isolated
  trend-hunter:
    skill: trend-hunter
    cron: "0 */4 * * *"
    session: isolated
  suffering-detector:
    skill: suffering-detector
    cron: "*/5 * * * *"
    session: main
  app-nudge-sender:
    skill: app-nudge-sender
    cron: "0 * * * *"
    session: isolated
  hookpost-ttl-cleaner:
    skill: hookpost-ttl-cleaner
    cron: "0 3 * * *"
    session: isolated
  sto-weekly-refresh:
    skill: sto-weekly-refresh
    cron: "0 3 * * 0"
    session: isolated
  # J8hç”¨: atï¼ˆãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼‰ã‚¸ãƒ§ãƒ–
  one-shot-report:
    skill: daily-metrics-reporter
    at: "2026-02-06T09:00:00Z"
    session: isolated
    deleteAfterRun: true
  # J8iç”¨: everyï¼ˆå›ºå®šé–“éš”ï¼‰ã‚¸ãƒ§ãƒ–
  health-check-every:
    skill: health-check
    every: 300000
    session: isolated
  # J8jç”¨: systemEventå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
  system-event-job:
    skill: event-handler
    cron: "*/10 * * * *"
    session: main
    execMode: systemEvent
  # J8kç”¨: agentTurnå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰
  agent-turn-job:
    skill: agent-task
    cron: "0 * * * *"
    session: isolated
    execMode: agentTurn
`;

// fixtures/schedule/skills/ (SKILL.mdå­˜åœ¨æ¤œè¨¼ç”¨)
export const testSkillsMd = {
  'x-poster': '---\nname: x-poster\ndescription: XæŠ•ç¨¿ã‚¹ã‚­ãƒ«\n---',
  'tiktok-poster': '---\nname: tiktok-poster\ndescription: TikTokæŠ•ç¨¿ã‚¹ã‚­ãƒ«\n---',
  'trend-hunter': '---\nname: trend-hunter\ndescription: ãƒˆãƒ¬ãƒ³ãƒ‰æ¤œå‡ºã‚¹ã‚­ãƒ«\n---',
  'suffering-detector': '---\nname: suffering-detector\ndescription: è‹¦ã—ã¿æ¤œå‡ºã‚¹ã‚­ãƒ«\n---',
  'app-nudge-sender': '---\nname: app-nudge-sender\ndescription: Pushé€šçŸ¥ã‚¹ã‚­ãƒ«\n---',
  'hookpost-ttl-cleaner': '---\nname: hookpost-ttl-cleaner\ndescription: TTLå‰Šé™¤ã‚¹ã‚­ãƒ«\n---',
  'sto-weekly-refresh': '---\nname: sto-weekly-refresh\ndescription: STOé€±æ¬¡æ›´æ–°ã‚¹ã‚­ãƒ«\n---',
  'nia': '---\nname: nia\ndescription: çŸ¥è­˜æ¤œç´¢ã‚¹ã‚­ãƒ«\n---',
  // J8h-J8k ãƒ†ã‚¹ãƒˆå°‚ç”¨ã‚¹ã‚­ãƒ«ï¼ˆat/every/execModeç”¨ï¼‰
  'daily-metrics-reporter': '---\nname: daily-metrics-reporter\ndescription: ãƒ†ã‚¹ãƒˆç”¨ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚¹ã‚­ãƒ«\n---',
  'health-check': '---\nname: health-check\ndescription: ãƒ†ã‚¹ãƒˆç”¨å›ºå®šé–“éš”ã‚¹ã‚­ãƒ«\n---',
  'event-handler': '---\nname: event-handler\ndescription: ãƒ†ã‚¹ãƒˆç”¨systemEventã‚¹ã‚­ãƒ«\n---',
  'agent-task': '---\nname: agent-task\ndescription: ãƒ†ã‚¹ãƒˆç”¨agentTurnã‚¹ã‚­ãƒ«\n---'
};

// ãƒ‘ã‚¹åˆ‡æ›¿ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆJ7/J26ãƒ†ã‚¹ãƒˆç”¨ï¼‰
export const getTestConfigPath = () => {
  return process.env.OPENCLAW_CONFIG_PATH || 'apps/api/src/__tests__/fixtures/schedule';
};

// fixtures/hookPosts.js (J17ç”¨)
export const testHookPosts = [
  {
    id: '990e8400-e29b-41d4-a716-446655440001',
    hookId: '550e8400-e29b-41d4-a716-446655440001',
    platform: 'x',
    content: 'å¤ã„æŠ•ç¨¿ï¼ˆå‰Šé™¤å¯¾è±¡ï¼‰',
    relevance: 0.05, // < 0.1 (å‰Šé™¤å¯¾è±¡)
    createdAt: new Date('2025-12-01') // 30æ—¥ä»¥ä¸Šå‰
  },
  {
    id: '990e8400-e29b-41d4-a716-446655440002',
    hookId: '550e8400-e29b-41d4-a716-446655440001',
    platform: 'x',
    content: 'æ–°ã—ã„æŠ•ç¨¿ï¼ˆä¿æŒå¯¾è±¡ï¼‰',
    relevance: 0.05, // < 0.1 ã ãŒ
    createdAt: new Date() // 30æ—¥ä»¥å†…ãªã®ã§ä¿æŒ
  },
  {
    id: '990e8400-e29b-41d4-a716-446655440003',
    hookId: '550e8400-e29b-41d4-a716-446655440001',
    platform: 'tiktok',
    content: 'é«˜relevanceæŠ•ç¨¿ï¼ˆä¿æŒå¯¾è±¡ï¼‰',
    relevance: 0.8, // >= 0.1 ãªã®ã§ä¿æŒ
    createdAt: new Date('2025-12-01')
  }
];

// fixtures/nia/ (J9/J16/D1-D4/J10/H5ç”¨ - æœ€å°ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿)
// å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã«é…ç½®: apps/api/src/__tests__/fixtures/nia/

// fixtures/nia/buddhist/dhammapada.txt (ã‚µãƒ³ãƒ—ãƒ«)
export const testBuddhistText = `
å››è–è«¦ï¼ˆCattÄri AriyasaccÄniï¼‰

ç¬¬ä¸€è–è«¦ï¼šè‹¦è«¦ï¼ˆDukkhaï¼‰
ç”Ÿãƒ»è€ãƒ»ç—…ãƒ»æ­»ã¯è‹¦ã§ã‚ã‚‹ã€‚æ„›ã™ã‚‹è€…ã¨é›¢ã‚Œã‚‹ã“ã¨ã¯è‹¦ã§ã‚ã‚‹ã€‚

ç¬¬äºŒè–è«¦ï¼šé›†è«¦ï¼ˆSamudayaï¼‰
è‹¦ã®åŸå› ã¯æ¸‡æ„›ï¼ˆtaá¹‡hÄï¼‰ã§ã‚ã‚‹ã€‚

ç¬¬ä¸‰è–è«¦ï¼šæ»…è«¦ï¼ˆNirodhaï¼‰
æ¸‡æ„›ã®æ»…å°½ãŒè‹¦ã®æ»…å°½ã§ã‚ã‚‹ã€‚

ç¬¬å››è–è«¦ï¼šé“è«¦ï¼ˆMaggaï¼‰
å…«æ­£é“ãŒè‹¦ã®æ»…å°½ã¸ã®é“ã§ã‚ã‚‹ã€‚
`;

// fixtures/nia/psychology/mbct-sample.txt (ã‚µãƒ³ãƒ—ãƒ«)
export const testPsychologyText = `
Mindfulness-Based Cognitive Therapy (MBCT)

Abstract: MBCT combines cognitive therapy with mindfulness strategies.
Results show 43% reduction in relapse rates for recurrent depression.

Reference: Kuyken et al., 2016, JAMA Psychiatry
DOI: 10.1001/jamapsychiatry.2016.0076
`;

// niaService ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆCLIä¾å­˜ã‚’æ’é™¤ï¼‰
export const createMockNiaService = (mockNia) => ({
  query: async (queryText, options = {}) => {
    return mockNia.query(queryText, options);
  },
  buildIndex: async (sourcePath, options = {}) => {
    return mockNia.buildIndex(sourcePath, options);
  },
  sourcesList: async () => {
    return mockNia.sourcesList();
  }
});
```

### 8.12 ãƒ¢ãƒƒã‚¯/ã‚¹ã‚¿ãƒ–å®šç¾©

> **é…ç½®**: `apps/api/src/__tests__/mocks/`

```javascript
// mocks/llm.js
export const mockLLM = {
  verify: vi.fn().mockResolvedValue({ score: 4, feedback: 'Good content' }),
  generate: vi.fn().mockResolvedValue({ content: 'Generated text', hook: 'Test hook' }),
  extractItems: vi.fn().mockResolvedValue([{ content: 'Item 1' }, { content: 'Item 2' }])
};

// mocks/externalApis.js
export const mockBlotato = {
  post: vi.fn().mockResolvedValue({ id: 'tweet-123', success: true })
};

export const mockTikTok = {
  post: vi.fn().mockResolvedValue({ id: 'tiktok-123', success: true }),
  // trend-hunterç”¨: TikTokãƒˆãƒ¬ãƒ³ãƒ‰æ¤œç´¢
  searchTrending: vi.fn().mockResolvedValue({
    videos: [
      { id: 'video-1', desc: 'meditation routine', hashtags: ['#meditation', '#mindfulness'] },
      { id: 'video-2', desc: 'anxiety tips', hashtags: ['#anxiety', '#mentalhealth'] }
    ]
  }),
  // RateLimit ãƒ†ã‚¹ãƒˆç”¨
  searchTrendingRateLimited: vi.fn().mockRejectedValue({
    status: 429,
    message: 'Rate limit exceeded',
    retryAfter: 60
  })
};

// mocks/apns.js (app-nudge-senderç”¨)
export const mockAPNs = {
  // æˆåŠŸã‚±ãƒ¼ã‚¹
  sendPushNotification: vi.fn().mockResolvedValue({
    sent: true,
    apnsId: 'apns-uuid-123'
  }),
  // å¤±æ•—ã‚±ãƒ¼ã‚¹: ç„¡åŠ¹ãªãƒ‡ãƒã‚¤ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
  sendPushInvalidToken: vi.fn().mockRejectedValue({
    reason: 'BadDeviceToken',
    statusCode: 400
  }),
  // å¤±æ•—ã‚±ãƒ¼ã‚¹: APNsã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
  sendPushServerError: vi.fn().mockRejectedValue({
    reason: 'InternalServerError',
    statusCode: 500
  })
};

// mocks/xApi.js (trend-hunterç”¨: X APIæ¤œç´¢)
export const mockXApi = {
  // ãƒˆãƒ¬ãƒ³ãƒ‰/ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢æˆåŠŸ
  searchTweets: vi.fn().mockResolvedValue({
    data: [
      { id: 'tweet-1', text: 'Dealing with anxiety through meditation' },
      { id: 'tweet-2', text: 'Buddhism helped me overcome procrastination' }
    ],
    meta: { next_token: 'cursor-abc' }
  }),
  // ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—æˆåŠŸ
  getTrends: vi.fn().mockResolvedValue({
    trends: [
      { name: '#meditation', tweet_volume: 5000 },
      { name: '#mindfulness', tweet_volume: 3000 }
    ]
  }),
  // RateLimit ãƒ†ã‚¹ãƒˆç”¨
  searchTweetsRateLimited: vi.fn().mockRejectedValue({
    status: 429,
    headers: { 'x-rate-limit-reset': '1609459200' }
  }),
  // èªè¨¼ã‚¨ãƒ©ãƒ¼
  searchTweetsUnauthorized: vi.fn().mockRejectedValue({
    status: 401,
    message: 'Unauthorized'
  })
};

// mocks/moltbook.js (suffering-detectorç”¨)
export const mockMoltbook = {
  // æŠ•ç¨¿å–å¾—æˆåŠŸï¼ˆè‹¦ã—ã¿æ¤œå‡ºå¯¾è±¡ï¼‰
  getPosts: vi.fn().mockResolvedValue({
    posts: [
      { id: 'moltbook-1', content: 'æœ€è¿‘ã€ä¸å®‰ã§çœ ã‚Œãªã„æ—¥ãŒç¶šã„ã¦ã„ã‚‹', userId: 'user-123' },
      { id: 'moltbook-2', content: 'ä»Šæ—¥ã‚‚è‡ªå·±å«Œæ‚ªã«é™¥ã£ãŸ', userId: 'user-456' }
    ]
  }),
  // æŠ•ç¨¿å–å¾—æˆåŠŸï¼ˆéè‹¦ã—ã¿ = ã‚¹ã‚­ãƒƒãƒ—å¯¾è±¡ï¼‰
  getPostsNoSuffering: vi.fn().mockResolvedValue({
    posts: [
      { id: 'moltbook-3', content: 'ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã—ãŸ', userId: 'user-789' }
    ]
  }),
  // è¿”ä¿¡é€ä¿¡æˆåŠŸ
  reply: vi.fn().mockResolvedValue({ success: true, replyId: 'reply-123' }),
  // è¿”ä¿¡é€ä¿¡å¤±æ•—
  replyFailed: vi.fn().mockRejectedValue({
    status: 500,
    message: 'Failed to send reply'
  }),
  // RateLimit ãƒ†ã‚¹ãƒˆç”¨
  getPostsRateLimited: vi.fn().mockRejectedValue({
    status: 429,
    message: 'Rate limit exceeded'
  })
};

export const mockSlack = {
  sendMessage: vi.fn().mockResolvedValue({ ok: true })
};

// mocks/openclaw.js
export const mockOpenClaw = {
  runSkill: vi.fn().mockResolvedValue({ success: true }),
  cronList: vi.fn().mockResolvedValue([{ name: 'x-poster', schedule: '0 9 * * *' }])
};

// mocks/prisma.js (prisma-mock)
import { mockDeep } from 'vitest-mock-extended';
import { PrismaClient } from '@prisma/client';

export const prismaMock = mockDeep<PrismaClient>();

// mocks/embedding.js (J18/J19ç”¨)
export const mockEmbedding = {
  create: vi.fn().mockResolvedValue({
    data: [{ embedding: new Array(1536).fill(0.1) }]
  })
};

// mocks/nia.js (J9/J16/D1-D4/J10/H5ç”¨ - å¤–éƒ¨CLIä¾å­˜ã‚’æ’é™¤)
export const mockNia = {
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¤œç´¢ï¼ˆä»æ•™æ–‡çŒ®ï¼‰
  query: vi.fn().mockResolvedValue({
    results: [
      {
        content: 'å››è–è«¦ã¯è‹¦ï¼ˆdukkhaï¼‰ã€é›†ï¼ˆsamudayaï¼‰ã€æ»…ï¼ˆnirodhaï¼‰ã€é“ï¼ˆmaggaï¼‰ã§ã‚ã‚‹',
        source: 'buddhist/dhammapada.txt',
        citation: { title: 'Dhammapada', author: 'Buddha', year: -500 }
      },
      {
        content: 'å…«æ­£é“ã¯æ­£è¦‹ã€æ­£æ€æƒŸã€æ­£èªã€æ­£æ¥­ã€æ­£å‘½ã€æ­£ç²¾é€²ã€æ­£å¿µã€æ­£å®šã§ã‚ã‚‹',
        source: 'buddhist/noble-eightfold-path.txt',
        citation: { title: 'Satipatthana Sutta', author: 'Buddha', year: -500 }
      }
    ]
  }),
  // å¿ƒç†å­¦è«–æ–‡æ¤œç´¢
  queryPsychology: vi.fn().mockResolvedValue({
    results: [
      {
        content: 'Mindfulness-based interventions show significant effects on anxiety reduction',
        source: 'psychology/mbct-meta-analysis.pdf',
        citation: { title: 'MBCT Meta-Analysis', author: 'Kuyken et al.', year: 2016, doi: '10.1001/jamapsychiatry.2016.0076' }
      }
    ]
  }),
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰
  buildIndex: vi.fn().mockResolvedValue({ indexed: 100, chunks: 500, status: 'success' }),
  // ã‚½ãƒ¼ã‚¹ä¸€è¦§å–å¾—
  sourcesList: vi.fn().mockResolvedValue([
    { name: 'buddhist', documents: 100, chunks: 500 },
    { name: 'psychology', documents: 50, chunks: 250 }
  ]),
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
  indexAdd: vi.fn().mockResolvedValue({ added: 10, status: 'success' })
};

// mocks/clawhub.js (Nia Skill ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨)
export const mockClawHub = {
  install: vi.fn().mockResolvedValue({ skill: 'nia', version: '1.0.0', status: 'installed' }),
  list: vi.fn().mockResolvedValue([
    { name: 'nia', version: '1.0.0', installed: true },
    { name: 'skill-creator', version: '2.0.0', installed: true }
  ])
};

// mocks/fs.js (J8l runså±¥æ­´ãƒ†ã‚¹ãƒˆç”¨ - ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ éš”é›¢)
import { vol } from 'memfs';

// memfs ã§ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›
export const mockFs = {
  // ãƒ†ã‚¹ãƒˆå‰ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
  reset: () => {
    vol.reset();
    // ~/.openclaw/cron/runs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    vol.mkdirSync('/tmp/test-openclaw/cron/runs', { recursive: true });
  },
  // ãƒ†ã‚¹ãƒˆç”¨ã®HOMEãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
  getTestHome: () => '/tmp/test-openclaw',
  // runså±¥æ­´jsonlã‚’èª­ã¿å–ã‚‹
  readRunsHistory: (jobId) => {
    const path = `/tmp/test-openclaw/cron/runs/${jobId}.jsonl`;
    if (!vol.existsSync(path)) return [];
    const content = vol.readFileSync(path, 'utf-8');
    return content.trim().split('\n').map(line => JSON.parse(line));
  },
  // vol ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ†ã‚¹ãƒˆã§ç›´æ¥ä½¿ç”¨ï¼‰
  vol
};

// ç’°å¢ƒå¤‰æ•°ã§HOMEã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆJ8lãƒ†ã‚¹ãƒˆç”¨ï¼‰
// beforeEach: process.env.OPENCLAW_HOME = mockFs.getTestHome()
// afterEach: mockFs.reset()

// ãƒ†ã‚¹ãƒˆå†…ã§ã®ä½¿ç”¨ä¾‹:
// vi.mock('../services/embeddingService', () => ({ generateEmbedding: mockEmbedding.create }));

// mocks/cagCache.js (C4a/C4b/C4c/I10a/I10bç”¨)
import { testCagCache, cagMissQuery } from '../fixtures/cagCache';

export const mockCagCache = {
  // CAGãƒ’ãƒƒãƒˆ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨
  get: vi.fn().mockImplementation((key) => {
    if (testCagCache[key]) {
      return { ...testCagCache[key], fallbackUsed: false };
    }
    return null; // CAGãƒŸã‚¹
  }),
  set: vi.fn().mockResolvedValue(true),
  // CAGCacheInterfaceæº–æ‹ : invalidateï¼ˆç‰¹å®šã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–ï¼‰
  invalidate: vi.fn().mockResolvedValue(true),
  // ãƒ†ã‚¹ãƒˆç”¨: å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
  clear: vi.fn()
};

// CAGãƒ’ãƒƒãƒˆæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
export const cagHitResponse = {
  items: testCagCache['query:ç‘æƒ³:770e8400-e29b-41d4-a716-446655440001'].items,
  fallbackUsed: false,
  source: 'cag'
};

// RAGãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹
export const ragFallbackResponse = {
  items: [
    {
      id: '880e8400-e29b-41d4-a716-446655440002',
      content: 'ä¸å®‰ãªæ°—æŒã¡ã¨å‘ãåˆã†ç·´ç¿’ã‚’ã—ã¦ã„ã‚‹',
      relevanceScore: 0.85,
      categoryPath: 'mental_health/anxiety'
    }
  ],
  fallbackUsed: true,
  source: 'rag'
};

// mocks/clock.js (J17 TTLãƒ†ã‚¹ãƒˆç”¨)
// Vitest fake timers ã‚’ä½¿ç”¨
// beforeEach(() => vi.useFakeTimers());
// afterEach(() => vi.useRealTimers());

// æ™‚é–“ã‚’30æ—¥å¾Œã«é€²ã‚ã‚‹ä¾‹:
// vi.advanceTimersByTime(30 * 24 * 60 * 60 * 1000);

// ã¾ãŸã¯ Date ã‚’ç›´æ¥ãƒ¢ãƒƒã‚¯:
export const mockDate = (dateString) => {
  const RealDate = Date;
  global.Date = class extends RealDate {
    constructor(...args) {
      if (args.length === 0) return new RealDate(dateString);
      return new RealDate(...args);
    }
    static now() { return new RealDate(dateString).getTime(); }
  };
};

// mocks/openclawCli.js (J7/J8ç³»ã‚¹ã‚¿ãƒ–)
export const mockOpenClawCli = {
  cronList: vi.fn().mockResolvedValue({
    jobs: [
      { name: 'x-poster-morning', cron: '0 9 * * *', session: 'isolated', env: { SLOT: 'morning' } },
      { name: 'x-poster-evening', cron: '0 21 * * *', session: 'isolated', env: { SLOT: 'evening' } },
      { name: 'tiktok-poster', cron: '0 20 * * *', session: 'isolated' },
      { name: 'trend-hunter', cron: '0 */4 * * *', session: 'isolated' },
      { name: 'suffering-detector', cron: '*/5 * * * *', session: 'main' },
      { name: 'app-nudge-sender', cron: '0 * * * *', session: 'isolated' },
      { name: 'hookpost-ttl-cleaner', cron: '0 3 * * *', session: 'isolated' },
      { name: 'sto-weekly-refresh', cron: '0 3 * * 0', session: 'isolated' },
      // J8h-J8k ãƒ†ã‚¹ãƒˆç”¨ã‚¸ãƒ§ãƒ–
      { name: 'one-shot-report', at: '2026-02-06T09:00:00Z', session: 'isolated', deleteAfterRun: true },
      { name: 'health-check-every', every: 300000, session: 'isolated' },
      { name: 'system-event-job', cron: '*/10 * * * *', session: 'main', execMode: 'systemEvent' },
      { name: 'agent-turn-job', cron: '0 * * * *', session: 'isolated', execMode: 'agentTurn' }
    ]
  }),
  skillsList: vi.fn().mockResolvedValue([
    'x-poster',
    'tiktok-poster',
    'trend-hunter',
    'suffering-detector',
    'app-nudge-sender',
    'hookpost-ttl-cleaner',
    'sto-weekly-refresh',
    'nia',
    // J8h-J8k ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚­ãƒ«
    'daily-metrics-reporter',
    'health-check',
    'event-handler',
    'agent-task'
  ]),
  // J27/J28 Skill E2E ãƒ†ã‚¹ãƒˆç”¨
  cronRun: vi.fn().mockImplementation(async (jobName) => {
    // å®Ÿéš›ã®Skillå®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    if (jobName === 'hookpost-ttl-cleaner') {
      return { success: true, archived: 5, deleted: 5, failed: 0 };
    }
    if (jobName === 'sto-weekly-refresh') {
      return { success: true, usersUpdated: 10 };
    }
    return { success: true };
  })
};
```

### 8.13 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

> **ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼**: Vitestï¼ˆpackage.json: `"test": "vitest run"`ï¼‰

**Node.js ãƒ¦ãƒ‹ãƒƒãƒˆ/çµ±åˆãƒ†ã‚¹ãƒˆ**:

```bash
# å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰
cd apps/api && npm test

# ç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«
npm test -- hookSelector.test.js

# ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆ80%ä»¥ä¸Šå¿…é ˆï¼‰
npm test -- --coverage

# çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆDBæ¥ç¶šå¿…è¦ï¼‰
# package.json ã«è¿½åŠ : "test:integration": "vitest run --config vitest.integration.config.ts"
npm run test:integration

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼ˆTDDç”¨ï¼‰
npm run test:watch
```

**çµ±åˆãƒ†ã‚¹ãƒˆç”¨DBæº–å‚™**:

> **éš”é›¢æˆ¦ç•¥**: çµ±åˆãƒ†ã‚¹ãƒˆã¯å°‚ç”¨ã®ãƒ†ã‚¹ãƒˆDBã‚’ä½¿ç”¨ã—ã€æœ¬ç•ª/é–‹ç™ºDBã¨å®Œå…¨ã«åˆ†é›¢

```bash
# 1. ãƒ†ã‚¹ãƒˆDBç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ.env.testï¼‰
TEST_DATABASE_URL="postgresql://test:test@localhost:5433/anicca_test"

# 2. docker-compose ã§ãƒ†ã‚¹ãƒˆDBèµ·å‹•
docker compose -f docker-compose.test.yml up -d

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
DATABASE_URL=$TEST_DATABASE_URL npx prisma migrate deploy

# 4. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆfixtures/seed.tsï¼‰
DATABASE_URL=$TEST_DATABASE_URL npx prisma db seed

# 5. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:integration

# 6. ãƒ†ã‚¹ãƒˆDBåœæ­¢
docker compose -f docker-compose.test.yml down
```

```yaml
# docker-compose.test.yml
services:
  test-db:
    image: postgres:16
    ports:
      - "5433:5432"
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: anicca_test
    tmpfs:
      - /var/lib/postgresql/data  # é«˜é€ŸåŒ–ã®ãŸã‚tmpfsä½¿ç”¨
```

**Maestro E2Eãƒ†ã‚¹ãƒˆï¼ˆiOSï¼‰**:

> **é‡è¦**: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä½œæ¥­æ™‚ã¯ MCP ã‚’ä½¿ç”¨ã€‚CLI ã¯CI/CDã§ã®ã¿ä½¿ç”¨ã€‚

```bash
# å…¨E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCI/CDç”¨ï¼‰
maestro test maestro/

# ç‰¹å®šãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
maestro test maestro/nudge/01-nudge-deeplink-navigation.yaml

# ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹å®Ÿè¡Œï¼ˆsmokeTest, regression, nightlyï¼‰
maestro test maestro/ --include-tags=smokeTest

# ã‚¨ãƒ©ãƒ¼æ™‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä»˜ããƒ¬ãƒãƒ¼ãƒˆ
maestro test maestro/ --format junit --output test-results/

# ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿æŒ‡å®šå®Ÿè¡Œ
maestro test maestro/ --device "iPhone 16"
```

**MCPçµŒç”±ã®Maestroæ“ä½œï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç”¨ï¼‰**:

```
# ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§
mcp__maestro__list_devices

# View Hierarchyç¢ºèªï¼ˆã‚»ãƒ¬ã‚¯ã‚¿æ±ºå®šï¼‰
mcp__maestro__inspect_view_hierarchy

# å˜ä¸€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
mcp__maestro__run_flow
  command: "tapOn: id:'nudge_content_llm'"

# ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—
mcp__maestro__take_screenshot

# æ—¢å­˜YAMLãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ
mcp__maestro__run_flow_files
  flowFiles: ["maestro/nudge/01-nudge-deeplink-navigation.yaml"]
```

### 8.14 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆUnitï¼‰

> **Section 3.1 Security Layers ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆ**

| ID | ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|----|---------|---------|---------------|
| S1 | å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º: URLé™¤å» | `http://...` ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ `[URL]` ã«ç½®æ› | `security.test.js::sanitizeUrl` |
| S2 | å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º: ã‚³ãƒ¼ãƒ‰é™¤å» | ``` ãƒ–ãƒ­ãƒƒã‚¯ã‚’ `[CODE]` ã«ç½®æ› | `security.test.js::sanitizeCode` |
| S3 | ã‚¿ã‚°ã‚«ãƒ—ã‚»ãƒ«åŒ– | ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ `<user_post>...</user_post>` ã§å›²ã‚€ | `security.test.js::tagEncapsulation` |
| S4 | ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¤œçŸ¥ | æ—¢çŸ¥ã®æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡ºæ™‚ã«è­¦å‘Šãƒ•ãƒ©ã‚° | `security.test.js::blocklistDetection` |
| S5 | ãƒ„ãƒ¼ãƒ«allow/denyåˆ¤å®š: è¨±å¯ | allowãƒªã‚¹ãƒˆå†…ã®ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ | `security.test.js::toolAllowed` |
| S6 | ãƒ„ãƒ¼ãƒ«allow/denyåˆ¤å®š: æ‹’å¦ | denyãƒªã‚¹ãƒˆå†…ã®ãƒ„ãƒ¼ãƒ«ã¯ã‚¨ãƒ©ãƒ¼ | `security.test.js::toolDenied` |
| S7 | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ60 req/minï¼‰ | 61å›ç›®ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§429 | `security.test.js::rateLimitExceeded` |
| S8 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¢ãƒªåˆ†é›¢ | cron session ã¨ main session ã®ãƒ¡ãƒ¢ãƒªãŒå…±æœ‰ã•ã‚Œãªã„ | `security.test.js::sessionMemoryIsolation` |
| S9 | hookã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«åˆ¶é™ | hook session ã¯ Minimal tools ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯ | `security.test.js::hookSessionToolRestriction` |
| S10 | Elevatedãƒ¢ãƒ¼ãƒ‰æ˜ç¤ºè¨±å¯ | elevated: true æœªæŒ‡å®šæ™‚ã¯ãƒ›ã‚¹ãƒˆå®Ÿè¡Œæ‹’å¦ | `security.test.js::elevatedModeExplicit` |
| S11 | ç›£æŸ»ãƒ­ã‚°å‡ºåŠ› | å…¨ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ãŒ audit.log ã«è¨˜éŒ² | `security.test.js::auditLogOutput` |
| S12 | LLMå‡ºåŠ›æ¤œè¨¼ | output_validation: true æ™‚ã€2nd pass ã§æ¤œè¨¼ | `security.test.js::llmOutputValidation` |
| S13 | Gateway loopback bind | Gateway ã¯ 127.0.0.1 ã®ã¿ãƒã‚¤ãƒ³ãƒ‰ï¼ˆå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰ | `security.test.js::gatewayLoopbackBind` |
| S14 | Token/TLSæ¤œè¨¼ | productionç’°å¢ƒã§ã¯ HTTPS + æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ | `security.test.js::tokenTlsRequired` |
| S15 | Docker sandboxing | ã‚³ãƒ³ãƒ†ãƒŠéš”é›¢ï¼ˆread-only filesystem, no-new-privilegesï¼‰ | `security.test.js::dockerSandboxing` |
| S16 | Hook session memoryç„¡åŠ¹ | hook session ã¯ memory persistã—ãªã„ï¼ˆä¸€æ™‚çš„ã®ã¿ï¼‰ | `security.test.js::hookSessionMemoryDisabled` |
| S17 | Minimal toolsæ¤œè¨¼ | Minimal tools = [read, write, exec] ã®ã¿è¨±å¯ | `security.test.js::minimalToolsVerification` |

---

## 9. å®Ÿè£…æ±ºå®šã‚µãƒãƒªãƒ¼ (Implementation Decisions)

> **æ ¹æ‹ **: 2026å¹´2æœˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»ï¼ˆ4ä¸¦åˆ—ãƒªã‚µãƒ¼ãƒï¼‰ã«åŸºã¥ã

| ã‚«ãƒ†ã‚´ãƒª | æ±ºå®š | ç†ç”± | æ ¹æ‹  |
|---------|------|------|------|
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** | Workflow-first + Agentä¾‹å¤– | äºˆæ¸¬å¯èƒ½æ€§ãƒ»ã‚³ã‚¹ãƒˆãƒ»ä¿¡é ¼æ€§ | Anthropic "Building Effective Agents" |
| **Thompson Sampling** | **Dynamic Prior TS** (Îµ=10%, r=0.1) | ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ã€-21% Regret | arxiv 2602.00943 (2026å¹´2æœˆ) |
| **ãƒ¡ãƒ¢ãƒªã‚·ã‚¹ãƒ†ãƒ ** | 3-Layer memU + Mem0 2ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ | 90%ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›ã€+26%ç²¾åº¦ | Mem0 v2.0 Research |
| **ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°** | 0-5ã‚¹ã‚±ãƒ¼ãƒ«ã€é–¾å€¤3 | ã‚·ãƒ³ãƒ—ãƒ«ã•ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å“è³ªã®ãƒãƒ©ãƒ³ã‚¹ | Karpathy "Keep it simple" |
| **å†ç”Ÿæˆä¸Šé™** | 3å› | é™ç•ŒåŠ¹ç”¨é€“æ¸›ã€çµ±è¨ˆçš„åæŸ | A/Bãƒ†ã‚¹ãƒˆæ¥­ç•Œæ¨™æº– |
| **æ¤œè¨¼ãƒ¢ãƒ‡ãƒ«** | gpt-4o-mini | ã‚³ã‚¹ãƒˆåŠ¹ç‡æœ€è‰¯ï¼ˆ$0.15/1M tokensï¼‰ | OpenAI Pricing 2025 |
| **Embedding** | text-embedding-3-small | ç²¾åº¦ã¨ã‚³ã‚¹ãƒˆã®ãƒãƒ©ãƒ³ã‚¹ | OpenAIæ¨å¥¨ |
| **æ¤œç´¢æˆ¦ç•¥** | CAGãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆï¼ˆé™çš„ï¼‰ã€RAGãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå‹•çš„ï¼‰ | 40.5å€é«˜é€Ÿ | UC Strategies "Standard RAG Is Dead" |
| **ã‚¨ãƒ©ãƒ¼å‡¦ç†** | Retry(æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•+Equal Jitter) + Circuit Breaker + DLQ | Enterpriseæ¨™æº– | Polly/Dapr Best Practices |
| **Backoff** | Equal Jitter | thundering herdé˜²æ­¢ | AWS Architecture Blog |
| **DLQä¿æŒ** | 14æ—¥ | æ‰‹å‹•ç¢ºèªã®ç¾å®Ÿçš„æœŸé–“ | SREæ¨™æº– |
| **Fallbacké †åº** | OpenAI â†’ Anthropic â†’ Groq | å“è³ªãƒ»ã‚³ã‚¹ãƒˆãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™è€ƒæ…® | å®Ÿæ¸¬ãƒ™ãƒ¼ã‚¹ |
| **ã‚¤ãƒ³ãƒ•ãƒ©** | Railway API/DB + Hetzner VPS (OpenClaw) | ã‚³ã‚¹ãƒˆæœ€é© + é•·æ™‚é–“å®Ÿè¡Œå¯¾å¿œ | Railway vs VPSèª¿æŸ» |
| **ãƒãƒ£ãƒ³ã‚¯æˆ¦ç•¥** | 512ãƒˆãƒ¼ã‚¯ãƒ³ + 50%ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ— | æ–‡è„ˆä¿æŒã¨æ¤œç´¢ç²¾åº¦ | RAGãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹2025 |
| **VPSãƒªãƒ¼ã‚¸ãƒ§ãƒ³** | Hetzner Ashburn | æ—¥æœ¬ã¸ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€è‰¯ï¼ˆ140msï¼‰ | Hetznerå…¬å¼ |
| **Dockerå†èµ·å‹•** | unless-stopped | OOMå¾©æ—§ + æ‰‹å‹•åœæ­¢å°Šé‡ | Docker Best Practices |
| **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯** | 30ç§’é–“éš” | éšœå®³æ¤œå‡ºé€Ÿåº¦ã¨è² è·ã®ãƒãƒ©ãƒ³ã‚¹ | Kubernetesæ¨å¥¨å€¤ |

---

## 10. æˆåŠŸãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | ç›®æ¨™ | æ¸¬å®šæ–¹æ³• |
|-----------|-------------|------|---------|
| **æŠ•ç¨¿å“è³ªã‚¹ã‚³ã‚¢** | N/A | >= 3/5 å…¨æŠ•ç¨¿ | verifier.js |
| **X ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼** | 0 | 100 (æœˆæœ«) | X API |
| **TikTok ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼** | 0 | 100 (æœˆæœ«) | TikTok API |
| **ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆç‡** | N/A | >= 5% | feedback-fetchï¼ˆv1.6.3ï¼‰ |
| **LLMã‚³ã‚¹ãƒˆ** | 100% | 10-20% (memUå¾Œ) | OpenAI Usage |
| **ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡** | N/A | 99.5% | Health check |
| **DLQã‚¨ãƒ³ãƒˆãƒªæ•°** | N/A | < 5/é€± | DLQç›£è¦– |

---

---

## 12. ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ (2026-02-05)

### 12.1 Tech Review: NEEDS_WORK

| Severity | Count | ä¸»è¦Issue |
|----------|-------|----------|
| **CRITICAL** | 2 | Slack webhookæœªã‚µãƒ‹ã‚¿ã‚¤ã‚ºã€JSON.parseç„¡é˜²å‚™ |
| **HIGH** | 4 | timedeltaæœªimportã€Race Conditionã€å…¥åŠ›æ¤œè¨¼ãªã—ã€APIåä¸é©åˆ‡ |
| **MEDIUM** | 6 | HTTPã‚»ãƒƒã‚·ãƒ§ãƒ³æœªcloseã€DBã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã—ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸çµ±ä¸€ |
| **LOW** | 4 | ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã€ãƒ­ã‚°ä¸çµ±ä¸€ã€bare except |

**P1ä¿®æ­£å¿…é ˆï¼ˆå®Ÿè£…å‰ï¼‰**:

1. **Slack Webhook ã‚µãƒ‹ã‚¿ã‚¤ã‚º**
```python
# main.py - sanitize hook content
def sanitize_for_slack(text: str, max_len: int = 50) -> str:
    # Remove potential injection vectors
    sanitized = re.sub(r'[<>{}]', '', text)
    return sanitized[:max_len] + '...' if len(sanitized) > max_len else sanitized
```

2. **JSON.parse é˜²å¾¡**
```javascript
// memuService.js
let extracted;
try {
  extracted = JSON.parse(response.choices[0].message.content);
} catch (e) {
  logger.warn('LLM returned invalid JSON, using empty array');
  extracted = { items: [] };
}
```

3. **Prisma Transactionè¿½åŠ **
```javascript
async function memorize(resource, userId) {
  return prisma.$transaction(async (tx) => {
    // ... all DB operations use tx
  });
}
```

4. **å…¥åŠ›æ¤œè¨¼è¿½åŠ **
```javascript
// hookSelector.js
function validateHook(hook) {
  const required = ['id', 'content', 'problemType'];
  return required.every(k => hook[k]);
}

def select_hook_thompson(hooks: List[Dict], ...) -> Dict:
    valid_hooks = [h for h in hooks if validate_hook(h)]
    if not valid_hooks:
        raise ValueError("No valid hooks available")
    # ...
```

### 12.2 Architect Review: PASS

| Severity | Count | ä¸»è¦Concern |
|----------|-------|-------------|
| **CRITICAL** | 0 | - |
| **MEDIUM** | 2 | Embeddingæœªå®Ÿè£…ã€Categoryè¦ç´„ã‚³ã‚¹ãƒˆ |
| **LOW** | 5 | Session TTLã€Secret Rotationã€DLQæ°¸ç¶šåŒ– |

**ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è©•ä¾¡**:

| Scale | è©•ä¾¡ | å¯¾å¿œ |
|-------|------|------|
| 1xï¼ˆç¾åœ¨ï¼‰ | âœ… å•é¡Œãªã— | - |
| 10x | âš ï¸ è»½å¾®ãªæ‡¸å¿µ | Connection Poolã€ãƒãƒƒãƒå‡¦ç† |
| 100x | âŒ å†è¨­è¨ˆå¿…è¦ | Gatewayæ°´å¹³åˆ†æ•£ã€memUã‚·ãƒ£ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° |

**P1å®Ÿè£…å¿…é ˆï¼ˆv1å‰ï¼‰**:

1. **Embeddingç”Ÿæˆå®Ÿè£…**
```javascript
async function generateEmbedding(text) {
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text.slice(0, 8000),
  });
  return response.data[0].embedding;
}
```

2. **ãƒãƒƒãƒCategoryè¦ç´„**
```javascript
// é–¾å€¤ãƒ™ãƒ¼ã‚¹ï¼ˆU7ã§æ±ºå®šæ¸ˆã¿ï¼‰: 20 Itemsè¶…éæ™‚ã®ã¿è¦ç´„
if (itemCount > 20) {
  await summarizeCategory(categoryName, userId);
}
```

### 12.3 Strengthsï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼è©•ä¾¡ï¼‰

| è©•ä¾¡å¯¾è±¡ | Tech | Arch |
|---------|------|------|
| ADRï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ±ºå®šè¨˜éŒ²ï¼‰ | âœ… | âœ… |
| Thompson Samplingå®Ÿè£… | âœ… Excellent | âœ… |
| Error Handlingï¼ˆEqual Jitter, DLQï¼‰ | âœ… | âœ… |
| Security Layers | âœ… | âœ… |
| Test Coverageï¼ˆSection 8å‚ç…§ï¼‰ | âœ… | âœ… |
| ä¸ç¢ºå®Ÿæ€§è§£æ±ºï¼ˆ18ä»¶ï¼‰ | âœ… | âœ… |

---

## 13. æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ |
|------|------|
| 2026-02-03 | åˆç‰ˆä½œæˆï¼ˆ4ãƒªã‚µãƒ¼ãƒçµ±åˆï¼‰ |
| 2026-02-05 | v2: ä¸ç¢ºå®Ÿæ€§18ä»¶ã€å®Ÿè£…æ±ºå®šè¿½åŠ  |
| 2026-02-05 | Thompson Samplingå¼·åŒ–ï¼ˆDiscounted TS, Dynamic Prior, Novelty Bonusï¼‰ |
| 2026-02-05 | ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚° 1-10 â†’ 0-5 ã«å¤‰æ›´ï¼ˆé–¾å€¤3ï¼‰ |
| 2026-02-05 | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° Equal Jitter è¿½åŠ  |
| 2026-02-05 | DLQ 14æ—¥ä¿æŒãƒãƒªã‚·ãƒ¼è¿½åŠ  |
| 2026-02-05 | ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœè¿½åŠ ï¼ˆTech: NEEDS_WORK, Arch: PASSï¼‰ |
| 2026-02-05 | **v3: ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹èª¿æŸ»çµ±åˆ** â€” Dynamic Prior TS, Mem0 v2.0, CAG, Before/Afterå›³è¿½åŠ  |
| 2026-02-07 | VPSä¸æ•´åˆä¿®æ­£ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³7.5-7.11è¿½åŠ ã€OpenClawèª¿æŸ»çµæœåæ˜ ã€MASTER TASK LISTæ›´æ–° |

---

## 14. å‚è€ƒæ–‡çŒ®ï¼ˆ2026å¹´2æœˆèª¿æŸ»ï¼‰

### Thompson Sampling

| æ–‡çŒ® | å†…å®¹ | URL |
|------|------|-----|
| **Dynamic Prior TS (2026å¹´2æœˆ)** | ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ã€+0.19% CTRã€-21% Regret | https://arxiv.org/html/2602.00943 |
| Thompson Sampling for Non-Stationary Bandits | Discounted TS | https://www.mdpi.com/1099-4300/27/1/51 |
| Stanford TS Tutorial | å®šç•ªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« | https://web.stanford.edu/~bvr/pubs/TS_Tutorial.pdf |

### AI Agent Memory Systems

| æ–‡çŒ® | å†…å®¹ | URL |
|------|------|-----|
| **Mem0 v2.0 Research** | +26%ç²¾åº¦ã€-91%ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€-90%ãƒˆãƒ¼ã‚¯ãƒ³ | https://arxiv.org/abs/2504.19413 |
| Memory in the Age of AI Agents | åŒ…æ‹¬çš„ã‚µãƒ¼ãƒ™ã‚¤ | https://arxiv.org/abs/2512.13564 |
| MongoDB Memory Engineering | 5ã¤ã®æŸ±ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | https://www.mongodb.com/company/blog/technical/why-multi-agent-systems-need-memory-engineering |
| **Standard RAG Is Dead** | CAG vs RAG vs Agentic RAG | https://ucstrategies.com/news/standard-rag-is-dead-why-ai-architecture-split-in-2026/ |

### AI Agent Orchestration

| æ–‡çŒ® | å†…å®¹ | URL |
|------|------|-----|
| **Anthropic Multi-Agent Research** | 3-5ä¸¦åˆ—æ¨å¥¨ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ40-60%ç¶­æŒ | https://www.anthropic.com/engineering/multi-agent-research-system |
| Anthropic Building Effective Agents | Workflow-firstæ¨å¥¨ | https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk |
| Vellum AI Agent Workflows 2026 | ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ | https://www.vellum.ai |

### Error Handling & Resilience

| æ–‡çŒ® | å†…å®¹ | URL |
|------|------|-----|
| AWS Architecture Blog | Equal Jitter Backoff | https://aws.amazon.com/blogs/architecture/ |
| Polly Resilience Patterns | Circuit Breakerã€Retry | https://github.com/App-vNext/Polly |
| Microsoft Dapr Resiliency | Enterpriseæ¨™æº– | https://docs.dapr.io/operations/resiliency/ |

### Infrastructure

| æ–‡çŒ® | å†…å®¹ | URL |
|------|------|-----|
| Railway Cron Docs | 5åˆ†é–“éš”ã€ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ | https://docs.railway.com/reference/cron-jobs |
| Railway vs VPS Comparison | ã‚³ã‚¹ãƒˆãƒ»é‹ç”¨è² è·æ¯”è¼ƒ | https://docs.railway.com/maturity/compare-to-vps |

---

**END OF SPECIFICATION**
