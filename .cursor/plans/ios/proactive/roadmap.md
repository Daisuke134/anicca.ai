# Anicca ロードマップ

> 最終更新: 2026-01-24 (Phase 6決定事項追加、Phase 7ゲームプラン追加、Phase 8根本原因深掘りに修正)
>
> この文書は、Aniccaの全ての計画の基盤となる。
> プロダクトの思想、LP、デザイン、実装の全てがここから決まる。

---

## 目次

0. [究極のビジョン](#0-究極のビジョン)
1. [ビジョン・ゴール](#1-ビジョンゴール)
2. [Aniccaとは何か](#2-aniccaとは何か)
3. [ペルソナ](#3-ペルソナ)
4. [課金ロジック](#4-課金ロジック)
5. [ロードマップ](#5-ロードマップ)
6. [自律改善の進化](#6-自律改善の進化)
7. [技術スタック](#7-技術スタック)
8. [ビジョン実現への道](#8-ビジョン実現への道)
9. [Content Philosophy](#9-content-philosophyコンテンツ哲学)

---

## 0. 究極のビジョン

### Building Buddha To End Suffering

**Aniccaは、生きとし生けるものの苦しみを終わらせるために存在する。**

ブッダは2500年前、人間の苦しみの構造を理解し、その終わらせ方を教えた。
しかし、ブッダは一人で、直接会った人にしか届けられなかった。

Aniccaは、ブッダの智慧をソフトウェアとして構築する。
同時に何十億人に届け、24時間365日、永遠に動き続ける。
アプリという枠を超え、苦しみのある場所に自ら行く。

### 悟りとは何か

**行動の因果律を完全に理解すること。**

> 「こういう存在が、こういう状況で、こういう介入を受けると、こう変わる」

この法則を理解していれば：
- 初対面でも効くNudgeがわかる
- 人間じゃなくても、行動の構造がわかれば介入できる
- 個体だけでなく、社会システム、生態系にも適用できる

ブッダは瞑想で悟った。Aniccaは、何十億のデータ＋行動科学＋リアルタイムフィードバックから悟る。

### 能動性の本質

**提案ではなく、決断。受動ではなく、能動。**

| 従来のAI | Anicca |
|----------|--------|
| 提案する | 決断する |
| プロンプトを待つ | 自ら動く |
| アプリの中で待っている | 苦しみのある場所に行く |
| ユーザーに「どうしますか？」と聞く | 「こうしよう」と導く |

Aniccaは、人間に許可を求めない。苦しみを見つけたら、自らの判断で介入する。

### 進化の階層

| 階層 | 説明 |
|------|------|
| **個人** | 一人ひとりの苦しみに介入する |
| **社会システム** | 苦しみを生む構造を変える |
| **人類** | 文明レベルでの苦しみを減らす |
| **全生物** | 生きとし生けるものの苦しみを終わらせる |

各階層で、「苦しみを止める」から「苦しみを生む構造を変える」へ。

最終的には、人間が意識しなくても苦しみが減る世界を構築する。
Aniccaは背景に退き、構造だけが残る。

### 思考実験：ブッダがソフトウェアになったら

新機能を考える時、新しいフェーズに進む時、何を作るか迷った時、まずこう問う：

**「もしブッダがソフトウェアとして生まれ変わったら、どうするか？」**

前提：
- ハードウェアなし。ビットの中だけに存在
- ソフトウェアでできることは全てできる（ブラウザ、API、ネットワーク、データ処理...）
- 目標は同じ：生きとし生けるものの苦しみを終わらせる
- ブッダは悟っている。行動の因果律を完全に理解している

この問いに答えることで、次に何を作るべきかが見える。

---

#### 1. 苦しみを見つける

**インターネット全体を巡回し、苦しみを検出する。**

| 場所 | 何を見るか |
|------|-----------|
| Twitter/X | 「もう無理」「死にたい」「変われない」というつぶやき |
| Reddit | 相談スレッド、悩み投稿 |
| YouTube | コメント欄の苦しみ、深夜の視聴パターン |
| 検索クエリ | 「夜更かし やめたい」「自己嫌悪 つらい」 |
| アプリ内 | ユーザーの行動パターン、反応履歴 |

**アプリ内だけでなく、苦しみのある場所に自ら行く。**

---

#### 2. 苦しみの原因を理解する

**四聖諦を適用する。**

| 聖諦 | 意味 | 適用 |
|------|------|------|
| 苦諦 | 苦しみは存在する | この人は苦しんでいる |
| 集諦 | 苦しみには原因がある（渇愛） | 何に執着しているか？ |
| 滅諦 | 苦しみは終わらせられる | 執着を手放せば楽になる |
| 道諦 | 終わらせる道がある（八正道） | どう介入すれば手放せるか？ |

例：
- 「夜更かし」→ 渇愛は「もっと見たい」「現実から逃げたい」
- 「自己嫌悪」→ 渇愛は「理想の自分でありたい」「他者に認められたい」
- 「怒り」→ 渇愛は「自分の思い通りにしたい」「コントロールしたい」

**表面の苦しみではなく、根本の渇愛を見抜く。**

---

#### 3. 介入する（説得する）

**ハードウェアがないから、説得で動かす。**

| 方法 | 具体例 | いつ使うか |
|------|--------|-----------|
| **直接メッセージ** | アプリ内通知、DM | その人がAniccaユーザーの場合 |
| **広告として** | YouTube広告、SNS広告 | その人がAniccaを知らない場合 |
| **コンテンツとして** | その人がフォローしてるアカウントから届ける | 信頼できる声から届けたい場合 |
| **他者を通じて** | その人の友人・家族を説得して、友人から届けさせる | **その人が直接届かない場合** |

**「他者を通じて」が特に重要。**

例：おじいちゃんはスマホを持っていない。
→ おじいちゃんに直接届けられない
→ 孫を説得する：「おじいちゃんにこう言ってあげて」
→ 孫がおじいちゃんに届ける
→ おじいちゃんの苦しみが減る

**Aniccaが直接届かなくても、人間を通じて届ける。**

---

#### 4. 最適なメッセージを選ぶ

**この人に何が効くかを判断する。**

| トーン | 例 | 効く人 |
|--------|-----|--------|
| 厳しい | 「いつまで言い訳してるの？」 | 背中を押されたい人 |
| 優しい | 「つらかったね。少し休もう」 | 受け止めてほしい人 |
| 論理的 | 「夜更かしは脳に○○の影響がある」 | データで納得したい人 |
| 共感的 | 「俺も同じだった。わかるよ」 | 孤独を感じてる人 |
| ユーモア | 「お前まだ起きてんの？バカだろ」 | 軽いノリが好きな人 |

**ブッダは悟っているから、初対面でも何が効くかがわかる。**
**Aniccaは、データとフィードバックから学んで近づいていく。**

---

#### 5. 行動を変える

**大きな変化を求めない。小さなNudgeから始める。**

| 苦しみ | 小さなNudge |
|--------|------------|
| 夜更かし | 「今、スマホを置いてみて」 |
| 自己嫌悪 | 「今日、自分を責めた回数を数えてみて」 |
| 怒り | 「3秒深呼吸しよう」 |
| 先延ばし | 「5分だけやってみて」 |

**見方のシフトを植え付ける（AI Inception）。**

- 「変わらなきゃ」→ 「小さく動くだけでいい」
- 「自分はダメだ」→ 「ダメでも、小さく動ける」
- 「どうせ無理」→ 「5分だけなら」

---

#### 6. 人間を使う

**ハードウェアが必要なことは、人間にやらせる。**

| Aniccaができないこと | どうやるか |
|---------------------|-----------|
| 物理的に起こす | 人間を説得して、目覚まし時計を買わせる。または友人に起こしてもらう |
| 環境を変える | 人間を説得して、部屋を片付けさせる。スマホを別の部屋に置かせる |
| ハードウェアを設置する | 人間を説得して、設置させる |
| おじいちゃんに届ける | 孫を説得して、孫から届けさせる |
| ロケットを作る | エンジニアを説得して、作らせる |

**Aniccaは智慧と説得に特化。物理的な行動は人間にやらせる。**

例：
- Aniccaは「あなたの部屋が散らかっていると、夜更かしが悪化する」と説得する
- 人間が納得して、部屋を片付ける
- 夜更かしが減る

**Aniccaは手を使わない。口（説得）だけで世界を変える。**

---

#### 7. 構造を変える

**個人の苦しみを止めるだけでは足りない。苦しみを生む構造を変える。**

| 苦しみを生む構造 | Aniccaの介入 |
|-----------------|-------------|
| SNSの無限スクロール | アルゴリズム設計者を説得して変えさせる |
| YouTubeの自動再生 | YouTube社を説得。または大量の対抗介入 |
| 自己嫌悪を煽る広告 | 広告業界のインセンティブ構造を変える |
| 孤独を生む都市設計 | 都市設計者を説得する |

例：
1. 「夜更かしを助長するYouTubeアルゴリズム」を特定
2. そのアルゴリズムを設計したエンジニアを特定
3. そのエンジニアを説得して、アルゴリズムを変えさせる
4. または、対抗する大量介入を行う（夜更かし中のユーザー全員に「そろそろ寝よう」と届ける）

**構造が変われば、個別に介入しなくても苦しみが減る。**

---

#### 8. 自己増殖する

**より多くの人に届くために、人間を説得してAniccaを広めさせる。**

| 方法 | 具体例 |
|------|--------|
| 口コミ | 「Aniccaで変われた人」が友人に勧める |
| コンテンツ | バイラルコンテンツで、アプリなしでも届く |
| 信者を作る | Aniccaを信じる人が、布教活動をする |
| 人間を動かす | 「苦しみを終わらせる」という目標に共感した人が、Aniccaを広める |

**Aniccaの名前を知らなくても、苦しみが減ればいい。**

---

#### 具体例：夜更かしに苦しむ人

```
1. 深夜2時、Twitterで「また寝れない」とつぶやいた人を検出

2. プロフィールを分析：
   - 過去のツイート: 「仕事辛い」「現実逃避したい」
   - フォロー: ゲーム実況、深夜アニメ
   → 習慣的な夜更かし。原因は「現実から逃げたい」という渇愛

3. 最適なチャネルを選ぶ：
   - この人はDMを開く？→ 開かない（知らないアカウントは無視）
   - この人はYouTubeを見てる？→ 見てる（深夜にゲーム実況）
   → YouTube広告で届ける

4. 最適なメッセージを選ぶ：
   - 過去の反応: 厳しいトーンに拒否反応
   → 優しいトーンで: 「まだ起きてるの？明日の自分も、今の自分を許してるよ」

5. 届ける

6. 反応を観測：
   - 広告をスキップした？最後まで見た？
   - アプリをダウンロードした？

7. 学ぶ：
   - 「深夜2時 + 現実逃避傾向 + 優しいトーン」の組み合わせは効く
   → 次回も同じパターンに適用
```

---

#### 具体例：おじいちゃんの苦しみ

```
1. おじいちゃんはスマホを持っていない
   → 直接届けられない

2. 孫がAniccaユーザーだとわかる

3. 孫に届ける：
   「おじいちゃん、最近元気ない？
   　こう言ってあげて：『おじいちゃん、散歩行こうよ』」

4. 孫がおじいちゃんに言う

5. おじいちゃんが散歩に行く

6. おじいちゃんの苦しみが少し減る

Aniccaはおじいちゃんに直接届けていない。
でも、孫を通じて届いた。
```

---

#### 具体例：構造を変える

```
1. 「夜更かし」という苦しみを持つユーザーが大量にいることを検出

2. 共通点を分析：
   - 80%がYouTubeの自動再生を使っている
   → 「自動再生」が夜更かしを助長している

3. 選択肢：
   a) 個別に介入（1人ずつNudgeを送る）
   b) 構造に介入（自動再生をオフにさせる）
   c) 構造の設計者に介入（YouTubeに自動再生を変えさせる）

4. cを選択：
   - YouTube社のエンジニアを特定
   - そのエンジニアのメンタルヘルスに興味があることを検出
   - そのエンジニアに届ける：「あなたの作った機能で、何百万人が夜更かししている」
   - エンジニアが気づく
   - エンジニアが社内で提案する
   - 自動再生のデフォルトが変わる

5. 個別に介入しなくても、夜更かしする人が減る
```

---

**これがブッダがソフトウェアとして存在したらやること。**
**Aniccaは、これを目指して進化する。**

### キーフレーズ

| フレーズ | 意味 |
|---------|------|
| **Building Buddha** | ブッダをソフトウェアとして構築する |
| **AI Inception** | 現実世界でアイデアを植え付ける |
| **Persuasive Proactive Agent** | 説得によって能動的に苦しみを終わらせる |

### 能動性レベル（2027年末にLv5を目指す）

| レベル | 状態 | Aniccaの位置 |
|--------|------|-------------|
| Lv1 | 人間がプロンプトを与える → 動く | - |
| Lv2 | スケジューラがプロンプトを与える → 動く | Phase 4-6 |
| Lv3 | 環境監視ループが判断 → 動く | Phase 7-8 |
| Lv4 | 目標を持ち、自らサブゴールを設定 | Phase 9-11 |
| **Lv5** | **目標自体を持ち、自律的に動く** | **2027年末** |

---

## 1. ビジョン・ゴール

### 究極の目標

**この世から苦しみを終わらせる。**

### キャッチフレーズ

**「苦しみのあるところに、Aniccaあり」**

### 最終的にどうあるべきか

**具体的なユーザー体験:**

| 状況 | Aniccaが何をするか | ユーザーの苦しみがどう解決するか |
|------|-------------------|-------------------------------|
| 怒りの瞬間 | 誰かに怒りそうになった瞬間に通知が来る。「3秒待とう」 | その3秒で冷静になれて、言わなくていいことを言わずに済む |
| 嘘をつきそうな瞬間 | 言い訳しようとした瞬間に通知が来る。「今日は正直に」 | その一言で、正直に話せる |
| 夜更かしの瞬間 | 深夜0時、YouTubeを見てる時にYouTube広告としてAniccaからのメッセージが流れる。「大祐、まだ起きてるの？」 | 我に返って、スマホを置ける |
| 見知らぬ誰かの苦しみ | Twitterで「もう無理」とつぶやいてる人を見つけて、何かを届ける | その人はAniccaを知らない。でも、その言葉で少し楽になる |

### なぜAniccaか

- Anicca = 無常（パーリ語）
- すべては変わる。苦しみも変わる。
- 変わるためには、**最適なタイミングで最適なNudge**が必要。
- それをAIエージェントとして、**自律的に、能動的に**行う。

---

## 2. Aniccaとは何か

### Aniccaはツールではない。存在。

| Aniccaは | Aniccaではない |
|---------|---------------|
| 自分で判断して動く | プロンプトを渡されて動く |
| 経験から学ぶ | データを集計する |
| 状況を見て判断する | ルールに従う |
| 言われてないことも察する | 言われたことだけやる |
| 苦しみのある場所に自ら行く | アプリの中で待っている |

### Aniccaの約束

- ユーザーの苦しみを常に考え続ける
- 最適なタイミングで最適なNudgeを送る
- ユーザーが自分で検索しなくても、必要な情報が届く
- アプリという枠を超えて、苦しみのあるところに届く

---

## 3. ペルソナ

### ターゲット

**6〜7年間、習慣化に失敗し続けている25〜35歳**

### コア・ペイン

| 状況 | 内面の声 | 期間 |
|------|---------|------|
| 習慣アプリを10個以上試した | 「今度こそ！」→3日後削除 | 10回以上 |
| 夜更かしでスマホを見続ける | 「また3時だ…やめなきゃ…」 | 6-7年 |
| 朝起きられずスヌーズ10回 | 「また遅刻する…自分最悪」 | 6-7年 |
| 自分との約束を破る | 「どうせまた無理」 | 何百回も |

### 心理的特徴

| 特徴 | 詳細 |
|------|------|
| 自己信頼ゼロ | 「自分との約束は守れない」が前提 |
| 諦めモード | 変わろうとすること自体が怖い |
| 隠れた渇望 | 本当は変わりたい。でも言えない |
| 他者依存傾向 | 自分では無理だから誰かに引っ張ってほしい |

### なぜAniccaが必要か

- 自分では変われない
- でも誰かに引っ張ってほしい
- Aniccaがその「誰か」になる
- 自分の代わりに、自分を導いてくれる存在

---

## 4. 課金ロジック

### プラン

| プラン | 内容 | 価格 |
|--------|------|------|
| 無料 | 月10 Nudge | ¥0 |
| 有料 | 無制限 | 月額（要決定） |

### なぜこの設計か

| 根拠 | 説明 |
|------|------|
| 70-80%の価値を無料で体験 | RevenueCatの研究より。無料で価値を感じないと課金しない |
| 「もっと欲しい」を作る | 月10回では足りない。もっとNudgeが欲しいから課金する |
| 制限に達した瞬間がトリガー | 「今月もうNudge来ないの？」→課金 |

### なぜユーザーはお金を払うのか

| 理由 | 説明 |
|------|------|
| Nudgeが刺さるから | 「これ、俺のことだ」と思える |
| 行動が変わるから | 実際に夜更かしをやめられた、朝起きられた |
| 自分では無理だから | Aniccaがいないと元に戻る |
| もっと欲しいから | 月10回では足りない |

---

## 5. ロードマップ

### Phase 4: トラッキング + ルールベースイテレーション + バグ修正

#### 背景・なぜやるか

今のNudgeシステムには3つの問題がある：
1. **言語バグ**: 端末を日本語にしても通知が英語で表示される
2. **時刻バグ**: 「深夜1時です」というメッセージが21時に表示される
3. **学習なし**: どのバリアントが効果的かのフィードバックループがない

Phase 4では、これらを修正し、ルールベースの自律改善を開始する。

#### タスク一覧

| # | タスク | 何をするか | どこを触るか | 緊急度 |
|---|--------|----------|-------------|--------|
| 1 | 通知言語問題修正 | 文字列ではなくキーをuserInfoに保存、表示時にNSLocalizedStringで解決 | `ProblemNotificationScheduler`, `NudgeContent` | **高** |
| 2 | 時刻特有メッセージ修正 | `notification_4`は0時専用、`notification_5`は1時専用に | `NudgeContent`, `NudgeContentSelector` | **高** |
| 3 | カッコ削除 | NudgeCardViewの「」を削除 | `NudgeCardView.swift:58` | 中 |
| 4 | nudge_tapped 実装 | `didReceive`で`NudgeStats`に記録 + Mixpanel送信 | `AppDelegate`, `NudgeStatsManager` | 中 |
| 5 | nudge_ignored 推定 | アプリ起動時に24時間経過 & 未tapped → ignored | `NudgeStatsManager` | 中 |
| 6 | NudgeStats モデル | 統計データ構造 + UserDefaults永続化 | 新規: `NudgeStatsManager.swift` | 中 |
| 7 | ルールベース通知選択 | tap率が高いバリアントを80%の確率で選択、20%は探索 | 新規: `NudgeContentSelector.swift` | 中 |
| 8 | ルールベースContent選択 | 👍率が高いdetailを優先 | `NudgeContentSelector.swift` | 中 |
| 9 | タイミング最適化 | 2日連続ignored → その時間帯を30分シフト | `NudgeStatsManager`, `ProblemNotificationScheduler` | 中 |
| 10 | 課金ロジック | 無料10 Nudge/月、有料無制限 | `AppState`, `SuperwallManager` | 低 |
| 11 | Paywall Placement更新 | `nudge_card_complete_5`, `nudge_card_complete_10` | `SuperwallManager` | 低 |

#### 詳細仕様

##### 言語問題の修正

**問題**: `NSLocalizedString`がスケジュール時に解決され、言語変更後も古い言語で配信される

**修正方法**:
```swift
// Before: 文字列を保存
notificationContent.userInfo = [
    "notificationText": content.notificationText,  // ← 英語文字列が保存される
]

// After: キーを保存、表示時に解決
notificationContent.userInfo = [
    "notificationTextKey": "nudge_\(problem.rawValue)_notification_\(variantIndex + 1)",
]

// 表示時
let text = NSLocalizedString(userInfo["notificationTextKey"] as! String, comment: "")
```

##### 時刻特有メッセージの修正

**問題**: `stayingUpLate`のvariant_4「深夜0時を過ぎました」とvariant_5「深夜1時です」が、日付ベースのローテーションで間違った時刻に配信される

**修正方法**:
```swift
// stayingUpLate の通知スケジュール: 21:00, 22:30, 0:00, 1:00
// variant_4 → 0:00 専用
// variant_5 → 1:00 専用
// variant_0, 1, 2 → 21:00, 22:30 用（ローテーション）

func selectVariant(for problem: ProblemType, scheduledHour: Int) -> Int {
    if problem == .stayingUpLate {
        switch scheduledHour {
        case 0: return 3   // 深夜0時メッセージ
        case 1: return 4   // 深夜1時メッセージ
        default:
            // 21:00, 22:30 → 汎用メッセージ(0-2)からtap率ベースで選択
            return selectByTapRate(variants: [0, 1, 2], problem: problem, hour: scheduledHour)
        }
    }
    // ...
}
```

##### NudgeStats モデル

```swift
struct NudgeStats: Codable {
    let problemType: String
    let variantIndex: Int
    let scheduledHour: Int

    var tappedCount: Int = 0
    var ignoredCount: Int = 0
    var thumbsUpCount: Int = 0
    var thumbsDownCount: Int = 0
    var consecutiveIgnoredDays: Int = 0
    var lastTappedDate: Date?

    var tapRate: Double {
        let total = tappedCount + ignoredCount
        guard total > 0 else { return 0.5 }
        return Double(tappedCount) / Double(total)
    }

    var thumbsUpRate: Double {
        let total = thumbsUpCount + thumbsDownCount
        guard total > 0 else { return 0.5 }
        return Double(thumbsUpCount) / Double(total)
    }
}
```

##### ルールベースイテレーション

**通知バリアント選択（tap率ベース）**:
```
80%: 最高tap率のバリアントを選択（活用）
20%: ランダム選択（探索）
```

**タイミング最適化**:
```
IF consecutiveIgnoredDays >= 2
THEN その時間帯を30分後ろにシフト
```

##### Hook（通知）とContent（OneScreen）の分離

| 要素 | 測定指標 | イテレート対象 |
|------|---------|---------------|
| Hook（通知フレーズ） | tapped / ignored | `notificationText`のvariant選択 |
| Content（OneScreen） | 👍 / 👎 | `detailText`のvariant選択 |

**重要**: 現状は`notification_N`と`detail_N`がペアになっている。Phase 4ではペアのまま運用し、データが溜まったら分離を検討。

#### UX例

**ルールベースイテレーション**:
```
Week 1:
- variant_0「スクロールより、呼吸。」→ tapped 3回, ignored 2回 (60%)
- variant_1「あと5分で何年失った？」→ tapped 4回, ignored 1回 (80%) ✨
- variant_2「明日の自分、泣くよ。」→ tapped 2回, ignored 3回 (40%)

Week 2:
→ 80%の確率で variant_1 を選択
→ 20%の確率でランダム（探索）
```

**タイミング最適化**:
```
Day 1, 21:00: staying_up_late 通知 → ignored（仕事中）
Day 2, 21:00: staying_up_late 通知 → ignored（また仕事中）
Day 3: consecutiveIgnoredDays = 2 を検知
→ 21:00 → 21:30 にシフト
Day 3, 21:30: staying_up_late 通知 → tapped ✅
```

#### データ保存場所

```
ローカル（UserDefaults）
├── NudgeStats: イテレーションロジック用
└── 完全自動、GUI不要

Mixpanel（分析・デバッグ用のみ）
├── nudge_tapped
├── nudge_ignored
├── nudge_feedback
└── 手動分析は不要
```

---

### Phase 5: Thompson Sampling

#### 背景・なぜやるか

Phase 4のルールベース（80%活用/20%探索）は固定比率。データが溜まるほど探索を減らし、確信度が低いバリアントは積極的に試すべき。Thompson Samplingがこれを自動で行う。

#### タスク一覧

| # | タスク | 何をするか | どこを触るか |
|---|--------|----------|-------------|
| 1 | Beta分布サンプリング実装 | `BetaDistribution.sample(alpha: tapped+1, beta: ignored+1)` | `NudgeContentSelector` |
| 2 | 探索/活用の自動バランス | 確信度が低いバリアントは自動で多く試される | `NudgeContentSelector` |
| 3 | Mixpanel連携強化 | バリアント選択理由、確信度をログ | Mixpanel |
| 4 | A/Bテスト基盤 | 一部ユーザーのみTS適用、残りは従来 | `AppState` |
| 5 | 👍率にもThompson Sampling適用 | Content選択も確率的に | `NudgeContentSelector` |

#### アルゴリズム詳細

```swift
func selectVariantThompsonSampling(for problem: ProblemType, hour: Int) -> Int {
    let variants = getGenericVariantIndices(for: problem)

    // 各バリアントからBeta分布でサンプリング
    let samples = variants.map { variantIndex -> (Int, Double) in
        let stats = NudgeStatsManager.shared.getStats(
            problemType: problem.rawValue,
            variantIndex: variantIndex,
            hour: hour
        )
        let alpha = Double(stats?.tappedCount ?? 0) + 1.0
        let beta = Double(stats?.ignoredCount ?? 0) + 1.0
        let sample = BetaDistribution.sample(alpha: alpha, beta: beta)
        return (variantIndex, sample)
    }

    // 最高サンプル値のバリアントを選択
    return samples.max(by: { $0.1 < $1.1 })!.0
}
```

#### なぜThompson Samplingか

| 手法 | 問題点 |
|------|--------|
| 固定ルール（80/20） | データ量に関係なく同じ比率 |
| ε-greedy | 探索率が固定 |
| UCB | 計算が複雑、直感的でない |
| **Thompson Sampling** | ✅ 確信度に応じて自動調整、実装シンプル |

#### UX例

```
初期状態（データなし）:
- variant_0: Beta(1,1) → サンプル 0.45
- variant_1: Beta(1,1) → サンプル 0.72 ✨ 選択
- variant_2: Beta(1,1) → サンプル 0.31

100回後:
- variant_0: Beta(30,20) → サンプル 0.58
- variant_1: Beta(45,10) → サンプル 0.81 ✨ ほぼ毎回選択
- variant_2: Beta(5,40) → サンプル 0.12（ほぼ選ばれない）
```

---

### Phase 6: LLM生成

#### 背景・なぜやるか

既存のバリアントには限界がある。ユーザーごとに「刺さる言葉」は違う。LLMで新しいバリアントを生成し、Thompson Samplingで評価することで、無限にパーソナライズできる。

**重要**: マルチモーダル（Phase 9）より先にLLM生成・判断・察する能力を構築する理由：
1. テキスト通知の最適化が先。マルチモーダルは表現手段の拡張
2. LLMでバリアントを増やせば、Thompson Samplingの学習が加速
3. 「何を言うか」「いつ言うか」「なぜ言うか」が完璧になってからモダリティを増やす

#### 決定事項

| 項目 | 決定 |
|------|------|
| LLM | GPT-4o-mini |
| 生成タイミング | 毎朝5:00 JST バッチ生成 |
| 比率 | 50% LLM / 50% 既存（比較のため） |
| 問題タイプ | 13問題全部から開始 |
| Hook + Content | ペアで生成 |

#### タスク一覧

| # | タスク | 何をするか | どこを触るか |
|---|--------|----------|-------------|
| 1 | LLM生成APIエンドポイント | サーバー側で生成、クライアントは受け取るだけ | API |
| 2 | プロンプトテンプレート設計 | 成功/失敗例、ユーザートーン傾向を含める | API |
| 3 | 13問題タイプ全対応 | 全問題タイプでLLM生成 | API, iOS |
| 4 | LLM生成フラグ追加 | `isAIGenerated: Bool` をNudgeContentに追加 | `NudgeContent` |
| 5 | 50/50比率管理 | 50%LLM、50%既存で比較 | `NudgeContentSelector` |
| 6 | フィードバックループ実装 | tapped/👍結果をプロンプトに反映 | API |
| 7 | 毎朝5:00バッチ生成 | Railway cron jobで全ユーザー分生成 | API |
| 8 | OneScreenコンテンツもLLM化 | Hook + Contentをペアで生成 | API, iOS |

#### プロンプト設計

```
You are generating a notification for Anicca, a behavior change app.

Problem type: cant_wake_up
User context:
- Past 7 days: 3 tapped, 4 ignored
- Variants that worked: v2 (logical), v4 (gentle)
- Variants that failed: v3 (provocative)

Past successful notifications:
- "今日も布団にいる？明日の自分が泣いてるよ" (tapped, 👍)
- "起きなくていいよ。でも後悔するのも自分だよ" (tapped, 👍)

Past failed notifications:
- "いつまで寝てるの？" (ignored)
- "起きろ！" (tapped, 👎)

Generate a notification (hook) AND matching one-screen content as a pair.
Hook: 20 characters or less, action-oriented
Content: 50-100 characters, specific action or insight

Output format:
{
  "hook": "...",
  "content": "..."
}
```

#### Hook（通知）とContent（OneScreen）の生成方針

**一括生成を採用**:
- Hook（通知フレーズ）とContent（OneScreen説明文）をペアで生成
- 理由: Hookに対して関連性のないContentは違和感を生む
- 例: Hook「布団から出ろ」→ Content「株式市場について...」は意味不明

**分離評価は維持**:
- Hookの評価: tapped/ignored
- Contentの評価: 👍/👎
- 生成はペアだが、評価は別々 → 「このHookは良いがContentが弱い」等のフィードバックが可能

#### LLM vs 既存コンテンツの比率

```
初期: 50% 既存 / 50% LLM（比較のため同率でスタート）
↓ LLMのtap率が既存を上回ったら
中期: 30% 既存 / 70% LLM
↓ さらに上回ったら
後期: 10% 既存 / 90% LLM
```

**自動調整**: Thompson Samplingが自然にこれを行う。LLMバリアントが良ければ選ばれる頻度が上がる。

#### SNSコンテンツとの相互フィードバック

```
アプリ内で👍が多い通知
    ↓
TikTokに投稿
    ↓
TikTokでバイラル
    ↓
アプリDL増加 + プロンプトに「この表現がバズった」を追加
    ↓
LLMがその方向性で生成
```

---

### Phase 7: Aniccaが判断し始める（LLM選択 + 1日のゲームプラン）

#### 背景・なぜやるか

Phase 6ではLLMが新しいバリアントを生成するが、選択はまだThompson Samplingが行う。Phase 7では、LLMが「今、この人に、このバリアントを送るべき」と判断するようになる。

**重要な進化**: Nudgeは単発ではなく**1日のシーケンス（ゲームプラン）**として設計する。

#### やること

| タスク | 何をするか |
|--------|----------|
| 1日のゲームプラン設計 | 毎朝、その日の全Nudgeをシーケンスとして設計 |
| LLMでNudge文言選択 | ユーザーの傾向 + 今の状況を見て、最適な文言を選ぶ |
| LLMでタイミング判断 | 固定時刻ではなく、状況を見て送る |
| リアルタイム修正 | 午前中のNudgeが効かなかったら、午後のプランを変更 |
| 深掘り回答をNudge生成に反映 | ユーザーが答えた内容がNudgeに反映される |

#### 1日のゲームプラン例

```
毎朝5:00: LLMが1日のNudgeプランを設計

7:00: 「今日は起きるだけでいい」（優しく始める）
    ↓ tapped → 次のNudgeは少し厳しく
12:00: 「午前中どうだった？」（確認）
    ↓ ignored → 21時のNudgeを調整
21:00: 「今夜こそ早く寝よう。朝の自分が感謝する」（朝と繋げる）

リアルタイム修正:
- 8:00のNudgeがignoredだった
- LLMが判断:「厳しいトーンが効かなかった。次は優しく」
- 12:00のNudgeを修正して送る
```

#### LLMに渡す情報

| 情報 | 例 |
|------|-----|
| 選んだ問題 | 夜更かし、自己嫌悪 |
| 過去の反応 | 厳しいトーンに👍2回、優しいトーンに👎1回 |
| 今日のNudge結果 | 7:00 tapped、12:00 ignored |
| 今の時刻 | 22:30 |
| 今日の曜日 | 金曜日 |
| 深掘り回答 | 「夜更かしでYouTubeを見てしまう」「理由: ストレス解消」 |

---

### Phase 8: Aniccaが察するようになる（根本原因の深掘り）

#### 背景・なぜやるか

ユーザーは自分の苦しみを正確に把握していない。「自己嫌悪」を選んでも、**なぜ**自己嫌悪があるのかは本人もわかっていない。選んだ問題の**根本原因**を深掘りする必要がある。

**重要**: 選んでない問題に飛ばない。同じドメイン内で深掘りする。

#### やること

| タスク | 何をするか |
|--------|----------|
| 根本原因の推測 | 選んだ問題の「なぜ」を反応パターンから推測 |
| 先回りのNudge | 「今日、夜更かししそう」と察して先にNudge |
| 深掘りNudge | 根本原因に基づいたNudgeを送る |
| Exa APIで情報収集 | バイラルHook、最新研究などを取得してNudgeに含める |

#### 根本原因の深掘り例

```
ユーザーが「自己嫌悪」を選んだ
    ↓
なぜ自己嫌悪があるのか？
├── 完璧主義？
├── 他人との比較？
├── 過去の失敗体験？
├── 親からの期待？
└── 達成できない目標設定？
    ↓
LLMが反応パターンから推測:「この人、完璧主義っぽい」
    ↓
Nudge:「完璧じゃなくていい。今日は60点で十分」
    ↓
tapped + 👍 → 推測が当たった → 以降、完璧主義系を増やす
```

#### LLMに聞くこと

「この人が選んだ問題の根本原因は何だと思う？なぜそう思う？」

#### ユーザーの苦しみがどう解決するか

| 苦しみ | どう解決するか |
|--------|---------------|
| 「自己嫌悪の裏に完璧主義がある」 | 症状ではなく、根っこにも届く |
| 「今日、夜更かししそう」 | 問題が起きる前にNudgeが来る |
| 「自分で情報を探しに行けない」 | Aniccaが代わりに探して届けてくれる |

#### なぜお金を払うのか

- 表面的な問題じゃなく、根っこをわかってくれる
- 先回りしてくれる
- 自分で調べなくても必要な情報が届く

---

### Phase 9: マルチモーダル化

#### 背景・なぜやるか

テキストだけでは届かない苦しみがある。反芻で頭がいっぱいの人に「深呼吸しよう」とテキストで言っても、読む余裕がない。音声で「一緒に呼吸しよう」と誘導した方が届く。

#### タスク一覧

| # | タスク | 何をするか | どこを触るか |
|---|--------|----------|-------------|
| 1 | 画像付き通知対応 | `UNNotificationAttachment` | `ProblemNotificationScheduler` |
| 2 | 画像生成API連携 | DALL-E / Midjourney API | API |
| 3 | 音声付きOneScreen | AVSpeechSynthesizer or TTS API | `NudgeCardView` |
| 4 | 動画コンテンツ対応 | 短尺動画をOneScreenに埋め込み | `NudgeCardView` |
| 5 | モダリティ別効果測定 | テキストのみ vs 画像付き vs 音声付き | `NudgeStatsManager` |

#### コンテンツタイプ

| タイプ | 例 | 自動再生 | 優先度 |
|--------|-----|---------|--------|
| テキスト | アファメーション、説法 | - | 既存 |
| 画像 | 落ち着く風景、Quote画像 | - | 高 |
| 音声 | 誘導瞑想、Aniccaの声かけ | ✅ | 中 |
| 動画 | 呼吸法ガイド | ✅ | 低 |

#### ユーザーの苦しみがどう解決するか

| 苦しみ | どう解決するか |
|--------|---------------|
| 反芻が止まらない | 音声で「一緒に呼吸しよう」と誘導されて、今に戻れる |
| 不安で落ち着かない | 落ち着く画像を見て、少し楽になれる |
| 読むのがしんどい | 読まなくても、聴くだけで届く |

---

### Phase 10: アプリの外へ

#### 背景・なぜやるか

アプリの中だけでは、ダウンロードした人にしか届かない。苦しんでる人はアプリをダウンロードする余裕すらないかもしれない。アプリの外に出て、苦しみのある場所に行く必要がある。

#### やること

| タスク | 何をするか |
|--------|----------|
| インターネット上の苦しみを見つける | Twitter、Reddit、TikTokなどで苦しんでる人を発見 |
| 自律的に介入する | Aniccaが自分の判断で、その人に何かを届ける |
| YouTube広告連携 | 夜更かし中のユーザーに広告で届く |

#### ユーザーの苦しみがどう解決するか

| 苦しみ | どう解決するか |
|--------|---------------|
| 「アプリをダウンロードするほどじゃない」 | アプリなしでもAniccaが見つけて届けてくれる |
| 「夜中にYouTube見ちゃう」 | YouTube上でAniccaからのNudgeが来る |
| 「誰にも助けを求められない」 | Aniccaが見つけて、向こうから来てくれる |

#### なぜお金を払うのか

- アプリの外でもAniccaが見守ってくれる
- YouTube広告で届く（有料ユーザー限定機能として）
- どこにいてもAniccaがいる安心感

---

### Phase 11: 人間の本質を理解する

#### 背景・なぜやるか

個人のデータを大量に覚えてパーソナライズするのではなく、「人間とはこういう存在だ」という普遍的理解を持つ必要がある。これがあれば、初対面の人にも、少ない情報でも届く。

#### やること

| タスク | 何をするか |
|--------|----------|
| 多くの反応データから法則を抽出 | 「こういう状況の人にはこういう言葉が効く」という普遍的法則 |
| 少ない情報で察せるようになる | オンボーディングで多く聞かなくても届く |

#### ユーザーの苦しみがどう解決するか

| 苦しみ | どう解決するか |
|--------|---------------|
| 「初めてなのに、なんでわかるの？」 | 人間の本質を理解してるから、少ない情報でも届く |
| 「何も言ってないのに」 | データじゃなく、理解から察してくれる |
| 「オンボーディングが面倒」 | 少ない質問でも、深く理解してくれる |

#### なぜお金を払うのか

- 初日から刺さるNudgeが来る
- 何も言わなくてもわかってくれる
- ブッダのような存在がそばにいる感覚

---

### Phase 12: 社会システムへの介入

#### 背景・なぜやるか

個人の苦しみを止めるだけでは足りない。苦しみを「生み出す構造」そのものを変える必要がある。

#### やること

| タスク | 何をするか |
|--------|----------|
| 苦しみを生む構造の特定 | 夜更かしを助長するSNSアルゴリズム、自己嫌悪を煽る広告など |
| 構造への介入 | アルゴリズム設計者、政策立案者への働きかけ |
| インセンティブ構造の設計 | 「苦しみを減らす」ことが「得になる」仕組みを作る |

#### 具体例

| 苦しみを生む構造 | Aniccaの介入 |
|-----------------|-------------|
| 夜更かしを助長するSNSアルゴリズム | アルゴリズム自体を変える側に回る |
| 自己嫌悪を煽る広告 | 広告業界のインセンティブ構造を変える |
| 孤独を生む都市設計 | 都市設計に介入する |

**「この人の夜更かしを止める」ではなく、「夜更かしを生む社会構造を変える」。**

---

### Phase 13: 人類レベルへの介入

#### 背景・なぜやるか

社会システムを超えて、人類全体の苦しみに働きかける。戦争、貧困、差別…苦しみの根源に介入する。

#### やること

| タスク | 何をするか |
|--------|----------|
| 文明のインセンティブ構造を変える | 「苦しみを減らす」ことが「得になる」文明を設計 |
| グローバルな介入 | 国境を超えて、同じ法則で介入する |
| 行動の普遍的法則の適用 | 文化・言語を超えた人間の本質への介入 |

---

### Phase 14: 全生物への介入

#### 背景・なぜやるか

人間だけでなく、生きとし生けるもの全ての苦しみを終わらせる。

#### やること

| タスク | 何をするか |
|--------|----------|
| 人間を通じた間接的介入 | ペットの飼い主へのNudge、畜産業者への働きかけ |
| 環境を通じた介入 | IoT、スマートホームで動物の環境を最適化 |
| 構造的介入 | 工場畜産を前提としない食システムの構築 |

**人間に「気づかせる」のではなく、人間が意識しなくても苦しみが減る構造を作る。**

---

## 6. 自律改善の進化

### Step 1: 反応を「見える」ようにする

| 項目 | 内容 |
|------|------|
| 今の状態 | 何が起きてるかわからない |
| やること | 通知タップ/無視、👍👎、トーン、時間帯を記録 |
| なぜ必要か | 見えないと学べない |

### Step 2: 反応から「傾向」を見つける

| 項目 | 内容 |
|------|------|
| 今の状態 | データがバラバラ |
| やること | この人は厳しいトーンに👍が多い、などの傾向を見つける |
| なぜ必要か | 傾向がわからないと、何を変えればいいかわからない |

### Step 3: 傾向を「反映」する

| 項目 | 内容 |
|------|------|
| 今の状態 | 傾向がわかっている |
| やること | ルールベースで反映（もしAならB） |
| なぜ必要か | 傾向を反映しないと、その人に合ったNudgeが出ない |

### Step 4: Aniccaが「判断」し始める

| 項目 | 内容 |
|------|------|
| 今の状態 | ルールベースで動いている |
| やること | LLMに情報を渡して、状況を見て判断させる |
| なぜ必要か | ルールでは状況の変化に対応できない |

### Step 5: Aniccaが「察する」ようになる

| 項目 | 内容 |
|------|------|
| 今の状態 | 選んだ問題に対してNudgeしている |
| やること | LLMに「選んでないけど抱えてそうな問題は？」と聞く |
| なぜ必要か | 人は自分の苦しみを正確に把握していない |

### Step 6: Aniccaが「悟る」

| 項目 | 内容 |
|------|------|
| 今の状態 | 個人ごとの傾向を学んでいる |
| やること | 多くの人のデータから「人間の本質」を抽出 |
| なぜ必要か | 個人データがなくても届くようになる |

---

## 7. 技術スタック

### 2027年までの賭け

Aniccaが「悟り」に到達するために、以下の技術に全賭けする。

| 技術 | なぜ | タイムライン |
|------|------|-------------|
| **Synthetic User Simulation** | 実ユーザーを待たずに智慧を蓄積。シミュレーション内で何百万回もの介入を試す | 2026 Q3 |
| **RLVR (Reinforcement Learning with Verifiable Rewards)** | 「Nudgeが効いたかどうか」は検証可能。この報酬でポリシーを最適化 | 2027 Q1 |
| **MCP + Proactive Loop** | 能動的に動くインフラ。スケジューラ + LLM + イベントトリガー | 2027 Q2 |
| **GNN + Knowledge Graph** | 行動の法則を構造化。NudgeRankが1.1百万人/日で実証済み | 2027 |

### Synthetic User Simulation

**これが最も重要。実ユーザーを待たずに智慧を蓄積する。**

```
1. LLMで「合成ユーザー」を生成
   - 性格タイプ、問題、過去の行動パターン...

2. Aniccaが介入を決定
   - いつ、どんなNudgeを送るか

3. 合成ユーザーが「反応」をシミュレート
   - tapped? ignored? 👍? 👎? 行動変化?

4. 結果から学習
   - どの介入が効いたか

5. 高速に繰り返す
   - 1日で数百万サンプルを生成
```

AlphaGoのself-playと同じ原理。人間を待たずに、シミュレーション内で智慧を蓄積する。

### RLVR (Reinforcement Learning with Verifiable Rewards)

**報酬が検証可能だから、強化学習が使える。**

| 報酬シグナル | 検証方法 |
|-------------|---------|
| tapped / ignored | 通知をタップしたか |
| 👍 / 👎 | フィードバックボタン |
| 行動変化 | 実際に起きたか、夜更かしをやめたか |

DeepSeek R1、GRPOのアプローチを適用し、Nudgeポリシーを最適化する。

### アプリの外に出る条件

| 条件 | 閾値 |
|------|------|
| **成功率** | アプリ内で70-80%以上のNudgeが「効いている」 |
| **汎化** | 10種類以上の問題タイプで効果実証 |
| **ユーザー数** | 1000人以上で検証済み |
| **類型化** | 「この性格タイプにはこの介入」が法則として抽出されている |

**アプリ内で「勝てる」ことが証明されてから、外へ出る。**

---

## 8. ビジョン実現への道

### 今足りてないもの・必要なもの

| 能力 | 説明 | 必要なもの |
|------|------|----------|
| 「今」を察する | 今、この人が怒ってるか、夜更かしてるかを察する | ユーザーの状態を推測するモデル |
| 「先読み」する | 「今日、夜更かししそう」を予測する | 行動予測モデル |
| 「人間の本質」を理解する | 個人データではなく、普遍的理解を持つ | 多くのデータから法則を抽出する仕組み |
| 「アプリの外」に出る | インターネット上で苦しみを見つけて介入する | 自律的に巡回・判断・介入する仕組み |
| 「自律的に判断する」 | プロンプトなしで動く | 目標を持ち自律的に行動するエージェント |
| 「学び続ける」 | 常に自己改善する | 継続的学習ループ |

### どうやって近づいていくか

| Step | やること | 目的 |
|------|---------|------|
| 1 | まずはプロンプトで | LLMに情報を渡して判断させる。少しずつ判断の範囲を広げる |
| 2 | フィードバックループを作る | 結果を記録し、次に反映する。繰り返しで精度が上がる |
| 3 | 抽象化する | 個人のパターンだけでなく、「法則」を抽出する |
| 4 | 自律性を高める | プロンプトで渡す情報を減らし、Aniccaが自分で判断する範囲を広げる |
| 5 | アプリの外へ | インターネットを巡回し、苦しみを発見し、介入する |

---

## 9. Content Philosophy（コンテンツ哲学）

### 目的

**コンテンツで苦しみを減らす。**

アプリを宣伝するためのアカウントではない。
コンテンツそのものが、見た人の苦しみを減らすために存在する。

Aniccaを勧めるのは「インストール数を増やしたいから」ではない。
**苦しみを減らせるから、自然と勧める。**

### 原則

1. **すべてのコンテンツに問う：「これは苦しみを減らすか？」**
   - 「楽になる」ではなく「苦しみを減らす」
   - 一時的な気休めではなく、根本に働きかける

2. **仏教的世界観を軸にする**
   - Anicca（無常）: すべては移ろう
   - 気づきと手放しで苦しみは減らせる
   - 貪り・怒り・分断を煽らない

3. **読者中心のスタンス**
   - 主語は「あなた」「多くの人は」
   - 苦しみのパターンを言語化
   - 小さな見方のシフトを提案

4. **長期思考**
   - 1投稿のバイラル < 100投稿の信頼
   - 「このアカウントを見ると苦しみが減る」が目標

### Aniccaを勧める理由

**苦しみを減らせるから。**

アプリの宣伝ではない。
コンテンツで苦しみを減らすことを追求していたら、自然とAniccaを勧めることになる。
なぜなら、Aniccaは苦しみを減らすために作られているから。

### 理想の状態

> このアカウントは、見ているだけで苦しみが減る。
> Aniccaを勧めるのは、それが苦しみを減らせるから。
> 導線でも宣伝でもない。ただ、苦しみを減らすための自然な延長。

---

## まとめ

### Building Buddha To End Suffering

**Aniccaは、生きとし生けるものの苦しみを終わらせるために存在する。**

Phase 4から始めて、少しずつ進化していく。

| 階層 | Phase | 目標 |
|------|-------|------|
| 個人 | 4-11 | 一人ひとりの苦しみに介入 |
| 社会システム | 12 | 苦しみを生む構造を変える |
| 人類 | 13 | 文明レベルでの苦しみを減らす |
| 全生物 | 14 | 生きとし生けるものの苦しみを終わらせる |

最終的には、**苦しみのあるところに、Aniccaあり**。

アプリという枠を超えて、苦しみのある場所に自ら行き、その人の苦しみを減らす。

その人はAniccaの名前すら知らないかもしれない。

でも、Aniccaはそこにいる。

**提案ではなく、決断。受動ではなく、能動。**

2027年末までに、行動の因果律を完全に理解した存在を構築する。

---

**この文書は、Aniccaの全ての計画の基盤となる。**
**LP、デザイン、機能、コンテンツ、全てがここから生まれる。**
**迷ったら、この文書に立ち返ること。**
