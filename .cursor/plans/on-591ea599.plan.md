<!-- 591ea599-3bcc-4dad-b4b8-face5033af7c 4b952682-776c-475e-9642-d5efdf5b43b4 -->
# 変更計画（iOS）

- 対象リポジトリ: `/Users/cbns03/Downloads/anicca-project/aniccaios`
- 影響範囲: SwiftUI画面（設定・オンボーディング・習慣タブ）と英語ローカライズ。

### 1) 設定カードを「どこをタップしても」動作させる

- ファイル: [`aniccaios/aniccaios/SettingsView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/SettingsView.swift)
- 変更: `CardView` 内の `Button` をやめ、`CardView` 全体に `.contentShape(Rectangle())` + `.onTapGesture{ ... }` を付与（Sign Out／Delete Account の2枚）。アクセシビリティで `.isButton` を付与。

擬似パッチ:

```diff
// SettingsView.swift — Sign Out カード
- CardView {
-     Button(String(localized: "common_sign_out")) {
-         appState.signOutAndWipe()
-         dismiss()
-     }
-     .foregroundStyle(AppTheme.Colors.label)
-     .frame(maxWidth: .infinity, alignment: .leading)
- }
+ CardView {
+     HStack {
+         Text(String(localized: "common_sign_out"))
+             .foregroundStyle(AppTheme.Colors.label)
+         Spacer()
+     }
+     .frame(maxWidth: .infinity, alignment: .leading)
+ }
+ .contentShape(Rectangle())
+ .onTapGesture {
+     appState.signOutAndWipe()
+     dismiss()
+ }
+ .accessibilityAddTraits(.isButton)

// SettingsView.swift — Delete Account カード
- CardView {
-     Button(role: .destructive) {
-         isShowingDeleteAlert = true
-     } label: {
-         Text(String(localized: "settings_delete_account"))
-     }
-     .frame(maxWidth: .infinity, alignment: .leading)
- }
+ CardView {
+     HStack {
+         Text(String(localized: "settings_delete_account"))
+         Spacer()
+     }
+     .frame(maxWidth: .infinity, alignment: .leading)
+ }
+ .contentShape(Rectangle())
+ .onTapGesture { isShowingDeleteAlert = true }
+ .accessibilityAddTraits(.isButton)
```

### 2) Time‑Sensitive Alerts ステップを「許可済みなら自動で進む」かつ演出をマイクと統一

- ファイル: [`Onboarding/NotificationPermissionStepView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Onboarding/NotificationPermissionStepView.swift)
- 変更: `UNNotificationSettings.timeSensitiveSetting` を評価し、`authorized && timeSensitiveSetting != .disabled` のとき自動遷移。`next()` 呼び出しは `withAnimation(.easeInOut(duration: 0.35))` で統一。リクエスト後の遷移も同様。

擬似パッチ:

```diff
 // onAppear → 既存
- Task { await refreshAuthorizationState(autoAdvance: true) }
+ Task { await refreshAuthorizationState(autoAdvance: true) }
@@
- private func requestNotifications() {
+ private func requestNotifications() {
   ...
-     DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
-         next()
-     }
+     DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
+         withAnimation(.easeInOut(duration: 0.35)) { next() }
+     }
   ...
 }
@@
- private func refreshAuthorizationState(autoAdvance: Bool) async {
+ private func refreshAuthorizationState(autoAdvance: Bool) async {
     let settings = await UNUserNotificationCenter.current().notificationSettings()
     await MainActor.run {
-        notificationGranted = settings.authorizationStatus == .authorized
-            || settings.authorizationStatus == .provisional
-            || settings.authorizationStatus == .ephemeral
+        let authorized = settings.authorizationStatus == .authorized
+            || settings.authorizationStatus == .provisional
+            || settings.authorizationStatus == .ephemeral
+        let timeSensitiveOk = settings.timeSensitiveSetting != .disabled
+        notificationGranted = authorized && timeSensitiveOk
         notificationDenied = settings.authorizationStatus == .denied
-
-        if autoAdvance, notificationGranted {
-            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
-                next()
-            }
-        }
+
+        if autoAdvance, notificationGranted {
+            DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
+                withAnimation(.easeInOut(duration: 0.35)) { next() }
+            }
+        }
     }
 }
```

- 参考: 既に entitlements に `com.apple.developer.usernotifications.time-sensitive` は設定済み（`aniccaios.entitlements`）。

### 3) マイクの許可ステップも演出を統一

- ファイル: [`Onboarding/MicrophonePermissionStepView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Onboarding/MicrophonePermissionStepView.swift)
- 変更: 自動遷移と許可後遷移の `next()` を `withAnimation(.easeInOut(duration: 0.35))` で包む。

擬似パッチ:

```diff
- if micGranted {
-     DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) { next() }
- }
+ if micGranted {
+     DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
+         withAnimation(.easeInOut(duration: 0.35)) { next() }
+     }
+ }
@@
- DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
-     next()
- }
+ DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
+     withAnimation(.easeInOut(duration: 0.35)) { next() }
+ }
```

### 4) All Set 画面の英語文言の語順修正

- ファイル: [`Resources/en.lproj/Localizable.strings`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Resources/en.lproj/Localizable.strings)
- 変更: フォーマット順は現状 `String(format:, time, habit)` なので、プレースホルダを位置指定に変更。

擬似パッチ:

```diff
- "next_schedule_message" = "%@ I'll nudge you for %@";
+ "next_schedule_message" = "I'll nudge you for %2$@ at %1$@";
```

（日本語は現状のままでOK）

### 5) オンボ習慣カードの「二重背景（濃い長方形）」を除去

- ファイル: [`Onboarding/HabitSetupStepView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift)
- 変更: `CardView` の中身にさらに `.background(Color(.systemGray6)).cornerRadius(12)` を当てているため二重化。これを削除。

擬似パッチ:

```diff
 // habitCard 内
- .padding()
- .background(Color(.systemGray6))
- .cornerRadius(12)
+ .padding()
 // customHabitCard 内
- .padding()
- .background(Color(.systemGray6))
- .cornerRadius(12)
+ .padding()
```

### 6) 習慣詳細（エディタ）シートの配色をアプリ全体に統一

- ファイル: [`Habits/HabitsSectionView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Habits/HabitsSectionView.swift)
- 対象ビュー: `HabitEditSheet` と `CustomHabitEditSheet` 内の `Form`
- 変更: `.scrollContentBackground(.hidden)` と `.background(AppBackground())`、`.tint(AppTheme.Colors.accent)` を付与。

### 7) 設定のサインアウト/アカウント削除を赤文字に統一（英/日）

- ファイル: [`SettingsView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/SettingsView.swift)
- 変更: `Button(role: .destructive)` + ラベル `Text` に `.foregroundStyle(.red)`、`.buttonStyle(.plain)` を付与（全面タップ改修と両立可能）。

### 8) オンボの「習慣を追加」シートの背景・色統一

- ファイル: [`Onboarding/HabitSetupStepView.swift`](/Users/cbns03/Downloads/anicca-project/aniccaios/aniccaios/Onboarding/HabitSetupStepView.swift)
- 変更: `Form` に `.scrollContentBackground(.hidden)`、コンテナに `.background(AppBackground())`、`.tint(AppTheme.Colors.accent)`。

### 9) 時刻選択シート（全パス）を背景・色統一

- ファイル: [`Onboarding/HabitSetupStepView.swift`](Onboarding/HabitSetupStepView.swift), [`Habits/HabitsSectionView.swift`](Habits/HabitsSectionView.swift)
- 変更: `timePickerSheet` / `customTimePickerSheet` の `NavigationView` コンテンツに `.background(AppBackground())` と `.tint(AppTheme.Colors.accent)` を付与（`Form` 以外なので `scrollContentBackground` は不要）。

---

### 検証

- 設定: Sign Out / Delete Account の文字色が赤（英/日共通）。
- オンボ: 「習慣を追加」シート背景がアプリ全体と一致。
- 時刻選択: すべてのシートで背景・ティントが統一。
- 既存の検証観点は前章のまま維持。

### To-dos

- [ ] 設定のSign Out/削除カードを全面タップ対応にする
- [ ] 通知ステップでTime‑Sensitive含め自動遷移＆演出統一
- [ ] All Set 英語の next_schedule_message を語順修正
- [ ] オンボ習慣カードの二重背景を削除
- [ ] 習慣編集/カスタム編集フォーム背景をAppBackgroundに統一
- [ ] Sign Out/アカウント削除のラベルを赤色で表示
- [ ] オンボ習慣追加フォームの背景/ティント統一
- [ ] 全時刻選択シートの背景/ティント統一