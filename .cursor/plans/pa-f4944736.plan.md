<!-- f4944736-ec1f-4fc7-be26-274a91822058 f2390a09-db43-413a-9572-f6bddc9d7bb4 -->
# pa.md 徹底レビュー（現行コード突合）+ 修正議事パッチ（チャット用）

## 結論（まずここだけ）

- **`pa.md` はそのままだと成立しない箇所が複数あります**（例: `CustomHabitConfiguration` が `let` で不変、`SessionView` にクレジット切れシートが無い、`VoiceSessionController` が 402 時にホールドを消してしまう等）。
- ただし、狙っている要件（表の #1〜#7）は **既存実装を活かして“小さく”直せます**。`UnifiedSessionView` のような大規模統合は不要です（UI/UX変更量が大きく、リスクが高い）。

---

## まず事実確認（現行コードの状態）

- **#1**: `CustomHabitEditSheet` は別ファイルではなく、`HabitsSectionView.swift` 内に定義されています（`struct CustomHabitEditSheet: View`）。
- **#3**: `SubscriptionInfo` には `monthlyUsageCount`/`monthlyUsageLimit` が既に存在します。`ProfileView` はそれをまだ表示していません。
- **#4**: `HighlightsCard.localizedValueLabel` は **「JA→EN置換のみ」**で、**EN→JA が無い**ため日本語UIで英語が混ざり得ます。
- **#5**: `HabitSessionView` は `UsageLimitModalView` を持ちますが、`Views/Session/SessionView.swift`（Talk側のセッション画面）には **クレジット切れシートが存在しません**。
- **#5の根本バグ**: `VoiceSessionController.establishSession` の 402 ハンドリングで `markQuotaHold(plan: nil)` を呼び、**せっかく立てたホールドを即消しています**。このせいで「シートが出ない/一瞬で消える」系の不安定挙動が起き得ます。
- **#6**: `UsageLimitModalView` の文言は `Localizable.strings` の `quota_exceeded_*` / `session_time_cap_*` キーで管理されています（`pa.md` の `usage_limit_*` という新キー案は現状不要）。
- **#7**: `CustomerCenterView` 呼び出しは既に複数箇所に実装済み（Profile/HabitSession/Settings）。ユーザーの言う通り基本は **RCダッシュボード設定依存**です。

---

## 修正議事パッチ（必要最小限・現行構造維持）

### 1) #1 習慣名インライン編集（`CustomHabitEditSheet` + `AppState`）

ポイント: `CustomHabitConfiguration` は `let name`/`let updatedAt` なので **「新しいインスタンスを作って差し替え」**が正解。

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Habits/HabitsSectionView.swift
@@
 struct CustomHabitEditSheet: View {
@@
     @State private var time = Date()
     @State private var followups: Int = 2
     @State private var showAlarmKitDeniedAlert = false
+    @State private var habitName: String = ""
@@
     var body: some View {
         NavigationView {
             Form {
+                Section {
+                    TextField(String(localized: "habit_custom_name_placeholder"), text: $habitName)
+                }
                 Section {
                     DatePicker(String(localized: "common_time"), selection: $time, displayedComponents: [.hourAndMinute])
                 }
@@
         .onAppear {
+            habitName = appState.customHabits.first(where: { $0.id == customId })?.name ?? ""
             if let comps = appState.customHabitSchedules[customId],
                let d = Calendar.current.date(from: comps) {
                 time = d
             }
             followups = appState.customFollowupCount(for: customId)
         }
@@
     private func save() {
         appState.updateCustomHabitSchedule(id: customId, time: Calendar.current.dateComponents([.hour, .minute], from: time))
         appState.updateCustomFollowupCount(id: customId, count: followups)
+        appState.updateCustomHabitName(id: customId, name: habitName)
         Task {
             await MainActor.run {
                 onSave()
                 dismiss()
             }
         }
     }
 }
*** End Patch
```
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/AppState.swift
@@
     // MARK: - Custom Habit Management
@@
     func updateCustomHabitSchedule(id: UUID, time: DateComponents?) {
@@
     }
+
+    func updateCustomHabitName(id: UUID, name: String) {
+        let trimmed = name.trimmingCharacters(in: .whitespacesAndNewlines)
+        guard !trimmed.isEmpty else { return }
+        guard let index = customHabits.firstIndex(where: { $0.id == id }) else { return }
+
+        let current = customHabits[index]
+        guard current.name != trimmed else { return }
+
+        let updated = CustomHabitConfiguration(id: current.id, name: trimmed, updatedAt: .now)
+        customHabits[index] = updated
+        CustomHabitStore.shared.saveAll(customHabits)
+
+        // サーバー同期（payloadにcustomHabitsが含まれる）
+        Task { await ProfileSyncService.shared.enqueue(profile: userProfile) }
+    }
*** End Patch
```

---

### 2) #3 使用量表示 (250/300)（`ProfileView.swift`）

ポイント: `SubscriptionInfo.monthlyUsageCount` と `monthlyUsageLimit` を使って **Plan表示文字列に括弧で付加**。

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Views/Profile/ProfileView.swift
@@
                 Button {
                     showingManageSubscription = true
                 } label: {
-                    row(label: String(localized: "profile_row_plan"), value: appState.subscriptionInfo.displayPlanName, showsChevron: true)
+                    row(label: String(localized: "profile_row_plan"), value: planDisplayWithUsage, showsChevron: true)
                 }
                 .buttonStyle(.plain)
@@
     }
+
+    private var planDisplayWithUsage: String {
+        let base = appState.subscriptionInfo.displayPlanName
+        if let used = appState.subscriptionInfo.monthlyUsageCount,
+           let limit = appState.subscriptionInfo.monthlyUsageLimit {
+            return "\(base) (\(used)/\(limit))"
+        }
+        return base
+    }
*** End Patch
```

---

### 3) #4 ハイライトのローカライズ（`HighlightsCard.swift`）

ポイント: 現状は `JA→EN` のみ。**`EN→JA` を追加**して双方向に。

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Views/Behavior/HighlightsCard.swift
@@
     private func localizedValueLabel(_ raw: String) -> String {
-        guard appState.effectiveLanguage == .en else { return raw.isEmpty ? "-" : raw }
-        let replacements: [(ja: String, en: String)] = [
-            ("起床", "Wake"),
-            ("スクリーン", "Screen"),
-            ("歩数", "Steps"),
-            ("反芻", "Rumination"),
-            ("分", "min")
-        ]
-        var result = raw.isEmpty ? "-" : raw
-        for pair in replacements {
-            result = result.replacingOccurrences(of: pair.ja, with: pair.en)
-        }
-        return result
+        guard !raw.isEmpty else { return "-" }
+        let pairs: [(ja: String, en: String)] = [
+            ("起床", "Wake"),
+            ("スクリーン", "Screen"),
+            ("歩数", "Steps"),
+            ("反芻", "Rumination"),
+            ("分", "min")
+        ]
+        var result = raw
+        if appState.effectiveLanguage == .en {
+            for p in pairs { result = result.replacingOccurrences(of: p.ja, with: p.en) }
+        } else {
+            for p in pairs { result = result.replacingOccurrences(of: p.en, with: p.ja) }
+        }
+        return result
     }
 }
*** End Patch
```

---

### 4) #5 クレジット切れシート（Talk側も含めて“確実に出る”）

#### 4-A) **根本修正**: 402時にホールドを消さない（`VoiceSessionController.swift`）

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/VoiceSessionController.swift
@@
         } catch VoiceSessionError.quotaExceeded {
             // 402エラー時はPaywallを表示してセッションを終了
             logger.warning("Quota exceeded, showing paywall")
-            await MainActor.run {
-                AppState.shared.markQuotaHold(plan: nil)
-            }
             setStatus(.disconnected)
         } catch {
*** End Patch
```

#### 4-B) Talkの `SessionView` に `UsageLimitModalView` を追加（`Views/Session/SessionView.swift`）

ポイント: `HabitSessionView` と同等のシート構成を追加し、`subscriptionHold` を監視。

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Views/Session/SessionView.swift
@@
-import SwiftUI
+import SwiftUI
 import AVFoundation
 import Combine
+import RevenueCatUI
@@
 struct SessionView: View {
@@
     @State private var showMicAlert = false
     @State private var isShowingEMA = false
     @State private var pendingDismissAfterEMA = false
+    @State private var showUsageLimitModal = false
+    @State private var showPaywall = false
+    @State private var showManageSubscription = false
@@
     var body: some View {
@@
         .onAppear {
-            ensureMicrophonePermissionAndStart()
+            // 既にホールド or 残量0が分かっている場合は、開始せずシート表示
+            if appState.subscriptionHold {
+                showUsageLimitModal = true
+                return
+            }
+            if let remaining = appState.subscriptionInfo.monthlyUsageRemaining, remaining <= 0 {
+                appState.markQuotaHold(plan: appState.subscriptionInfo.plan, reason: .quotaExceeded)
+                showUsageLimitModal = true
+                return
+            }
+            ensureMicrophonePermissionAndStart()
         }
@@
         .alert(String(localized: "session_mic_permission_title"), isPresented: $showMicAlert) {
@@
         } message: {
             Text(String(localized: "session_mic_permission_message"))
         }
+
+        .sheet(isPresented: $showUsageLimitModal) {
+            UsageLimitModalView(
+                plan: appState.subscriptionHoldPlan ?? appState.subscriptionInfo.plan,
+                reason: appState.quotaHoldReason ?? .quotaExceeded,
+                onClose: { showUsageLimitModal = false },
+                onUpgrade: {
+                    showUsageLimitModal = false
+                    showPaywall = true
+                },
+                onManage: {
+                    showUsageLimitModal = false
+                    showManageSubscription = true
+                }
+            )
+        }
+        .sheet(isPresented: $showPaywall) {
+            PaywallContainerView(
+                forcePresent: true,
+                onPurchaseCompleted: { showPaywall = false },
+                onDismissRequested: { showPaywall = false }
+            )
+            .environmentObject(appState)
+        }
+        .sheet(isPresented: $showManageSubscription) {
+            RevenueCatUI.CustomerCenterView()
+                .onCustomerCenterRestoreCompleted { info in
+                    Task {
+                        let subscription = SubscriptionInfo(info: info)
+                        await MainActor.run { appState.updateSubscriptionInfo(subscription) }
+                        await SubscriptionManager.shared.syncNow()
+                    }
+                }
+        }
+        .onChange(of: appState.subscriptionHold) { hold in
+            if hold {
+                showUsageLimitModal = true
+            } else {
+                showUsageLimitModal = false
+                showPaywall = false
+                showManageSubscription = false
+            }
+        }
     }
*** End Patch
```

---

### 5) #6 ダイアログ文言（`Localizable.strings` 日英）

ポイント: 現状のタイトルに `Free 30/30` などがハードコードされており、将来の上限変更や表記方針とズレやすい。**タイトルは汎用化して、具体値は本文で説明**に寄せるのが安全。

```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Resources/ja.lproj/Localizable.strings
@@
-"quota_exceeded_title_free" = "月の使用上限に達しました（Free 30/30）";
-"quota_exceeded_title_pro" = "月の使用上限に達しました（Pro 300/300）";
+"quota_exceeded_title_free" = "月間利用上限に達しました";
+"quota_exceeded_title_pro" = "月間利用上限に達しました";
@@
-"quota_exceeded_message_free" = "Proにアップグレードすると今すぐ続けられます。";
-"quota_exceeded_message_pro" = "Maxプランは近日公開です。必要な方はサポートへご連絡ください。";
+"quota_exceeded_message_free" = "今月の30分を使い切りました。Proにアップグレードすると300分使えます。";
+"quota_exceeded_message_pro" = "今月の300分を使い切りました。来月リセットされます。";
*** End Patch
```
```diff
*** Begin Patch
*** Update File: aniccaios/aniccaios/Resources/en.lproj/Localizable.strings
@@
-"quota_exceeded_title_free" = "Monthly usage limit reached (Free 30/30)";
-"quota_exceeded_title_pro" = "Monthly usage limit reached (Pro 300/300)";
+"quota_exceeded_title_free" = "Monthly limit reached";
+"quota_exceeded_title_pro" = "Monthly limit reached";
@@
-"quota_exceeded_message_free" = "Upgrade to Pro to continue right away.";
-"quota_exceeded_message_pro" = "Max plan coming soon. Please contact support if needed.";
+"quota_exceeded_message_free" = "You’ve used all 30 minutes this month. Upgrade to Pro to get 300 minutes.";
+"quota_exceeded_message_pro" = "You’ve used all 300 minutes this month. Your limit will reset next month.";
*** End Patch
```

---

## #2（RC通貨表示の誤解）

- **結論**: Paywallに出ている「300」は“残高”ではなく **「購入で付与される分数」**の表示である可能性が高いです。
- **アプリ内での残り分数**は `SubscriptionInfo.monthlyUsageRemaining`（サーバー由来）が正。
- #3 の表示を入れると「残り/上限」がUIで一貫し、誤解が減ります。

---

## #7（RC Customer Center）

- コード側は既に `RevenueCatUI.CustomerCenterView()` を表示できています。
- それでもキャンセル導線が出ない場合は **RCダッシュボードのCustomer Center設定 / 対象Entitlement / Sandbox制限 / StoreKit状態**の可能性が高いです。
- 追加でコード変更するなら「CustomerCenterを出す条件（plan判定）と同期タイミング」程度ですが、現状実装は十分に妥当です。

---

## 実装・検証の順序（安全に進める）

1. `VoiceSessionController` の 402 ハンドリング修正（ホールドを消さない）
2. `SessionView` に UsageLimitModal を追加（Talkでも確実に表示）
3. `ProfileView` の 250/300 表示
4. `HighlightsCard` の双方向ローカライズ
5. `CustomHabitEditSheet` の名前編集 + `AppState.updateCustomHabitName`
6. `Localizable.strings` 文言調整

## 実装TODO

- review-pa-md-vs-code: `pa.md` の不整合点を潰した上で、上の最小パッチ案に差し替える
- fix-voice-402-hold: 402時ホールドが消える不具合を修正
- add-session-usage-modal: Talk側 `SessionView` に UsageLimitModal/Paywall/CustomerCenter を実装
- profile-usage-250-300: Plan行に (used/limit) を付与
- highlights-bidirectional-l10n: ハイライトの valueLabel を双方向置換
- custom-habit-inline-name-edit: CustomHabitEditSheet に TextField + AppState に更新API
- strings-dialog-copy: `Localizable.strings` の quota exceeded 文言を更新

### To-dos

- [ ] 402(Quota)時にsubscriptionHoldを消してしまう不具合を修正（`VoiceSessionController.establishSession`）
- [ ] `Views/Session/SessionView.swift` に `UsageLimitModalView`/Paywall/CustomerCenterを追加し、Talkでもクレジット切れシートを表示
- [ ] `ProfileView.swift` のPlan表示に (used/limit) を付与（例: 250/300）
- [ ] `HighlightsCard.swift` の valueLabel を双方向ローカライズ（EN→JAも）
- [ ] `CustomHabitEditSheet` に習慣名TextFieldを追加し、`AppState.updateCustomHabitName` を実装
- [ ] `Localizable.strings`(日英) の quota exceeded / session cap 文言を整備