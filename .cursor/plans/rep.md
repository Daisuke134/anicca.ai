# Anicca iOS / Backend å®Œå…¨ãƒ‘ãƒƒãƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Behaviorã‚¿ãƒ–ãŠã‚ˆã³ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®å®Œå…¨ãªãƒ‘ãƒƒãƒã§ã™ã€‚

---

## ç›®æ¬¡

1. [å•é¡Œ1: 10 Years From Now ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º](#å•é¡Œ1-10-years-from-now-ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º)
2. [å•é¡Œ2: 10 Years From Now ãŒ2è¡Œè¡¨ç¤ºã•ã‚Œã‚‹](#å•é¡Œ2-10-years-from-now-ãŒ2è¡Œè¡¨ç¤ºã•ã‚Œã‚‹)
3. [å•é¡Œ3: 10 Years From Now ã‚«ãƒ¼ãƒ‰ã®æ¨ªå¹…ãŒç‹­ã„](#å•é¡Œ3-10-years-from-now-ã‚«ãƒ¼ãƒ‰ã®æ¨ªå¹…ãŒç‹­ã„)
4. [å•é¡Œ4: Today's Insight ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º](#å•é¡Œ4-todays-insight-ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º)
5. [å•é¡Œ5: 24h Timeline ã«ç¡çœ ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„](#å•é¡Œ5-24h-timeline-ã«ç¡çœ ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„)
6. [å•é¡Œ6: HealthKit ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒå¤œé–“ç¡çœ ã‚’å–å¾—ã§ããªã„](#å•é¡Œ6-healthkit-ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒå¤œé–“ç¡çœ ã‚’å–å¾—ã§ããªã„)
7. [å•é¡Œ7: ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ©ãƒ™ãƒ«ãŒæ—¥æœ¬èªã§ã‚‚è‹±èªè¡¨ç¤º](#å•é¡Œ7-ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ©ãƒ™ãƒ«ãŒæ—¥æœ¬èªã§ã‚‚è‹±èªè¡¨ç¤º)
8. [å•é¡Œ8: ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡è¨€ã‚’å‰Šé™¤ã—å€¤ã®ã¿è¡¨ç¤º](#å•é¡Œ8-ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡è¨€ã‚’å‰Šé™¤ã—å€¤ã®ã¿è¡¨ç¤º)
9. [å•é¡Œ9: Ideal Traits/Problems ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§è‹±èªã®ã¾ã¾](#å•é¡Œ9-ideal-traitsproblems-ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§è‹±èªã®ã¾ã¾)
10. [å•é¡Œ10: LANGUAGE LOCK ãŒå¸¸ã« English ã«ãªã‚‹](#å•é¡Œ10-language-lock-ãŒå¸¸ã«-english-ã«ãªã‚‹)
11. [å•é¡Œ11: Feeling ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè‹±èªã®ã¿](#å•é¡Œ11-feeling-ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè‹±èªã®ã¿)
12. [å•é¡Œ12: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒä¸è¶³](#å•é¡Œ12-ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒä¸è¶³)
13. [ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ä¸€è¦§](#ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ä¸€è¦§)
14. [é©ç”¨æ‰‹é †](#é©ç”¨æ‰‹é †)

---

## å•é¡Œ1: 10 Years From Now ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º

### åŸå› 

`futureScenario.js` ãŒå­˜åœ¨ã—ãªã„ OpenAI API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/v1/responses` ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€å¸¸ã« catch ãƒ–ãƒ­ãƒƒã‚¯ã«å…¥ã‚Š fallback ãŒè¿”ã•ã‚Œã‚‹ã€‚

æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ `/v1/chat/completions`ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/simulation/futureScenario.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (55-78è¡Œç›®):
// ============================================
  try {
    // Minimal call (Responses API assumed). If this fails, we fallback.
    const resp = await fetch('https://api.openai.com/v1/responses', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model,
        input,
        // Ask for JSON in text; parse best-effort below.
        text: { format: { type: 'json_object' } }
      })
    });

    if (!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    const text = data.output_text || '';
    const parsed = JSON.parse(text);
    if (parsed?.ifContinue && parsed?.ifImprove) {
      return { ifContinue: String(parsed.ifContinue), ifImprove: String(parsed.ifImprove) };
    }
    return fallback(language);
  } catch {
    return fallback(language);
  }

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
  try {
    // â˜… æ­£ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: /v1/chat/completions
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model,
        messages: input,  // â˜… 'input' â†’ 'messages'
        response_format: { type: 'json_object' },  // â˜… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡å®š
        max_tokens: 500,
        temperature: 0.7
      })
    });

    if (!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    const text = data.choices?.[0]?.message?.content || '';  // â˜… ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æä¿®æ­£
    const parsed = JSON.parse(text);
    if (parsed?.ifContinue && parsed?.ifImprove) {
      return { ifContinue: String(parsed.ifContinue), ifImprove: String(parsed.ifImprove) };
    }
    return fallback(language);
  } catch {
    return fallback(language);
  }
```

---

## å•é¡Œ2: 10 Years From Now ãŒ2è¡Œè¡¨ç¤ºã•ã‚Œã‚‹

### åŸå› 

ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã« `ifContinue` ã¨ `ifImprove` ã®ä¸¡æ–¹ã«åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã‚‹ãŸã‚ã€UIã§ä¸¡æ–¹è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/simulation/futureScenario.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (3-14è¡Œç›®):
// ============================================
function fallback(language) {
  if (language === 'ja') {
    return {
      ifContinue: 'ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
      ifImprove: 'ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'
    };
  }
  return {
    ifContinue: 'Not enough data available',
    ifImprove: 'Not enough data available'
  };
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
function fallback(language) {
  if (language === 'ja') {
    return {
      ifContinue: 'ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
      ifImprove: ''  // â˜… ç©ºã«ã—ã¦1è¡Œã®ã¿è¡¨ç¤º
    };
  }
  return {
    ifContinue: 'Not enough data available',
    ifImprove: ''  // â˜… ç©ºã«ã—ã¦1è¡Œã®ã¿è¡¨ç¤º
  };
}
```

---

## å•é¡Œ3: 10 Years From Now ã‚«ãƒ¼ãƒ‰ã®æ¨ªå¹…ãŒç‹­ã„

### åŸå› 

ãƒ‡ãƒ¼ã‚¿ãªã—æ™‚ã® `CardView` ã« `maxWidth: .infinity` ãŒé©ç”¨ã•ã‚Œã¦ã„ãªã„ã€‚ã¾ãŸã€ã‚¿ã‚¤ãƒˆãƒ«ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Views/Behavior/FutureScenarioView.swift`

```swift
// ============================================
// å¤‰æ›´å‰ (10-18è¡Œç›®):
// ============================================
if isEmpty {
    CardView {
        Text(String(localized: "behavior_not_enough_data"))
            .font(AppTheme.Typography.subheadlineDynamic)
            .foregroundStyle(AppTheme.Colors.secondaryLabel)
            .frame(maxWidth: .infinity, alignment: .center)
    }
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
if isEmpty {
    CardView {
        VStack(alignment: .leading, spacing: 12) {
            // â˜… ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
            Text(String(localized: "behavior_title_future"))
                .font(.system(size: 20, weight: .bold))
                .foregroundStyle(AppTheme.Colors.label)
            Text(String(localized: "behavior_not_enough_data"))
                .font(AppTheme.Typography.subheadlineDynamic)
                .foregroundStyle(AppTheme.Colors.secondaryLabel)
                .frame(maxWidth: .infinity, alignment: .center)
        }
    }
    .frame(maxWidth: .infinity)  // â˜… TimelineViewã¨åŒã˜æ¨ªå¹…
}
```

---

## å•é¡Œ4: Today's Insight ãŒå¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º

### åŸå› 

`pickTodayInsight()` ã¯ `daily_metrics.insights.todayInsight` ã‚’èª­ã‚€ã ã‘ã§ã€AIç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå­˜åœ¨ã—ãªã„ã€‚

### ãƒ‘ãƒƒãƒ

#### ãƒ‘ãƒƒãƒ4-1: æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/insights/generateTodayInsight.js` ï¼ˆæ–°è¦ä½œæˆï¼‰

```javascript
import { fetch } from 'undici';
import baseLogger from '../../utils/logger.js';

const logger = baseLogger.withContext('TodayInsight');

export async function generateTodayInsight({ todayStats, traits, language = 'en' }) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    logger.warn('OPENAI_API_KEY not set, returning fallback');
    return null;
  }

  // ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ãªå ´åˆã¯nullã‚’è¿”ã™ï¼ˆå‘¼ã³å‡ºã—å…ƒã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  const hasData = todayStats && (
    todayStats.wakeAt ||
    todayStats.steps > 0 ||
    todayStats.snsMinutesTotal > 0 ||
    todayStats.sleepDurationMin
  );
  
  if (!hasData) {
    return null;
  }

  const model = process.env.OPENAI_INSIGHT_MODEL || 'gpt-4o-mini';

  const systemPrompt = language === 'ja'
    ? `ã‚ãªãŸã¯è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€ä»Šæ—¥1æ—¥ã®çŸ­ã„æ´å¯Ÿï¼ˆ1-2æ–‡ï¼‰ã‚’æä¾›ã—ã¾ã™ã€‚
       ãƒã‚¸ãƒ†ã‚£ãƒ–ã§åŠ±ã¾ã—ã®è¨€è‘‰ã‚’ä½¿ã„ã€åŒ»ç™‚çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯é¿ã‘ã¦ãã ã•ã„ã€‚
       ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªè¦³å¯Ÿã¨ã€å°ã•ãªæ”¹å–„ææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
    : `You provide brief insights (1-2 sentences) based on behavioral data.
       Use positive, encouraging language. Avoid medical advice.
       Include specific observations from the data and small improvement suggestions.`;

  const userContent = JSON.stringify({
    task: language === 'ja' 
      ? 'ä»Šæ—¥ã®è¡Œå‹•ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€çŸ­ã„æ´å¯Ÿã‚’1-2æ–‡ã§æ›¸ã„ã¦ãã ã•ã„ã€‚'
      : 'Write a brief insight (1-2 sentences) based on today\'s behavioral data.',
    data: {
      sleepMinutes: todayStats.sleepDurationMin,
      wakeTime: todayStats.wakeAt,
      steps: todayStats.steps,
      snsMinutes: todayStats.snsMinutesTotal,
      sedentaryMinutes: todayStats.sedentaryMinutes
    },
    userTraits: {
      ideals: traits?.ideals || [],
      struggles: traits?.struggles || []
    }
  }, null, 2);

  try {
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userContent }
        ],
        max_tokens: 150,
        temperature: 0.7
      })
    });

    if (!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    const insight = data.choices?.[0]?.message?.content?.trim();
    
    if (insight) {
      return insight;
    }
  } catch (e) {
    logger.error('Failed to generate today insight', e);
  }

  return null;
}
```

#### ãƒ‘ãƒƒãƒ4-2: stateBuilder.js ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/metrics/stateBuilder.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (89-95è¡Œç›®):
// ============================================
export function pickTodayInsight({ todayStats, language = 'en' }) {
  const insight = todayStats?.insights?.todayInsight;
  if (typeof insight === 'string' && insight.trim()) return insight.trim();
  return language === 'ja'
    ? 'ã¾ã ååˆ†ãªè¡Œå‹•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šæ—¥ã®æµã‚Œã‚’ä¸€ç·’ã«æ•´ãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚'
    : 'Not enough behavior data yet. We can shape today gently from here.';
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
export function pickTodayInsight({ todayStats, language = 'en' }) {
  const insight = todayStats?.insights?.todayInsight;
  if (typeof insight === 'string' && insight.trim()) {
    return insight.trim();
  }
  // â˜… ä¿å­˜æ¸ˆã¿ãŒãªã„å ´åˆã¯nullã‚’è¿”ã—ã€å‘¼ã³å‡ºã—å…ƒã§AIç”Ÿæˆã‚’ä¿ƒã™
  return null;
}

// â˜… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è¿½åŠ 
export function getInsightFallback(language = 'en') {
  return language === 'ja'
    ? 'ã¾ã ååˆ†ãªè¡Œå‹•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šæ—¥ã®æµã‚Œã‚’ä¸€ç·’ã«æ•´ãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚'
    : 'Not enough behavior data yet. We can shape today gently from here.';
}
```

#### ãƒ‘ãƒƒãƒ4-3: behavior.js ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/routes/mobile/behavior.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (1-44è¡Œç›®):
// ============================================
import express from 'express';
import baseLogger from '../../utils/logger.js';
import extractUserId from '../../middleware/extractUserId.js';
import { buildContextSnapshot } from '../../modules/realtime/contextSnapshot.js';
import { buildHighlights, buildTimeline, pickTodayInsight } from '../../modules/metrics/stateBuilder.js';
import { generateFutureScenario } from '../../modules/simulation/futureScenario.js';
import { PrismaClient } from '../../generated/prisma/index.js';

const router = express.Router();
const logger = baseLogger.withContext('MobileBehavior');
const prisma = new PrismaClient();

// GET /api/mobile/behavior/summary
router.get('/summary', async (req, res) => {
  const deviceId = (req.get('device-id') || '').toString().trim();
  const userId = await extractUserId(req, res);
  if (!userId) return;

  try {
    const snapshot = await buildContextSnapshot({ userId, deviceId });
    const tz = snapshot?.timezone || 'UTC';
    const lang = snapshot?.language || 'en';
    const today = snapshot?.today_stats || null;

    const todayInsight = pickTodayInsight({ todayStats: today, language: lang });
    const highlights = buildHighlights({ todayStats: today, timezone: tz });
    const timeline = buildTimeline({ todayStats: today, timezone: tz });
    // ...

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
import express from 'express';
import baseLogger from '../../utils/logger.js';
import extractUserId from '../../middleware/extractUserId.js';
import { buildContextSnapshot } from '../../modules/realtime/contextSnapshot.js';
import { buildHighlights, buildTimeline, pickTodayInsight, getInsightFallback } from '../../modules/metrics/stateBuilder.js';  // â˜… getInsightFallback è¿½åŠ 
import { generateFutureScenario } from '../../modules/simulation/futureScenario.js';
import { generateTodayInsight } from '../../modules/insights/generateTodayInsight.js';  // â˜… è¿½åŠ 
import { PrismaClient } from '../../generated/prisma/index.js';

const router = express.Router();
const logger = baseLogger.withContext('MobileBehavior');
const prisma = new PrismaClient();

// GET /api/mobile/behavior/summary
router.get('/summary', async (req, res) => {
  const deviceId = (req.get('device-id') || '').toString().trim();
  const userId = await extractUserId(req, res);
  if (!userId) return;

  try {
    const snapshot = await buildContextSnapshot({ userId, deviceId });
    const tz = snapshot?.timezone || 'UTC';
    const lang = snapshot?.language || 'en';
    const today = snapshot?.today_stats || null;

    // â˜… ä¿å­˜æ¸ˆã¿insightã‚’ãƒã‚§ãƒƒã‚¯ã€ãªã‘ã‚Œã°AIç”Ÿæˆ
    let todayInsight = pickTodayInsight({ todayStats: today, language: lang });
    if (!todayInsight) {
      // AIç”Ÿæˆã‚’è©¦ã¿ã‚‹
      todayInsight = await generateTodayInsight({
        todayStats: today,
        traits: snapshot?.traits,
        language: lang
      });
      // ç”Ÿæˆã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      if (!todayInsight) {
        todayInsight = getInsightFallback(lang);
      }
    }

    const highlights = buildHighlights({ todayStats: today, timezone: tz, language: lang });  // â˜… language è¿½åŠ 
    const timeline = buildTimeline({ todayStats: today, timezone: tz });
    // ...
```

---

## å•é¡Œ5: 24h Timeline ã«ç¡çœ ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„

### åŸå› 

`contextSnapshot.js` ã® `today_stats` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `sleepStartAt` ãŒå«ã¾ã‚Œã¦ã„ãªã„ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/realtime/contextSnapshot.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (144-155è¡Œç›®):
// ============================================
    today_stats: today
      ? {
          sleepDurationMin: today.sleep_duration_min ?? null,
          wakeAt: today.wake_at ?? null,
          snsMinutesTotal: today.sns_minutes_total ?? 0,
          steps: today.steps ?? 0,
          sedentaryMinutes: today.sedentary_minutes ?? 0,
          mindSummary: today.mind_summary ?? {},
          activitySummary: today.activity_summary ?? {},
          insights: today.insights ?? {}
        }
      : null,

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
    today_stats: today
      ? {
          sleepDurationMin: today.sleep_duration_min ?? null,
          sleepStartAt: today.sleep_start_at ?? null,  // â˜… è¿½åŠ : Timelineç”¨
          wakeAt: today.wake_at ?? null,
          snsMinutesTotal: today.sns_minutes_total ?? 0,
          steps: today.steps ?? 0,
          sedentaryMinutes: today.sedentary_minutes ?? 0,
          mindSummary: today.mind_summary ?? {},
          activitySummary: today.activity_summary ?? {},
          insights: today.insights ?? {}
        }
      : null,
```

---

## å•é¡Œ6: HealthKit ç¡çœ ãƒ‡ãƒ¼ã‚¿ãŒå¤œé–“ç¡çœ ã‚’å–å¾—ã§ããªã„

### åŸå› 

`HealthKitManager.swift` ãŒ `.strictStartDate` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€æ˜¨å¤œ22æ™‚ã€œä»Šæœ6æ™‚ã®ç¡çœ ãƒ‡ãƒ¼ã‚¿ã¯ã€Œé–‹å§‹æ™‚åˆ»ãŒæ˜¨æ—¥ã€ã®ãŸã‚å–å¾—ã•ã‚Œãªã„ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Services/HealthKitManager.swift`

```swift
// ============================================
// å¤‰æ›´å‰ (93-136è¡Œç›®):
// ============================================
    func fetchDailySummary() async -> DailySummary {
        var summary = DailySummary()
        
        let calendar = Calendar.current
        let now = Date()
        let startOfDay = calendar.startOfDay(for: now)
        let endOfDay = calendar.date(byAdding: .day, value: 1, to: startOfDay)!
        
        // Fetch sleep
        if let sleepType = HKObjectType.categoryType(forIdentifier: .sleepAnalysis) {
            let predicate = HKQuery.predicateForSamples(withStart: startOfDay, end: endOfDay, options: .strictStartDate)
            let sleepSamples = try? await withCheckedThrowingContinuation { (continuation: CheckedContinuation<[HKCategorySample], Error>) in
                let query = HKSampleQuery(sampleType: sleepType, predicate: predicate, limit: HKObjectQueryNoLimit, sortDescriptors: nil) { _, samples, error in
                    if let error = error {
                        continuation.resume(throwing: error)
                    } else {
                        continuation.resume(returning: samples as? [HKCategorySample] ?? [])
                    }
                }
                healthStore.execute(query)
            }
            
            if let samples = sleepSamples {
                let asleepValues: Set<Int> = [
                    HKCategoryValueSleepAnalysis.asleepCore.rawValue,
                    HKCategoryValueSleepAnalysis.asleepDeep.rawValue,
                    HKCategoryValueSleepAnalysis.asleepREM.rawValue,
                    HKCategoryValueSleepAnalysis.asleepUnspecified.rawValue
                ]
                let totalSleepSeconds = samples
                    .filter { asleepValues.contains($0.value) }
                    .reduce(0.0) { $0 + $1.endDate.timeIntervalSince($1.startDate) }
                summary.sleepMinutes = Int(totalSleepSeconds / 60)
                
                // v3: ç¡çœ ã®é–‹å§‹/çµ‚äº†æ™‚åˆ»ã‚’æ¨å®š
                let asleepSamples = samples.filter { asleepValues.contains($0.value) }
                if !asleepSamples.isEmpty {
                    summary.sleepStartAt = asleepSamples.map { $0.startDate }.min()
                    summary.wakeAt = asleepSamples.map { $0.endDate }.max()
                }
            }
        }
        // ... ä»¥ä¸‹çœç•¥

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
    func fetchDailySummary() async -> DailySummary {
        var summary = DailySummary()
        
        let calendar = Calendar.current
        let now = Date()
        let startOfDay = calendar.startOfDay(for: now)
        let endOfDay = calendar.date(byAdding: .day, value: 1, to: startOfDay)!
        
        // â˜… ç¡çœ ã‚¯ã‚¨ãƒªç”¨: å‰æ—¥18:00ã‹ã‚‰å–å¾—ï¼ˆå¤œ22æ™‚ã«å¯ã¦æœ6æ™‚ã«èµ·ãã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•æ‰ï¼‰
        let sleepQueryStart = calendar.date(byAdding: .hour, value: -6, to: startOfDay)!
        
        // Fetch sleep
        if let sleepType = HKObjectType.categoryType(forIdentifier: .sleepAnalysis) {
            // â˜… .strictStartDate ã‚’å‰Šé™¤ã—ã€ç¯„å›²ã¨é‡ãªã‚‹ã™ã¹ã¦ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’å–å¾—
            let predicate = HKQuery.predicateForSamples(withStart: sleepQueryStart, end: endOfDay, options: [])
            let sleepSamples = try? await withCheckedThrowingContinuation { (continuation: CheckedContinuation<[HKCategorySample], Error>) in
                let query = HKSampleQuery(sampleType: sleepType, predicate: predicate, limit: HKObjectQueryNoLimit, sortDescriptors: nil) { _, samples, error in
                    if let error = error {
                        continuation.resume(throwing: error)
                    } else {
                        continuation.resume(returning: samples as? [HKCategorySample] ?? [])
                    }
                }
                healthStore.execute(query)
            }
            
            if let samples = sleepSamples {
                let asleepValues: Set<Int> = [
                    HKCategoryValueSleepAnalysis.asleepCore.rawValue,
                    HKCategoryValueSleepAnalysis.asleepDeep.rawValue,
                    HKCategoryValueSleepAnalysis.asleepREM.rawValue,
                    HKCategoryValueSleepAnalysis.asleepUnspecified.rawValue
                ]
                
                // â˜… ä»Šæ—¥ã®èµ·åºŠæ™‚åˆ»ï¼ˆ=ä»Šæ—¥ã®æ—¥ä»˜ã§çµ‚äº†ã—ãŸã‚µãƒ³ãƒ—ãƒ«ï¼‰ã®ã¿ã‚’å¯¾è±¡ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let todayAsleepSamples = samples.filter { sample in
                    asleepValues.contains(sample.value) && sample.endDate >= startOfDay
                }
                
                let totalSleepSeconds = todayAsleepSamples
                    .reduce(0.0) { $0 + $1.endDate.timeIntervalSince($1.startDate) }
                summary.sleepMinutes = Int(totalSleepSeconds / 60)
                
                // v3: ç¡çœ ã®é–‹å§‹/çµ‚äº†æ™‚åˆ»ã‚’æ¨å®š
                if !todayAsleepSamples.isEmpty {
                    // æœ€ã‚‚æ—©ã„é–‹å§‹æ™‚åˆ»ã‚’ sleepStartAtï¼ˆæ˜¨å¤œã®å°±å¯æ™‚åˆ»ï¼‰
                    summary.sleepStartAt = todayAsleepSamples.map { $0.startDate }.min()
                    // æœ€ã‚‚é…ã„çµ‚äº†æ™‚åˆ»ã‚’ wakeAtï¼ˆä»Šæœã®èµ·åºŠæ™‚åˆ»ï¼‰
                    summary.wakeAt = todayAsleepSamples.map { $0.endDate }.max()
                }
                
                logger.info("Sleep query: found \(samples.count) samples, \(todayAsleepSamples.count) for today, duration=\(summary.sleepMinutes ?? 0)min")
            }
        }
        // ... ä»¥ä¸‹ã¯å¤‰æ›´ãªã—
```

---

## å•é¡Œ7: ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ©ãƒ™ãƒ«ãŒæ—¥æœ¬èªã§ã‚‚è‹±èªè¡¨ç¤º

### åŸå› 

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® `stateBuilder.js` ãŒãƒ©ãƒ™ãƒ«ã‚’è‹±èªå›ºå®šã§ç”Ÿæˆã—ã¦ã„ã‚‹ã€‚

### ãƒ‘ãƒƒãƒ

#### ãƒ‘ãƒƒãƒ7-1: stateBuilder.js ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/modules/metrics/stateBuilder.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (8-43è¡Œç›®):
// ============================================
export function buildHighlights({ todayStats, timezone }) {
  const wakeAt = todayStats?.wakeAt ? new Date(todayStats.wakeAt) : null;
  const snsMinutesTotal = Number(todayStats?.snsMinutesTotal ?? 0);
  const steps = Number(todayStats?.steps ?? 0);
  
  const activity = todayStats?.activitySummary || {};
  const ruminationProxy = calculateRuminationProxy({
    lateNightSnsMinutes: Number(activity?.lateNightSnsMinutes ?? 0),
    snsMinutes: snsMinutesTotal,
    totalScreenTime: Number(activity?.totalScreenTime ?? snsMinutesTotal),
    sleepWindowPhoneMinutes: Number(activity?.sleepWindowPhoneMinutes ?? 0),
    longestNoUseHours: Number(activity?.longestNoUseHours ?? 0)
  });

  const wakeLabel = wakeAt ? `Wake ${toLocalTimeHHMM(wakeAt, timezone)}` : 'Wake';
  const wakeStatus = wakeAt ? 'on_track' : 'warning';

  const screenStatus = snsMinutesTotal >= 180 ? 'warning' : snsMinutesTotal >= 120 ? 'warning' : 'on_track';
  const screenLabel = snsMinutesTotal > 0 ? `SNS ${snsMinutesTotal}m` : 'SNS';

  const workoutStatus = steps >= 8000 ? 'on_track' : steps >= 3000 ? 'warning' : 'missed';
  const workoutLabel = steps > 0 ? `Steps ${steps}` : 'Workout';

  const ruminationStatus = ruminationProxy >= 0.7 ? 'warning' : ruminationProxy >= 0.4 ? 'ok' : 'ok';
  const ruminationLabel = `Rumination ${Math.round(ruminationProxy * 100)}%`;

  return {
    wake: { status: wakeStatus, label: wakeLabel },
    screen: { status: screenStatus, label: screenLabel },
    workout: { status: workoutStatus, label: workoutLabel },
    rumination: { status: ruminationStatus, label: ruminationLabel }
  };
}

// ============================================
// å¤‰æ›´å¾Œï¼ˆlanguage ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰:
// ============================================
export function buildHighlights({ todayStats, timezone, language = 'en' }) {
  const wakeAt = todayStats?.wakeAt ? new Date(todayStats.wakeAt) : null;
  const snsMinutesTotal = Number(todayStats?.snsMinutesTotal ?? 0);
  const steps = Number(todayStats?.steps ?? 0);
  
  const activity = todayStats?.activitySummary || {};
  const ruminationProxy = calculateRuminationProxy({
    lateNightSnsMinutes: Number(activity?.lateNightSnsMinutes ?? 0),
    snsMinutes: snsMinutesTotal,
    totalScreenTime: Number(activity?.totalScreenTime ?? snsMinutesTotal),
    sleepWindowPhoneMinutes: Number(activity?.sleepWindowPhoneMinutes ?? 0),
    longestNoUseHours: Number(activity?.longestNoUseHours ?? 0)
  });

  const isJa = language === 'ja';
  
  // â˜… ãƒ©ãƒ™ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º
  const wakeLabel = wakeAt 
    ? (isJa ? `èµ·åºŠ ${toLocalTimeHHMM(wakeAt, timezone)}` : `Wake ${toLocalTimeHHMM(wakeAt, timezone)}`)
    : (isJa ? 'èµ·åºŠ' : 'Wake');
  const wakeStatus = wakeAt ? 'on_track' : 'warning';

  const screenStatus = snsMinutesTotal >= 180 ? 'warning' : snsMinutesTotal >= 120 ? 'warning' : 'on_track';
  const screenLabel = snsMinutesTotal > 0 
    ? (isJa ? `SNS ${snsMinutesTotal}åˆ†` : `SNS ${snsMinutesTotal}m`) 
    : 'SNS';

  const workoutStatus = steps >= 8000 ? 'on_track' : steps >= 3000 ? 'warning' : 'missed';
  const workoutLabel = steps > 0 
    ? (isJa ? `æ­©æ•° ${steps.toLocaleString()}` : `Steps ${steps.toLocaleString()}`) 
    : (isJa ? 'é‹å‹•' : 'Workout');

  const ruminationStatus = ruminationProxy >= 0.7 ? 'warning' : ruminationProxy >= 0.4 ? 'ok' : 'ok';
  const ruminationLabel = isJa 
    ? `åèŠ» ${Math.round(ruminationProxy * 100)}%`
    : `Rumination ${Math.round(ruminationProxy * 100)}%`;

  return {
    wake: { status: wakeStatus, label: wakeLabel },
    screen: { status: screenStatus, label: screenLabel },
    workout: { status: workoutStatus, label: workoutLabel },
    rumination: { status: ruminationStatus, label: ruminationLabel }
  };
}
```

#### ãƒ‘ãƒƒãƒ7-2: realtime.js ã®ä¿®æ­£

**ãƒ•ã‚¡ã‚¤ãƒ«**: `apps/api/src/routes/mobile/realtime.js`

```javascript
// ============================================
// å¤‰æ›´å‰ (è©²å½“ç®‡æ‰€):
// ============================================
const highlights = buildHighlights({ todayStats: today, timezone: tz });

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
const highlights = buildHighlights({ todayStats: today, timezone: tz, language: lang });
```

---

## å•é¡Œ8: ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡è¨€ã‚’å‰Šé™¤ã—å€¤ã®ã¿è¡¨ç¤º

### åŸå› 

ã€Œè¦æ³¨æ„ã€ã€Œå‰é€²ä¸­ã€ã€Œå®‰å®šã€ãªã©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã€å†—é•·ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Views/Behavior/HighlightsCard.swift`

```swift
// ============================================
// å¤‰æ›´å‰ (29-72è¡Œç›®):
// ============================================
private func highlightMiniCard(title: String, apiStatus: String, valueLabel: String, streak: Int) -> some View {
    let ui = mapToUI(apiStatus)

    return ZStack(alignment: .topTrailing) {
        CardView(cornerRadius: 24) {
            VStack(alignment: .leading, spacing: 10) {
                HStack(spacing: 8) {
                    Text(ui.icon)
                        .font(.system(size: 20, weight: .bold))
                        .foregroundStyle(ui.iconColor)
                    Text(title)
                        .font(.system(size: 14, weight: .bold))
                        .foregroundStyle(AppTheme.Colors.label)
                    Spacer()
                }

                VStack(alignment: .leading, spacing: 4) {
                    Text(ui.label)
                        .font(.system(size: 12))
                        .foregroundStyle(AppTheme.Colors.secondaryLabel)
                    
                    if !valueLabel.isEmpty {
                        Text(valueLabel)
                            .font(.system(size: 11))
                            .foregroundStyle(AppTheme.Colors.tertiaryLabel)
                    }
                }
            }
        }

        HStack(spacing: 6) {
            Text("ğŸŒ±").font(.system(size: 12))
            Text("\(streak)")
                .font(.system(size: 12, weight: .medium))
                .foregroundStyle(Color(red: 0.42, green: 0.56, blue: 0.44))
        }
        .padding(.horizontal, 10)
        .padding(.vertical, 6)
        .background(AppTheme.Colors.buttonUnselected.opacity(0.6))
        .clipShape(Capsule())
        .padding(10)
    }
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
private func highlightMiniCard(title: String, apiStatus: String, valueLabel: String, streak: Int) -> some View {
    let ui = mapToUI(apiStatus)

    return ZStack(alignment: .topTrailing) {
        CardView(cornerRadius: 24) {
            VStack(alignment: .leading, spacing: 10) {
                HStack(spacing: 8) {
                    Text(ui.icon)
                        .font(.system(size: 20, weight: .bold))
                        .foregroundStyle(ui.iconColor)
                    Text(title)
                        .font(.system(size: 14, weight: .bold))
                        .foregroundStyle(AppTheme.Colors.label)
                    Spacer()
                }

                // â˜… å¤‰æ›´: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã€å€¤ã‚’åŒã˜ã‚µã‚¤ã‚ºã§è¡¨ç¤º
                Text(valueLabel.isEmpty ? "-" : valueLabel)
                    .font(.system(size: 12))
                    .foregroundStyle(AppTheme.Colors.secondaryLabel)
            }
        }

        HStack(spacing: 6) {
            Text("ğŸŒ±").font(.system(size: 12))
            Text("\(streak)")
                .font(.system(size: 12, weight: .medium))
                .foregroundStyle(Color(red: 0.42, green: 0.56, blue: 0.44))
        }
        .padding(.horizontal, 10)
        .padding(.vertical, 6)
        .background(AppTheme.Colors.buttonUnselected.opacity(0.6))
        .clipShape(Capsule())
        .padding(10)
    }
}
```

---

## å•é¡Œ9: Ideal Traits/Problems ãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã§è‹±èªã®ã¾ã¾

### åŸå› 

`WakePromptBuilder.swift` ã§ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒè‹±èªå›ºå®šã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/WakePromptBuilder.swift`

```swift
// ============================================
// å¤‰æ›´å‰ (153-167è¡Œç›®):
// ============================================
// ç†æƒ³ã®å§¿ï¼ˆå…¨ç¿’æ…£ã§ä½¿ç”¨ï¼‰
if !profile.idealTraits.isEmpty {
    let localizedTraits = profile.idealTraits.map { NSLocalizedString("ideal_trait_\($0)", comment: "") }
    replacements["IDEAL_TRAITS"] = "ç†æƒ³ã®å§¿ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ç‰¹æ€§: " + localizedTraits.joined(separator: "ã€")
} else {
    replacements["IDEAL_TRAITS"] = ""
}

if !profile.problems.isEmpty {
    let localizedProblems = profile.problems.map { NSLocalizedString("problem_\($0)", comment: "") }
    replacements["PROBLEMS"] = "ä»ŠæŠ±ãˆã¦ã„ã‚‹å•é¡Œ: " + localizedProblems.joined(separator: "ã€")
} else {
    replacements["PROBLEMS"] = ""
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
// ç†æƒ³ã®å§¿ï¼ˆå…¨ç¿’æ…£ã§ä½¿ç”¨ï¼‰- è¨€èªè¨­å®šã«å¿œã˜ã¦ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º
if !profile.idealTraits.isEmpty {
    let localizedTraits = profile.idealTraits.map { NSLocalizedString("ideal_trait_\($0)", comment: "") }
    let prefix = profile.preferredLanguage == .ja
        ? "ç†æƒ³ã®å§¿ã¨ã—ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ç‰¹æ€§: "
        : "Ideal self traits: "
    let separator = profile.preferredLanguage == .ja ? "ã€" : ", "
    replacements["IDEAL_TRAITS"] = prefix + localizedTraits.joined(separator: separator)
} else {
    replacements["IDEAL_TRAITS"] = ""
}

if !profile.problems.isEmpty {
    let localizedProblems = profile.problems.map { NSLocalizedString("problem_\($0)", comment: "") }
    let prefix = profile.preferredLanguage == .ja
        ? "ä»ŠæŠ±ãˆã¦ã„ã‚‹å•é¡Œ: "
        : "Current struggles: "
    let separator = profile.preferredLanguage == .ja ? "ã€" : ", "
    replacements["PROBLEMS"] = prefix + localizedProblems.joined(separator: separator)
} else {
    replacements["PROBLEMS"] = ""
}
```

---

## å•é¡Œ10: LANGUAGE LOCK ãŒå¸¸ã« English ã«ãªã‚‹

### åŸå› 

`LanguagePreference.languageLine` ãŒ `NSLocalizedString` ã‚’ä½¿ç”¨ã—ã€ã‚¢ãƒ—ãƒªã®ãƒãƒ³ãƒ‰ãƒ«è¨€èªã«ä¾å­˜ã—ã¦ã„ã‚‹ã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Models/UserProfile.swift`

```swift
// ============================================
// å¤‰æ›´å‰ (3-22è¡Œç›®):
// ============================================
enum LanguagePreference: String, Codable {
    case ja
    case en
    
    var languageLine: String {
        switch self {
        case .ja:
            return NSLocalizedString("language_preference_ja", comment: "")
        case .en:
            return NSLocalizedString("language_preference_en", comment: "")
        }
    }
    
    static func detectDefault(locale: Locale = .current) -> Self {
        let preferred = Locale.preferredLanguages.first ?? locale.identifier
        if preferred.hasPrefix("ja") || locale.identifier.hasPrefix("ja") {
            return .ja
        }
        return .en
    }
}

// ============================================
// å¤‰æ›´å¾Œ:
// ============================================
enum LanguagePreference: String, Codable {
    case ja
    case en
    
    /// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…ã®LANGUAGE LOCKç”¨ï¼ˆãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ç¢ºå®Ÿã«æ­£ã—ã„è¨€èªåã‚’è¿”ã™ï¼‰
    var languageLine: String {
        switch self {
        case .ja:
            return "æ—¥æœ¬èª"
        case .en:
            return "English"
        }
    }
    
    /// UIè¡¨ç¤ºç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºã•ã‚ŒãŸè¨€èªå
    var displayName: String {
        switch self {
        case .ja:
            return NSLocalizedString("language_preference_ja", comment: "")
        case .en:
            return NSLocalizedString("language_preference_en", comment: "")
        }
    }
    
    static func detectDefault(locale: Locale = .current) -> Self {
        let preferred = Locale.preferredLanguages.first ?? locale.identifier
        if preferred.hasPrefix("ja") || locale.identifier.hasPrefix("ja") {
            return .ja
        }
        return .en
    }
}
```

---

## å•é¡Œ11: Feeling ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ©ãƒ™ãƒ«ãŒè‹±èªã®ã¿

### åŸå› 

`[Feeling: irritation]` ãªã©ã®ãƒ©ãƒ™ãƒ«éƒ¨åˆ†ãŒè‹±èªå›ºå®šã€‚

### ãƒ‘ãƒƒãƒ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/VoiceSessionController.swift`

è¨€èªã«å¿œã˜ã¦ `[Feeling: xxx]` ã‚’å‹•çš„ã«ç½®æ›ã™ã‚‹ã€‚`_ja.txt` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸è¦ã€‚

```swift
private enum RealtimePromptBuilder {
    static func buildFeelingInstructions(topic: FeelingTopic, profile: UserProfile) -> String {
        let openerName: String = {
            switch topic {
            case .selfLoathing: return "feeling_self_loathing"
            case .anxiety: return "feeling_anxiety"
            case .irritation: return "feeling_irritation"
            case .freeConversation: return "feeling_free_conversation"
            }
        }()
        
        // â˜… è¨€èªåˆ¥ã®Feelingãƒ©ãƒ™ãƒ«
        let localizedFeelingLabel: String = {
            let isJa = profile.preferredLanguage == .ja
            switch topic {
            case .selfLoathing: return isJa ? "è‡ªå·±å«Œæ‚ª" : "self_loathing"
            case .anxiety: return isJa ? "ä¸å®‰" : "anxiety"
            case .irritation: return isJa ? "æ€’ã‚Š" : "irritation"
            case .freeConversation: return isJa ? "è‡ªç”±ãªå¯¾è©±" : "free_conversation"
            }
        }()
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆ1ã¤ã ã‘ï¼‰
        var opener = (load(name: openerName, ext: "txt") ?? "").trimmingCharacters(in: .whitespacesAndNewlines)
        
        // â˜… [Feeling: xxx] ã‚’å‹•çš„ã«ç½®æ›
        let englishLabel: String = {
            switch topic {
            case .selfLoathing: return "self_loathing"
            case .anxiety: return "anxiety"
            case .irritation: return "irritation"
            case .freeConversation: return "free_conversation"
            }
        }()
        opener = opener.replacingOccurrences(
            of: "[Feeling: \(englishLabel)]",
            with: "[Feeling: \(localizedFeelingLabel)]"
        )
        
        let commonTemplate = (load(name: "common", ext: "txt") ?? "").trimmingCharacters(in: .whitespacesAndNewlines)
        let talkTemplate = (load(name: "talk_session", ext: "txt") ?? "").trimmingCharacters(in: .whitespacesAndNewlines)
        
        let mergedTemplate = "\(commonTemplate)\n\n\(talkTemplate)\n\n\(opener)"
        
        let rendered = renderTemplate(mergedTemplate, profile: profile)
        return rendered
    }
}
```

### å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

- `feeling_self_loathing_ja.txt`
- `feeling_anxiety_ja.txt`
- `feeling_irritation_ja.txt`
- `feeling_free_conversation_ja.txt`

---

## å•é¡Œ12: ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒä¸è¶³

### åŸå› 

ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚„ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãŒè¡¨ç¤ºã•ã‚Œãªã„åŸå› ã®ç‰¹å®šãŒå›°é›£ã€‚

### ãƒ‘ãƒƒãƒ

#### ãƒ‘ãƒƒãƒ12-1: BehaviorView.swift ã«ãƒ­ã‚°è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Views/Behavior/BehaviorView.swift`

```swift
// ============================================
// load() é–¢æ•°ã«è¿½åŠ  (102-125è¡Œç›®):
// ============================================
private func load() async {
    guard !isLoading else { return }
    isLoading = true
    errorText = nil
    
    // â˜… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
    logger.info("BehaviorView: Starting data load")
    logger.info("BehaviorView: screenTimeEnabled=\(appState.sensorAccess.screenTimeEnabled), sleepEnabled=\(appState.sensorAccess.sleepEnabled), stepsEnabled=\(appState.sensorAccess.stepsEnabled)")
    
    // v3.1: Screen Time ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã« DeviceActivityReport ã‚’è¡¨ç¤º
    if appState.sensorAccess.screenTimeEnabled {
        showScreenTimeReport = true
        logger.info("BehaviorView: Waiting for DeviceActivityReport...")
        try? await Task.sleep(nanoseconds: 1_000_000_000) // 1ç§’ã«å»¶é•·
        showScreenTimeReport = false
    }
    
    // v3.1: æœ€æ–°ã® HealthKit ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸é€ä¿¡
    logger.info("BehaviorView: Running MetricsUploader...")
    await MetricsUploader.shared.runUploadIfDue(force: true)
    
    do {
        logger.info("BehaviorView: Fetching summary from backend...")
        let data = try await BehaviorSummaryService.shared.fetchSummary()
        
        // â˜… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
        logger.info("BehaviorView: Summary received - timeline segments: \(data.timeline.count)")
        logger.info("BehaviorView: Highlights - wake: \(data.highlights.wake.label), screen: \(data.highlights.screen.label), workout: \(data.highlights.workout.label), rumination: \(data.highlights.rumination.label)")
        
        summary = data
    } catch {
        logger.error("BehaviorView: Failed to load summary - \(error.localizedDescription)")
        errorText = String(localized: "behavior_error_failed_load")
    }
    isLoading = false
}
```

#### ãƒ‘ãƒƒãƒ12-2: MetricsUploader.swift ã«ãƒ­ã‚°è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `aniccaios/aniccaios/Services/MetricsUploader.swift`

```swift
// ============================================
// runUploadIfDue é–¢æ•°ã®é€ä¿¡å‰ã«è¿½åŠ :
// ============================================

// â˜… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ 
logger.info("MetricsUploader: Payload keys: \(payload.keys.joined(separator: ", "))")
if let sleepStart = payload["sleep_start_at"] {
    logger.info("MetricsUploader: sleep_start_at = \(sleepStart)")
}
if let wakeAt = payload["wake_at"] {
    logger.info("MetricsUploader: wake_at = \(wakeAt)")
}
if let activitySummary = payload["activity_summary"] as? [String: Any] {
    logger.info("MetricsUploader: activity_summary keys: \(activitySummary.keys.joined(separator: ", "))")
    if let snsSessions = activitySummary["snsSessions"] as? [[String: Any]] {
        logger.info("MetricsUploader: snsSessions count: \(snsSessions.count)")
    }
}
```

---

## ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|---------|---------|
| `apps/api/src/modules/simulation/futureScenario.js` | OpenAI API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿®æ­£ã€fallback ã® ifImprove ã‚’ç©ºã« |
| `apps/api/src/modules/realtime/contextSnapshot.js` | sleepStartAt ã‚’ today_stats ã«è¿½åŠ  |
| `apps/api/src/modules/insights/generateTodayInsight.js` | **æ–°è¦ä½œæˆ**: AI Insight ç”Ÿæˆé–¢æ•° |
| `apps/api/src/modules/metrics/stateBuilder.js` | language ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ã€pickTodayInsight ã®æˆ»ã‚Šå€¤å¤‰æ›´ã€getInsightFallback è¿½åŠ  |
| `apps/api/src/routes/mobile/behavior.js` | language å¼•æ•°è¿½åŠ ã€AI Insight å‘¼ã³å‡ºã— |
| `apps/api/src/routes/mobile/realtime.js` | language å¼•æ•°è¿½åŠ  |
| `aniccaios/.../FutureScenarioView.swift` | ã‚«ãƒ¼ãƒ‰æ¨ªå¹…ãƒ»ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºä¿®æ­£ |
| `aniccaios/.../HighlightsCard.swift` | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡è¨€å‰Šé™¤ã€å€¤è¡¨ç¤º |
| `aniccaios/.../HealthKitManager.swift` | ç¡çœ ã‚¯ã‚¨ãƒªæ—¥ä»˜ç¯„å›²ä¿®æ­£ |
| `aniccaios/.../WakePromptBuilder.swift` | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º |
| `aniccaios/.../UserProfile.swift` | languageLine ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã€displayName è¿½åŠ  |
| `aniccaios/.../VoiceSessionController.swift` | è¨€èªåˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿ã€IDEAL_TRAITS ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º |
| `aniccaios/.../BehaviorView.swift` | ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ã€å¾…æ©Ÿæ™‚é–“1ç§’ã«å»¶é•· |
| `aniccaios/.../MetricsUploader.swift` | ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ  |
| `aniccaios/.../Resources/Prompts/feeling_self_loathing_ja.txt` | **æ–°è¦ä½œæˆ** |
| `aniccaios/.../Resources/Prompts/feeling_anxiety_ja.txt` | **æ–°è¦ä½œæˆ** |
| `aniccaios/.../Resources/Prompts/feeling_irritation_ja.txt` | **æ–°è¦ä½œæˆ** |
| `aniccaios/.../Resources/Prompts/feeling_free_conversation_ja.txt` | **æ–°è¦ä½œæˆ** |

---

## é©ç”¨æ‰‹é †

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆapps/apiï¼‰

1. `apps/api/src/modules/insights/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
   ```bash
   mkdir -p apps/api/src/modules/insights
   ```

2. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« `generateTodayInsight.js` ã‚’ä½œæˆ

3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒƒãƒã‚’é©ç”¨

4. ãƒ‡ãƒ—ãƒ­ã‚¤

### 2. iOSï¼ˆaniccaiosï¼‰

1. å„Swiftãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒƒãƒã‚’é©ç”¨

2. æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ4ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ `Resources/Prompts/` ã«ä½œæˆ

3. Xcodeã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«è¿½åŠ 

4. ãƒ“ãƒ«ãƒ‰ãƒ»å®Ÿè¡Œ

---

## ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†åŸºæº–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `futureScenario.js` ã® fetch URL ãŒ `https://api.openai.com/v1/chat/completions` ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
- [ ] `futureScenario.js` ã® `fallback()` é–¢æ•°ã§ `ifImprove: ''` ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
- [ ] `FutureScenarioView.swift` ã® isEmpty ã‚±ãƒ¼ã‚¹ã§ `frame(maxWidth: .infinity)` ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹
- [ ] `generateTodayInsight.js` ãŒæ–°è¦ä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `behavior.js` ã§ `generateTodayInsight()` ã‚’å‘¼ã³å‡ºã™ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹
- [ ] `contextSnapshot.js` ã® `today_stats` ã« `sleepStartAt` ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] `HealthKitManager.swift` ã®ã‚¯ã‚¨ãƒªé–‹å§‹æ™‚åˆ»ãŒå‰æ—¥18æ™‚ã«ãªã£ã¦ã„ã‚‹
- [ ] `HealthKitManager.swift` ã® options ãŒ `[]` ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹
- [ ] `stateBuilder.js` ã® `buildHighlights()` ã« `language` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹
- [ ] `behavior.js` ã¨ `realtime.js` ã§ `language: lang` ãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹
- [ ] `HighlightsCard.swift` ã§ `ui.label` ã®è¡¨ç¤ºãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] `WakePromptBuilder.swift` ã§ `preferredLanguage` ã‚’å‚ç…§ã—ã¦ã„ã‚‹
- [ ] `UserProfile.swift` ã§ `languageLine` ãŒ `NSLocalizedString` ã‚’ä½¿ã‚ãšãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹
- [ ] `VoiceSessionController.swift` ã§ `langSuffix` ã‚’ä½¿ã£ã¦è¨€èªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹
- [ ] æ—¥æœ¬èªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ4ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] `BehaviorView.swift` ã¨ `MetricsUploader.swift` ã«ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹

---

**æœ€çµ‚æ›´æ–°**: 2025-12-26
