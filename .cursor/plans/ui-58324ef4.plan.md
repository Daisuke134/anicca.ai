<!-- 58324ef4-dd82-4713-8f5d-1e47ef079f23 3dc7a2b3-ff35-4ed7-8915-20c68c2ef775 -->
# Anicca iOS UI Refresh — 細部レビューと修正パッチ案

## 要旨

- 既存 `DesignSystem/AppTheme.swift` と衝突する新規トークン追加（Colors/Spacing/Typography/Theme）は不要。既存トークンへ整合させる。
- 参照名の不一致（AppTheme.colors, AppTheme.type など）でビルドエラーになる箇所を全修正。
- 背景は既存 `AppBackground` を採用。List背景は `Appearance.configure()` でOS全体を統一。
- `.scrollContentBackground(.hidden)` はiOS16+限定APIのため、不要 or ガード付きに調整。
- 既存 `DayOfWeekPicker` と重複する `DayCircleButtonStyle` は追加しない。

## 主な問題点（現状パッチのままだと）

- AppThemeの参照ミス: `AppTheme.colors`/`AppTheme.type` → 本来は `AppTheme.Colors`/（フォントは既存Dynamic Type推奨）
- DesignSystemの重複定義: ColorTokens/Spacing/Typography/Theme の新規追加は既存と競合・混乱の原因。
- iOS16 APIの無条件適用: `.scrollContentBackground(.hidden)` はデプロイターゲット次第でビルド不可に。
- 既存 `DayOfWeekPicker` と重複する新規スタイルの追加。

## 採用方針（最小衝突・最大一貫）

- 新規追加は最小限: `DesignSystem/Appearance.swift` と `DesignSystem/Components/PrimaryButtonStyle.swift` のみ追加。
- 既存トークンに準拠: 色は `AppTheme.Colors.*`、背景は `AppBackground()`、フォントはDynamic Type中心。
- 画面ごとに背景/余白/見出し/CTAの階層を統一。

## 修正パッチ（an-434648-2731dfe5.plan.md への置換指示）

### 1) 追加ファイルセクションの差し替え

Before（該当ブロック全削除）:

- Color+Hex.swift / ColorTokens.swift / Spacing.swift / Typography.swift / Theme.swift / SecondaryButtonStyle.swift / DayCircleButtonStyle.swift / CardBackground.swift

After（必要最小限の追加）:

```swift
// *** Begin Patch
// *** Add File: aniccaios/aniccaios/DesignSystem/Appearance.swift
import SwiftUI

enum Appearance {
    static func configure() {
        let bg = UIColor(AppTheme.Colors.background)

        // UINavigationBar
        let nav = UINavigationBarAppearance()
        nav.configureWithOpaqueBackground()
        nav.backgroundColor = bg
        nav.shadowColor = .clear
        UINavigationBar.appearance().standardAppearance = nav
        UINavigationBar.appearance().scrollEdgeAppearance = nav

        // UIToolbar
        let tb = UIToolbarAppearance()
        tb.configureWithOpaqueBackground()
        tb.backgroundColor = bg
        UIToolbar.appearance().standardAppearance = tb
        if #available(iOS 15.0, *) {
            UIToolbar.appearance().scrollEdgeAppearance = tb
        }

        // UITableView / UICollectionView 背景
        UITableView.appearance().backgroundColor = bg
        UICollectionView.appearance().backgroundColor = bg
    }
}
// *** End Patch
```
```swift
// *** Begin Patch
// *** Add File: aniccaios/aniccaios/DesignSystem/Components/PrimaryButtonStyle.swift
import SwiftUI

struct PrimaryButtonStyle: ButtonStyle {
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .font(.headline)
            .foregroundColor(.white)
            .frame(maxWidth: .infinity, minHeight: 56)
            .background(
                RoundedRectangle(cornerRadius: 28, style: .continuous)
                    .fill(Color.black.opacity(configuration.isPressed ? 0.9 : 1.0))
            )
            .overlay(
                RoundedRectangle(cornerRadius: 28, style: .continuous)
                    .stroke(AppTheme.Colors.border, lineWidth: 1)
            )
            .animation(.easeOut(duration: 0.12), value: configuration.isPressed)
    }
}
// *** End Patch
```

### 2) App起動時適用（参照名の統一と背景の統一）

Before（抜粋）:

```swift
// aniccaiosApp.swift の擬似パッチ
init() {
    Appearance.configure()
}
...
.tint(AppTheme.colors.accent)
.background(AppTheme.colors.appBackground)
```

After:

```swift
// aniccaiosApp.swift の修正案
init() {
    Appearance.configure()
}
...
.tint(AppTheme.Colors.accent)
.background(AppBackground())
```

### 3) ルートコンテナ背景（ContentView）

Before:

```swift
.background(AppTheme.colors.appBackground.ignoresSafeArea())
```

After:

```swift
.background(AppBackground())
```

### 4) SessionView（見出し/通知カード/CTA/背景）

Before（抜粋）:

```swift
VStack(spacing: AppTheme.spacing.lg) {
    Text("Anicca")
        .font(AppTheme.type.titleXL)
        .foregroundStyle(AppTheme.colors.textPrimary)
    ...
    .background(
        RoundedRectangle(cornerRadius: 16)
            .fill(AppTheme.colors.surface)
            .overlay(
                RoundedRectangle(cornerRadius: 16)
                    .stroke(AppTheme.colors.border, lineWidth: 1)
            )
    )
    ...
    sessionButton
        .buttonStyle(PrimaryButtonStyle())
}
.padding(AppTheme.spacing.lg)
.background(AppTheme.colors.appBackground.ignoresSafeArea())
```

After:

```swift
VStack(spacing: AppTheme.Spacing.xl) {
    Text("Anicca")
        .font(.system(size: 32, weight: .bold))
        .foregroundStyle(AppTheme.Colors.label)

    if shouldShowWakeSilentNotice {
        Text(String(localized: "session_wake_silent_notice"))
            .multilineTextAlignment(.center)
            .font(.subheadline)
            .foregroundStyle(AppTheme.Colors.secondaryLabel)
            .padding(16)
            .frame(maxWidth: .infinity)
            .background(
                RoundedRectangle(cornerRadius: 16, style: .continuous)
                    .fill(AppTheme.Colors.adaptiveCardBackground)
                    .overlay(
                        RoundedRectangle(cornerRadius: 16, style: .continuous)
                            .stroke(AppTheme.Colors.border, lineWidth: 1)
                    )
            )
    }

    Spacer(minLength: 24)
    sessionButton.buttonStyle(PrimaryButtonStyle())
}
.padding(AppTheme.Spacing.xl)
.background(AppBackground())
```

### 5) Onboarding系（背景/フォント/CTA統一）

- すべてのステップビュー末尾に `.background(AppBackground())` を追加。
- 見出しは `.font(.system(size: 32, weight: .bold))`（または `.title`）/ 説明は `.subheadline` + `secondary` を統一。

例: WelcomeStepView

Before:

```swift
VStack(spacing: 32) { ... }
.padding(24)
```

After:

```swift
VStack(spacing: AppTheme.Spacing.xl) { ... }
.padding(AppTheme.Spacing.xl)
.background(AppBackground())
```

例: AuthenticationStepView 見出し/説明

Before:

```swift
Text("onboarding_account_title").font(.title)
Text("onboarding_account_description").font(.subheadline).foregroundStyle(.secondary)
```

After:

```swift
Text("onboarding_account_title").font(.title).foregroundStyle(AppTheme.Colors.label)
Text("onboarding_account_description").font(.subheadline).foregroundStyle(AppTheme.Colors.secondaryLabel)
```

### 6) Settings / ManageSubscription / Paywall

- List背景は `Appearance.configure()` によりOSレベルで背景統一。`.scrollContentBackground(.hidden)` は省略可。
- 画面ルートに `.background(AppBackground())` を付与。
- `tint` は `AppTheme.Colors.accent` を使用。

例: SettingsView

Before:

```swift
.onAppear { ... }
.safeAreaInset(edge: .bottom) { LegalLinksView() }
```

After（末尾に追加）:

```swift
.background(AppBackground())
```

例: ManageSubscriptionSheet

Before:

```swift
.navigationTitle(...)
```

After（末尾に追加）:

```swift
.tint(AppTheme.Colors.accent)
.background(AppBackground())
```

例: SubscriptionRequiredView / PaywallContainerView

Before:

```swift
.ignoresSafeArea()
```

After:

```swift
.ignoresSafeArea()
.background(AppBackground())
// さらにPaywallContainerViewのGroup末尾に:
.tint(AppTheme.Colors.accent)
.background(AppBackground())
```

### 7) 削除・保留

- `PricingDisclosureBanner` は現状未使用のため変更不要（コメントのみでOK）。
- `DayOfWeekPicker` が存在するため `DayCircleButtonStyle` は追加しない。

## 検証観点

- 主要画面（Session/Onboarding/Settings/Paywall）の背景色・階層・タップ領域がFigma準拠。
- RevenueCat UIの表示/遷移が `.tint` 変更で破綻しないこと。
- iOS 15でもList背景がアプリ基調色になること（AppearanceによるUITableView背景統一）。

## 適用手順（高レベル）

1) an-434648-2731dfe5.plan.md を上記の置換に更新

2) `Appearance.swift` と `PrimaryButtonStyle.swift` を追加

3) 各画面の修正を適用

4) ビルド&動作確認

### To-dos

- [ ] Color/Spacing/Typography/Themeの新規追加を計画から削除
- [ ] DesignSystem/Appearance.swift を追加し背景/Bar/Listを統一
- [ ] DesignSystem/Components/PrimaryButtonStyle.swift を追加
- [ ] aniccaiosAppにAppearance.configure/tint/backgroundを適用
- [ ] ContentView/Onboarding/Settings等へAppBackgroundを適用
- [ ] SessionViewの見出し/告知カード/CTAを新テーマで統一
- [ ] Manage/Paywall系にtintと背景を適用、一貫性を担保