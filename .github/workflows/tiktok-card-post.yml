name: TikTok Card Daily Post

on:
  schedule:
    # JA朝: 09:00 JST = 00:00 UTC
    - cron: '0 0 * * *'
    # JA夜: 19:00 JST = 10:00 UTC
    - cron: '0 10 * * *'
    # EN朝: 23:00 JST = 14:00 UTC固定（US 9AM EST / 10AM EDT）
    - cron: '0 14 * * *'
    # EN夜: 10:00 JST = 01:00 UTC固定（US 8PM EST / 9PM EDT）
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      language:
        description: 'Language (en or ja)'
        required: true
        type: choice
        options:
          - en
          - ja

permissions:
  contents: write

concurrency:
  group: tiktok-post
  cancel-in-progress: false

jobs:
  post:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: dev
          fetch-depth: 0
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: cd scripts/tiktok-poster && npm ci
      - name: Build and test
        run: cd scripts/tiktok-poster && npm run build && npm test
      - name: Mask secrets
        run: echo "::add-mask::${{ secrets.BLOTATO_API_KEY }}"
      - name: Resolve language
        id: lang
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ github.event.inputs.language }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event.schedule }}" = "0 0 * * *" ] || \
               [ "${{ github.event.schedule }}" = "0 10 * * *" ]; then
            echo "value=ja" >> "$GITHUB_OUTPUT"
          else
            echo "value=en" >> "$GITHUB_OUTPUT"
          fi
      - name: Verify card images (189 expected per language)
        run: |
          LANG="${{ steps.lang.outputs.value }}"
          IMG_DIR="assets/card-screenshots/${LANG}"
          EXPECTED=189
          COUNT=$(find "${IMG_DIR}" -name '*.png' -maxdepth 1 2>/dev/null | wc -l | tr -d ' ')
          echo "::group::Card image verification"
          echo "Language: ${LANG}"
          echo "Directory: ${IMG_DIR}"
          echo "Expected: ${EXPECTED}"
          echo "Found: ${COUNT}"
          echo "::endgroup::"
          if [ "${COUNT}" -eq 0 ]; then
            echo "ERROR: No card images found in ${IMG_DIR}/. Run CardScreenshotGenerator first:"
            echo "  cd aniccaios && swift run CardScreenshotGenerator --language ${LANG} --output ../assets/card-screenshots/${LANG}"
            exit 1
          fi
          if [ "${COUNT}" -lt "${EXPECTED}" ]; then
            echo "WARNING: Expected ${EXPECTED} images but found ${COUNT}. Some cards may be missing."
          fi
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: "Stage 1: Reserve in_flight"
        run: cd scripts/tiktok-poster && npm run reserve -- --language ${{ steps.lang.outputs.value }}
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          BLOTATO_API_KEY: ${{ secrets.BLOTATO_API_KEY }}
      - name: "Stage 1: Push reservation"
        run: |
          set -e
          git add assets/card-screenshots/posted_tracker.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: reserve in_flight for TikTok post"
          MAX_RETRIES=3; PUSHED=false
          for i in $(seq 1 $MAX_RETRIES); do
            git pull --rebase origin dev
            if git push; then PUSHED=true; break; fi
            echo "Push conflict, retry $i/$MAX_RETRIES"; sleep 5
          done
          if [ "$PUSHED" = false ]; then echo "ERROR: reservation push failed"; exit 1; fi
      - name: "Stage 2: Post to TikTok via Blotato"
        id: post
        run: cd scripts/tiktok-poster && npm run post -- --language ${{ steps.lang.outputs.value }}
        env:
          BLOTATO_API_KEY: ${{ secrets.BLOTATO_API_KEY }}
          BLOTATO_ACCOUNT_ID_EN: ${{ vars.BLOTATO_ACCOUNT_ID_EN }}
          BLOTATO_ACCOUNT_ID_JA: ${{ vars.BLOTATO_ACCOUNT_ID_JA }}
      - name: "Stage 2: Push tracker update (success or rollback)"
        if: always() && steps.lang.outputs.value != ''
        run: |
          set -e
          git add assets/card-screenshots/posted_tracker.json
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update TikTok post tracker"
          MAX_RETRIES=3; PUSHED=false
          for i in $(seq 1 $MAX_RETRIES); do
            git pull --rebase origin dev
            if git push; then PUSHED=true; break; fi
            echo "Push conflict, retry $i/$MAX_RETRIES"; sleep 5
          done
          if [ "$PUSHED" = false ]; then echo "ERROR: tracker push failed"; exit 1; fi
