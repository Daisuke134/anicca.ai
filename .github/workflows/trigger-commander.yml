name: Trigger Commander Agent
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
concurrency:
  group: trigger-commander
  cancel-in-progress: false
jobs:
  trigger:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Trigger generateNudges via admin endpoint
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            BASE_URL="https://anicca-proxy-staging.up.railway.app"
          else
            BASE_URL="${API_BASE_URL}"
          fi
          echo "=== Triggering generateNudges on ${{ inputs.environment }} ==="
          echo "URL: ${BASE_URL}/api/admin/trigger-nudges"
          STATUS=$(curl -s -o response.json -w "%{http_code}" \
            -X POST "${BASE_URL}/api/admin/trigger-nudges" \
            -H "Authorization: Bearer $API_AUTH_TOKEN" \
            -H "Content-Type: application/json")
          echo "HTTP Status: $STATUS"
          cat response.json
          if [ "$STATUS" -ge 400 ]; then
            echo "::error::Trigger failed with status $STATUS"
            exit 1
          fi
          echo "âœ… generateNudges triggered. Check Railway logs for results."
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_AUTH_TOKEN: ${{ secrets.API_AUTH_TOKEN }}
