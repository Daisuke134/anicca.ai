// Anicca v0.3 Prisma schema (Node ESM .js runtime)
// - v0.3 „ÅØ Node ESM „ÅÆ .js „ÇíÁ∂≠ÊåÅ„Åó„ÄÅTypeScriptÂ∞éÂÖ•„ÅØ v0.4 ‰ª•Èôç
// - Êó¢Â≠òDBÔºàsnake_caseÔºâ„Å´Âêà„Çè„Åõ„Å¶ @map/@@map „Çí‰ªò„Åë„Çã
// - v0.3 „Åß„ÅØ Prisma Migrate ‰∏ªÂ∞é„ÅßÊó¢Â≠òDB„ÇíÁÆ°ÁêÜ„Åó„Å™„ÅÑÔºà„Éà„É™„Ç¨„Éº/Âºè„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ

// Prisma v7+ Ê≥®ÊÑè: `prisma generate` „ÅØ generator „ÅÆ `output` „ÇíÂøÖÈ†à„Å®„Åô„ÇãÔºàÂÖ¨Âºè‰∏ÄÊ¨°ÊÉÖÂ†±: Prisma v7.0.0 release notesÔºâ
// - `https://github.com/prisma/prisma/releases/tag/7.0.0`
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------
// Existing tables (current repo)
// -----------------------------

model Token {
  userId           String @map("user_id")
  provider         String
  providerSub      String? @map("provider_sub")
  email            String?
  accessTokenEnc   Json @db.JsonB @map("access_token_enc")
  refreshTokenEnc  Json? @db.JsonB @map("refresh_token_enc")
  scope            String?
  expiry           DateTime? @db.Timestamptz
  rotationFamilyId String? @map("rotation_family_id")
  revokedAt        DateTime? @db.Timestamptz @map("revoked_at")
  createdAt        DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt        DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@id([userId, provider])
  @@map("tokens")
}

model RefreshToken {
  id            String   @id @db.Uuid @default(uuid())
  userId        String   @db.Uuid @map("user_id")
  tokenHash     String   @map("token_hash")
  deviceId      String   @map("device_id")
  userAgent     String?  @map("user_agent")
  createdAt     DateTime @default(now()) @db.Timestamptz @map("created_at")
  expiresAt     DateTime @db.Timestamptz @map("expires_at")
  rotatedFrom   String?  @db.Uuid @map("rotated_from")
  revokedAt     DateTime? @db.Timestamptz @map("revoked_at")
  lastUsedAt    DateTime? @db.Timestamptz @map("last_used_at")
  reuseDetected Boolean  @default(false) @map("reuse_detected")

  @@map("refresh_tokens")
}

model MobileProfile {
  deviceId  String @id @map("device_id")
  userId    String @map("user_id")
  profile   Json   @db.JsonB @default("{}")
  language  String @default("en")
  updatedAt DateTime? @db.Timestamptz @map("updated_at")
  createdAt DateTime? @db.Timestamptz @map("created_at")

  @@map("mobile_profiles")
}

model MobileVoipToken {
  userId      String @map("user_id")
  deviceToken String @map("device_token")
  updatedAt   DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@id([userId, deviceToken])
  @@map("mobile_voip_tokens")
}

// Ê≥®ÊÑè: `mobile_alarm_schedules.id` „ÅØÈÅéÂéª„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Åå UUID/TEXT „ÅßÊè∫„Çå„Å¶„ÅÑ„Çã„ÄÇ
// v0.3 „ÅÆ‰∏ªË¶ÅÊ©üËÉΩ„Åß„ÅØÂøÖÈ†à„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁèæDB„ÅÆÂûã„Å´Âêà„Çè„Åõ„Å¶ÂøÖË¶Å„Å™„Çâ @db.Uuid/@db.Text „ÇíË™øÊï¥„Åô„Çã„ÄÇ
model MobileAlarmSchedule {
  id         String @id @map("id")
  userId     String @map("user_id")
  habitType  String @map("habit_type")
  fireTime   DateTime @db.Timestamptz @map("fire_time")
  timezone   String
  repeatRule String @default("daily") @map("repeat_rule")
  nextFireAt DateTime @db.Timestamptz @map("next_fire_at")
  createdAt  DateTime? @db.Timestamptz @map("created_at")
  updatedAt  DateTime? @db.Timestamptz @map("updated_at")

  @@map("mobile_alarm_schedules")
}

model UserSubscription {
  userId                          String @id @map("user_id")
  plan                            String @default("free")
  status                          String @default("free")
  stripeCustomerId                String? @map("stripe_customer_id")
  stripeSubscriptionId            String? @map("stripe_subscription_id")
  entitlementSource               String @default("revenuecat") @map("entitlement_source")
  revenuecatEntitlementId         String? @map("revenuecat_entitlement_id")
  revenuecatOriginalTransactionId String? @map("revenuecat_original_transaction_id")
  entitlementPayload              Json? @db.JsonB @map("entitlement_payload")
  currentPeriodEnd                DateTime? @db.Timestamptz @map("current_period_end")
  trialEnd                        DateTime? @db.Timestamptz @map("trial_end")
  metadata                        Json @db.JsonB @default("{}")
  updatedAt                       DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@map("user_subscriptions")
}

model RealtimeUsageDaily {
  userId    String @map("user_id")
  usageDate DateTime @db.Date @map("usage_date")
  count     Int @default(0)
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@id([userId, usageDate])
  @@map("realtime_usage_daily")
}

model UsageSession {
  sessionId     String @id @map("session_id")
  userId        String @map("user_id")
  startedAt     DateTime @default(now()) @db.Timestamptz @map("started_at")
  endedAt       DateTime? @db.Timestamptz @map("ended_at")
  billedSeconds Int @default(0) @map("billed_seconds")
  billedMinutes Int @default(0) @map("billed_minutes")
  source        String @default("realtime")
  updatedAt     DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@map("usage_sessions")
}

model MonthlyVcGrant {
  userId     String @map("user_id")
  grantMonth DateTime @db.Date @map("grant_month")
  reason     String
  minutes    Int
  grantedAt  DateTime @default(now()) @db.Timestamptz @map("granted_at")

  @@id([userId, grantMonth, reason])
  @@map("monthly_vc_grants")
}

model Profile {
  id        String @id @db.Uuid
  email     String? @unique
  metadata  Json @db.JsonB @default("{}")
  createdAt DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt DateTime @default(now()) @db.Timestamptz @map("updated_at")

  settings         UserSetting?
  userTypeEstimate UserTypeEstimate?

  @@map("profiles")
}

model UserSetting {
  userId               String @id @db.Uuid @map("user_id")
  language             String @default("ja")
  timezone             String @default("Asia/Tokyo")
  notificationsEnabled Boolean @default(true) @map("notifications_enabled")
  preferences          Json @db.JsonB @default("{}")
  createdAt            DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt            DateTime @default(now()) @db.Timestamptz @map("updated_at")

  profile Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// -----------------------------
// New v0.3 tables
// -----------------------------

model UserTrait {
  userId         String   @id @db.Uuid @map("user_id")
  ideals         String[] @db.Text @default([])
  struggles      String[] @db.Text @default([])
  big5           Json     @db.JsonB @default("{}")
  keywords       String[] @db.Text @default([])
  summary        String   @db.Text @default("")
  nudgeIntensity String   @default("normal") @map("nudge_intensity")
  stickyMode     Boolean  @default(false) @map("sticky_mode")
  createdAt      DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt      DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@map("user_traits")
}

model NudgeEvent {
  id             String   @id @db.Uuid @default(uuid())
  userId         String   @db.Uuid @map("user_id")
  domain         String
  subtype        String
  decisionPoint  String   @map("decision_point")
  state          Json     @db.JsonB
  actionTemplate String?  @map("action_template")
  channel        String
  sent           Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz @map("created_at")

  outcomes NudgeOutcome[]

  @@map("nudge_events")
}

model NudgeOutcome {
  id           String   @id @db.Uuid @default(uuid())
  nudgeEventId String   @db.Uuid @map("nudge_event_id")
  reward       Float?
  shortTerm    Json     @db.JsonB @default("{}") @map("short_term")
  emaScore     Json?    @db.JsonB @map("ema_score")
  signals      Json     @db.JsonB @default("{}")
  createdAt    DateTime @default(now()) @db.Timestamptz @map("created_at")

  event NudgeEvent @relation(fields: [nudgeEventId], references: [id], onDelete: Cascade)

  @@map("nudge_outcomes")
}

model BanditModel {
  id         String   @id @db.Uuid @default(uuid())
  domain     String
  version    Int      @default(1)
  weights    Json     @db.JsonB
  covariance Json     @db.JsonB
  meta       Json     @db.JsonB @default("{}")
  createdAt  DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt  DateTime @default(now()) @db.Timestamptz @map("updated_at")

  @@unique([domain, version])
  @@map("bandit_models")
}

// -----------------------------
// 1.5.0 Cross-User Learning
// -----------------------------

model UserTypeEstimate {
  userId      String   @id @db.Uuid @map("user_id")
  primaryType String   @db.VarChar(10) @map("primary_type")
  typeScores  Json     @db.JsonB @default("{}") @map("type_scores")
  confidence  Decimal  @db.Decimal(5,4) @default(0)
  createdAt   DateTime @default(now()) @db.Timestamptz @map("created_at")
  updatedAt   DateTime @default(now()) @db.Timestamptz @map("updated_at")

  profile     Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([primaryType])
  @@map("user_type_estimates")
}

model TypeStats {
  typeId          String   @db.VarChar(10) @map("type_id")
  tone            String   @db.VarChar(20)
  tappedCount     BigInt   @default(0) @map("tapped_count")
  ignoredCount    BigInt   @default(0) @map("ignored_count")
  thumbsUpCount   BigInt   @default(0) @map("thumbs_up_count")
  thumbsDownCount BigInt   @default(0) @map("thumbs_down_count")
  sampleSize      BigInt   @default(0) @map("sample_size")
  updatedAt       DateTime @default(now()) @db.Timestamptz @map("updated_at")
  // NOTE: tap_rate, thumbs_up_rate are GENERATED ALWAYS AS columns in PostgreSQL
  // Not defined in Prisma; read via prisma.$queryRaw

  @@id([typeId, tone])
  @@map("type_stats")
}

model HookCandidate {
  id                 String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  text               String    @db.Text
  tone               String    @db.VarChar(20)
  targetProblemTypes String[]  @default([]) @map("target_problem_types")
  targetUserTypes    String[]  @default([]) @map("target_user_types")
  appTapRate         Decimal   @db.Decimal(5,4) @default(0) @map("app_tap_rate")
  appThumbsUpRate    Decimal   @db.Decimal(5,4) @default(0) @map("app_thumbs_up_rate")
  appSampleSize      Int       @default(0) @map("app_sample_size")
  tiktokLikeRate     Decimal   @db.Decimal(5,4) @default(0) @map("tiktok_like_rate")
  tiktokShareRate    Decimal   @db.Decimal(5,4) @default(0) @map("tiktok_share_rate")
  tiktokSampleSize   Int       @default(0) @map("tiktok_sample_size")
  tiktokHighPerformer Boolean  @default(false) @map("tiktok_high_performer")
  isWisdom           Boolean   @default(false) @map("is_wisdom")
  explorationWeight  Decimal   @db.Decimal(3,2) @default(1.0) @map("exploration_weight")
  createdAt          DateTime  @default(now()) @db.Timestamptz @map("created_at")
  updatedAt          DateTime  @default(now()) @db.Timestamptz @map("updated_at")

  // 1.6.0 Phase 3: Hook Storage ‚Üí TS Loop
  source            String    @default("manual") @db.VarChar(20) // 'manual', 'llm_nudge', 'x_agent', 'tiktok_agent'
  generatedForUserId String?  @db.Uuid @map("generated_for_user_id")
  promoted          Boolean   @default(false)
  // 1.6.0 Phase 5: X metrics
  xEngagementRate   Decimal   @db.Decimal(5,4) @default(0) @map("x_engagement_rate")
  xSampleSize       Int       @default(0) @map("x_sample_size")
  xHighPerformer    Boolean   @default(false) @map("x_high_performer")

  // 1.6.1: Moltbook metrics
  moltbookUpvoteRate    Decimal?  @db.Decimal(5,4) @map("moltbook_upvote_rate")
  moltbookSampleSize    Int?      @map("moltbook_sample_size")
  moltbookHighPerformer Boolean?  @map("moltbook_high_performer")

  // 1.6.1: Slack metrics
  slackReactionRate     Decimal?  @db.Decimal(5,4) @map("slack_reaction_rate")
  slackSampleSize       Int?      @map("slack_sample_size")
  slackHighPerformer    Boolean?  @map("slack_high_performer")

  tiktokPosts TiktokPost[]
  xPosts      XPost[]

  @@unique([text, tone])
  @@index([tone])
  @@index([source])
  @@map("hook_candidates")
}

model TiktokPost {
  id                String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  hookCandidateId   String?   @db.Uuid @map("hook_candidate_id")
  tiktokVideoId     String?   @db.VarChar(100) @unique @map("tiktok_video_id")
  blotatoPostId     String?   @unique @db.VarChar(100) @map("blotato_post_id")
  caption           String?   @db.Text
  postedAt          DateTime  @default(now()) @db.Timestamptz @map("posted_at")
  metricsFetchedAt  DateTime? @db.Timestamptz @map("metrics_fetched_at")
  viewCount         BigInt?   @map("view_count")
  likeCount         BigInt?   @map("like_count")
  commentCount      BigInt?   @map("comment_count")
  shareCount        BigInt?   @map("share_count")
  agentReasoning    String?   @db.Text @map("agent_reasoning")
  slot              String?   @db.VarChar(20) @map("slot")
  scheduledAt       DateTime? @db.Timestamptz @map("scheduled_at")
  createdAt         DateTime  @default(now()) @db.Timestamptz @map("created_at")

  hookCandidate HookCandidate? @relation(fields: [hookCandidateId], references: [id])

  @@index([hookCandidateId])
  @@index([postedAt(sort: Desc)])
  @@map("tiktok_posts")
}

model WisdomPattern {
  id                     String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  patternName            String    @unique @db.VarChar(100) @map("pattern_name")
  description            String?   @db.Text
  targetUserTypes        String[]  @default([]) @map("target_user_types")
  effectiveTone          String?   @db.VarChar(20) @map("effective_tone")
  effectiveHookPattern   String?   @db.Text @map("effective_hook_pattern")
  effectiveContentLength String?   @db.VarChar(20) @map("effective_content_length")
  appEvidence            Json      @db.JsonB @default("{}") @map("app_evidence")
  tiktokEvidence         Json      @db.JsonB @default("{}") @map("tiktok_evidence")
  confidence             Decimal   @db.Decimal(5,4) @default(0)
  verifiedAt             DateTime? @db.Timestamptz @map("verified_at")
  createdAt              DateTime  @default(now()) @db.Timestamptz @map("created_at")
  updatedAt              DateTime  @default(now()) @db.Timestamptz @map("updated_at")

  @@map("wisdom_patterns")
}

// 1.6.0 Phase 4: X/Twitter posts
model XPost {
  id                String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  hookCandidateId   String?   @db.Uuid @map("hook_candidate_id")
  xPostId           String?   @unique @db.VarChar(100) @map("x_post_id")
  blotatoPostId     String?   @unique @db.VarChar(100) @map("blotato_post_id")
  text              String    @db.Text
  slot              String?   @db.VarChar(20) @map("slot")
  postedAt          DateTime? @db.Timestamptz @map("posted_at")
  metricsFetchedAt  DateTime? @db.Timestamptz @map("metrics_fetched_at")
  impressionCount   BigInt    @default(0) @map("impression_count")
  likeCount         BigInt    @default(0) @map("like_count")
  retweetCount      BigInt    @default(0) @map("retweet_count")
  replyCount        BigInt    @default(0) @map("reply_count")
  engagementRate    Decimal   @db.Decimal(7,6) @default(0) @map("engagement_rate")
  agentReasoning    String?   @db.Text @map("agent_reasoning")
  createdAt         DateTime  @default(now()) @db.Timestamptz @map("created_at")

  hookCandidate HookCandidate? @relation(fields: [hookCandidateId], references: [id])

  @@index([hookCandidateId])
  @@index([postedAt(sort: Desc)])
  @@map("x_posts")
}

// 1.6.0 Phase 7: Notification Schedules (Commander Decision ‰øùÂ≠ò)
model NotificationSchedule {
  id              String    @id @db.Uuid @default(dbgenerated("gen_random_uuid()"))
  userId          String    @unique @db.Uuid @map("user_id")
  schedule        Json      @db.JsonB  // CommanderDecision (Ê≠£Ë¶èÂåñÂæå)
  agentRawOutput  Json?     @db.JsonB @map("agent_raw_output")  // AgentRawOutput (Áõ£ÊüªÁî®)
  createdAt       DateTime  @default(now()) @db.Timestamptz @map("created_at")

  @@map("notification_schedules")
}

// -----------------------------
// 1.6.1 Anicca in the World
// -----------------------------

model AgentPost {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  platform          String    @db.VarChar(50)        // 'moltbook', 'slack', 'x', 'tiktok', 'instagram'
  externalPostId    String?   @map("external_post_id") @db.VarChar(255)
  platformUserId    String?   @map("platform_user_id") @db.VarChar(255) // <platform>:<user_id> ÂΩ¢Âºè
  severity          String?   @db.VarChar(20)        // null | 'crisis'
  region            String?   @db.VarChar(10)        // 'JP', 'US', 'UK', 'KR', 'OTHER'
  hook              String?
  content           String?
  tone              String?   @db.VarChar(50)
  problemType       String?   @map("problem_type") @db.VarChar(100)
  reasoning         String?
  buddhismReference String?   @map("buddhism_reference")

  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
  upvotes           Int       @default(0)
  reactions         Json      @default("{}") @db.JsonB  // Slack { "üëç": 3, "‚ù§Ô∏è": 1 }
  views             Int?      // null = unknown/not available (for Moltbook Z-Score fallback)
  likes             Int       @default(0)
  shares            Int       @default(0)
  comments          Int       @default(0)

  // Z-Score
  moltbookZ         Float?    @map("moltbook_z")
  slackZ            Float?    @map("slack_z")
  tiktokZ           Float?    @map("tiktok_z")
  xZ                Float?    @map("x_z")
  instagramZ        Float?    @map("instagram_z")
  unifiedScore      Float?    @map("unified_score")

  // „É°„Çø„Éá„Éº„Çø
  createdAt                  DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                  DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  promotedToHookCandidates   Boolean   @default(false) @map("promoted_to_hook_candidates")
  anonymizedAt               DateTime? @map("anonymized_at") @db.Timestamptz

  @@unique([platform, externalPostId])
  @@index([platform])
  @@index([createdAt(sort: Desc)])
  @@index([platformUserId])
  @@map("agent_posts")
}

model AgentAuditLog {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType       String    @map("event_type") @db.VarChar(50)  // 'llm_call', 'tool_execution', 'deletion_request', 'deletion_completed'
  agentPostId     String?   @db.Uuid @map("agent_post_id")
  platform        String?   @db.VarChar(50)
  requestPayload  Json?     @db.JsonB @map("request_payload")
  responsePayload Json?     @db.JsonB @map("response_payload")
  executedBy      String?   @db.VarChar(100) @map("executed_by")  // 'system', 'admin:<id>', 'user:<id>'
  durationMs      Int?      @map("duration_ms")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@index([agentPostId])
  @@map("agent_audit_logs")
}

// 1.6.1 HookCandidate Êã°Âºµ„Ç´„É©„É†ÔºàÊó¢Â≠ò HookCandidate „Å´ËøΩÂä†Ôºâ
// Note: Êó¢Â≠ò„ÅÆ HookCandidate model „Å´‰ª•‰∏ã„ÅÆ„Ç´„É©„É†„ÇíËøΩÂä†Ê∏à„Åø:
// - moltbookUpvoteRate, moltbookSampleSize, moltbookHighPerformer
// - slackReactionRate, slackSampleSize, slackHighPerformer

