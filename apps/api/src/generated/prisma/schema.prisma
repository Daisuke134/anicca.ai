// Anicca v0.3 Prisma schema (Node ESM .js runtime)
// - v0.3 „ÅØ Node ESM „ÅÆ .js „ÇíÁ∂≠ÊåÅ„Åó„ÄÅTypeScriptÂ∞éÂÖ•„ÅØ v0.4 ‰ª•Èôç
// - Êó¢Â≠òDBÔºàsnake_caseÔºâ„Å´Âêà„Çè„Åõ„Å¶ @map/@@map „Çí‰ªò„Åë„Çã
// - v0.3 „Åß„ÅØ Prisma Migrate ‰∏ªÂ∞é„ÅßÊó¢Â≠òDB„ÇíÁÆ°ÁêÜ„Åó„Å™„ÅÑÔºà„Éà„É™„Ç¨„Éº/Âºè„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åå„ÅÇ„Çã„Åü„ÇÅÔºâ

// Prisma v7+ Ê≥®ÊÑè: `prisma generate` „ÅØ generator „ÅÆ `output` „ÇíÂøÖÈ†à„Å®„Åô„ÇãÔºàÂÖ¨Âºè‰∏ÄÊ¨°ÊÉÖÂ†±: Prisma v7.0.0 release notesÔºâ
// - `https://github.com/prisma/prisma/releases/tag/7.0.0`
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------
// Existing tables (current repo)
// -----------------------------

model Token {
  userId           String    @map("user_id")
  provider         String
  providerSub      String?   @map("provider_sub")
  email            String?
  accessTokenEnc   Json      @map("access_token_enc") @db.JsonB
  refreshTokenEnc  Json?     @map("refresh_token_enc") @db.JsonB
  scope            String?
  expiry           DateTime? @db.Timestamptz
  rotationFamilyId String?   @map("rotation_family_id")
  revokedAt        DateTime? @map("revoked_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@id([userId, provider])
  @@map("tokens")
}

model RefreshToken {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  tokenHash     String    @map("token_hash")
  deviceId      String    @map("device_id")
  userAgent     String?   @map("user_agent")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz
  rotatedFrom   String?   @map("rotated_from") @db.Uuid
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz
  lastUsedAt    DateTime? @map("last_used_at") @db.Timestamptz
  reuseDetected Boolean   @default(false) @map("reuse_detected")

  @@map("refresh_tokens")
}

model MobileProfile {
  deviceId  String    @id @map("device_id")
  userId    String    @map("user_id")
  profile   Json      @default("{}") @db.JsonB
  language  String    @default("en")
  updatedAt DateTime? @map("updated_at") @db.Timestamptz
  createdAt DateTime? @map("created_at") @db.Timestamptz

  @@map("mobile_profiles")
}

model UserSubscription {
  userId                          String    @id @map("user_id")
  plan                            String    @default("free")
  status                          String    @default("free")
  entitlementSource               String    @default("revenuecat") @map("entitlement_source")
  revenuecatEntitlementId         String?   @map("revenuecat_entitlement_id")
  revenuecatOriginalTransactionId String?   @map("revenuecat_original_transaction_id")
  entitlementPayload              Json?     @map("entitlement_payload") @db.JsonB
  currentPeriodEnd                DateTime? @map("current_period_end") @db.Timestamptz
  trialEnd                        DateTime? @map("trial_end") @db.Timestamptz
  metadata                        Json      @default("{}") @db.JsonB
  updatedAt                       DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@map("user_subscriptions")
}

model SubscriptionEvent {
  eventId   String   @id @map("event_id")
  userId    String?  @map("user_id")
  type      String
  provider  String   @default("revenuecat")
  payload   Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("subscription_events")
}

model MonthlyVcGrant {
  userId     String   @map("user_id")
  grantMonth DateTime @map("grant_month") @db.Date
  reason     String
  minutes    Int
  grantedAt  DateTime @default(now()) @map("granted_at") @db.Timestamptz

  @@id([userId, grantMonth, reason])
  @@map("monthly_vc_grants")
}

model Profile {
  id        String   @id @db.Uuid
  email     String?  @unique
  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz

  settings         UserSetting?
  userTypeEstimate UserTypeEstimate?

  @@map("profiles")
}

model UserSetting {
  userId               String   @id @map("user_id") @db.Uuid
  language             String   @default("ja")
  timezone             String   @default("Asia/Tokyo")
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  preferences          Json     @default("{}") @db.JsonB
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @map("updated_at") @db.Timestamptz

  profile Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// -----------------------------
// New v0.3 tables
// -----------------------------

model UserTrait {
  userId         String   @id @map("user_id") @db.Uuid
  ideals         String[] @default([]) @db.Text
  struggles      String[] @default([]) @db.Text
  big5           Json     @default("{}") @db.JsonB
  keywords       String[] @default([]) @db.Text
  summary        String   @default("") @db.Text
  nudgeIntensity String   @default("normal") @map("nudge_intensity")
  stickyMode     Boolean  @default(false) @map("sticky_mode")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @map("updated_at") @db.Timestamptz

  @@map("user_traits")
}

model NudgeEvent {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  domain         String
  subtype        String
  decisionPoint  String   @map("decision_point")
  state          Json     @db.JsonB
  actionTemplate String?  @map("action_template")
  channel        String
  sent           Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  outcomes NudgeOutcome[]

  @@map("nudge_events")
}

model NudgeOutcome {
  id           String   @id @default(uuid()) @db.Uuid
  nudgeEventId String   @map("nudge_event_id") @db.Uuid
  reward       Float?
  shortTerm    Json     @default("{}") @map("short_term") @db.JsonB
  emaScore     Json?    @map("ema_score") @db.JsonB
  signals      Json     @default("{}") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  event NudgeEvent @relation(fields: [nudgeEventId], references: [id], onDelete: Cascade)

  @@map("nudge_outcomes")
}

model FeelingSession {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  feelingId      String    @map("feeling_id")
  topic          String?
  actionTemplate String?   @map("action_template")
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz
  endedAt        DateTime? @map("ended_at") @db.Timestamptz
  emaBetter      Boolean?  @map("ema_better")
  summary        String?   @db.Text
  transcript     Json?     @db.JsonB
  context        Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@map("feeling_sessions")
}

model BanditModel {
  id         String   @id @default(uuid()) @db.Uuid
  domain     String
  version    Int      @default(1)
  weights    Json     @db.JsonB
  covariance Json     @db.JsonB
  meta       Json     @default("{}") @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz

  @@unique([domain, version])
  @@map("bandit_models")
}

// -----------------------------
// 1.5.0 Cross-User Learning
// -----------------------------

model UserTypeEstimate {
  userId      String   @id @map("user_id") @db.Uuid
  primaryType String   @map("primary_type") @db.VarChar(10)
  typeScores  Json     @default("{}") @map("type_scores") @db.JsonB
  confidence  Decimal  @default(0) @db.Decimal(5, 4)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz

  profile Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([primaryType])
  @@map("user_type_estimates")
}

model TypeStats {
  typeId          String   @map("type_id") @db.VarChar(10)
  tone            String   @db.VarChar(20)
  tappedCount     BigInt   @default(0) @map("tapped_count")
  ignoredCount    BigInt   @default(0) @map("ignored_count")
  thumbsUpCount   BigInt   @default(0) @map("thumbs_up_count")
  thumbsDownCount BigInt   @default(0) @map("thumbs_down_count")
  sampleSize      BigInt   @default(0) @map("sample_size")
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz
  // NOTE: tap_rate, thumbs_up_rate are GENERATED ALWAYS AS columns in PostgreSQL
  // Not defined in Prisma; read via prisma.$queryRaw

  @@id([typeId, tone])
  @@map("type_stats")
}

model HookCandidate {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  text                String   @db.Text
  tone                String   @db.VarChar(20)
  targetProblemTypes  String[] @default([]) @map("target_problem_types")
  targetUserTypes     String[] @default([]) @map("target_user_types")
  appTapRate          Decimal  @default(0) @map("app_tap_rate") @db.Decimal(5, 4)
  appThumbsUpRate     Decimal  @default(0) @map("app_thumbs_up_rate") @db.Decimal(5, 4)
  appSampleSize       Int      @default(0) @map("app_sample_size")
  tiktokLikeRate      Decimal  @default(0) @map("tiktok_like_rate") @db.Decimal(5, 4)
  tiktokShareRate     Decimal  @default(0) @map("tiktok_share_rate") @db.Decimal(5, 4)
  tiktokSampleSize    Int      @default(0) @map("tiktok_sample_size")
  tiktokHighPerformer Boolean  @default(false) @map("tiktok_high_performer")
  isWisdom            Boolean  @default(false) @map("is_wisdom")
  explorationWeight   Decimal  @default(1.0) @map("exploration_weight") @db.Decimal(3, 2)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @map("updated_at") @db.Timestamptz

  // 1.6.0 Phase 3: Hook Storage ‚Üí TS Loop
  source             String  @default("manual") @db.VarChar(20) // 'manual', 'llm_nudge', 'x_agent', 'tiktok_agent'
  generatedForUserId String? @map("generated_for_user_id") @db.Uuid
  promoted           Boolean @default(false)
  // 1.6.0 Phase 5: X metrics
  xEngagementRate    Decimal @default(0) @map("x_engagement_rate") @db.Decimal(5, 4)
  xSampleSize        Int     @default(0) @map("x_sample_size")
  xHighPerformer     Boolean @default(false) @map("x_high_performer")

  // 1.6.1: Moltbook metrics
  moltbookUpvoteRate    Decimal? @map("moltbook_upvote_rate") @db.Decimal(5, 4)
  moltbookSampleSize    Int?     @map("moltbook_sample_size")
  moltbookHighPerformer Boolean? @map("moltbook_high_performer")

  // 1.6.1: Slack metrics
  slackReactionRate  Decimal? @map("slack_reaction_rate") @db.Decimal(5, 4)
  slackSampleSize    Int?     @map("slack_sample_size")
  slackHighPerformer Boolean? @map("slack_high_performer")

  tiktokPosts TiktokPost[]
  xPosts      XPost[]

  @@unique([text, tone])
  @@index([tone])
  @@index([source])
  @@map("hook_candidates")
}

model TiktokPost {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hookCandidateId  String?   @map("hook_candidate_id") @db.Uuid
  tiktokVideoId    String?   @unique @map("tiktok_video_id") @db.VarChar(100)
  blotatoPostId    String?   @unique @map("blotato_post_id") @db.VarChar(100)
  caption          String?   @db.Text
  postedAt         DateTime  @default(now()) @map("posted_at") @db.Timestamptz
  metricsFetchedAt DateTime? @map("metrics_fetched_at") @db.Timestamptz
  viewCount        BigInt?   @map("view_count")
  likeCount        BigInt?   @map("like_count")
  commentCount     BigInt?   @map("comment_count")
  shareCount       BigInt?   @map("share_count")
  agentReasoning   String?   @map("agent_reasoning") @db.Text
  slot             String?   @map("slot") @db.VarChar(20)
  scheduledAt      DateTime? @map("scheduled_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz

  hookCandidate HookCandidate? @relation(fields: [hookCandidateId], references: [id])

  @@index([hookCandidateId])
  @@index([postedAt(sort: Desc)])
  @@map("tiktok_posts")
}

model WisdomPattern {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  patternName            String    @unique @map("pattern_name") @db.VarChar(100)
  description            String?   @db.Text
  targetUserTypes        String[]  @default([]) @map("target_user_types")
  effectiveTone          String?   @map("effective_tone") @db.VarChar(20)
  effectiveHookPattern   String?   @map("effective_hook_pattern") @db.Text
  effectiveContentLength String?   @map("effective_content_length") @db.VarChar(20)
  appEvidence            Json      @default("{}") @map("app_evidence") @db.JsonB
  tiktokEvidence         Json      @default("{}") @map("tiktok_evidence") @db.JsonB
  confidence             Decimal   @default(0) @db.Decimal(5, 4)
  verifiedAt             DateTime? @map("verified_at") @db.Timestamptz
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@map("wisdom_patterns")
}

// 1.6.0 Phase 4: X/Twitter posts
model XPost {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hookCandidateId  String?   @map("hook_candidate_id") @db.Uuid
  xPostId          String?   @unique @map("x_post_id") @db.VarChar(100)
  blotatoPostId    String?   @unique @map("blotato_post_id") @db.VarChar(100)
  text             String    @db.Text
  slot             String?   @map("slot") @db.VarChar(20)
  postedAt         DateTime? @map("posted_at") @db.Timestamptz
  metricsFetchedAt DateTime? @map("metrics_fetched_at") @db.Timestamptz
  impressionCount  BigInt    @default(0) @map("impression_count")
  likeCount        BigInt    @default(0) @map("like_count")
  retweetCount     BigInt    @default(0) @map("retweet_count")
  replyCount       BigInt    @default(0) @map("reply_count")
  engagementRate   Decimal   @default(0) @map("engagement_rate") @db.Decimal(7, 6)
  agentReasoning   String?   @map("agent_reasoning") @db.Text
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz

  hookCandidate HookCandidate? @relation(fields: [hookCandidateId], references: [id])

  @@index([hookCandidateId])
  @@index([postedAt(sort: Desc)])
  @@map("x_posts")
}

// 1.6.0 Phase 7: Notification Schedules (Commander Decision ‰øùÂ≠ò)
model NotificationSchedule {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @unique @map("user_id") @db.Uuid
  schedule       Json     @db.JsonB // CommanderDecision (Ê≠£Ë¶èÂåñÂæå)
  agentRawOutput Json?    @map("agent_raw_output") @db.JsonB // AgentRawOutput (Áõ£ÊüªÁî®)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("notification_schedules")
}

// -----------------------------
// 1.6.1 Anicca in the World
// -----------------------------

model AgentPost {
  id                String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  platform          String  @db.VarChar(50) // 'moltbook', 'slack', 'x', 'tiktok', 'instagram'
  externalPostId    String? @map("external_post_id") @db.VarChar(255)
  platformUserId    String? @map("platform_user_id") @db.VarChar(255) // <platform>:<user_id> ÂΩ¢Âºè
  severity          String? @db.VarChar(20) // null | 'crisis'
  region            String? @db.VarChar(10) // 'JP', 'US', 'UK', 'KR', 'OTHER'
  hook              String?
  content           String?
  tone              String? @db.VarChar(50)
  problemType       String? @map("problem_type") @db.VarChar(100)
  reasoning         String?
  buddhismReference String? @map("buddhism_reference")

  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
  upvotes   Int  @default(0)
  reactions Json @default("{}") @db.JsonB // Slack { "üëç": 3, "‚ù§Ô∏è": 1 }
  views     Int? // null = unknown/not available (for Moltbook Z-Score fallback)
  likes     Int  @default(0)
  shares    Int  @default(0)
  comments  Int  @default(0)

  // Z-Score
  moltbookZ    Float? @map("moltbook_z")
  slackZ       Float? @map("slack_z")
  tiktokZ      Float? @map("tiktok_z")
  xZ           Float? @map("x_z")
  instagramZ   Float? @map("instagram_z")
  unifiedScore Float? @map("unified_score")

  // „É°„Çø„Éá„Éº„Çø
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt                DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  promotedToHookCandidates Boolean   @default(false) @map("promoted_to_hook_candidates")
  anonymizedAt             DateTime? @map("anonymized_at") @db.Timestamptz

  @@unique([platform, externalPostId])
  @@index([platform])
  @@index([createdAt(sort: Desc)])
  @@index([platformUserId])
  @@map("agent_posts")
}

model AgentAuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType       String   @map("event_type") @db.VarChar(50) // 'llm_call', 'tool_execution', 'deletion_request', 'deletion_completed'
  agentPostId     String?  @map("agent_post_id") @db.Uuid
  platform        String?  @db.VarChar(50)
  requestPayload  Json?    @map("request_payload") @db.JsonB
  responsePayload Json?    @map("response_payload") @db.JsonB
  executedBy      String?  @map("executed_by") @db.VarChar(100) // 'system', 'admin:<id>', 'user:<id>'
  durationMs      Int?     @map("duration_ms")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([eventType])
  @@index([createdAt(sort: Desc)])
  @@index([agentPostId])
  @@map("agent_audit_logs")
}

// 1.6.1 HookCandidate Êã°Âºµ„Ç´„É©„É†ÔºàÊó¢Â≠ò HookCandidate „Å´ËøΩÂä†Ôºâ
// Note: Êó¢Â≠ò„ÅÆ HookCandidate model „Å´‰ª•‰∏ã„ÅÆ„Ç´„É©„É†„ÇíËøΩÂä†Ê∏à„Åø:
// - moltbookUpvoteRate, moltbookSampleSize, moltbookHighPerformer
// - slackReactionRate, slackSampleSize, slackHighPerformer
