// Anicca v0.3 Prisma schema (Node ESM .js runtime)
// - v0.3 は Node ESM の .js を維持し、TypeScript導入は v0.4 以降
// - 既存DB（snake_case）に合わせて @map/@@map を付ける
// - v0.3 では Prisma Migrate 主導で既存DBを管理しない（トリガー/式インデックスがあるため）

// Prisma v7+ 注意: `prisma generate` は generator の `output` を必須とする（公式一次情報: Prisma v7.0.0 release notes）
// - `https://github.com/prisma/prisma/releases/tag/7.0.0`
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------
// Existing tables (current repo)
// -----------------------------

model Token {
  userId           String    @map("user_id")
  provider         String
  providerSub      String?   @map("provider_sub")
  email            String?
  accessTokenEnc   Json      @map("access_token_enc") @db.JsonB
  refreshTokenEnc  Json?     @map("refresh_token_enc") @db.JsonB
  scope            String?
  expiry           DateTime? @db.Timestamptz
  rotationFamilyId String?   @map("rotation_family_id")
  revokedAt        DateTime? @map("revoked_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@id([userId, provider])
  @@map("tokens")
}

model RefreshToken {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @map("user_id") @db.Uuid
  tokenHash     String    @map("token_hash")
  deviceId      String    @map("device_id")
  userAgent     String?   @map("user_agent")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz
  rotatedFrom   String?   @map("rotated_from") @db.Uuid
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz
  lastUsedAt    DateTime? @map("last_used_at") @db.Timestamptz
  reuseDetected Boolean   @default(false) @map("reuse_detected")

  @@map("refresh_tokens")
}

model MobileProfile {
  deviceId  String    @id @map("device_id")
  userId    String    @map("user_id")
  profile   Json      @default("{}") @db.JsonB
  language  String    @default("en")
  updatedAt DateTime? @map("updated_at") @db.Timestamptz
  createdAt DateTime? @map("created_at") @db.Timestamptz

  @@map("mobile_profiles")
}

model UserSubscription {
  userId                          String    @id @map("user_id")
  plan                            String    @default("free")
  status                          String    @default("free")
  stripeCustomerId                String?   @map("stripe_customer_id")
  stripeSubscriptionId            String?   @map("stripe_subscription_id")
  entitlementSource               String    @default("revenuecat") @map("entitlement_source")
  revenuecatEntitlementId         String?   @map("revenuecat_entitlement_id")
  revenuecatOriginalTransactionId String?   @map("revenuecat_original_transaction_id")
  entitlementPayload              Json?     @map("entitlement_payload") @db.JsonB
  currentPeriodEnd                DateTime? @map("current_period_end") @db.Timestamptz
  trialEnd                        DateTime? @map("trial_end") @db.Timestamptz
  metadata                        Json      @default("{}") @db.JsonB
  updatedAt                       DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@map("user_subscriptions")
}

model SubscriptionEvent {
  eventId   String   @id @map("event_id")
  userId    String?  @map("user_id")
  type      String
  provider  String   @default("revenuecat")
  payload   Json?    @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@map("subscription_events")
}

model MonthlyVcGrant {
  userId     String   @map("user_id")
  grantMonth DateTime @map("grant_month") @db.Date
  reason     String
  minutes    Int
  grantedAt  DateTime @default(now()) @map("granted_at") @db.Timestamptz

  @@id([userId, grantMonth, reason])
  @@map("monthly_vc_grants")
}

model Profile {
  id        String   @id @db.Uuid
  email     String?  @unique
  metadata  Json     @default("{}") @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz

  settings         UserSetting?
  userTypeEstimate UserTypeEstimate?

  @@map("profiles")
}

model UserSetting {
  userId               String   @id @map("user_id") @db.Uuid
  language             String   @default("ja")
  timezone             String   @default("Asia/Tokyo")
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  preferences          Json     @default("{}") @db.JsonB
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @default(now()) @map("updated_at") @db.Timestamptz

  profile Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// -----------------------------
// New v0.3 tables
// -----------------------------

model UserTrait {
  userId         String   @id @map("user_id") @db.Uuid
  ideals         String[] @default([]) @db.Text
  struggles      String[] @default([]) @db.Text
  big5           Json     @default("{}") @db.JsonB
  keywords       String[] @default([]) @db.Text
  summary        String   @default("") @db.Text
  nudgeIntensity String   @default("normal") @map("nudge_intensity")
  stickyMode     Boolean  @default(false) @map("sticky_mode")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @default(now()) @map("updated_at") @db.Timestamptz

  @@map("user_traits")
}

model DailyMetric {
  userId           String    @map("user_id") @db.Uuid
  date             DateTime  @db.Date
  sleepDurationMin Int?      @map("sleep_duration_min")
  sleepStartAt     DateTime? @map("sleep_start_at") @db.Timestamptz
  wakeAt           DateTime? @map("wake_at") @db.Timestamptz
  snsMinutesTotal  Int       @default(0) @map("sns_minutes_total")
  snsMinutesNight  Int       @default(0) @map("sns_minutes_night")
  steps            Int       @default(0)
  sedentaryMinutes Int       @default(0) @map("sedentary_minutes")
  activitySummary  Json      @default("{}") @map("activity_summary") @db.JsonB
  mindSummary      Json      @default("{}") @map("mind_summary") @db.JsonB
  insights         Json      @default("{}") @db.JsonB
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@id([userId, date])
  @@map("daily_metrics")
}

model NudgeEvent {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  domain         String
  subtype        String
  decisionPoint  String   @map("decision_point")
  state          Json     @db.JsonB
  actionTemplate String?  @map("action_template")
  channel        String
  sent           Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  outcomes NudgeOutcome[]

  @@map("nudge_events")
}

model NudgeOutcome {
  id           String   @id @default(uuid()) @db.Uuid
  nudgeEventId String   @map("nudge_event_id") @db.Uuid
  reward       Float?
  shortTerm    Json     @default("{}") @map("short_term") @db.JsonB
  emaScore     Json?    @map("ema_score") @db.JsonB
  signals      Json     @default("{}") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  event NudgeEvent @relation(fields: [nudgeEventId], references: [id], onDelete: Cascade)

  @@map("nudge_outcomes")
}

model FeelingSession {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  feelingId      String    @map("feeling_id")
  topic          String?
  actionTemplate String?   @map("action_template")
  startedAt      DateTime  @default(now()) @map("started_at") @db.Timestamptz
  endedAt        DateTime? @map("ended_at") @db.Timestamptz
  emaBetter      Boolean?  @map("ema_better")
  summary        String?   @db.Text
  transcript     Json?     @db.JsonB
  context        Json      @default("{}") @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz

  @@map("feeling_sessions")
}

model BanditModel {
  id         String   @id @default(uuid()) @db.Uuid
  domain     String
  version    Int      @default(1)
  weights    Json     @db.JsonB
  covariance Json     @db.JsonB
  meta       Json     @default("{}") @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt  DateTime @default(now()) @map("updated_at") @db.Timestamptz

  @@unique([domain, version])
  @@map("bandit_models")
}

// -----------------------------
// 1.5.0 Cross-User Learning
// -----------------------------

model UserTypeEstimate {
  userId      String   @id @map("user_id") @db.Uuid
  primaryType String   @map("primary_type") @db.VarChar(10)
  typeScores  Json     @default("{}") @map("type_scores") @db.JsonB
  confidence  Decimal  @default(0) @db.Decimal(5, 4)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz

  profile Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([primaryType])
  @@map("user_type_estimates")
}

model TypeStats {
  typeId          String   @map("type_id") @db.VarChar(10)
  tone            String   @db.VarChar(20)
  tappedCount     BigInt   @default(0) @map("tapped_count")
  ignoredCount    BigInt   @default(0) @map("ignored_count")
  thumbsUpCount   BigInt   @default(0) @map("thumbs_up_count")
  thumbsDownCount BigInt   @default(0) @map("thumbs_down_count")
  sampleSize      BigInt   @default(0) @map("sample_size")
  updatedAt       DateTime @default(now()) @map("updated_at") @db.Timestamptz
  // NOTE: tap_rate, thumbs_up_rate are GENERATED ALWAYS AS columns in PostgreSQL
  // Not defined in Prisma; read via prisma.$queryRaw

  @@id([typeId, tone])
  @@map("type_stats")
}

model HookCandidate {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  text                String   @db.Text
  tone                String   @db.VarChar(20)
  targetProblemTypes  String[] @default([]) @map("target_problem_types")
  targetUserTypes     String[] @default([]) @map("target_user_types")
  appTapRate          Decimal  @default(0) @map("app_tap_rate") @db.Decimal(5, 4)
  appThumbsUpRate     Decimal  @default(0) @map("app_thumbs_up_rate") @db.Decimal(5, 4)
  appSampleSize       Int      @default(0) @map("app_sample_size")
  tiktokLikeRate      Decimal  @default(0) @map("tiktok_like_rate") @db.Decimal(5, 4)
  tiktokShareRate     Decimal  @default(0) @map("tiktok_share_rate") @db.Decimal(5, 4)
  tiktokSampleSize    Int      @default(0) @map("tiktok_sample_size")
  tiktokHighPerformer Boolean  @default(false) @map("tiktok_high_performer")
  isWisdom            Boolean  @default(false) @map("is_wisdom")
  explorationWeight   Decimal  @default(1.0) @map("exploration_weight") @db.Decimal(3, 2)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime @default(now()) @map("updated_at") @db.Timestamptz

  tiktokPosts TiktokPost[]

  @@unique([text, tone])
  @@index([tone])
  @@map("hook_candidates")
}

model TiktokPost {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hookCandidateId  String?   @map("hook_candidate_id") @db.Uuid
  tiktokVideoId    String?   @unique @map("tiktok_video_id") @db.VarChar(100)
  blotatoPostId    String?   @map("blotato_post_id") @db.VarChar(100)
  caption          String?   @db.Text
  postedAt         DateTime  @default(now()) @map("posted_at") @db.Timestamptz
  metricsFetchedAt DateTime? @map("metrics_fetched_at") @db.Timestamptz
  viewCount        BigInt?   @map("view_count")
  likeCount        BigInt?   @map("like_count")
  commentCount     BigInt?   @map("comment_count")
  shareCount       BigInt?   @map("share_count")
  agentReasoning   String?   @map("agent_reasoning") @db.Text
  scheduledAt      DateTime? @map("scheduled_at") @db.Timestamptz
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz

  hookCandidate HookCandidate? @relation(fields: [hookCandidateId], references: [id])

  @@index([hookCandidateId])
  @@index([postedAt(sort: Desc)])
  @@map("tiktok_posts")
}

model WisdomPattern {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  patternName            String    @unique @map("pattern_name") @db.VarChar(100)
  description            String?   @db.Text
  targetUserTypes        String[]  @default([]) @map("target_user_types")
  effectiveTone          String?   @map("effective_tone") @db.VarChar(20)
  effectiveHookPattern   String?   @map("effective_hook_pattern") @db.Text
  effectiveContentLength String?   @map("effective_content_length") @db.VarChar(20)
  appEvidence            Json      @default("{}") @map("app_evidence") @db.JsonB
  tiktokEvidence         Json      @default("{}") @map("tiktok_evidence") @db.JsonB
  confidence             Decimal   @default(0) @db.Decimal(5, 4)
  verifiedAt             DateTime? @map("verified_at") @db.Timestamptz
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime  @default(now()) @map("updated_at") @db.Timestamptz

  @@map("wisdom_patterns")
}
