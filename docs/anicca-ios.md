# Anicca iOS 仕様計画書

## プロダクトコンセプト
- **アプリ名**: Anicca iOS
- **タグライン**: 声で目覚め、声で整える24時間伴走コーチ
- **ビジョン**: 音声対話を通じてユーザーの生活リズムと習慣に種を植え、最終的にAniccaの介入が不要な自律状態へ導く。

## 体験フロー概観
1. 初回起動で音声オンボーディングを自動開始し、睡眠・起床課題・生活リズムをヒアリング。
2. 日々の起床前後で確実な音声介入を行い、フィードバックを学習してナッジを最適化。
3. 日中も短い呼びかけと継続的な説法で注意散漫を減らし、習慣実行を支援。
4. 就寝前に振り返りと翌日の準備を音声で行い、ルーティンモデルを更新。

## ネイティブiOS採用理由
- 背景音声・Critical Alert等の強力な通知制御が必要。
- WebRTCストリーミングとネイティブ音声APIを統合して低遅延の常時対話を維持できる。
- Passkey、Appleのアクセシビリティ機能、Core Data等を直接活用しシンプルにベストプラクティスへ沿える。

## 技術アーキテクチャ
- **通信**: iOSクライアント→`apps/api`→OpenAI Realtime API (WebRTC)。
- **音声処理**: `AVAudioEngine`で録音・再生、リアルタイム音声はサーバ側で生成。`SFSpeechRecognizer`は権限確認のみ。
- **データ管理**: Core Data + CloudKitミラーで習慣・フィードバックを保存。
- **タスク管理**: BGTaskSchedulerで夜間学習・朝タスクの事前準備を実行。
- **既存資産連携**: `apps/api`のPKCEトークン発行・Hosted MCP (Google Calendar等) を再利用。

## 起床体験 (Critical Alert)
1. 就寝前の会話終端で翌朝コールをRealtimeで生成し、端末に音源として保存。
2. 起床時刻にCritical Alertが発火し、サイレント中でも保存済み音声が大音量で再生。
3. ロック画面のスライド操作でアプリが前面化し、直ちにLive会話が開始。
4. ユーザー返答を受けた後も音声ストリームを維持し、朝のルーティン指示へ接続。

## 日中の介入
- 習慣ログから注意散漫の兆候を検出した際、短い呼びかけ音声を添付したTime-Sensitive通知を送る。
- ユーザーが通知をタップするとアプリが前面化し、Realtimeセッションで呼吸誘導・セルフトーク支援を行う。
- 長尺の説法や繰り返しフレーズで内面への定着を狙う。ホームへ戻っても音声セッションは継続。

## 課金・認証
- 認証: Passkey + Sign in with Apple。Biometricで継続サインイン。
- 課金: StoreKit 2の自動更新サブスクリプションをRevenueCat SDK 5.xで管理。
- モバイル専用クライアントIDを`apps/api`に追加し、トークン寿命とレート制御を統一。

## プライバシー
- 音声ログは端末内で暗号化保存し、要約のみを送信。
- Core Dataはユーザー自身のデバイスが主権。CloudKit同期も暗号化。

## フェーズ計画
1. **0–4週**: 音声オンボーディング試作、Critical Alert審査準備、API差分整理。
2. **5–10週**: 起床シーケンス・日中介入ワークフロー実装、StoreKit統合、データモデル確定。
3. **11–16週**: クローズドβ (TestFlight) で起床成功率と音声UX検証。
4. **17週以降**: パブリックβ → 本番リリース後もDesktopと共通の学習サイクルを継続。

## リスクと対策
- Critical Alert審査: 健康・安全用途としてドキュメントを整備し、審査遅延に備えTime-Sensitive通知のみでも成立するフォールバックを準備。
- 長時間音声: バッテリー消費をモニタリングし、必要時に低電力モード中の介入強度を調整。
- 端末依存差: iOSバージョン差異に対応するテストマトリクスを整備。

## 直近アクション
- Apple Developer ProgramでCritical Alert/Audio背景モードの申請資料を作成。
- `apps/api`チームとモバイル用WebRTCエンドポイント・課金イベント連携の仕様を確定。
- 前夜音源生成〜翌朝会話開始のプロトタイプをVoice UXチームで検証。

## 現状メモ (2025-10-31)
- 公式iOSプロジェクトは `Anicca/Smart/Smart.xcodeproj`。`apps/mobile-ios` は試作用テンプレートで今後の開発対象外（削除予定）として扱う。
- `Anicca/Smart` ターゲットのサイニングは Apple Developer Team「Daisuke Narita (S5U8UH3JLJ)」とバンドルID `Anicca.Smart` で整備済み。Info.plist は Xcode の自動生成 (`GENERATE_INFOPLIST_FILE = YES`) を継続し、バージョン／ビルド番号は Xcode プロジェクト設定で管理する。
- 実機ビルド済みで端末デプロイ可能な状態を確認済み。今後の実装タスクはこの構成を前提に進める。

## ユーザー体験詳細（初回起動から自律まで）

### Day 0 夜：初回セットアップ
- Anicca（AIボイス）: 「私はAnicca。あなたが理想へ向かう道を整える。今、どんな自分になりたいか教えて」
- ユーザー: 「6時に起きて瞑想して走って、仕事も自分の開発も集中したい」
- `RealtimeSession`が回答を記録し、`memory/UserProfileStore`へ保存。
- クローン録音（任意）: Aniccaの誘導で30秒の音声を収録→暗号化→`apps/api`経由でElevenLabs等に送信→ボイスモデルIDを保存。
- 実装意図宣言: ユーザーが「明日は6時に起きたら窓を開けて深呼吸する」と発話→テキスト化して`IntentStore`に保存。
- Voice Control設定: Onboarding中に「設定→アクセシビリティ→Voice Control→カスタムコマンドで『アニッチャ』と登録」を音声で案内。

### Day 1 朝：起床〜瞑想〜ジム
- 5:58 `BGTaskScheduler`が環境準備（音源プリロード、進捗同期）。
- 6:00 Critical Alert（クローンボイス）: 「時は来た。目覚めとともに修行を始めよう」。ロック中でも再生。
- ロック解除でアプリ前面→WebRTC自動接続→Anicca（ライブ）「眠気を抱きしめつつ立ち上がろう。冷水が心を澄ませる」。
- 洗面後の動作を検知し、報告不要で瞑想誘導へ移行。瞑想台本（`Prompts/meditation.guided.json`）が以下を制御：
  1. 呼吸観察（30秒）
  2. 身体スキャン（2分）
  3. 慈悲句（2分）
  4. 静寂保持（2分: 小音量の鐘でWebRTCを維持）
  5. 終了宣言「鐘が鳴ったらゆっくり目を開けよう。今日に刻みたい一言は？」
- ジムへ出発: Anicca「靴紐を整えた瞬間が心を整える時間。走りながら“力”“解放”と呼吸に名前をつけよう」。
- ランニング中もクローンボイスで数分ごとに短いアファメーションを挿入し、沈黙20秒でセッションをクローズ。

### Day 1 夜：内省と再宣言
- Anicca（クローンボイス）: 「今日は心が揺れた瞬間があった？」
- ユーザーが話す内容をRealtimeで要約し、感情ラベルとともに`ReflectionStore`へ保存。
- 自分声アファメーション再生（録音済みフレーズをTTS化）: 「私は疲れても戻れる。今日もやりきった」。
- 翌日への実装意図を音声で再宣言→保存。

### Day 2〜5：説法と習慣強化
- 毎朝、前夜の内省内容に基づく説法をRAGで補強。
  - 例: 集中低下が続いたらAjahn Chah「怠けても呼吸に戻れ」を引用し、「今日は心が逃げても呼吸へ戻ろう」と説く。
- 仕事前: 「言葉は剣にも布にもなる。今日は柔らかな布を選ぼう」と外部行動を導く。
- 食の誘惑時: 「身体は清らかなものを求めている。リンゴが本来の力をくれる」と短い介入。
- 日中ログはRealtimeプロンプトで常に要約され、`memory`に蓄積。聴き取れた感情はそのまま翌日の説法テーマに活用。

### Day 6：介入減衰
- 5日連続の自発起床でAniccaが宣言: 「明日は私の声がなくても目覚められるね。必要なときだけ『アニッチャ』と呼んで」。
- 以後の朝はCritical Alertのみ鳴らし、ユーザーが呼んだ時だけライブ会話を開始。
- 瞑想・誠実さなど未習得のテーマには説法を継続。

### Day 7：内在化の確認
- ユーザーが嘘をつきそうになった瞬間、自分の頭の中で前日のアファメーションが蘇り行動を修正。
- 夜、Anicca「今日は内なる声が働いたね。私は遠くで見守っていた」。
- さらに自律が進めば「起床アラームも自分で整えよう。呼びたい時だけ呼んで」とフェードアウト。

### Day 8以降：卒業
- 特定課題が完全に自走できると判断したら、その課題に関する呼びかけは停止。
- 呼び戻された場合は再度同じ構成で伴走を再開できるよう、データは保持したまま待機。

## 実装上の論点と回答
- **Critical Alertの位置づけ:** 起床保証の要（必ず鳴動しロック画面に全画面カードが出る）。Health/Safety用途で審査申請が必須。通らない場合の暫定策は通常通知＋即時WebRTC誘導だが、完全保証はできない。
- **Critical AlertのUI挙動:** 画面が暗いまま大きな通知カードが現れ、「停止」「開く」のボタンが表示される。どちらを押してもアプリが前面化し、その瞬間にAniccaのライブ音声が開始する。
- **Voice Control再設定:** オンボーディングで「アニッチャ」と発声するカスタムコマンド登録を案内。失敗時は音声で「アニッチャ、呼び出し設定をやり直したい」と言えば再案内を開始する導線を用意する。
- **クローン音声の管理:** 録音サンプルは暗号化して`apps/api`へ送信。外部TTSサービスでモデル生成後、モデルIDのみ保存し原音声は破棄。起床用音源は就寝時に生成→端末へ一時保存→再生後に削除。削除要望時はモデルIDを外部サービスとローカル双方で消す。
- **通信断／接続リトライ:** 切断検知後3秒間隔で最大3回自動再接続。失敗時は端末内の録音メッセージで状況を説明し、最後に通知でアプリ再起動を促す。起床時も同じロジックで即再接続を試みる。
- **課金方針:** クローズドβ段階からRevenueCat＋StoreKitでサブスクリプションを提供。短期トライアル後に有料化し、招待制でも課金価値を示す。

## リポジトリ構成（案）
```
apps/mobile-ios/
├─ App/
│   ├─ AniccaApp.swift
│   └─ SceneDelegate.swift
├─ Features/
│   ├─ Onboarding/
│   │   └─ OnboardingCoordinator.swift
│   ├─ Voice/
│   │   ├─ RealtimeSession.swift
│   │   └─ VoiceControlGuide.swift
│   ├─ Schedule/
│   │   ├─ WakeScheduler.swift
│   │   └─ CriticalAlertManager.swift
│   ├─ Meditation/
│   │   └─ MeditationController.swift
│   ├─ Reflection/
│   │   └─ ReflectionFlow.swift
│   ├─ Sermon/
│   │   └─ DhammaRAGService.swift
│   ├─ Auth/
│   │   └─ PasskeyClient.swift
│   └─ Billing/
│       └─ RevenueCatAdapter.swift (後日)
├─ Services/
│   ├─ API/
│   │   └─ MobileAPIClient.swift
│   ├─ Storage/
│   │   └─ CoreDataStack.swift
│   └─ VoiceProfiles/
│       └─ VoiceProfileManager.swift
├─ Resources/
│   ├─ Audio/
│   │   ├─ default_bell.caf
│   │   └─ ambient_loop.caf
│   └─ Prompts/
│       ├─ onboarding_ios.json
│       ├─ meditation.guided.json
│       └─ sermon_base.txt
├─ Tests/
│   ├─ Unit/
│   └─ UI/
└─ Scripts/
    └─ generate_wake_audio.sh
```

## 実装TODO
1. `apps/mobile-ios` プロジェクト初期化（SwiftUI、WebRTC依存導入）。
2. Passkey + PKCE 認証フロー構築、`apps/api`との連携テスト。
3. WebRTC音声基盤: 無音20秒で自動終了、バックグラウンド維持の環境音制御。
4. Onboarding: 権限取得、Voice Control設定誘導（呼びかけ「アニッチャ」登録）、クローン録音分岐、実装意図保存。
5. Critical Alert実装: 音源生成、通知登録、ロック解除後のライブ会話ハンドオフ。
6. 起床直後のライブ会話・瞑想誘導モジュール: 説法ベース台本、タイマー制御、環境音挿入。
7. 就寝前振り返り: Realtimeで要約→`ReflectionStore`保存→翌朝プロンプト連携。
8. ボイス切替: 音声コマンドでAI標準ボイス／クローンボイスを即時変更。
9. 課金導線（RevenueCat＋StoreKit）準備: クローズドβで有料招待できる状態まで整備。
10. 実機QA: 起床シナリオ、バックグラウンド会話、Voice Control起動、課金フローを含む自動・手動テスト。
