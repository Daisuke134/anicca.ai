# Anicca v0.3 手動テストチェックリスト（Phase 9）

> 目的: v0.3 の主要フロー（Talk / 習慣通知 / セッション開始停止 / 課金/上限 / 権限フォールバック）を、人手で再現可能な形で検証する。

## 前提
- ビルド: Debug / Staging / Production のどれで実行したかを記録
- 端末: iPhone 実機（OSバージョンを記録）
- ネットワーク: オンライン（機内モードのテスト項目は別途）

## 0. 初回起動（クリーン状態）
- [ ] `-resetOnLaunch` 相当で UserDefaults を初期化できること（またはアプリ削除→再インストール）
- [ ] オンボーディングが `.welcome` から開始すること

## 1. 認証
- [ ] Sign in with Apple → 成功してメイン画面に遷移する
- [ ] サインアウト後にローカル状態が消える（設定画面の Sign Out）

## 2. マイク権限（許可/拒否）
- [ ] 初回: マイク許可を求める導線が「文脈のあるタイミング」で表示される（Onboarding または Talk 開始時）
- [ ] 許可: Talk/Session が開始できる
- [ ] 拒否: Session開始時に「Open Settings」導線が表示され、クラッシュしない
- [ ] 設定アプリで許可→アプリ復帰後に Session が開始できる

## 3. 通知権限（許可/拒否）
- [ ] 通知許可: 習慣通知が予定時刻に届く
- [ ] 通知拒否: アプリ内で「通知が無効でも Talk は使える」ことが明示され、クラッシュしない
- [ ] 設定アプリで許可→アプリ復帰後に通知が届く

## 4. 習慣スケジュール（Wake / Training / Bedtime）
- [ ] 各習慣の時刻を保存すると、通知が再登録される
- [ ] 既存スケジュールを変更すると、古い通知が残らない

## 5. 通知タップ → セッション開始
- [ ] 習慣通知をタップすると、`pendingHabitTrigger` が立ち Session が開始する
- [ ] セッション終了（End）で `/session/stop` が呼ばれ、利用量が反映される

## 6. Wake サイレント説明（Just-in-time / 1回だけ）
- [ ] Wake 通知 → Session 開始のタイミングで、Wakeサイレント説明が **1回だけ**表示される
- [ ] `OK, got it` 押下で以降は出ない
- [ ] 端末/OS 条件（AlarmKit利用可否等）により、出る/出ないが仕様通りである

## 7. 利用量上限 / Paywall
- [ ] 無料枠の上限到達で `UsageLimitModal` が表示される
- [ ] `Upgrade` → Paywall 表示、`Manage` → Settings 表示
- [ ] 課金/復元後、`syncNow()` により上限状態が解除される

## 8. Fallback UX（未許可でも継続可能）
- [ ] 通知/各種データ連携が未許可でも、Talk を開始できる
- [ ] Behavior（将来実装）でデータが不足する場合、説明コピーが表示される
- [ ] 「Open Settings」導線があり、自己解決できる

## 9. 回帰確認（最低限）
- [ ] 設定画面が開ける（SessionView の gear）
- [ ] アカウント削除フローが動作し、失敗時にエラーが表示される
- [ ] アプリがクラッシュしない（権限拒否/オフライン/復元失敗の代表ケース）










