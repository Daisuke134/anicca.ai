@startuml
title 本を返すシナリオ

actor "利用者" as User
participant "図書館" as Library
participant "貸出記録" as LoanRecord
participant "本" as Book
participant "利用者" as UserObj

User -> Library: 本を返す(loanId)
activate Library

Library -> LoanRecord: 貸出記録検索(loanId)
activate LoanRecord
LoanRecord --> Library: LoanRecordオブジェクトまたはnull
deactivate LoanRecord

alt 貸出記録が見つからない
    Library --> User: エラー: 貸出記録が見つかりません
    deactivate Library
else 貸出記録が見つかった
    Library -> LoanRecord: isOverdue()
    activate LoanRecord
    LoanRecord -> LoanRecord: 現在日付と返却期限を比較
    LoanRecord --> Library: 延滞判定結果
    deactivate LoanRecord
    
    Library -> LoanRecord: markAsReturned(現在日付)
    activate LoanRecord
    LoanRecord -> LoanRecord: returnDate = 現在日付
    LoanRecord -> LoanRecord: isOverdue = false
    LoanRecord --> Library: 更新完了
    deactivate LoanRecord
    
    Library -> Book: markAsReturned()
    activate Book
    Book -> Book: status = AVAILABLE
    Book -> Book: usageCount++
    Book -> Book: lastUsedDate = 現在日付
    Book --> Library: 更新完了
    deactivate Book
    
    Library -> UserObj: 貸出記録を削除
    activate UserObj
    UserObj --> Library: 更新完了
    deactivate UserObj
    
    Library -> LoanRecord: calculateFine()
    activate LoanRecord
    LoanRecord -> LoanRecord: 延滞日数を計算
    alt 延滞している
        LoanRecord --> Library: 延滞料金
        Library --> User: 返却完了\n延滞料金: XXX円
    else 期限内に返却
        LoanRecord --> Library: 延滞料金なし
        Library --> User: 返却完了\nありがとうございました
    end
    deactivate LoanRecord
    
    Library -> Book: shouldBeDiscarded()
    activate Book
    Book -> Book: 破損チェック・利用期間チェック
    alt 廃棄条件を満たしている
        Book --> Library: 廃棄が必要
        Library -> Book: discard()
        activate Book
        Book -> Book: status = DISCARDED
        Book --> Library: 廃棄完了
        deactivate Book
    else まだ利用可能
        Book --> Library: 利用可能
    end
    deactivate Book
end
deactivate Library

@enduml

