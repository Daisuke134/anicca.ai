# アニッチャ行動変容計画（観察・裏解析編）

## 目的
- `apps/desktop` の音声エージェントを、微細なユーザー反応を捉えて即座にナッジへ反映する「師匠人格」として完成させる。
- 音声・発話内容・沈黙といった観測結果を裏解析に回し、プロンプトと記憶をリアルタイムで更新することで行動変容力を極限まで高める。

## Realtime セッション構成
- WebRTC 接続＋`semantic_vad` を既定とし、ターン区切りと返答生成をサーバー側に任せる。
- Conversation Item は真実の唯一ソース。各 Item の `id` と本文を保持し、引用・検証・仮説更新に利用する。

## 観察データ取得
1. **音声メトリクス（クライアント計測）**
   - Web Audio API で RMS 音量・ピッチ推移・無音区間を算出。
   - 計測値を最新ユーザー Item にメタデータとして紐づけ、裏解析への入力にする。
2. **テキスト特徴（モデルテキスト化）**
   - `semantic_vad` により自動生成されたユーザー Item から語尾・言い訳語・感情語を抽出。
   - 直前 3 ターンをまとめて裏解析へ渡し、流れを把握させる。

## 裏解析（Out-of-band 応答）
- `response.create` に `conversation: "none"` を指定し、本線に影響させず解析を実行。
- 代表的な解析ジョブ：
  1. **感情推定**: 「怒り/悲しみ/恐怖/虚無/平静」を分類し、根拠文を返させる。
  2. **言い訳検出**: 「直近の発話は逃避か？真意か？」を Yes/No 判定＋理由付きで出力。
  3. **トリガー抽出**: 「繰り返し出現した弱音・欲望ワードは何か？」を列挙。
- 解析結果は `metadata` で種類をタグ付けし、戻り値のテキストを即 `hypothesis_journal` に格納する。

## 指示への反映
1. **場内反映**
   - `response.create` を送る直前に、解析結果を差し込んだテンプレートを整形し、`instructions` へ埋め込む。
   - 例: `怒り` 判定なら「今の苛立ちは恐れの裏返しだ。深呼吸して『I choose discipline』と叫べ。」を追加。
2. **セッション更新**
   - 大局的な洞察（今日の最大の逃避など）は `session.update` の `instructions` に書き足し、以後の応答すべてがその洞察を前提に動くようにする。

## 記憶ストア運用
- `profile_memory`: ユーザー自身の発話を `item_id` 付きで保存（例: `item_user_350: "I procrastinated again."`）。
- `hypothesis_journal`: 裏解析結果と判定理由を時系列記録。次回再利用時に成功/失敗を追記し、外れた仮説は破棄。
- `interaction_trace`: 当日の重要 Item ID を順番に並べ、どのナッジで態度が変化したかを把握する。

## ユーザー体験シナリオ
1. 起床時、ユーザーが「Just five more minutes…」と発話 (`item_user_271`)。
2. 裏解析が即座に「逃避=Yes」「感情=恐れ」と判定し、師匠の次発話が「さっき『five more minutes』と言った。恐れを握り潰せ。」に変化。
3. ユーザーが「Fine, I’m sitting up now.」と応答 (`item_user_279`)。この成功 Item を `profile_memory` に保存し、翌朝の第一声で引用。
4. 慈悲瞑想後、out-of-band で「怒り語が多い」と分析→就寝前レビューで師匠が「今日の怒りは罪悪感が根だ」と断言し、翌朝の instructions に継承。

## 今後の追加実装
- 音声メトリクスを LLM へ渡すフォーマット（例: JSON）を統一。
- 裏解析結果を評価するループ（成功時は優先度アップ、失敗時は即別フレーズへ切り替え）。
- 沈黙が続く場合の自動トリガー（一定無音で「怒り or 虚無」判定ジョブを発火）。

