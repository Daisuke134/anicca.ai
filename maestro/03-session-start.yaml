# Voice Session Start/End Test
# Tests starting and ending a voice session
# Requires: User already signed in with microphone permission granted
# Note: Uses text-based taps (no accessibilityIdentifier required)

appId: ai.anicca.app.ios
name: Voice session basic flow

---
# Launch the app
- launchApp

# Wait for main screen to load
- assertVisible:
    text: "Talk"
    timeout: 10000

# Make sure we're on the Talk tab
- tapOn:
    text: "Talk"

# Verify the session start button is visible
- assertVisible:
    text: "Consult Anicca"
    timeout: 5000

# Start the session
- tapOn:
    text: "Consult Anicca"

# Handle potential microphone permission dialog (if not granted)
- tapOn:
    text: "Allow"
    optional: true
    timeout: 3000

# Verify connecting state
- assertVisible:
    text: "Connecting"
    optional: true
    timeout: 5000

# Wait for session to connect (may take a few seconds)
# The button text changes to "End Session" when connected
- assertVisible:
    text: "End Session"
    timeout: 15000

# Alternative: Check for session status indicators
- assertVisible:
    text: "listening"
    optional: true
    timeout: 5000

- assertVisible:
    text: "speaking"
    optional: true

# End the session
- tapOn:
    text: "End Session"

# Verify we're back to the idle state with start button
- assertVisible:
    text: "Consult Anicca"
    timeout: 10000

# Optional: Check if EMA (feedback) dialog appears
- assertVisible:
    text: "Did you feel a bit better?"
    optional: true
    timeout: 3000

# If EMA appears, respond or skip
- tapOn:
    text: "Skip"
    optional: true

# Verify session ended successfully
- assertVisible:
    text: "Talk"
    timeout: 5000

